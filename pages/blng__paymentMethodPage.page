<apex:page showHeader="true" sidebar="true" standardController="Account" standardStylesheets="true" extensions="blng.CurrencyUtils">
  <apex:includeScript value="/lightning/lightning.out.js" />
     <script src="../../soap/ajax/38.0/connection.js" type="text/javascript"/>
    <style>
        /* This prevents page shifting when scrollbar appears/disappears */
        html {
            overflow-y:scroll;
        }
    </style>
     
     <article class="slds-card"  id="MessagingWindow" style="display:none;min-height:10rem;">
      <div class="slds-card__header slds-grid">
         <header class="slds-media slds-media--center slds-has-flexi-truncate">             
          
                <div class="slds-media__body slds-truncate">               
                    <div style="margin-left:40%; margin-top:5rem;font-size:1.3rem;">
                     <span id="spanId"></span>             
                    </div>
                </div>
            </header>
            <div> 
                 <button class="slds-button slds-button--neutral" onclick="goBack()">Back</button>       
             </div>   
             
        </div>
    </article>
                 
    
    <div id="lightning"> 
    <div id="spinnerId" class="slds-spinner_container slds-show" >
            <div class="slds-spinner--brand slds-spinner slds-spinner--large" aria-hidden="false" role="alert">               
                <div class="slds-spinner__dot-a"></div>
                <div class="slds-spinner__dot-b"></div>
            </div>
     </div>
     </div>
           
 
    <script>
          sforce.connection.sessionId='{!GETSESSIONID()}';
          //var invoiceName = '{!$ObjectType.DebitNote__c.Name}'; 
           // var namespace = (invoiceName.toLowerCase().startsWith('blng')) ? 'blng' : 'c'; 
          //var prefix = (invoiceName.toLowerCase().startsWith('blng')) ? 'blng__' : '';
          
        var invoice = '{!JSENCODE(BillingRawPrefix)}';
        var invoice1 = '{!JSENCODE(BillingBarPrefix)}';
        var namespace = invoice != '' ? invoice : 'c';
        var prefix = invoice1 != '' ? invoice1 : '';
        var currencyIsoCode = '';
        currencyIsoCode = '{!JSENCODE(currencyISOCode)}';
          
          var queryValue = "SELECT Id FROM "+prefix+"PaymentGateway__c WHERE "+prefix+"Active__c = true";
          var result = sforce.connection.query(queryValue);
          var records = result.getArray("records");
          var isAutoPayEnabled = JSON.parse({!JSENCODE(IF(accountHasAutoPayPaymentMethod,"true", "false"))});

          if(records.length > 0)
          { 
              $Lightning.use(namespace+":paymentMethodApp", function() {
              $Lightning.createComponent(namespace+":paymentMethod",
              { "recordId" : "{!$CurrentPage.parameters.Id}",
                "accountName" : "{!JSENCODE(Account.Name)}",
                "currencyIsoCode" : currencyIsoCode,
                "prefix" : prefix,
                  "autoPayEnabled" : isAutoPayEnabled
              },
              "lightning",
              function(cmp) {
                document.getElementById('spinnerId').style.display = 'none';
              });
            });
        } else {
            document.getElementById('spinnerId').style.display = 'none';
            document.getElementById('MessagingWindow').style.display = 'block';      
            document.getElementById('spanId').textContent = "{!JSENCODE($Label.NoActiveGateway)}";
        }
        function goBack() { window.history.back(); }
    </script>
</apex:page>