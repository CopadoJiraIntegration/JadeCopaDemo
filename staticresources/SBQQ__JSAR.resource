"use strict";var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined;}else{return get(parent,property,receiver);}}else if("value"in desc){return desc.value;}else{var getter=desc.get;if(getter===undefined){return undefined;}return getter.call(receiver);}};var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i["return"])_i["return"]();}finally{if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i);}else{throw new TypeError("Invalid attempt to destructure non-iterable instance");}};}();var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a;}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r);},p,p.exports,r,e,n,t);}return n[i].exports;}for(var u="function"==typeof require&&require,i=0;i<t.length;i++){o(t[i]);}return o;}return r;})()({1:[function(require,module,exports){(function(process,global){(function(){'use strict';var logger=require('js-logger').logger.getLogger();function CacheManager(){logger.trace('Creating new instance of cache manager');this._caches=new Map();}CacheManager.prototype.getCache=function(name,cacheClass){logger.debug('Getting cache by name:',name);var inMainNodeProcess=typeof window==='undefined'&&process&&process.mainModule&&process.mainModule.filename&&process.mainModule.filename.endsWith('server.js');if(inMainNodeProcess){logger.trace('Cache with name ',name,' requested in main process. Returning new instance.');return this._createCacheInstance(name,cacheClass);}else{var cache=this._caches.get(name);if(!cache){logger.trace('Cache with name:',name,'not exist yet.');cache=this._createCacheInstance(name,cacheClass);this._caches.set(name,cache);}else{logger.trace('Find cache for name:',name);}return cache;}};CacheManager.prototype._createCacheInstance=function(cacheName,cacheClass){var cache=void 0;if(cacheClass){logger.trace('Cache class defined');if(typeof cacheClass==='function'){logger.trace('Creating new cache by customized class for name:',cacheName);cache=new cacheClass();}else{logger.warn('Cache class defined, but is not a function.',typeof cacheClass==="undefined"?"undefined":_typeof(cacheClass));throw new Error('Customize cache class type wrong.');}}else{logger.trace('Creating new cache as Map for name:',cacheName);cache=new Map();}if(typeof cache!=='undefined'){return cache;}else{logger.warn('Cache undefined, something wrong.');throw new Error('Create cache get undefined.');}};CacheManager.prototype.flushCaches=function(resetCaches){logger.debug('Flushing all caches');this._caches.forEach(function(value){if(value&&typeof value.clear==='function'){value.clear();}});if(resetCaches){logger.trace('Rest cache');this._caches.clear();}};var CACHE_MANAGER_KEY=Symbol.for('client.Utils.CacheManager');var globalRef=typeof global!=='undefined'?global:typeof self!=='undefined'?self:typeof window!='undefined'?window:{};var globalSymbols=Object.getOwnPropertySymbols(globalRef);var hasCacheManager=globalSymbols.indexOf(CACHE_MANAGER_KEY)>-1;if(!hasCacheManager){var _cacheManager=new CacheManager();Object.freeze(_cacheManager);globalRef[CACHE_MANAGER_KEY]=_cacheManager;}module.exports={cacheManager:globalRef[CACHE_MANAGER_KEY]};}).call(this);}).call(this,require('_process'),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"_process":73,"js-logger":58}],2:[function(require,module,exports){var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var WhereClauseSplitter=require('./WhereClauseSplitter.js');var BaseSubqueryDescriptor=function(){function BaseSubqueryDescriptor(){_classCallCheck(this,BaseSubqueryDescriptor);}_createClass(BaseSubqueryDescriptor,[{key:"addSubqueriesToQuery",value:function addSubqueriesToQuery(query){throw Error('Error: BaseSubqueryDescriptor.addSubqueriesToQuery() should be overridden by child classes and never invoked directly.');}}]);return BaseSubqueryDescriptor;}();var BaseDAO=function(){function BaseDAO(conn,labels){_classCallCheck(this,BaseDAO);this._conn=conn;this._labels=labels;this._QUERY_LENGTH_LIMIT=15000;this._WHERE_CLAUSE_LENGTH_LIMIT=3800;this._logger=jsLogger;}_createClass(BaseDAO,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"_logWarning",value:function _logWarning(msg){this._logger.warn(msg);}},{key:"_constructSelectClauseAndCalculateRemainingLength",value:function _constructSelectClauseAndCalculateRemainingLength(selectedFields){var uniqueSelectedFields=[].concat(_toConsumableArray(new Set(selectedFields)));var totalQueryLength=0;var selectClause=uniqueSelectedFields.join(', ');totalQueryLength+=selectClause.length;var charsUntilLimitReached=this._QUERY_LENGTH_LIMIT-totalQueryLength;if(charsUntilLimitReached<18){throw Error('SELECT clause length exceeded safe threshold of 15,000 characters.');}var maxLengthForWhereClause=charsUntilLimitReached<this._WHERE_CLAUSE_LENGTH_LIMIT?charsUntilLimitReached:this._WHERE_CLAUSE_LENGTH_LIMIT;return{selectClause:selectClause,maxWhereLength:maxLengthForWhereClause};}},{key:"_constructAndPerformQuery",value:function _constructAndPerformQuery(objectType,selectedFields,fullWhereClause,subqueryDescriptor,orderbyArray){var _this=this;var selectDescriptor=this._constructSelectClauseAndCalculateRemainingLength(selectedFields);var selectClause=selectDescriptor.selectClause;var whereSplitDescriptor=new WhereClauseSplitter().splitWhereClause(fullWhereClause,selectDescriptor.maxWhereLength);var partialWhereClauses=whereSplitDescriptor.clauses;var querySpecificityPreserved=whereSplitDescriptor.specificityPreserved;var queryPromises=[];partialWhereClauses.forEach(function(partialWhereClause){var query=_this._conn.sobject(objectType).select(selectClause).where(partialWhereClause);if(subqueryDescriptor){subqueryDescriptor.addSubqueriesToQuery(query);}if(orderbyArray){query.orderby(orderbyArray[0],orderbyArray[1]);}queryPromises.push(query.execute({autoFetch:true,maxFetch:Number.POSITIVE_INFINITY}));});return Promise.all(queryPromises).then(function(queryResultsArrays){return _this._reconcileQueryResultsWithWhereClauses(queryResultsArrays,whereSplitDescriptor);},function(err){return _this._simplifyAndRethrowQueryError(err);});}},{key:"_simplifyAndRethrowQueryError",value:function _simplifyAndRethrowQueryError(err){var fullMsg=err.message||err;var msgLines=fullMsg.split('\n');if(msgLines.length===5){var firstLineEmpty=msgLines[0]==='';var thirdLineIsCaratAndWhitespace=/^\s*\^$/g.test(msgLines[2]);var fourthLineFitsPattern=msgLines[3].startsWith('ERROR at Row');var fifthLineFitsPattern=msgLines[4].startsWith('No such column \'');if(firstLineEmpty&&thirdLineIsCaratAndWhitespace&&fourthLineFitsPattern&&fifthLineFitsPattern){var extractor=/No such column '(\w+)' on entity '(\w+)'./g;var matches=extractor.exec(msgLines[4]);if(matches&&matches[1]&&matches[2]){var errTemplate=this._labels.msg_missing_fls_on_amend_or_renew;throw new Error(errTemplate.replace('{0}',matches[1]).replace('{1}',matches[2]));}}}throw new Error(fullMsg);}},{key:"_reconcileQueryResultsWithWhereClauses",value:function _reconcileQueryResultsWithWhereClauses(queryResultArrays,whereClauseDescriptors){if(whereClauseDescriptors.specificityPreserved){var results=[];var idSet=new Set();queryResultArrays.forEach(function(queryResults){queryResults.forEach(function(record){if(!idSet.has(record.Id)){results.push(record);idSet.add(record.Id);}});});return results;}else{var _ret=function(){var idx=0;var currentCombinedResults=queryResultArrays;var currentKeyLists=whereClauseDescriptors.splitKeyLists;var keysByDepth=whereClauseDescriptors.splitKeysMappedByMaxDepth;var _loop=function _loop(){var newCombinedResults=[];var newKeyLists=[];var keysToSeek=keysByDepth.get(idx);var primaryIndexesBySplitKey=new Map();var combinationInfoByPrimaryIndex=new Map();currentKeyLists.forEach(function(keyList,listIdx){var splitKey=keyList[0];if(keysToSeek.has(splitKey)&&!primaryIndexesBySplitKey.has(splitKey)){primaryIndexesBySplitKey.set(splitKey,listIdx);combinationInfoByPrimaryIndex.set(listIdx,{splitKey:splitKey,secondaryIdxs:[]});}else if(keysToSeek.has(splitKey)){var primaryIndex=primaryIndexesBySplitKey.get(splitKey);combinationInfoByPrimaryIndex.get(primaryIndex).secondaryIdxs.push(listIdx);}else{combinationInfoByPrimaryIndex.set(listIdx,null);}});combinationInfoByPrimaryIndex.forEach(function(combInfo,primaryIdx){if(combInfo==null){newCombinedResults.push(currentCombinedResults[primaryIdx]);newKeyLists.push(currentKeyLists[primaryIdx]);}else{var splitKey=combInfo.splitKey;var primaryResults=currentCombinedResults[primaryIdx];var secondaryResults=combInfo.secondaryIdxs.map(function(idx){return currentCombinedResults[idx];});var _idSet=new Set();var combinedResults=[];if(splitKey.startsWith("AND")){secondaryResults.forEach(function(resultList,i){var tmpIdSet=new Set();resultList.forEach(function(record){if(_idSet.has(record.Id)||i===0){tmpIdSet.add(record.Id);}});_idSet=tmpIdSet;});primaryResults.forEach(function(record){if(_idSet.has(record.Id)){combinedResults.push(record);}});}else{var resultLists=[primaryResults].concat(_toConsumableArray(secondaryResults));resultLists.forEach(function(resultList){resultList.forEach(function(record){if(!_idSet.has(record.Id)){combinedResults.push(record);_idSet.add(record.Id);}});});}newCombinedResults.push(combinedResults);newKeyLists.push(currentKeyLists[primaryIdx].slice(1));}});currentCombinedResults=newCombinedResults;currentKeyLists=newKeyLists;idx+=1;};while(idx<keysByDepth.size){_loop();}return{v:currentCombinedResults[0]};}();if((typeof _ret==="undefined"?"undefined":_typeof(_ret))==="object")return _ret.v;}}}]);return BaseDAO;}();module.exports.BaseSubqueryDescriptor=BaseSubqueryDescriptor;module.exports.BaseDAO=BaseDAO;},{"./WhereClauseSplitter.js":5,"js-logger":58}],3:[function(require,module,exports){'use strict';module.exports.properlyPrefixFields=function(prefix,fieldList){return fieldList.map(function(field){return field.endsWith('__c')?prefix+field:field;});};},{}],4:[function(require,module,exports){'use strict';var IdToValueCache=require('../IdToValueCache.js');var DAOHelperMethods=require('./DAOHelperMethods.js');var BaseDAO=require('./BaseDAO.js').BaseDAO;var BaseSubqueryDescriptor=require('./BaseDAO.js').BaseSubqueryDescriptor;var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var cacheManager=require('../CacheManager.js').cacheManager;var PRODUCT_FIELDS=['Id','Description','BatchQuantity__c','PriceEditable__c','CostEditable__c','PricingMethodEditable__c','PricingMethod__c','NonDiscountable__c','NonPartnerDiscountable__c','CompoundDiscountRate__c','HasConfigurationAttributes__c','ReconfigurationDisabled__c','DescriptionLocked__c','ConfigurationType__c','ConfigurationEvent__c','QuantityEditable__c','QuantityScale__c','AssetAmendmentBehavior__c','Optional__c','Hidden__c','Taxable__c','SubscriptionPricing__c','SubscriptionPercent__c','SubscriptionTerm__c','SubscriptionBase__c','SubscriptionCategory__c','TaxCode__c','SubscriptionTarget__c','ExcludeFromOpportunity__c','SubscriptionType__c','DynamicPricingConstraint__c','BlockPricingField__c','IncludeInMaintenance__c','ExcludeFromMaintenance__c','CostSchedule__c','TermDiscountLevel__c'];var PRICEBOOK_ENTRY_FIELDS=['Id','Pricebook2Id','UnitPrice','IsActive'];var COST_FIELDS=['UnitCost__c','Active__c','Product__c'];var OPTION_FIELDS=['Id','UnitPrice__c'];var DIMENSION_FIELDS=['Id','Type__c','PriceBook__c','UnitPrice__c'];var BLOCKPRICE_FIELDS=['Id','PriceBook2__c','LowerBound__c','UpperBound__c','Price__c'];var CACHE_NAME='ProductCache';var ProductSubqueryDescriptor=function(_BaseSubqueryDescript){_inherits(ProductSubqueryDescriptor,_BaseSubqueryDescript);function ProductSubqueryDescriptor(opts){_classCallCheck(this,ProductSubqueryDescriptor);var _this2=_possibleConstructorReturn(this,(ProductSubqueryDescriptor.__proto__||Object.getPrototypeOf(ProductSubqueryDescriptor)).call(this));_this2._opts=opts;_this2._salesCloudPrefix=_this2._opts.prefix;_this2._includeCosts=false;_this2._includePriceEntries=false;_this2._includeDimensions=false;_this2._includeBlockPrices=false;_this2._filteredPricebooks=null;_this2._filteredCurrencyCodes=null;_this2._includeOptionsByOptionalSKU=false;_this2._mappableOptionFields=null;_this2._initialized=false;return _this2;}_createClass(ProductSubqueryDescriptor,[{key:"includeJSARSubqueries",value:function includeJSARSubqueries(){this.includeJSQCSubqueries();this._includeCosts=true;this._includePriceEntries=true;this._includeDimensions=true;this._includeOptionsByOptionalSKU=true;}},{key:"includeJSQCSubqueries",value:function includeJSQCSubqueries(){this._includeBlockPrices=true;}},{key:"addPricebookFilters",value:function addPricebookFilters(pricebookIds){var existingFilters=this._filteredPricebooks||[];this._filteredPricebooks=existingFilters.concat(pricebookIds);}},{key:"addCurrencyFilters",value:function addCurrencyFilters(currencyCodes){var existingFilters=this._filteredCurrencyCodes||[];this._filteredCurrencyCodes=existingFilters.concat(currencyCodes);}},{key:"init",value:function init(services){var _this3=this;if(this._initialized){return Promise.resolve();}var initPromises=[];var lineType=this._salesCloudPrefix+'QuoteLine__c';if(this._includeOptionsByOptionalSKU){var optionType=this._salesCloudPrefix+'ProductOption__c';initPromises.push(services.fieldMetadataService.getSharedMappableFieldNames(optionType,lineType).then(function(fields){_this3._mappableOptionFields=fields;}));}return Promise.all(initPromises).then(function(){_this3._initialized=true;});}},{key:"_addSubquery",value:function _addSubquery(query,relationship,fields,whereArray,orderByArray){query=query.include(relationship).select(fields.join(', '));if(orderByArray&&orderByArray.length===2){query=query.orderby(orderByArray[0],orderByArray[1]);}if(whereArray&&whereArray.length>0){query=query.where(whereArray.join(' AND '));}query=query.end();}},{key:"addSubqueriesToQuery",value:function addSubqueriesToQuery(query){if(!this._initialized){throw new Error('Cannot call \'addSubqueriesToQuery()\' on an uninitialized ProductSubqueryDescriptor.');}var pricebookString=this._filteredPricebooks&&this._filteredPricebooks.length>0?"'"+this._filteredPricebooks.join("', '")+"'":null;var currencyCodeString=this._filteredCurrencyCodes&&this._filteredCurrencyCodes.length>0?"'"+this._filteredCurrencyCodes.join("', '")+"'":null;if(this._includeCosts){var costFields=DAOHelperMethods.properlyPrefixFields(this._salesCloudPrefix,COST_FIELDS);if(this._opts.isMultiCurrencyOrg){costFields.push('CurrencyIsoCode');}this._addSubquery(query,this._salesCloudPrefix+'Costs__r',costFields);}if(this._includeOptionsByOptionalSKU){var optionFields=DAOHelperMethods.properlyPrefixFields(this._salesCloudPrefix,OPTION_FIELDS);optionFields=optionFields.concat(this._mappableOptionFields||[]);var whereArray=[];if(this._opts.isMultiCurrencyOrg){optionFields.push('CurrencyIsoCode');if(currencyCodeString){whereArray.push("CurrencyIsoCode IN ("+currencyCodeString+")");}}this._addSubquery(query,this._salesCloudPrefix+'OptionalFor__r',optionFields,whereArray);}if(this._includeDimensions){var dimensionFields=DAOHelperMethods.properlyPrefixFields(this._salesCloudPrefix,DIMENSION_FIELDS);if(this._opts.isMultiCurrencyOrg){dimensionFields.push('CurrencyIsoCode');}var _whereArray=[];if(pricebookString){_whereArray.push("("+this._salesCloudPrefix+"PriceBook__c IN ("+pricebookString+") OR "+this._salesCloudPrefix+"PriceBook__c = null)");}if(currencyCodeString&&this._opts.isMultiCurrencyOrg){_whereArray.push("CurrencyIsoCode IN ("+currencyCodeString+")");}this._addSubquery(query,this._salesCloudPrefix+'Dimensions__r',dimensionFields,_whereArray);}if(this._includePriceEntries){var priceEntryFields=DAOHelperMethods.properlyPrefixFields(this._salesCloudPrefix,PRICEBOOK_ENTRY_FIELDS);if(this._opts.isMultiCurrencyOrg){priceEntryFields.push('CurrencyIsoCode');}var _whereArray2=[];if(pricebookString){_whereArray2.push("Pricebook2Id IN ("+pricebookString+")");}if(currencyCodeString&&this._opts.isMultiCurrencyOrg){_whereArray2.push("CurrencyIsoCode IN ("+currencyCodeString+")");}if(!this._opts.allowInactivePrices){_whereArray2.push('IsActive = true');}this._addSubquery(query,'PricebookEntries',priceEntryFields,_whereArray2);}if(this._includeBlockPrices){var blockPriceFields=DAOHelperMethods.properlyPrefixFields(this._salesCloudPrefix,BLOCKPRICE_FIELDS);if(this._opts.isMultiCurrencyOrg){blockPriceFields.push('CurrencyIsoCode');}if(this._opts.overageRateFieldName){blockPriceFields.push(this._opts.overageRateFieldName);}var _whereArray3=[];if(pricebookString){_whereArray3.push("("+this._salesCloudPrefix+"PriceBook2__c IN ("+pricebookString+") OR "+this._salesCloudPrefix+"PriceBook2__c = null)");}if(currencyCodeString&&this._opts.isMultiCurrencyOrg){_whereArray3.push("CurrencyIsoCode IN ("+currencyCodeString+")");}var orderByArray=[this._salesCloudPrefix+'LowerBound__c','ASC'];this._addSubquery(query,this._salesCloudPrefix+'BlockPrices__r',blockPriceFields,_whereArray3,orderByArray);}}},{key:"_getHashKey",value:function _getHashKey(){return"COSTS?"+(this._includeCosts?'YES':'NO')+"_DIMENSIONS?"+(this._includeDimensions?'YES':'NO')+"_PRICEENTRIES?"+(this._includePriceEntries?'YES':'NO')+"_BLOCKPRICES?"+(this._includeBlockPrices?'YES':'NO')+"__PRICEBOOKIDS:"+(this._filteredPricebooks&&this._filteredPricebooks.length>0?JSON.stringify(this._filteredPricebooks):'NONE')+"__CURRENCYCODES:"+(this._filteredCurrencyCodes&&this._filteredCurrencyCodes.length>0?JSON.stringify(this._filteredCurrencyCodes):'NONE');}}]);return ProductSubqueryDescriptor;}(BaseSubqueryDescriptor);var ProductDAO=function(_BaseDAO){_inherits(ProductDAO,_BaseDAO);function ProductDAO(conn,services,opts){_classCallCheck(this,ProductDAO);var _this4=_possibleConstructorReturn(this,(ProductDAO.__proto__||Object.getPrototypeOf(ProductDAO)).call(this,conn,opts.labels));_this4._opts=opts;_this4._prefix=opts.prefix;_this4._services=services;_this4._cache=cacheManager.getCache(CACHE_NAME);_this4._initialized=false;_this4._logger=jsLogger;return _this4;}_createClass(ProductDAO,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"_init",value:function _init(){var _this5=this;if(this._initialized){return Promise.resolve();}else{var lineType=this._prefix+'QuoteLine__c';this._logMessage('ProductDAO.js: Initialization. SessionId='+this._opts.userId);var getSharedMappableFieldNamesStartTime=Date.now();return this._services.fieldMetadataService.getSharedMappableFieldNames('Product2',lineType).then(function(fields){_this5._logMessage('ProductDAO.js: Getting shared mappable fields names took '+(Date.now()-getSharedMappableFieldNamesStartTime)+' ms. SessionId='+_this5._opts.userId);_this5._mappableFields=fields;_this5._initialized=true;});}}},{key:"loadProductsByIds",value:function loadProductsByIds(ids,subqueryInfo){var _this6=this;var uniqueIds=[];new Set(ids).forEach(function(id){uniqueIds.push(id);});this._logMessage('ProductDAO.js: Initialization. SessionId='+this._opts.userId);var loadProductsStartTime=void 0;var initStartTime=Date.now();var initPromises=[];initPromises.push(this._init());if(subqueryInfo){initPromises.push(subqueryInfo.init(this._services));}return Promise.all(initPromises).then(function(){_this6._logMessage('ProductDAO.js: Initialization took '+(Date.now()-initStartTime)+' ms. SessionId='+_this6._opts.userId);_this6._logMessage('ProductDAO.js: Get products by Ids. SessionId='+_this6._opts.userId);loadProductsStartTime=Date.now();return _this6._getProductsByIds(uniqueIds,subqueryInfo);}).then(function(products){_this6._logMessage('ProductDAO.js: Getting products by ids took '+(Date.now()-loadProductsStartTime)+' ms. SessionId='+_this6._opts.userId);return products;}).catch(function(err){var errHeader=_this6._opts.errorHeader;return Promise.reject(errHeader+(err.message||err));});}},{key:"_getProductsByIds",value:function _getProductsByIds(ids,subqueryInfo){var outerCacheKeySubqueryPortion=subqueryInfo?subqueryInfo._getHashKey():'default';var outerCacheKeyExtraFieldsPortion=JSON.stringify(this._opts.extraFields||[]);var outerCacheKey=outerCacheKeySubqueryPortion+'____'+outerCacheKeyExtraFieldsPortion;var productsRequiringQuery=[];var cachedResultsForSubquery=this._cache.get(outerCacheKey);if(!cachedResultsForSubquery){this._cache.set(outerCacheKey,new IdToValueCache());productsRequiringQuery=ids;}else{productsRequiringQuery=ids.filter(function(id){return!cachedResultsForSubquery.has(id);});}if(productsRequiringQuery.length>0){return this._queryAndCacheProducts(productsRequiringQuery,subqueryInfo,outerCacheKey);}else{return Promise.resolve(cachedResultsForSubquery);}}},{key:"_queryAndCacheProducts",value:function _queryAndCacheProducts(productIds,subqueryDescriptor,cacheKey){var _this7=this;var productFields=DAOHelperMethods.properlyPrefixFields(this._prefix,PRODUCT_FIELDS);if(this._opts.isMultiCurrencyOrg){productFields.push('CurrencyIsoCode');}productFields=productFields.concat(this._opts.extraFields||[]);productFields=productFields.concat(this._mappableFields);var whereClause="Id IN ('"+productIds.join("', '")+"')";return this._constructAndPerformQuery('Product2',productFields,whereClause,subqueryDescriptor).then(function(products){var precachedResults=_this7._cache.get(cacheKey);products.forEach(function(product){precachedResults.set(product.Id,product);});return precachedResults;});}}],[{key:"constructOptsFromJsarSettings",value:function constructOptsFromJsarSettings(jsarSettings){return{prefix:jsarSettings.salesCloudPrefix,userId:jsarSettings.userId,isMultiCurrencyOrg:jsarSettings.isMultiCurrencyOrg,errorHeader:jsarSettings.labels.msg_amendrenew_err_loading_products,labels:jsarSettings.labels,allowInactivePrices:jsarSettings.calcSettings.allowInactivePrices,overageRateFieldName:jsarSettings.calcSettings.overageRateFieldName,extraFields:jsarSettings.calcSettings.referencedFieldMap['Product2']||[]};}},{key:"constructOptsFromJsqcSettings",value:function constructOptsFromJsqcSettings(jsqcSettings){return{prefix:jsqcSettings.devPrefix,userId:jsqcSettings.userId,isMultiCurrencyOrg:jsqcSettings.isMultiCurrencyOrg,errorHeader:jsqcSettings.getLabelByKey('msg_amendrenew_err_loading_products'),allowInactivePrices:jsqcSettings.allowInactivePrices,overageRateFieldName:jsqcSettings.overageRateFieldName,extraFields:jsqcSettings.referencedFieldMap['Product2']||[],labels:jsqcSettings.jsqcLabels};}}]);return ProductDAO;}(BaseDAO);module.exports.DAO=ProductDAO;module.exports.SubqueryDescriptor=ProductSubqueryDescriptor;},{"../CacheManager.js":1,"../IdToValueCache.js":7,"./BaseDAO.js":2,"./DAOHelperMethods.js":3,"js-logger":58}],5:[function(require,module,exports){var parse=require("node-sqlparser").parse;var stringify=require("node-sqlparser").stringify;var WhereClauseSplitter=function(){function WhereClauseSplitter(){_classCallCheck(this,WhereClauseSplitter);this._overallSpecificityPreserved=true;this._nextNodeKey=0;this._semiJoinRegex=/\s+IN\s+\(\s*SELECT\s+.*?FROM/ig;this._semiJoinMap=new Map();this._semiJoinCounter=0;this._semiJoinReplacementFormat="'____SEMI-JOIN_%____'";this._unescapedDateRegex=/\d{4}-\d{2}-\d{2}(?:(?:T\d{2}:\d{2}:\d{2})(?:Z|[\+\-]\d{2}:\d{2}))?/gi;this._unescapedDateMap=new Map();this._unescapedDateCounter=0;this._unescapedDateReplacementFormat="'____UNESCAPED_DATE_%____'";this._nestedLookupRegex=/\w+\.\w+\.\w+(?:\.\w+)*/gi;this._nestedLookupMap=new Map();this._nestedLookupCounter=0;this._nestedLookupReplacementFormat="'____NESTED_LOOKUP_%____'";}_createClass(WhereClauseSplitter,[{key:"_resetModificationInformation",value:function _resetModificationInformation(){this._overallSpecificityPreserved=true;this._nextNodeKey=0;this._semiJoinMap=new Map();this._semiJoinCounter=0;this._unescapedDateMap=new Map();this._unescapedDateCounter=0;this._nestedLookupMap=new Map();this._nestedLookupCounter=0;}},{key:"splitWhereClause",value:function splitWhereClause(whereClause,maxLength){var _this8=this;var results={clauses:[],specificityPreserved:true};var whereLength=whereClause.length;if(whereLength<=maxLength){results.clauses.push(whereClause);return results;}var treatedWhereClause=this._makeWhereClauseParsable(whereClause);var fakeQueryString='SELECT * FROM SomeTable WHERE '+treatedWhereClause;var fullAst=void 0;try{fullAst=parse(fakeQueryString);}catch(e){throw Error('Failed to parse WHERE clause: '+(e.message||e));}var whereAst=fullAst.where;this._recursivelySetLengthOnAstNodes(whereAst);var preserveOverallSpecificity=true;this._recursivelySetMinLengthOnAstNodes(whereAst,preserveOverallSpecificity);if(whereAst.minLength>maxLength){preserveOverallSpecificity=false;this._recursivelySetMinLengthOnAstNodes(whereAst,preserveOverallSpecificity);if(whereAst.minLength>maxLength){throw Error('WHERE clause cannot be shrunk below maximum acceptable length of '+maxLength+'. WHERE CLAUSE: '+whereClause);}}var splitWhereAsts=this._recursivelySplitUntilTargetSizeReached(whereAst,maxLength,preserveOverallSpecificity);var splitWhereClauses=[];var splitKeyLists=[];var splitKeyMaxDepthMap=new Map();splitWhereAsts.forEach(function(splitWhereAst){fullAst.where=splitWhereAst;var splitWhereClause=stringify(fullAst).slice(30);splitWhereClauses.push(_this8._restoreUnparsableCharacters(splitWhereClause));if(!_this8._overallSpecificityPreserved){splitKeyLists.push(splitWhereAst.splitNodeKeys);splitWhereAst.splitNodeKeys.forEach(function(nodeKey,index){if(!splitKeyMaxDepthMap.has(nodeKey)||splitKeyMaxDepthMap.get(nodeKey)<index){splitKeyMaxDepthMap.set(nodeKey,index);}});}});var splitKeysMappedByMaxDepth=new Map();if(!this._overallSpecificityPreserved){splitKeyMaxDepthMap.forEach(function(value,key){if(!splitKeysMappedByMaxDepth.has(value)){splitKeysMappedByMaxDepth.set(value,new Set());}splitKeysMappedByMaxDepth.get(value).add(key);});}results.clauses=splitWhereClauses;results.specificityPreserved=this._overallSpecificityPreserved;results.splitKeyLists=splitKeyLists;results.splitKeysMappedByMaxDepth=splitKeysMappedByMaxDepth;return results;}},{key:"_makeWhereClauseParsable",value:function _makeWhereClauseParsable(whereClause){this._resetModificationInformation();return this._storeAndReplaceNestedLookups(this._storeAndReplaceUnescapedDates(this._storeAndReplaceSemiJoins(whereClause)));}},{key:"_restoreUnparsableCharacters",value:function _restoreUnparsableCharacters(whereClause){var modifiedWhereClause=whereClause;var mapList=[this._unescapedDateMap,this._nestedLookupMap,this._semiJoinMap];var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=mapList[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var map=_step.value;var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=map[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var _step2$value=_slicedToArray(_step2.value,2),replacementString=_step2$value[0],original=_step2$value[1];var replacementFindingRegex=new RegExp(replacementString,'g');modifiedWhereClause=modifiedWhereClause.replace(replacementFindingRegex,original);}}catch(err){_didIteratorError2=true;_iteratorError2=err;}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return();}}finally{if(_didIteratorError2){throw _iteratorError2;}}}}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}return modifiedWhereClause;}},{key:"_storeAndReplaceSemiJoins",value:function _storeAndReplaceSemiJoins(whereClause){var matchesByIndex=new Map();var match=void 0;while((match=this._semiJoinRegex.exec(whereClause))!==null){matchesByIndex.set(match.index,match);}if(matchesByIndex.size===0){return whereClause;}var semiJoinLengthsByStartIndex=new Map();var whereClauseIterator=whereClause[Symbol.iterator]();var idx=0;var iter=void 0;var stringDelimiterArray=[];var parenBalance=void 0;var capturingSemiJoin=false;var semiJoinLength=void 0;var semiJoinStartIndex=void 0;var matchesProcessed=0;while(!(iter=whereClauseIterator.next()).done){if(matchesByIndex.has(idx)){if(!capturingSemiJoin&&stringDelimiterArray.length===0){capturingSemiJoin=true;parenBalance=0;}matchesProcessed++;}else if(stringDelimiterArray.length>0&&iter.value===stringDelimiterArray[0]){stringDelimiterArray.shift();}else if(iter.value==='"'||iter.value==="'"){stringDelimiterArray.unshift(iter.value);}else if(stringDelimiterArray.length===0&&capturingSemiJoin){if(iter.value==='('){if(parenBalance++===0){semiJoinStartIndex=idx+1;semiJoinLength=-1;}}else if(iter.value===')'){if(--parenBalance===0){semiJoinLengthsByStartIndex.set(semiJoinStartIndex,semiJoinLength);capturingSemiJoin=false;if(matchesProcessed===matchesByIndex.size){break;}}}}if(capturingSemiJoin&&parenBalance>0){semiJoinLength++;}idx++;}if(semiJoinLengthsByStartIndex.size===0){return whereClause;}var modifiedWhereClause='';var sliceStartPoint=0;var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=semiJoinLengthsByStartIndex.entries()[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var _step3$value=_slicedToArray(_step3.value,2),_idx=_step3$value[0],len=_step3$value[1];modifiedWhereClause+=whereClause.slice(sliceStartPoint,_idx);var semiJoin=whereClause.slice(_idx,_idx+len);var semiJoinReplacement=this._semiJoinReplacementFormat.replace('%',++this._semiJoinCounter);modifiedWhereClause+=semiJoinReplacement;this._semiJoinMap.set(semiJoinReplacement,semiJoin);sliceStartPoint=_idx+len;}}catch(err){_didIteratorError3=true;_iteratorError3=err;}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return();}}finally{if(_didIteratorError3){throw _iteratorError3;}}}modifiedWhereClause+=whereClause.slice(sliceStartPoint);return modifiedWhereClause;}},{key:"_storeAndReplaceUnescapedDates",value:function _storeAndReplaceUnescapedDates(whereClause){return this._storeAndReplaceUnparsableSubstrings(whereClause,this._unescapedDateRegex,this._unescapedDateReplacementFormat,this._unescapedDateMap,this._unescapedDateCounter);}},{key:"_storeAndReplaceNestedLookups",value:function _storeAndReplaceNestedLookups(whereClause){return this._storeAndReplaceUnparsableSubstrings(whereClause,this._nestedLookupRegex,this._nestedLookupReplacementFormat,this._nestedLookupMap,this._nestedLookupCounter);}},{key:"_storeAndReplaceUnparsableSubstrings",value:function _storeAndReplaceUnparsableSubstrings(whereClause,regex,replacementFormat,storedValueMap,storedValueCounter){var matchesByIndex=new Map();var match=void 0;while((match=regex.exec(whereClause))!==null){matchesByIndex.set(match.index,match);}if(matchesByIndex.size===0){return whereClause;}var whereIterator=whereClause[Symbol.iterator]();var idx=0;var stringDelimiterArray=[];var sliceStartPoint=0;var modifiedWhereClause="";var iter=void 0;var matchCounter=0;while(!(iter=whereIterator.next()).done){if(matchesByIndex.has(idx)){if(stringDelimiterArray.length===0){var _match=matchesByIndex.get(idx);var unparsableValue=_match[0];var replacementValue=replacementFormat.replace('%',++storedValueCounter);storedValueMap.set(replacementValue,unparsableValue);modifiedWhereClause+=whereClause.slice(sliceStartPoint,idx)+replacementValue;sliceStartPoint=idx+unparsableValue.length;}if(++matchCounter===matchesByIndex.size){break;}}else if(stringDelimiterArray.length>0&&iter.value===stringDelimiterArray[0]){stringDelimiterArray.shift();}else if(iter.value==='"'||iter.value==="'"){stringDelimiterArray.unshift(iter.value);}idx++;}modifiedWhereClause+=whereClause.slice(sliceStartPoint);return modifiedWhereClause;}},{key:"_recursivelySetLengthOnAstNodes",value:function _recursivelySetLengthOnAstNodes(ast){var _this9=this;var length=0;ast.nodeKey=this._nextNodeKey++;ast.splitNodeKeys=[];switch(ast.type){case"binary_expr":var leftLength=this._recursivelySetLengthOnAstNodes(ast.left);var rightLength=this._recursivelySetLengthOnAstNodes(ast.right);var operatorLength=ast.operator.length;length=leftLength+rightLength+operatorLength+2;break;case"expr_list":length=-2;ast.value.forEach(function(valueNode){_this9._recursivelySetLengthOnAstNodes(valueNode);length+=valueNode.length+2;});length+=2;break;case"column_ref":length=ast.column.length;if(ast.table.length>0){length+=ast.table.length+1;}break;case"string":var prospectiveReplacementKey="'"+ast.value+"'";if(this._semiJoinMap.has(prospectiveReplacementKey)){length=this._semiJoinMap.get(prospectiveReplacementKey).length;}else if(this._unescapedDateMap.has(prospectiveReplacementKey)){length=this._unescapedDateMap.get(prospectiveReplacementKey).length;}else if(this._nestedLookupMap.has(prospectiveReplacementKey)){length=this._nestedLookupMap.get(prospectiveReplacementKey).length;}else{length=ast.value.length+2;}break;case"number":length=ast.value.toString().length;break;case"bool":length=ast.value?4:5;break;case"null":length=4;break;default:throw Error('Unexpected node type '+ast.type);}if(ast.paren===true){length+=2;}ast.length=length;return length;}},{key:"_recursivelySetMinLengthOnAstNodes",value:function _recursivelySetMinLengthOnAstNodes(ast,preserveOverallSpecificity){var _this10=this;var effectiveMinimumSize=void 0;switch(ast.type){case'expr_list':var lengths=ast.value.map(function(subAst){return _this10._recursivelySetMinLengthOnAstNodes(subAst,preserveOverallSpecificity)+2;});effectiveMinimumSize=Math.max.apply(this,lengths);break;case'binary_expr':var performDefaultSplit=true;switch(ast.operator){case'AND':if(preserveOverallSpecificity){break;}case'OR':var minLeftOrLength=this._recursivelySetMinLengthOnAstNodes(ast.left,preserveOverallSpecificity);var minRightOrLength=this._recursivelySetMinLengthOnAstNodes(ast.right,preserveOverallSpecificity);var largerMin=Math.max(minLeftOrLength,minRightOrLength);if(ast.paren){largerMin+=2;}effectiveMinimumSize=largerMin;performDefaultSplit=false;break;}if(!performDefaultSplit){break;}var inherentLength=ast.length-(ast.left.length+ast.right.length);var minLeftLength=this._recursivelySetMinLengthOnAstNodes(ast.left,preserveOverallSpecificity);var minRightLength=this._recursivelySetMinLengthOnAstNodes(ast.right,preserveOverallSpecificity);effectiveMinimumSize=inherentLength+minLeftLength+minRightLength;break;default:effectiveMinimumSize=ast.length;}ast.minLength=effectiveMinimumSize;return effectiveMinimumSize;}},{key:"_recursivelySplitUntilTargetSizeReached",value:function _recursivelySplitUntilTargetSizeReached(ast,targetSize,preserveOverallSpecificity){if(ast.length<=targetSize){return[ast];}switch(ast.type){case'expr_list':var partialLists=[[]];var currentPartialListSize=-2;var currentPartialListIndex=0;ast.value.forEach(function(valueNode){if(valueNode.length+2+currentPartialListSize>targetSize){partialLists.push([valueNode]);currentPartialListIndex++;currentPartialListSize=valueNode.length;}else{partialLists[currentPartialListIndex].push(valueNode);currentPartialListSize+=valueNode.length+2;}});var splitListExpressions=[];for(var i=0;i<partialLists.length;i++){var copiedListExpression=JSON.parse(JSON.stringify(ast));copiedListExpression.value=partialLists[i];splitListExpressions.push(copiedListExpression);}return splitListExpressions;case'binary_expr':switch(ast.operator){case'AND':if(preserveOverallSpecificity){var leftTargetLength=void 0;var rightTargetLength=void 0;var splitLeftAsts=void 0;var splitRightAsts=void 0;var leftSideSplitSufficient=targetSize>ast.length-ast.left.length+ast.left.minLength;var rightSideSplitSufficient=targetSize>ast.length-ast.right.length+ast.right.minLength;if(leftSideSplitSufficient){leftTargetLength=targetSize-(ast.length-ast.left.length);splitLeftAsts=this._recursivelySplitUntilTargetSizeReached(ast.left,leftTargetLength,preserveOverallSpecificity);splitRightAsts=[ast.right];}else if(rightSideSplitSufficient){rightTargetLength=targetSize-(ast.length-ast.right.length);splitLeftAsts=[ast.left];splitRightAsts=this._recursivelySplitUntilTargetSizeReached(ast.right,rightTargetLength,preserveOverallSpecificity);}else{var fullLeftSplit=ast.left.minLength<targetSize/2;leftTargetLength=fullLeftSplit?ast.left.minLength:Math.max(ast.left.minLength,targetSize/2);rightTargetLength=fullLeftSplit?Math.max(ast.right.minLength,targetSize/2):ast.right.minLength;splitLeftAsts=this._recursivelySplitUntilTargetSizeReached(ast.left,leftTargetLength,preserveOverallSpecificity);splitRightAsts=this._recursivelySplitUntilTargetSizeReached(ast.right,rightTargetLength,preserveOverallSpecificity);}var combinedAnds=[];splitLeftAsts.forEach(function(left){splitRightAsts.forEach(function(right){var copiedAnd=JSON.parse(JSON.stringify(ast));copiedAnd.left=left;copiedAnd.right=right;combinedAnds.push(copiedAnd);});});return combinedAnds;}this._overallSpecificityPreserved=false;case'OR':var targetOrSize=ast.paren?targetSize-2:targetSize;var splitLeftSide=this._recursivelySplitUntilTargetSizeReached(ast.left,targetOrSize,preserveOverallSpecificity);var splitRightSide=this._recursivelySplitUntilTargetSizeReached(ast.right,targetOrSize,preserveOverallSpecificity);var splitOrs=[].concat(_toConsumableArray(splitLeftSide),_toConsumableArray(splitRightSide));if(ast.paren){splitOrs.forEach(function(or){or.paren=true;});}if(!preserveOverallSpecificity){splitOrs.forEach(function(subTree){subTree.splitNodeKeys.push(ast.operator+'_'+ast.nodeKey);});}return splitOrs;case'IN':var inherentInLength=ast.length-ast.right.length;var splitLists=this._recursivelySplitUntilTargetSizeReached(ast.right,targetSize-inherentInLength,preserveOverallSpecificity);var splitIns=[];var splitNodeKey=preserveOverallSpecificity?undefined:ast.operator+'_'+ast.nodeKey;ast.splitNodeKeys.push(splitNodeKey);splitLists.forEach(function(list){var copiedIn=JSON.parse(JSON.stringify(ast));copiedIn.right=list;splitIns.push(copiedIn);});return splitIns;}default:return[ast];}}}]);return WhereClauseSplitter;}();module.exports=WhereClauseSplitter;},{"node-sqlparser":68}],6:[function(require,module,exports){module.exports.toApexDate=toApexDate;module.exports.toApexDateTime=toApexDateTime;module.exports.toUTCDateString=toUTCDateString;module.exports.monthsBetween=monthsBetween;module.exports.monthsBetweenRoundPartialUp=monthsBetweenRoundPartialUp;module.exports.daysBetween=daysBetween;module.exports.daysBetweenIgnoringLeapYearDays=daysBetweenIgnoringLeapYearDays;module.exports.distinguishDateFromDateTime=distinguishDateFromDateTime;module.exports.addMonths=addMonths;module.exports.addDays=addDays;module.exports.numberOfMonthsInFixedMdqDimension=numberOfMonthsInFixedMdqDimension;module.exports.countDaysInMonth=countDaysInMonth;module.exports.isEndOfMonth=isEndOfMonth;module.exports.moveToEndOfMonth=moveToEndOfMonth;module.exports.containsLeapDay=containsLeapDay;function toApexDate(date){var dateIso=date.toISOString();return dateIso.replace(new RegExp('[Tt].*'),"");}function toApexDateTime(dateTime){var dateIso=dateTime.toISOString();return dateIso.slice(0,dateIso.length-1)+"+0000";}function toUTCDateString(date){var timezone=date.getTimezoneOffset();return new Date(date.setMinutes(date.getMinutes()+parseInt(timezone))).toLocaleDateString();}function distinguishDateFromDateTime(dateString){var dateRegex=new RegExp('\\d{4}-\\d{2}-\\d{2}');var dateTimeRegex=new RegExp('\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}.\\d{3}(Z|(\\+\\d{4}))');if(dateRegex.test(dateString)&&dateString.length==10){return'date';}else if(dateTimeRegex.test(dateString)&&(dateString.length==24||dateString.length==28)){return'datetime';}return'none';}function monthsBetween(startDate,endDate){if(startDate>endDate){return-1*monthsBetween(endDate,startDate);}var result=0;result+=(endDate.getUTCFullYear()-startDate.getUTCFullYear())*12;result+=endDate.getUTCMonth()-startDate.getUTCMonth();return result;}function monthsBetweenRoundPartialUp(startDate,endDate){if(startDate>endDate){return-1*monthsBetweenRoundPartialUp(endDate,startDate);}var result=monthsBetween(startDate,endDate);var date=new Date(startDate.getTime());addMonths(date,result);if(date<endDate){result+=1;}return result;}function daysBetween(startDate,endDate){if(startDate>endDate){return-1*daysBetween(endDate,startDate);}var msDiff=endDate.getTime()-startDate.getTime();var dayInUnix=86400000;return Math.round(msDiff/dayInUnix);}function addMonths(startDate,numMonths){var currentMonth=startDate.getUTCMonth();startDate.setUTCMonth(startDate.getUTCMonth()+numMonths);var trueMonth=currentMonth+numMonths;trueMonth=trueMonth<0?trueMonth+12:trueMonth;if(startDate.getUTCMonth()!==trueMonth%12){startDate.setUTCDate(0);}return startDate;}function addDays(startDate,numDays){startDate.setUTCDate(startDate.getUTCDate()+numDays);return startDate;}function daysBetweenIgnoringLeapYearDays(startDate,endDate){var numLeapDays=getNumberOfLeapDays(startDate,endDate);return daysBetween(startDate,endDate)-numLeapDays;}function getNumberOfLeapDays(startDate,endDate){var numLeapDays=0;var startYear=startDate.getUTCFullYear();var endYear=endDate.getUTCFullYear();for(var i=startYear;i<=endYear;i++){if(!isLeapYear(i)){continue;}var leapDay=new Date(i,1,29);if(startDate<leapDay&&endDate>leapDay){numLeapDays++;}}return numLeapDays;}function containsLeapDay(startDate,endDate){return getNumberOfLeapDays(startDate,endDate)>0;}function isLeapYear(year){return year%100===0?year%400===0:year%4===0;}function numberOfMonthsInFixedMdqDimension(dimType){if(!dimType){return null;}switch(dimType.toLowerCase()){case'year':return 12;case'quarter':return 3;case'month':return 1;default:return null;}}function countDaysInMonth(month,year){return new Date(year,month+1,0).getDate();}function isEndOfMonth(date){var day=date.getUTCDate();var month=date.getUTCMonth();var year=date.getUTCFullYear();return day===countDaysInMonth(month,year);}function moveToEndOfMonth(date){var month=date.getUTCMonth();var year=date.getUTCFullYear();date.setUTCDate(countDaysInMonth(month,year));return date;}},{}],7:[function(require,module,exports){'use strict';var IdToValueCache=function(){function IdToValueCache(){_classCallCheck(this,IdToValueCache);for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}this._innerMap=new Map(args);}_createClass(IdToValueCache,[{key:"has",value:function has(key){return this._innerMap.has(key!=null?key.slice(0,15):key);}},{key:"get",value:function get(key){return this._innerMap.get(key!=null?key.slice(0,15):key);}},{key:"set",value:function set(key,val){return this._innerMap.set(key!=null?key.slice(0,15):key,val);}},{key:"forEach",value:function forEach(callback){return this._innerMap.forEach(callback);}},{key:"entries",value:function entries(){return this._innerMap.entries();}},{key:"values",value:function values(){return this._innerMap.values();}},{key:"clear",value:function clear(){return this._innerMap.clear();}},{key:"delete",value:function _delete(key){return this._innerMap.delete(key!=null?key.slice(0,15):key);}},{key:"keys",value:function keys(){return this._innerMap.keys();}},{key:Symbol.iterator,value:function value(){return this._innerMap.entries();}},{key:"size",get:function get(){return this._innerMap.size;}}]);return IdToValueCache;}();module.exports=IdToValueCache;},{}],8:[function(require,module,exports){'use strict';var globalCache=new Map();var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var FieldMetadataService=function(){function FieldMetadataService(conn,fmsSettings){_classCallCheck(this,FieldMetadataService);this._conn=conn;this._salesCloudPrefix=fmsSettings.salesCloudPrefix?fmsSettings.salesCloudPrefix.toLowerCase():"";this._serviceCloudPrefix=fmsSettings.serviceCloudPrefix?fmsSettings.serviceCloudPrefix.toLowerCase():'';this._userId=fmsSettings.userId;this._labels=fmsSettings.labels;var inBrowser=typeof window!=='undefined';this._cache=inBrowser?globalCache:new Map();this._logger=jsLogger;}_createClass(FieldMetadataService,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"getSharedMappableFieldNames",value:function getSharedMappableFieldNames(srcType,destType){var _this11=this;var cacheKey=srcType+':'+destType;if(this._cache.has(cacheKey)){return Promise.resolve(this._cache.get(cacheKey));}var srcPromise=this.getMappableFields(srcType);var destPromise=this.getMappableFields(destType);this._logMessage('FieldMetadataService.js: Get mappable fields. SessionId='+this._userId);var getMappableFields=Date.now();return Promise.all([srcPromise,destPromise]).then(function(arrs){_this11._logMessage('FieldMetadataService.js: Getting mappable fields took '+(Date.now()-getMappableFields)+' ms. SessionId='+_this11._userId);var sharedFields=[];var srcFields=arrs[0].fieldArray;var destFields=arrs[1].fieldMap;var srcFieldCount=srcFields.length;for(var i=0;i<srcFieldCount;i++){var srcField=srcFields[i];var destField=destFields.get(srcField.name);if(destField&&_this11._fieldsAreCompatible(srcField,destField)){sharedFields.push(destField.name);}}_this11._cache.set(cacheKey,sharedFields);return sharedFields;},function(reason){throw new Error(reason);});}},{key:"getMappableFields",value:function getMappableFields(objType){var _this12=this;if(this._cache.has('mappableFields')&&this._cache.get('mappableFields')[objType]){return Promise.resolve(this._cache.get('mappableFields')[objType]);}else{if(!this._cache.has('mappableFields')){this._cache.set('mappableFields',{});}}return this._getObjectDescribe(objType).then(function(objDescribe){var mappableFieldSummary=_this12._sweepDescribeForMappableFields(objDescribe);_this12._cache.get('mappableFields')[objType]=mappableFieldSummary;return mappableFieldSummary;},function(err){var header=_this12._labels.msg_could_not_retrieve_mappable_fields.replace('{0}',objType);return Promise.reject(header+(err.message||err));});}},{key:"checkExistenceOfFields",value:function checkExistenceOfFields(objType,fieldArray){var _this13=this;var cachedApiNamesByGenericName={};if(this._cache.has('fieldExistence')&&this._cache.get('fieldExistence')[objType]){cachedApiNamesByGenericName=this._cache.get('fieldExistence')[objType];}else if(!this._cache.has('fieldExistence')){this._cache.set('fieldExistence',{});}var existentFieldsMap={};var unknownFields=[];fieldArray.forEach(function(field){if(cachedApiNamesByGenericName[field]){existentFieldsMap[field]=cachedApiNamesByGenericName[field];}else if(cachedApiNamesByGenericName[field]===undefined){unknownFields.push(field);}});if(unknownFields.length===0){return Promise.resolve(existentFieldsMap);}else{return this._getObjectDescribe(objType).then(function(objDesc){var fieldCount=objDesc.fields.length;var _loop2=function _loop2(i){var fieldDesc=objDesc.fields[i];var indexOfMatchingUnknownField=unknownFields.findIndex(function(f){return fieldDesc.name.endsWith(f);});if(indexOfMatchingUnknownField!==-1){var matchingUnknownField=unknownFields[indexOfMatchingUnknownField];cachedApiNamesByGenericName[matchingUnknownField]=fieldDesc.name;existentFieldsMap[matchingUnknownField]=fieldDesc.name;unknownFields=unknownFields.filter(function(el,index){return index!==indexOfMatchingUnknownField;});}};for(var i=0;i<fieldCount;i++){_loop2(i);}unknownFields.forEach(function(nonexistentField){cachedApiNamesByGenericName[nonexistentField]=false;});_this13._cache.get('fieldExistence')[objType]=cachedApiNamesByGenericName;return existentFieldsMap;});}}},{key:"getFieldDescribe",value:function getFieldDescribe(objType,fieldName){var _this14=this;if(this._cache.has('fieldDescribe')&&this._cache.get('fieldDescribe')[objType+fieldName]){return Promise.resolve(this._cache.get('fieldDescribe')[objType+fieldName]);}else if(!this._cache.has('fieldDescribe')){this._cache.set('fieldDescribe',{});}return this._getObjectDescribe(objType).then(function(objDescribe){var fieldDescribe=objDescribe.fields.find(function(field){return field.name===fieldName;});if(fieldDescribe){_this14._cache.get('fieldDescribe')[objType+fieldName]=fieldDescribe;return fieldDescribe;}else{var noSuchFieldMessage=_this14._labels.msg_no_such_field.replace('{0}',fieldName).replace('{1}',objType);return Promise.reject(noSuchFieldMessage);}},function(err){var msgHeader=_this14._labels.msg_could_not_retrieve_field_describe.replace('{0}',objType).replace('{1}',fieldName);return Promise.reject(msgHeader+(err.message||err));});}},{key:"isObjectUpdateable",value:function isObjectUpdateable(objType){var _this15=this;if(!this._cache.has('objectPermissions')){this._cache.set('objectPermissions',{});}if(!this._cache.get('objectPermissions')[objType]){this._cache.get('objectPermissions')[objType]={};}else if(this._cache.get('objectPermissions')[objType].updateable!='undefined'){return Promise.resolve(this._cache.get('objectPermissions')[objType].updateable);}return this._getObjectDescribe(objType).then(function(objDescribe){_this15._cache.get('objectPermissions')[objType].updateable=objDescribe.updateable;return objDescribe.updateable;},function(err){var msgHeader=_this15._labels.msg_could_not_retrieve_crud.replace('{0}',objType);return Promise.reject(msgHeader+(err.message||err));});}},{key:"_getObjectDescribe",value:function _getObjectDescribe(objType){var _this16=this;if(this._cache.has(objType)){return Promise.resolve(this._cache.get(objType));}else{var jsForceStartTime=Date.now();this._logMessage('FieldMetadataService.js: JSForce call for object describe on '+objType+'. SessionId='+this._userId);return this._conn.sobject(objType).describe().then(function(res){_this16._logMessage('FieldMetadataService.js: JSForce call for object describe on '+objType+' took '+(Date.now()-jsForceStartTime)+' ms. SessionId='+_this16._userId);_this16._cache.set(objType,res);return res;});}}},{key:"_sweepDescribeForMappableFields",value:function _sweepDescribeForMappableFields(sobjectData){var fields=sobjectData.fields;var mfArray=[];var mfMap=new Map();var fieldCount=fields.length;for(var i=0;i<fieldCount;i++){var field=fields[i];if(this._isFieldMappable(field)){mfArray.push(field);mfMap.set(field.name,field);}}return{'fieldArray':mfArray,'fieldMap':mfMap};}},{key:"_isFieldMappable",value:function _isFieldMappable(field){if(!field.custom){return false;}var lcName=field.name.toLowerCase();if(this._salesCloudPrefix!==''&&lcName.startsWith(this._salesCloudPrefix)){return lcName.startsWith(this._salesCloudPrefix+'sbcustom');}else if(this._serviceCloudPrefix!==''&&lcName.startsWith(this._serviceCloudPrefix)){return lcName.startsWith(this._serviceCloudPrefix+'sbcustom');}else if(this._salesCloudPrefix===''&&this._serviceCloudPrefix===''){return lcName.startsWith('sbcustom');}else{return true;}}},{key:"_fieldsAreCompatible",value:function _fieldsAreCompatible(srcField,destField){if(!destField.updateable){return false;}if(srcField.type!==destField.type){return false;}if(srcField.type.toLowerCase()==='reference'){return srcField.referenceTo[0]===destField.referenceTo[0];}return true;}}]);return FieldMetadataService;}();module.exports=FieldMetadataService;},{"js-logger":58}],9:[function(require,module,exports){var FieldMetadataService=require('./FieldMetadataService.js');var ServicesManager=function(){function ServicesManager(conn,fmsSettings){_classCallCheck(this,ServicesManager);this.fieldMetadataService=new FieldMetadataService(conn,fmsSettings);}_createClass(ServicesManager,null,[{key:"constructFromJsarSettings",value:function constructFromJsarSettings(conn,jsarSettings){var fmsSettings={salesCloudPrefix:jsarSettings.salesCloudPrefix,serviceCloudPrefix:jsarSettings.serviceCloudPrefix,userId:jsarSettings.userId,labels:jsarSettings.labels};return new ServicesManager(conn,fmsSettings);}},{key:"constructFromJsqcSettings",value:function constructFromJsqcSettings(conn,jsqcSettings){var fmsSettings={salesCloudPrefix:jsqcSettings.scSettings.salesCloudPrefix,serviceCloudPrefix:jsqcSettings.scSettings.serviceCloudPrefix,userId:jsqcSettings.userId,labels:jsqcSettings.jsqcLabels};return new ServicesManager(conn,fmsSettings);}}]);return ServicesManager;}();module.exports=ServicesManager;},{"./FieldMetadataService.js":8}],10:[function(require,module,exports){'use strict';var AccountModel=require('../models/AccountModel.js');var IdToValueCache=require('../../Utils/IdToValueCache.js');var BaseDAO=require('../../Utils/DAOs/BaseDAO.js').BaseDAO;var cacheManager=require('../../Utils/CacheManager.js').cacheManager;var CACHE_NAME='AccountCache';var AccountDAO=function(_BaseDAO2){_inherits(AccountDAO,_BaseDAO2);function AccountDAO(conn,settings){_classCallCheck(this,AccountDAO);var _this17=_possibleConstructorReturn(this,(AccountDAO.__proto__||Object.getPrototypeOf(AccountDAO)).call(this,conn,settings.labels));_this17._settings=settings;_this17._prefix=settings.salesCloudPrefix;_this17._cache=cacheManager.getCache(CACHE_NAME,IdToValueCache);return _this17;}_createClass(AccountDAO,[{key:"getAccountsByIds",value:function getAccountsByIds(accIds){var _this18=this;var idsWithoutCachedRecord=accIds.filter(function(id){return!_this18._cache.has(id);});var queryPromise=idsWithoutCachedRecord.length?this._queryAndCacheAccounts(accIds):Promise.resolve();return queryPromise.then(function(){var accountsById=new IdToValueCache();accIds.forEach(function(id){if(_this18._cache.has(id)){accountsById.set(id,_this18._cache.get(id));}});return accountsById;}).catch(function(err){var errPrefix=_this18._settings.labels.msg_amendrenew_err_loading_accs;return Promise.reject(errPrefix+(err.message||err));});}},{key:"_queryAndCacheAccounts",value:function _queryAndCacheAccounts(accIds){var _this19=this;var accFields=Array.from(new Set(AccountModel.getFields(this._prefix)));var whereClause="Id IN ('"+accIds.join("', '")+"')";return this._constructAndPerformQuery('Account',accFields,whereClause).then(function(accounts){accounts.forEach(function(acc){_this19._cache.set(acc.Id,acc);});});}}]);return AccountDAO;}(BaseDAO);module.exports=AccountDAO;},{"../../Utils/CacheManager.js":1,"../../Utils/DAOs/BaseDAO.js":2,"../../Utils/IdToValueCache.js":7,"../models/AccountModel.js":39}],11:[function(require,module,exports){'use strict';var ContractModel=require('../models/ContractModel.js');var AccountModel=require('../models/AccountModel.js');var IdToValueCache=require('../../Utils/IdToValueCache.js');var QuoteModel=require('../models/QuoteModel.js');var DataChangeTrackerInvoker=require('../cleaners/DataChangeTrackerInvoker.js');var BaseDAO=require('../../Utils/DAOs/BaseDAO.js').BaseDAO;var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var cacheManager=require('../../Utils/CacheManager.js').cacheManager;var CACHE_NAME='ContractCache';var ContractDAO=function(_BaseDAO3){_inherits(ContractDAO,_BaseDAO3);function ContractDAO(conn,settings,services){_classCallCheck(this,ContractDAO);var _this20=_possibleConstructorReturn(this,(ContractDAO.__proto__||Object.getPrototypeOf(ContractDAO)).call(this,conn,settings.labels));_this20._settings=settings;_this20._fieldMetadataService=services.fieldMetadataService;_this20._cache=cacheManager.getCache(CACHE_NAME,IdToValueCache);var restResourcePrefix=_this20._settings.salesCloudPrefix===''?'':'/'+_this20._settings.salesCloudPrefix.slice(0,_this20._settings.salesCloudPrefix.indexOf('_'));_this20._serviceRouterUrl=restResourcePrefix+'/ServiceRouter';if(conn.oik)_this20._serviceRouterUrl+='?oik='+conn.oik;_this20._contractSaveProvider='ContractServiceProvider.SaveContractRecords';_this20._logger=jsLogger;return _this20;}_createClass(ContractDAO,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"loadContractsByIds",value:function loadContractsByIds(contractIds){var _this21=this;var idsWithoutCachedRecord=contractIds.filter(function(id){return!_this21._cache.has(id);});var queryPromise=idsWithoutCachedRecord.length?this._queryAndCacheContracts(idsWithoutCachedRecord):Promise.resolve();return queryPromise.then(function(){var contractsById=new IdToValueCache();contractIds.forEach(function(id){if(_this21._cache.has(id)){contractsById.set(id,_this21._cache.get(id));}});return contractsById;}).catch(function(err){var errPrefix=_this21._settings.labels.msg_amendrenew_err_loading_contracts;return Promise.reject(errPrefix+(err.message||err));});}},{key:"_queryAndCacheContracts",value:function _queryAndCacheContracts(contractIds){var _this22=this;var contractIdsArray=JSON.stringify(contractIds);var contractType=ContractModel.getSObjectType(this._settings.isServiceCloudEnabled);var getSelectedContractFieldsStartTime=Date.now();var constructAndPerformQueryStartTime=void 0;this._logMessage('ContractDAO.js: Get Selected Contract Fields. Contracts='+contractIdsArray+' SessionId='+this._settings.userId);return this._getSelectedContractFields().then(function(selectedFields){_this22._logMessage('ContractDAO.js: Getting Selected Contract Fields took '+(Date.now()-getSelectedContractFieldsStartTime)+' ms. Contracts='+contractIdsArray+' SessionId='+_this22._settings.userId);_this22._logMessage('ContractDAO.js: Construct and perform query. Contracts='+contractIdsArray+' SessionId='+_this22._settings.userId);var whereClause="Id IN ('"+contractIds.join("', '")+"')";constructAndPerformQueryStartTime=Date.now();return _this22._constructAndPerformQuery(contractType,selectedFields,whereClause);}).then(function(contracts){_this22._logMessage('ContractDAO.js: Constructing and performing query took '+(Date.now()-constructAndPerformQueryStartTime)+' ms. Contracts='+contractIdsArray+' SessionId='+_this22._settings.userId);contracts.forEach(function(contract){_this22._cache.set(contract.Id,contract);});var storedContracts=JSON.parse(JSON.stringify(contracts));storedContracts.forEach(function(c){delete c[_this22._settings.prefix+'Quote__r'];});DataChangeTrackerInvoker.storeChangedRecords(storedContracts);});}},{key:"_getSelectedContractFields",value:function _getSelectedContractFields(){var _this23=this;var contractFields=new Set(ContractModel.getFields(this._settings));var contractType=ContractModel.getSObjectType(this._settings.isServiceCloudEnabled);var contractPrefix=this._settings.prefix;var getFieldDescribeStartTime=void 0;var getContractMagicFieldsStartTime=void 0;var getQuoteMagicFieldsStartTime=void 0;this._logMessage('ContractDAO.js: Get mappable fields for Contract. SessionId='+this._settings.userId);var getMappableFieldsStartTime=Date.now();return this._fieldMetadataService.getMappableFields(contractType).then(function(mappableFields){_this23._logMessage('ContractDAO.js: Getting mappable fields for Contract took '+(Date.now()-getMappableFieldsStartTime)+' ms. SessionId='+_this23._settings.userId);mappableFields.fieldArray.forEach(function(mappableField){contractFields.add(mappableField.name);});_this23._logMessage('ContractDAO.js: Get field describe for Contract.AmendmendmentBehavior__c. SessionId='+_this23._settings.userId);getFieldDescribeStartTime=Date.now();return _this23._fieldMetadataService.getFieldDescribe(contractType,contractPrefix+'AmendmentRenewalBehavior__c');}).then(function(renAmendDescribe){_this23._logMessage('ContractDAO.js: Getting field describe for Contract.AmendmentBehavior__c took '+(Date.now()-getFieldDescribeStartTime)+' ms. SessionId='+_this23._settings.userId);var potentialFieldNames=renAmendDescribe.picklistValues.map(function(valueDesc){return valueDesc.value;});for(var magicFieldName in _this23._settings.contractMagicFieldNamesByAlias){potentialFieldNames.push(_this23._settings.contractMagicFieldNamesByAlias[magicFieldName]);}_this23._logMessage('ContractDAO.js: Get contract magic fields. SessionId='+_this23._settings.userId);getContractMagicFieldsStartTime=Date.now();return _this23._fieldMetadataService.checkExistenceOfFields(contractType,potentialFieldNames);}).then(function(contractMagicFields){_this23._logMessage('ContractDAO.js: Getting contract magic fields took '+(Date.now()-getContractMagicFieldsStartTime)+' ms. SessionId='+_this23._settings.userId);Object.keys(contractMagicFields).forEach(function(magicFieldReference){if(contractMagicFields[magicFieldReference]){contractFields.add(contractMagicFields[magicFieldReference]);}});var quoteType=_this23._settings.salesCloudPrefix+'Quote__c';_this23._logMessage('ContractDAO.js: Get quote magic fields. SessionId='+_this23._settings.userId);getQuoteMagicFieldsStartTime=Date.now();return _this23._fieldMetadataService.checkExistenceOfFields(quoteType,QuoteModel.getMagicFields());}).then(function(quoteMagicFields){_this23._logMessage('ContractDAO.js: Getting quote magic fields took '+(Date.now()-getQuoteMagicFieldsStartTime)+' ms. SessionId='+_this23._settings.userId);var quoteRelationship=contractPrefix+'Quote__r.';Object.keys(quoteMagicFields).forEach(function(magicFieldReference){if(quoteMagicFields[magicFieldReference]){contractFields.add(quoteRelationship+quoteMagicFields[magicFieldReference]);}});AccountModel.getFields(_this23._settings.salesCloudPrefix).forEach(function(field){contractFields.add('Account.'+field);});return Array.from(contractFields);});}},{key:"updateRecords",value:function updateRecords(contracts){var _this24=this;this._logMessage('ContractDAO.js: Check if contract is updateable. SessionId='+this._settings.userId);var saveRecordsStartTime=void 0;var checkIfContractIsUpdateableStartTime=Date.now();return this._fieldMetadataService.isObjectUpdateable(ContractModel.getSObjectType(this._settings.isServiceCloudEnabled)).then(function(isContractUpdateable){_this24._logMessage('ContractDAO.js: Checking if contract is updateable took '+(Date.now()-checkIfContractIsUpdateableStartTime)+' ms. SessionId='+_this24._settings.userId);if(!isContractUpdateable){var noCrudError=_this24._settings.labels.msg_no_object_crud.replace('{0}','update').replace('{1}',ContractModel.getSObjectType(_this24._settings.isServiceCloudEnabled));return Promise.reject(noCrudError);}contracts.forEach(function(contract){delete contract[_this24._settings.prefix+'Quote__r'];});_this24._logMessage('ContractDAO.js: Save contract records. SessionId='+_this24._settings.userId);saveRecordsStartTime=Date.now();return _this24._saveRecords(_this24._contractSaveProvider,contracts,_this24._settings.labels.msg_amendrenew_err_saving_contracts);}).then(function(saveResults){_this24._logMessage('ContractDAO.js: Saving contract records took '+(Date.now()-checkIfContractIsUpdateableStartTime)+' ms. SessionId='+_this24._settings.userId);return saveResults;});}},{key:"_saveRecords",value:function _saveRecords(saveProvider,records,errMsgHeader){var _this25=this;var index=0;var batchSize=200;var saveRecordsPromise=[];this._logMessage('ContractDAO.js: APEX Rest API Call Out ('+saveProvider+'). SessionId='+this._settings.userId);var apexRestCallOutStartTime=Date.now();for(index;index<records.length;index=index+batchSize){saveRecordsPromise.push(this._conn.apex.post(this._serviceRouterUrl,{saver:saveProvider,model:JSON.stringify(records.slice(index,index+batchSize))}).then(function(res){return res.toLowerCase()==='success'?res:JSON.parse(res);},function(err){var msg=err.message||err;return Promise.reject(errMsgHeader+msg);}));}return Promise.all(saveRecordsPromise).then(function(saveResults){_this25._logMessage('OpportunityDAO.js: APEX Rest API Call Out ('+saveProvider+') took '+(Date.now()-apexRestCallOutStartTime)+' ms. SessionId='+_this25._settings.userId);return saveResults;});}}]);return ContractDAO;}(BaseDAO);module.exports=ContractDAO;},{"../../Utils/CacheManager.js":1,"../../Utils/DAOs/BaseDAO.js":2,"../../Utils/IdToValueCache.js":7,"../cleaners/DataChangeTrackerInvoker.js":29,"../models/AccountModel.js":39,"../models/ContractModel.js":40,"../models/QuoteModel.js":42,"js-logger":58}],12:[function(require,module,exports){'use strict';var IdToValueCache=require('../../Utils/IdToValueCache.js');var BaseDAO=require('../../Utils/DAOs/BaseDAO.js').BaseDAO;var AccountDAO=require('./AccountDAO.js');var DAOHelperMethods=require('../../Utils/DAOs/DAOHelperMethods.js');var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var cacheManager=require('../../Utils/CacheManager.js').cacheManager;var CACHE_NAME='ContractedPriceCache';var FIELDS=['Id','Account__c','Discount__c','Description__c','DiscountSchedule__c','EffectiveDate__c','ExpirationDate__c','FilterField__c','FilterValue__c','NonDiscountable__c','Operator__c','Price__c','Product__c'];var ContractedPriceDAO=function(_BaseDAO4){_inherits(ContractedPriceDAO,_BaseDAO4);function ContractedPriceDAO(conn,settings){_classCallCheck(this,ContractedPriceDAO);var _this26=_possibleConstructorReturn(this,(ContractedPriceDAO.__proto__||Object.getPrototypeOf(ContractedPriceDAO)).call(this,conn,settings.labels));_this26._settings=settings;_this26._salesCloudPrefix=_this26._settings.salesCloudPrefix;_this26._outerCache=cacheManager.getCache(CACHE_NAME,IdToValueCache);_this26._logger=jsLogger;return _this26;}_createClass(ContractedPriceDAO,[{key:"_recursivelyQueryAndCacheContractedPrices",value:function _recursivelyQueryAndCacheContractedPrices(currentAccountId,descendantAccountIds,necessityDescriptor,currencyCode,asOfDate){var _this27=this;var recursiveNecessityDescriptor=void 0;var productsToQuery=necessityDescriptor.productsToQuery;var queryFilteredPrices=necessityDescriptor.queryFilteredPrices;var whereClause=this._buildWhereClause(productsToQuery,queryFilteredPrices,currentAccountId,currencyCode,asOfDate);var selectedFields=DAOHelperMethods.properlyPrefixFields(this._salesCloudPrefix,FIELDS);if(this._settings.isMultiCurrencyOrg){selectedFields.push('CurrencyIsoCode');}return this._constructAndPerformQuery(this._salesCloudPrefix+'ContractedPrice__c',selectedFields,whereClause,null,['CreatedDate','ASC']).then(function(contractedPrices){var filterKey=_this27._createFilteredCacheKey(currencyCode,asOfDate);var currentAcctInnerCache=_this27._outerCache.get(currentAccountId);contractedPrices.forEach(function(contractedPrice){if(contractedPrice[_this27._salesCloudPrefix+'FilterField__c']!=null){var filteredPrices=currentAcctInnerCache.get(filterKey)||[];filteredPrices.push(contractedPrice);currentAcctInnerCache.set(filterKey,filteredPrices);descendantAccountIds.forEach(function(descAccId){var descCacheData=_this27._outerCache.get(descAccId);var descFilters=descCacheData.get(filterKey)||[];descFilters.push(contractedPrice);descCacheData.set(filterKey,descFilters);});}else{var keyEndSection=contractedPrice[_this27._salesCloudPrefix+'Price__c']!=null?currencyCode||'none':'DISC';var key=_this27._createProductSpecificCacheKey(contractedPrice[_this27._salesCloudPrefix+'Product__c'],asOfDate,keyEndSection);currentAcctInnerCache.set(key,contractedPrice);descendantAccountIds.forEach(function(descAccId){var descCacheData=_this27._outerCache.get(descAccId);if(!descCacheData.has(key)){descCacheData.set(key,contractedPrice);}});}});recursiveNecessityDescriptor=_this27._createQueryNecessityDescriptor(currentAccountId,productsToQuery,currencyCode,asOfDate);if(recursiveNecessityDescriptor.productsToQuery.length===0){return null;}else{var accDao=new AccountDAO(_this27._conn,_this27._settings);return accDao.getAccountsByIds([currentAccountId]);}}).then(function(accountsById){if(accountsById==null){return;}var currentAccRec=accountsById.get(currentAccountId);if(currentAccRec['ParentId']==null||currentAccRec[_this27._salesCloudPrefix+'IgnoreParentContractedPrices__c']){return;}else{descendantAccountIds.push(currentAccountId);recursiveNecessityDescriptor=_this27._createQueryNecessityDescriptor(currentAccRec['ParentId'],productsToQuery,currencyCode,asOfDate);return _this27._recursivelyQueryAndCacheContractedPrices(currentAccRec['ParentId'],descendantAccountIds,recursiveNecessityDescriptor,currencyCode,asOfDate);}});}},{key:"_buildWhereClause",value:function _buildWhereClause(productsToQuery,queryFilteredPrices,accId,currencyCode,asOfDate){var whereClauseComponents=[];whereClauseComponents.push(this._salesCloudPrefix+'Account__c = \''+accId+'\'');var orClauseComponents=[];if(productsToQuery.length>0){var prodSpecificSubclause=this._salesCloudPrefix+'Product__c IN (\''+productsToQuery.join('\', \'')+'\')';if(this._settings.isMultiCurrencyOrg){prodSpecificSubclause+=' AND ('+this._salesCloudPrefix+'Price__c = null OR CurrencyIsoCode = \''+currencyCode+'\')';}orClauseComponents.push(prodSpecificSubclause);}if(queryFilteredPrices){var filterSubclause=this._salesCloudPrefix+'FilterField__c != null';if(this._settings.isMultiCurrencyOrg){filterSubclause+=' AND CurrencyIsoCode = \''+currencyCode+'\'';}orClauseComponents.push(filterSubclause);}whereClauseComponents.push('('+orClauseComponents.join(') OR (')+')');var effectiveDateField=this._salesCloudPrefix+'EffectiveDate__c';whereClauseComponents.push(effectiveDateField+' = null OR '+effectiveDateField+' <= '+asOfDate);var expirationDateField=this._salesCloudPrefix+'ExpirationDate__c';whereClauseComponents.push(expirationDateField+' = null OR '+expirationDateField+' >= '+asOfDate);return'('+whereClauseComponents.join(') AND (')+')';}},{key:"loadRelevantContractedPrices",value:function loadRelevantContractedPrices(accountId,productIds,currencyCode,asOfDate){var _this28=this;var necessityDescriptor=this._createQueryNecessityDescriptor(accountId,productIds,currencyCode,asOfDate);var queryPromise=necessityDescriptor.productsToQuery.length>0||necessityDescriptor.queryFilteredPrices?this._recursivelyQueryAndCacheContractedPrices(accountId,[],necessityDescriptor,currencyCode,asOfDate):Promise.resolve();return queryPromise.then(function(){var results=new IdToValueCache();var innerCache=_this28._outerCache.get(accountId);var filteredPricesNeeded=false;productIds.forEach(function(productId){var priceTypeKey=_this28._createProductSpecificCacheKey(productId,asOfDate,currencyCode);if(innerCache.has(priceTypeKey)&&innerCache.get(priceTypeKey)!=null){results.set(productId,innerCache.get(priceTypeKey));return;}innerCache.set(priceTypeKey,null);var discountTypeKey=_this28._createProductSpecificCacheKey(productId,asOfDate,'DISC');if(innerCache.has(discountTypeKey)&&innerCache.get(discountTypeKey)!=null){results.set(productId,innerCache.get(discountTypeKey));return;}innerCache.set(discountTypeKey,null);filteredPricesNeeded=true;});if(filteredPricesNeeded){var filteredPriceKey=_this28._createFilteredCacheKey(currencyCode,asOfDate);if(innerCache.has(filteredPriceKey)&&innerCache.get(filteredPriceKey)!=null){results.set('FILTERED',innerCache.get(filteredPriceKey));}else{innerCache.set(filteredPriceKey,null);}}return results;}).catch(function(err){var msgHeader=_this28._settings.labels.msg_amendrenew_err_loading_contracted_prices;return Promise.reject(msgHeader+(err.message||err));});}},{key:"_createQueryNecessityDescriptor",value:function _createQueryNecessityDescriptor(accountId,productIds,currencyCode,asOfDate){var _this29=this;var descriptor={productsToQuery:[],queryFilteredPrices:false};if(!this._outerCache.has(accountId)){this._outerCache.set(accountId,new Map());descriptor.productsToQuery=productIds;descriptor.queryFilteredPrices=true;}else{var existingCacheData=this._outerCache.get(accountId);productIds.forEach(function(productId){var productSpecificKey=_this29._createProductSpecificCacheKey(productId,asOfDate,currencyCode);if(!existingCacheData.has(productSpecificKey)){descriptor.productsToQuery.push(productId);}});descriptor.queryFilteredPrices=descriptor.productsToQuery.length>0&&!existingCacheData.has(this._createFilteredCacheKey(currencyCode,asOfDate));}return descriptor;}},{key:"_createProductSpecificCacheKey",value:function _createProductSpecificCacheKey(productId,asOfDate,endSection){return productId.slice(0,15)+'_'+(asOfDate||'none')+'_'+(endSection||'none');}},{key:"_createFilteredCacheKey",value:function _createFilteredCacheKey(currencyCode,asOfDate){return'FILTERED_'+(currencyCode||'none')+'_'+(asOfDate||'none');}}]);return ContractedPriceDAO;}(BaseDAO);module.exports=ContractedPriceDAO;},{"../../Utils/CacheManager.js":1,"../../Utils/DAOs/BaseDAO.js":2,"../../Utils/DAOs/DAOHelperMethods.js":3,"../../Utils/IdToValueCache.js":7,"./AccountDAO.js":10,"js-logger":58}],13:[function(require,module,exports){var IdToValueCache=require('../../Utils/IdToValueCache.js');var BaseDAO=require('../../Utils/DAOs/BaseDAO.js').BaseDAO;var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var cacheManager=require('../../Utils/CacheManager.js').cacheManager;var DataChangeTrackerInvoker=require('../cleaners/DataChangeTrackerInvoker.js');var FIELDS=['Id','OpportunityId','IsPrimary','ContactId','Role'];var OUTER_CACHE_NAME='OPPTY_CONTACT_ROLE_CACHE';var RECORDS_BY_OPPTYID='RECORDS_BY_OPPTYID';var OpportunityContactRoleDAO=function(_BaseDAO5){_inherits(OpportunityContactRoleDAO,_BaseDAO5);function OpportunityContactRoleDAO(conn,settings){_classCallCheck(this,OpportunityContactRoleDAO);var _this30=_possibleConstructorReturn(this,(OpportunityContactRoleDAO.__proto__||Object.getPrototypeOf(OpportunityContactRoleDAO)).call(this,conn,settings.labels));_this30._settings=settings;_this30._cache=cacheManager.getCache(OUTER_CACHE_NAME);_this30._logger=jsLogger;return _this30;}_createClass(OpportunityContactRoleDAO,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"_identifyUncachedKeys",value:function _identifyUncachedKeys(innerKeys,innerCacheName,innerCacheConstructor){var cachedResults=this._cache.get(innerCacheName);if(!cachedResults){cachedResults=new(innerCacheConstructor||Map)();this._cache.set(innerCacheName,cachedResults);return innerKeys;}else{return innerKeys.filter(function(key){return!cachedResults.has(key);});}}},{key:"loadOpportunityContactRolesByOpportunityId",value:function loadOpportunityContactRolesByOpportunityId(oppIdSet){var _this31=this;var oppIdArray=Array.from(oppIdSet);var uncachedKeys=this._identifyUncachedKeys(oppIdArray,RECORDS_BY_OPPTYID,IdToValueCache);var cachePopulationPromise=uncachedKeys.length>0?this._queryAndCacheOCRsByOpptyId(uncachedKeys):Promise.resolve();return cachePopulationPromise.then(function(){var results=new IdToValueCache();var cachedRecords=_this31._cache.get(RECORDS_BY_OPPTYID);oppIdArray.forEach(function(oppId){if(!cachedRecords.has(oppId)){cachedRecords.set(oppId,null);}else if(cachedRecords.get(oppId)!=null){results.set(oppId,cachedRecords.get(oppId));}});return results;}).catch(function(err){var errPrefix=_this31._settings.labels.msg_amendrenew_err_loading_ocrs;return Promise.reject(errPrefix+(err.message||err));});}},{key:"_queryAndCacheOCRsByOpptyId",value:function _queryAndCacheOCRsByOpptyId(opptyIds){var _this32=this;var selectedFields=FIELDS;var whereClause="OpportunityId IN ('"+opptyIds.join("', '")+"')";var opptyIdsArray=JSON.stringify(opptyIds);this._logMessage('OpportunityContactRoleDAO.js: Construct And Perform Query. OpptyIds='+opptyIdsArray+' SessionId='+this._settings.userId);var queryStartTime=Date.now();return this._constructAndPerformQuery('OpportunityContactRole',selectedFields,whereClause).then(function(ocrs){_this32._logMessage('OpportunityContactRoleDAO.js: Constructing and performing query took '+(Date.now()-queryStartTime)+' ms. Opptys='+opptyIdsArray+' SessionId='+_this32._settings.userId);var innerCache=_this32._cache.get(RECORDS_BY_OPPTYID);ocrs.forEach(function(ocr){var opptyId=ocr.OpportunityId;if(!innerCache.has(opptyId)){innerCache.set(opptyId,[]);}innerCache.get(opptyId).push(ocr);});});}},{key:"insertOpportunityContactRoles",value:function insertOpportunityContactRoles(records){var _this33=this;var sobject=this._conn.sobject('OpportunityContactRole');var listOfRecordLists=[];var recordCount=records.length;for(var i=0;i<recordCount;i+=10){listOfRecordLists.push(records.slice(i,i+10));}var promiseArray=[];this._logMessage('OpportunityContactRoleDAO.js: Inserting '+records.length+' OCR records using '+listOfRecordLists.length+' batches. SessionId='+this._settings.userId);var startTime=Date.now();listOfRecordLists.forEach(function(list){promiseArray.push(sobject.insert(list));});return Promise.all(promiseArray).then(function(listOfResultLists){_this33._logMessage('OpportunityContactRoleDAO.js: Finished inserting '+records.length+' OCR records using '+listOfRecordLists.length+' batches in '+(Date.now()-startTime)+' ms. SessionId='+_this33._settings.userId);var consolidatedRecordList=[];var ids=[];var parentOpptyIds=[];var subListCount=listOfRecordLists.length;var _loop3=function _loop3(_i){var records=listOfRecordLists[_i];var results=listOfResultLists[_i];records.forEach(function(record,index){var result=results[index];record.Id=result.id;ids.push(result.id);parentOpptyIds.push(record.OpportunityId);consolidatedRecordList.push(record);});};for(var _i=0;_i<subListCount;_i++){_loop3(_i);}DataChangeTrackerInvoker.storeCreatedRecordIds(ids,'OpportunityContactRole',parentOpptyIds);return consolidatedRecordList;}).catch(function(err){var errPrefix=_this33._settings.labels.msg_amendrenew_err_saving_ocrs;return Promise.reject(errPrefix+(err.message||err));});}}]);return OpportunityContactRoleDAO;}(BaseDAO);module.exports=OpportunityContactRoleDAO;},{"../../Utils/CacheManager.js":1,"../../Utils/DAOs/BaseDAO.js":2,"../../Utils/IdToValueCache.js":7,"../cleaners/DataChangeTrackerInvoker.js":29,"js-logger":58}],14:[function(require,module,exports){'use strict';var ContractModel=require('../models/ContractModel.js');var DataChangeTrackerInvoker=require('../cleaners/DataChangeTrackerInvoker.js');var OpportunityModel=require('../models/OpportunityModel.js');var IdToValueCache=require('../../Utils/IdToValueCache.js');var BaseDAO=require('../../Utils/DAOs/BaseDAO.js').BaseDAO;var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var cacheManager=require('../../Utils/CacheManager.js').cacheManager;var CACHE_NAME='OpportunityCache';var OpportunityDAO=function(_BaseDAO6){_inherits(OpportunityDAO,_BaseDAO6);function OpportunityDAO(conn,settings,services){_classCallCheck(this,OpportunityDAO);var _this34=_possibleConstructorReturn(this,(OpportunityDAO.__proto__||Object.getPrototypeOf(OpportunityDAO)).call(this,conn,settings.labels));_this34._settings=settings;_this34._fieldMetadataService=services.fieldMetadataService;_this34._hasRecordTypeField=null;_this34._cache=cacheManager.getCache(CACHE_NAME,IdToValueCache);var restResourcePrefix=_this34._settings.salesCloudPrefix===''?'':'/'+_this34._settings.salesCloudPrefix.slice(0,_this34._settings.salesCloudPrefix.indexOf('_'));_this34._serviceRouterUrl=restResourcePrefix+'/ServiceRouter';if(conn.oik)_this34._serviceRouterUrl+='?oik='+conn.oik;_this34._opportunitySaveProvider='OpportunityServiceProvider.SaveOpportunityRecords';_this34._logger=jsLogger;return _this34;}_createClass(OpportunityDAO,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"createOpportunityRecord",value:function createOpportunityRecord(opptyModel){var _this35=this;var errMsgHeader=this._settings.labels.msg_amendrenew_err_creating_oppty;var jsForceStartTime=Date.now();this._logMessage('OpportunityDAO.js: JSForce call to create opportunity record. SessionId='+this._settings.userId);return this._conn.sobject("Opportunity").create(opptyModel.getOpportunity()).then(function(result){_this35._logMessage('OpportunityDAO.js: JSForce call to create opportunity record took '+(Date.now()-jsForceStartTime)+' ms. SessionId='+_this35._settings.userId);if(result.success&&!result.error){opptyModel.Id=result.id;DataChangeTrackerInvoker.storeCreatedRecordIds([result.id],'Opportunity');return opptyModel;}else if(!result.success&&result.error){return Promise.reject(errMsgHeader+result.error);}},function(err){return Promise.reject(errMsgHeader+(err.message||err));});}},{key:"getOppStage1MasterLabel",value:function getOppStage1MasterLabel(){var _this36=this;if(this._cache.has('oppStageMasterLabels')){return Promise.resolve(this._cache.get('oppStageMasterLabels')[0].MasterLabel);}var jsForceStartTime=Date.now();this._logMessage('OpportunityDAO.js: JSForce query to get opportunity Stage 1 Master Label. SOQL to Execute - SELECT MasterLabel FROM OpportunityStage WHERE IsActive = true ORDER BY SortOrder. SessionId='+this._settings.userId);return this._conn.sobject('OpportunityStage').select('MasterLabel').where('IsActive = true').orderby('SortOrder').execute({autoFetch:true,maxFetch:Number.POSITIVE_INFINITY}).then(function(oppStageMasterLabels){_this36._logMessage('OpportunityDAO: JSForce query to get opportunity Stage 1 Master Label took '+(Date.now()-jsForceStartTime)+' ms. SessionId='+_this36._settings.userId);return oppStageMasterLabels[0].MasterLabel;});}},{key:"isCreateable",value:function isCreateable(){return this._getOppDescribe().then(function(oppDescribe){return oppDescribe.createable;});}},{key:"hasRecordTypeField",value:function hasRecordTypeField(){var _this37=this;if(this._hasRecordTypeField!=null){return Promise.resolve(this._hasRecordTypeField);}var recTypeFieldFound=false;return this._retrieveFields().then(function(fields){for(var i=0;i<fields.length;i++){if(fields[i].name==='RecordTypeId'){recTypeFieldFound=true;break;}}_this37._hasRecordTypeField=recTypeFieldFound;return recTypeFieldFound;});}},{key:"_retrieveFields",value:function _retrieveFields(){return this._getOppDescribe().then(function(oppDescribe){return oppDescribe.fields;});}},{key:"_getOppDescribe",value:function _getOppDescribe(){var _this38=this;if(this._cache.has('oppDescribe')){return Promise.resolve(this._cache.get('oppDescribe'));}else{var jsForceStartTime=Date.now();this._logMessage('OpportunityDAO.js: JSForce call for object describe on Opportunity. SessionId='+this._settings.userId);return this._conn.describe('Opportunity').then(function(describeResult){_this38._logMessage('OpportunityDAO.js: JSForce call for object describe on Opportunity took '+(Date.now()-jsForceStartTime)+' ms. SessionId='+_this38._settings.userId);_this38._cache.set('oppDescribe',describeResult);return describeResult;});}}},{key:"mapCustomFields",value:function mapCustomFields(contract,opportunity){return this._fieldMetadataService.getSharedMappableFieldNames(ContractModel.getSObjectType(this._settings.isServiceCloudEnabled),'Opportunity').then(function(srcMappedFields){srcMappedFields.forEach(function(field){opportunity[field]=contract[field];return Promise.resolve();});});}},{key:"updateRecords",value:function updateRecords(opportunities){var _this39=this;this._logMessage('OpportunityDAO.js: Check if opportunity object is updateable. SessionId='+this._settings.userId);var checkIfOppUpdateable=Date.now();return this._fieldMetadataService.isObjectUpdateable('Opportunity').then(function(isOpportunityUpdateable){_this39._logMessage('OpportunityDAO.js: Checking if opportunity object is updateable took '+(Date.now()-checkIfOppUpdateable)+' ms. SessionId='+_this39._settings.userId);if(!isOpportunityUpdateable){var noCrudError=_this39._settings.labels.msg_no_object_crud.replace('{0}','update').replace('{1}','Opportunity');return Promise.reject(noCrudError);}return _this39._saveRecords(_this39._opportunitySaveProvider,opportunities,_this39._settings.labels.msg_amendrenew_err_saving_opps);});}},{key:"_saveRecords",value:function _saveRecords(saveProvider,records,errMsgHeader){var _this40=this;var index=0;var batchSize=200;var saveRecordsPromise=[];this._logMessage('OpportunityDAO.js: APEX Rest API Call Out ('+saveProvider+'). SessionId='+this._settings.userId);var apexRestCallOutStartTime=Date.now();for(index;index<records.length;index=index+batchSize){saveRecordsPromise.push(this._conn.apex.post(this._serviceRouterUrl,{saver:saveProvider,model:JSON.stringify(records.slice(index,index+batchSize))}).then(function(res){return res.toLowerCase()==='success'?res:JSON.parse(res);},function(err){var msg=err.message||err;return Promise.reject(errMsgHeader+msg);}));}return Promise.all(saveRecordsPromise).then(function(saveResults){_this40._logMessage('OpportunityDAO.js: APEX Rest API Call Out ('+saveProvider+') took '+(Date.now()-apexRestCallOutStartTime)+' ms. SessionId='+_this40._settings.userId);return saveResults;});}},{key:"loadOppsByIds",value:function loadOppsByIds(oppIds){var _this41=this;var idsWithoutCachedRecord=oppIds.filter(function(id){return!_this41._cache.has(id);});var queryPromise=idsWithoutCachedRecord.length?this._queryAndCacheOpps(idsWithoutCachedRecord):Promise.resolve();return queryPromise.then(function(){var oppsById=new IdToValueCache();oppIds.forEach(function(id){if(_this41._cache.has(id)){oppsById.set(id,_this41._cache.get(id));}});return oppsById;}).catch(function(err){var errMsgHeader=_this41._settings.labels.msg_amendrenew_err_loading_opps;return Promise.reject(errMsgHeader+(err.message||err));});}},{key:"_queryAndCacheOpps",value:function _queryAndCacheOpps(oppIds){var _this42=this;var allFields=OpportunityModel.getFields(this._settings);var selectedFields=void 0;return this.hasRecordTypeField().then(function(hasRecordTypeField){if(!hasRecordTypeField){var index=allFields.indexOf('RecordTypeId');selectedFields=allFields.slice(0,index).concat(allFields.slice(index+1));}else{selectedFields=allFields;}var whereClause="Id IN ('"+oppIds.join("', '")+"')";return _this42._constructAndPerformQuery('Opportunity',selectedFields,whereClause);}).then(function(opps){opps.forEach(function(opp){_this42._cache.set(opp.Id,opp);});DataChangeTrackerInvoker.storeChangedRecords(opps);});}}]);return OpportunityDAO;}(BaseDAO);module.exports=OpportunityDAO;},{"../../Utils/CacheManager.js":1,"../../Utils/DAOs/BaseDAO.js":2,"../../Utils/IdToValueCache.js":7,"../cleaners/DataChangeTrackerInvoker.js":29,"../models/ContractModel.js":40,"../models/OpportunityModel.js":41,"js-logger":58}],15:[function(require,module,exports){var DataChangeTrackerInvoker=require('../cleaners/DataChangeTrackerInvoker.js');var BaseDAO=require('../../Utils/DAOs/BaseDAO.js').BaseDAO;var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var OpportunityLineDAO=function(_BaseDAO7){_inherits(OpportunityLineDAO,_BaseDAO7);function OpportunityLineDAO(conn,settings){_classCallCheck(this,OpportunityLineDAO);var _this43=_possibleConstructorReturn(this,(OpportunityLineDAO.__proto__||Object.getPrototypeOf(OpportunityLineDAO)).call(this,conn,settings.labels));_this43._settings=settings;_this43._salesCloudPrefix=settings.salesCloudPrefix;var restResourcePrefix=_this43._settings.salesCloudPrefix===''?'':'/'+_this43._settings.salesCloudPrefix.slice(0,_this43._settings.salesCloudPrefix.indexOf('_'));_this43._serviceRouterUrl=restResourcePrefix+'/ServiceRouter';if(conn.oik)_this43._serviceRouterUrl+='?oik='+conn.oik;_this43._lineDeletionServiceProvider='QuoteOpportunitySynchronizer.OpportunityLineItemDeleter';_this43._lineFragmentSaveServiceProvider='QuoteOpportunitySynchronizer.OpportunityLineFragmentedSaver';_this43._logger=jsLogger;return _this43;}_createClass(OpportunityLineDAO,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"saveOppLinesByOppId",value:function saveOppLinesByOppId(oppLinesByOppId){var _this44=this;var oppIds=[];var oppLines=[];var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=oppLinesByOppId.entries()[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var _step4$value=_slicedToArray(_step4.value,2),oppId=_step4$value[0],olis=_step4$value[1];oppIds.push(oppId);oppLines=oppLines.concat(olis);}}catch(err){_didIteratorError4=true;_iteratorError4=err;}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return();}}finally{if(_didIteratorError4){throw _iteratorError4;}}}this._logMessage('OpportunityLineDAO.js: Delete outdated opportunity lines. SessionId='+this._settings.userId);var saveOppLinesStartTime=void 0;var deleteOutdateOppLinesStartTime=Date.now();return this._deleteOutdatedOppLines(oppIds).then(function(){_this44._logMessage('OpportunityLineDAO.js: Deleting outdated opportunity lines took '+(Date.now()-deleteOutdateOppLinesStartTime)+' ms. SessionId='+_this44._settings.userId);_this44._logMessage('OpportunityLineDAO.js: Save opportunity lines. SessionId='+_this44._settings.userId);saveOppLinesStartTime=Date.now();return _this44._saveOppLines(oppLines);}).then(function(saveResults){_this44._logMessage('OpportunityLineDAO.js: Saving opportunity lines took '+(Date.now()-deleteOutdateOppLinesStartTime)+' ms. SessionId='+_this44._settings.userId);return saveResults;});}},{key:"_deleteOutdatedOppLines",value:function _deleteOutdatedOppLines(oppIds){return this._performCallout(this._lineDeletionServiceProvider,oppIds,this._settings.labels.msg_amendrenew_err_deleting_olis).then(function(deletedOppLineIds){DataChangeTrackerInvoker.storeDeletedRecordIds(deletedOppLineIds,'OpportunityLineItem');});}},{key:"_saveOppLines",value:function _saveOppLines(oppLines){var _this45=this;var msgPrefix=this._settings.labels.msg_amendrenew_err_saving_olis;return this._saveRecords(this._lineFragmentSaveServiceProvider,oppLines.map(function(oli){return oli.record;}),msgPrefix).then(function(oliIds){var parentOppIdArray=oppLines.map(function(oli){return oli.record.OpportunityId;});DataChangeTrackerInvoker.storeCreatedRecordIds(oliIds,'OpportunityLineItem',parentOppIdArray);_this45._assignIdsAndParentIdsToOppLines(oppLines,oliIds);var parentIdField=_this45._salesCloudPrefix+'ParentID__c';var recordsWithIdAndParentId=[];oppLines.forEach(function(oli){if(oli.record[parentIdField]){recordsWithIdAndParentId.push(_defineProperty({Id:oli.record.Id},parentIdField,oli.record[parentIdField]));}});return recordsWithIdAndParentId.length>0?_this45._saveRecords(_this45._lineFragmentSaveServiceProvider,recordsWithIdAndParentId,msgPrefix):Promise.resolve();});}},{key:"_assignIdsAndParentIdsToOppLines",value:function _assignIdsAndParentIdsToOppLines(oppLines,newLineIds){var idsByKey=new Map();for(var i=0;i<oppLines.length;i++){var oli=oppLines[i];var newLineId=newLineIds[i];idsByKey.set(oli.key,newLineId);oli.record.Id=newLineId;}var parentIdField=this._salesCloudPrefix+'ParentID__c';oppLines.forEach(function(oli){oli.record[parentIdField]=oli.parentKey?idsByKey.get(oli.parentKey):null;});}},{key:"_saveRecords",value:function _saveRecords(saveProvider,records,errMsgHeader){var _this46=this;var ids=[];var batchSize=200;var performCalloutRecursively=function performCalloutRecursively(index){if(index>=records.length){_this46._logMessage('OpportunityLineDAO.js: Performing call out recursively took '+(Date.now()-performCalloutRecursivelyStartTime)+' ms. SessionId='+_this46._settings.userId);return Promise.resolve(ids);}else{return _this46._performCallout(saveProvider,records.slice(index,index+batchSize),errMsgHeader).then(function(newIds){_this46._logMessage('OpportunityLineDAO.js: Performing call out recursively took '+(Date.now()-performCalloutRecursivelyStartTime)+' ms. SessionId='+_this46._settings.userId);ids=ids.concat(newIds);_this46._logMessage('OpportunityLineDAO.js: Perform call out recursively. SessionId='+_this46._settings.userId);performCalloutRecursivelyStartTime=Date.now();return performCalloutRecursively(index+batchSize);});}};this._logMessage('OpportunityLineDAO.js: Perform call out recursively. SessionId='+this._settings.userId);var performCalloutRecursivelyStartTime=Date.now();return performCalloutRecursively(0);}},{key:"_performCallout",value:function _performCallout(saveProvider,model,errMsgPrefix){var _this47=this;this._logMessage('OpportunityLineDAO.js: APEX Rest API Call Out ('+saveProvider+'). SessionId='+this._settings.userId);var apexRestCallOutStartTime=Date.now();return this._conn.apex.post(this._serviceRouterUrl,{saver:saveProvider,model:JSON.stringify(model)}).then(function(res){_this47._logMessage('OpportunityLineDAO.js: APEX Rest API Call Out ('+saveProvider+') took '+(Date.now()-apexRestCallOutStartTime)+' ms. SessionId='+_this47._settings.userId);return res.toLowerCase()==='success'?res:JSON.parse(res);},function(err){var msg=err.message||err;return Promise.reject(errMsgPrefix+msg);});}}]);return OpportunityLineDAO;}(BaseDAO);module.exports=OpportunityLineDAO;},{"../../Utils/DAOs/BaseDAO.js":2,"../cleaners/DataChangeTrackerInvoker.js":29,"js-logger":58}],16:[function(require,module,exports){var IdToValueCache=require('../../Utils/IdToValueCache.js');var BaseDAO=require('../../Utils/DAOs/BaseDAO.js').BaseDAO;var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var cacheManager=require('../../Utils/CacheManager.js').cacheManager;var DataChangeTrackerInvoker=require('../cleaners/DataChangeTrackerInvoker.js');var FIELDS=['Id','OpportunityId','Opportunity.AccountId','IsPrimary','AccountToId','Role'];var OUTER_CACHE_NAME='PARTNER_CACHE';var RECORDS_BY_OPPTYID='RECORDS_BY_OPPTYID';var PartnerDAO=function(_BaseDAO8){_inherits(PartnerDAO,_BaseDAO8);function PartnerDAO(conn,settings){_classCallCheck(this,PartnerDAO);var _this48=_possibleConstructorReturn(this,(PartnerDAO.__proto__||Object.getPrototypeOf(PartnerDAO)).call(this,conn,settings.labels));_this48._settings=settings;_this48._cache=cacheManager.getCache(OUTER_CACHE_NAME);_this48._logger=jsLogger;return _this48;}_createClass(PartnerDAO,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"_identifyUncachedKeys",value:function _identifyUncachedKeys(innerKeys,innerCacheName,innerCacheConstructor){var cachedResults=this._cache.get(innerCacheName);if(!cachedResults){cachedResults=new(innerCacheConstructor||Map)();this._cache.set(innerCacheName,cachedResults);return innerKeys;}else{return innerKeys.filter(function(key){return!cachedResults.has(key);});}}},{key:"loadPartnersByOpportunityId",value:function loadPartnersByOpportunityId(oppIdSet){var _this49=this;var oppIdArray=Array.from(oppIdSet);var uncachedKeys=this._identifyUncachedKeys(oppIdArray,RECORDS_BY_OPPTYID,IdToValueCache);var cachePopulationPromise=uncachedKeys.length>0?this._queryAndCachePartnersByOpptyId(uncachedKeys):Promise.resolve();return cachePopulationPromise.then(function(){var results=new IdToValueCache();var cachedRecords=_this49._cache.get(RECORDS_BY_OPPTYID);oppIdArray.forEach(function(oppId){if(!cachedRecords.has(oppId)){cachedRecords.set(oppId,null);}else if(cachedRecords.get(oppId)!=null){results.set(oppId,cachedRecords.get(oppId));}});return results;}).catch(function(err){var errPrefix=_this49._settings.labels.msg_amendrenew_err_loading_partners;return Promise.reject(errPrefix+(err.message||err));});}},{key:"_queryAndCachePartnersByOpptyId",value:function _queryAndCachePartnersByOpptyId(opptyIds){var _this50=this;var selectedFields=FIELDS;var whereClause="OpportunityId != null AND OpportunityId IN ('"+opptyIds.join("', '")+"')";var opptyIdsArray=JSON.stringify(opptyIds);this._logMessage('PartnerDAO.js: Construct And Perform Query. OpptyIds='+opptyIdsArray+' SessionId='+this._settings.userId);var queryStartTime=Date.now();return this._constructAndPerformQuery('Partner',selectedFields,whereClause).then(function(partners){_this50._logMessage('PartnerDAO.js: Constructing and performing query took '+(Date.now()-queryStartTime)+' ms. Opptys='+opptyIdsArray+' SessionId='+_this50._settings.userId);var innerCache=_this50._cache.get(RECORDS_BY_OPPTYID);partners.forEach(function(partner){var opptyId=partner.OpportunityId;if(!innerCache.has(opptyId)){innerCache.set(opptyId,[]);}innerCache.get(opptyId).push(partner);});});}},{key:"insertPartners",value:function insertPartners(records){var _this51=this;records.forEach(function(record){delete record.Opportunity;});var sobject=this._conn.sobject('Partner');var listOfRecordLists=[];var recordCount=records.length;for(var i=0;i<recordCount;i+=10){listOfRecordLists.push(records.slice(i,i+10));}var promiseArray=[];this._logMessage('PartnerDAO.js: Inserting '+records.length+' Partner records using '+listOfRecordLists.length+' batches. SessionId='+this._settings.userId);var startTime=Date.now();listOfRecordLists.forEach(function(list){promiseArray.push(sobject.insert(list));});return Promise.all(promiseArray).then(function(listOfResultLists){_this51._logMessage('PartnerDAO.js: Finished inserting '+records.length+' Partner Records using '+listOfRecordLists.length+' batches in '+(Date.now()-startTime)+' ms. SessionId='+_this51._settings.userId);var consolidatedRecordList=[];var ids=[];var parentOpptyIds=[];var subListCount=listOfRecordLists.length;var _loop4=function _loop4(_i2){var records=listOfRecordLists[_i2];var results=listOfResultLists[_i2];records.forEach(function(record,index){var result=results[index];record.Id=result.id;ids.push(result.id);parentOpptyIds.push(record.OpportunityId);consolidatedRecordList.push(record);});};for(var _i2=0;_i2<subListCount;_i2++){_loop4(_i2);}DataChangeTrackerInvoker.storeCreatedRecordIds(ids,'Partner',parentOpptyIds);return consolidatedRecordList;}).catch(function(err){var errPrefix=_this51._settings.labels.msg_amendrenew_err_saving_partners;return Promise.reject(errPrefix+(err.message||err));});}}]);return PartnerDAO;}(BaseDAO);module.exports=PartnerDAO;},{"../../Utils/CacheManager.js":1,"../../Utils/DAOs/BaseDAO.js":2,"../../Utils/IdToValueCache.js":7,"../cleaners/DataChangeTrackerInvoker.js":29,"js-logger":58}],17:[function(require,module,exports){'use strict';var DataChangeTrackerInvoker=require('../cleaners/DataChangeTrackerInvoker.js');var BaseDAO=require('../../Utils/DAOs/BaseDAO.js').BaseDAO;var logger=require('js-logger').logger.getLogger('JSAR Perf');var QuoteDAO=function(_BaseDAO9){_inherits(QuoteDAO,_BaseDAO9);function QuoteDAO(conn,settings){_classCallCheck(this,QuoteDAO);var _this52=_possibleConstructorReturn(this,(QuoteDAO.__proto__||Object.getPrototypeOf(QuoteDAO)).call(this,conn,settings.labels));_this52._settings=settings;_this52._salesCloudPrefix=settings.salesCloudPrefix;var restResourcePrefix=_this52._settings.salesCloudPrefix===''?'':'/'+_this52._settings.salesCloudPrefix.slice(0,_this52._settings.salesCloudPrefix.indexOf('_'));_this52._serviceRouterUrl=restResourcePrefix+'/ServiceRouter';if(conn.oik)_this52._serviceRouterUrl+='?oik='+conn.oik;_this52._quoteCreateReloadProvider='QuoteServiceProvider.CreateAndReloadQuoteRecord';_this52._quoteSaveProvider='QuoteServiceProvider.SaveQuoteRecords';_this52._lineInsertProvider='QuoteLineEditorServiceProvider.InsertLineRecords';_this52._lineUpdateProvider='QuoteLineEditorServiceProvider.UpdateLineRecords';_this52._groupSaveProvider='QuoteLineEditorServiceProvider.SaveGroupRecords';_this52._quoteDeleteProvider='QuoteServiceProvider.DeleteQuoteRecords';_this52._quoteUncheckPrimaryProvider='QuoteServiceProvider.UncheckPrimaryQuoteRecords';_this52._lineSaveRequeryRollbackProvider='SaveRequeryRollbackServiceProvider.SaveRequeryRollbackIncompleteLines';_this52._logger=logger;return _this52;}_createClass(QuoteDAO,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"createAndReloadQuote",value:function createAndReloadQuote(unsavedRecord,extraFields){var _this53=this;var model={quoteRecord:unsavedRecord,fieldsToReload:extraFields};return this._performCallout(this._quoteCreateReloadProvider,model,this._settings.labels.msg_amendrenew_err_creating_quote).then(function(rec){var oppId=rec[_this53._salesCloudPrefix+'Opportunity2__c'];DataChangeTrackerInvoker.storeCreatedRecordIds([rec.Id],rec.attributes.type,[oppId]);return rec;});}},{key:"saveQuotes",value:function saveQuotes(qvos){var _this54=this;var msgHeader=this._settings.labels.msg_amendrenew_err_saving_quotes;this._logMessage('QuoteDAO.js: Save quote. SessionId='+this._settings.userId);var saveChildRecordsStartTime=Date.now();var saveRecordsStartTime=Date.now();return this._saveRecords(this._quoteSaveProvider,qvos.map(function(qvo){return qvo.record;}),msgHeader).then(function(){_this54._logMessage('QuoteDAO.js: Saving quote took '+(Date.now()-saveRecordsStartTime)+' ms. SessionId='+_this54._settings.userId);_this54._logMessage('QuoteDAO.js: Save quote children records. SessionId='+_this54._settings.userId);return _this54._saveChildRecords(qvos).then(function(updatedVos){_this54._logMessage('QuoteDAO.js: Saving quote childdren records took '+(Date.now()-saveChildRecordsStartTime)+' ms. SessionId='+_this54._settings.userId);return updatedVos;});});}},{key:"saveRequeryRollbackIncompleteLines",value:function saveRequeryRollbackIncompleteLines(lines,fieldNames){var records=lines.map(function(line){return line.record;});return this._saveRequeryRollbackRecords(this._lineSaveRequeryRollbackProvider,records,this._settings.labels.msg_amendrenew_err_saving_contracted_prices,fieldNames);}},{key:"deleteQuotes",value:function deleteQuotes(qvos){var _this55=this;var msgHeader=this._settings.labels.msg_amendrenew_err_deleting_quotes;var records=[];qvos.forEach(function(qvo){if(qvo.record.Id){records.push({Id:qvo.record.Id});}});this._logMessage('QuoteDAO.js: Delete quote. SessionId='+this._settings.userId);var deleteQuoteStartTime=Date.now();return this._performCallout(this._quoteDeleteProvider,records,msgHeader).then(function(){_this55._logMessage('QuoteDAO.js: Deleting quote took '+(Date.now()-deleteQuoteStartTime)+' ms. SessionId='+_this55._settings.userId);DataChangeTrackerInvoker.unstoreCreatedRecordIds(qvos.map(function(qvo){return qvo.record.Id;}));return qvos;});}},{key:"_saveChildRecords",value:function _saveChildRecords(qvos){var _this56=this;var updatedVos=[];var saveQuoteChildrenRecursively=function saveQuoteChildrenRecursively(index){var saveGroupsStartTime=void 0;var saveLinesStartTime=void 0;if(index>=qvos.length){_this56._logMessage('QuoteDAO.js: Saving quote children recursively took '+(Date.now()-saveQuoteChildrenRecursivelyStartTime)+' ms. SessionId='+_this56._settings.userId);return Promise.resolve(updatedVos);}else{_this56._logMessage('QuoteDAO.js: Save groups. SessionId='+_this56._settings.userId);saveGroupsStartTime=Date.now();return _this56._saveGroups(qvos[index]).then(function(qvo){_this56._logMessage('QuoteDAO.js: Saving groups took '+(Date.now()-saveGroupsStartTime)+' ms. SessionId='+_this56._settings.userId);_this56._logMessage('QuoteDAO.js: Save Lines. SessionId='+_this56._settings.userId);saveLinesStartTime=Date.now();return _this56._saveLines(qvo);}).then(function(qvo){_this56._logMessage('QuoteDAO.js: Saving Lines took '+(Date.now()-saveLinesStartTime)+' ms. SessionId='+_this56._settings.userId);_this56._logMessage('QuoteDAO.js: Saving quote children recursively took '+(Date.now()-saveQuoteChildrenRecursivelyStartTime)+' ms. SessionId='+_this56._settings.userId);updatedVos.push(qvo);_this56._logMessage('QuoteDAO.js: Save quote children recursively. SessionId='+_this56._settings.userId);saveQuoteChildrenRecursivelyStartTime=Date.now();return saveQuoteChildrenRecursively(index+1);});}};this._logMessage('QuoteDAO.js: Save quote children recursively. SessionId='+this._settings.userId);var saveQuoteChildrenRecursivelyStartTime=Date.now();return saveQuoteChildrenRecursively(0);}},{key:"_saveGroups",value:function _saveGroups(qvo){var _this57=this;if(!qvo.lineItemGroups||qvo.lineItemGroups.length===0){return Promise.resolve(qvo);}var msgHeader=this._settings.labels.msg_amendrenew_err_saving_quote_groups;return this._saveRecords(this._groupSaveProvider,qvo.lineItemGroups.map(function(gvo){return gvo.record;}),msgHeader).then(function(newGroupIds){_this57._assignGroupIdsToGroupsAndContainedLines(qvo,newGroupIds);return qvo;});}},{key:"_assignGroupIdsToGroupsAndContainedLines",value:function _assignGroupIdsToGroupsAndContainedLines(qvo,idsOfNewGroups){var groupIdsByKey=new Map();for(var i=0;i<qvo.lineItemGroups.length;i++){var groupVo=qvo.lineItemGroups[i];var id=idsOfNewGroups[i];groupVo.record.Id=id;groupIdsByKey.set(groupVo.key,id);}for(var _i3=0;_i3<qvo.lineItems.length;_i3++){var lineVo=qvo.lineItems[_i3];lineVo.record[this._salesCloudPrefix+'Group__c']=groupIdsByKey.get(lineVo.parentGroupKey);}}},{key:"_saveLines",value:function _saveLines(qvo){var _this58=this;if(!qvo.lineItems||qvo.lineItems.length===0){return Promise.resolve(qvo);}var msgHeader=this._settings.labels.msg_amendrenew_err_saving_quote_lines;return this._saveRecords(this._lineInsertProvider,qvo.lineItems.map(function(lvo){return lvo.record;}),msgHeader).then(function(newLineIds){_this58._assignIdsAndParentIdsToLines(qvo,newLineIds);var parentLineIdField=_this58._salesCloudPrefix+'RequiredBy__c';var recordsWithParentInfo=[];qvo.lineItems.forEach(function(lvo){if(lvo.record[parentLineIdField]){recordsWithParentInfo.push(_defineProperty({Id:lvo.record.Id},parentLineIdField,lvo.record[parentLineIdField]));}});return recordsWithParentInfo.length>0?_this58._saveRecords(_this58._lineUpdateProvider,recordsWithParentInfo,msgHeader):Promise.resolve();}).then(function(){return qvo;});}},{key:"_assignIdsAndParentIdsToLines",value:function _assignIdsAndParentIdsToLines(qvo,newLineIds){var _this59=this;var lineIdsByKey=new Map();for(var i=0;i<qvo.lineItems.length;i++){var lvo=qvo.lineItems[i];var newLineId=newLineIds[i];lineIdsByKey.set(lvo.key,newLineId);lvo.record.Id=newLineId;}qvo.lineItems.forEach(function(lvo){lvo.record[_this59._salesCloudPrefix+'RequiredBy__c']=lvo.parentItemKey?lineIdsByKey.get(lvo.parentItemKey):null;});}},{key:"uncheckPrimaryQuotes",value:function uncheckPrimaryQuotes(quoteIdsToUpdate){var _this60=this;var originalRecords=[];var updatedRecords=[];var primaryField=this._settings.salesCloudPrefix+'Primary__c';quoteIdsToUpdate.forEach(function(qId){originalRecords.push(_defineProperty({attributes:{type:_this60._settings.salesCloudPrefix+'Quote__c'},Id:qId},primaryField,true));updatedRecords.push(_defineProperty({Id:qId},primaryField,false));});return this._saveRecords(this._quoteUncheckPrimaryProvider,updatedRecords,this._settings.labels.msg_amendrenew_err_saving_quotes).then(function(){DataChangeTrackerInvoker.storeChangedRecords(originalRecords);});}},{key:"_saveRecords",value:function _saveRecords(saveProvider,records,errMsgHeader){var _this61=this;var ids=[];var batchSize=200;var performCalloutRecursively=function performCalloutRecursively(index){if(index>=records.length){_this61._logMessage('QuoteDAO.js: Saving record recursively took '+(Date.now()-performCalloutRecursivelyStartTime)+' ms. SessionId='+_this61._settings.userId);return Promise.resolve(ids);}else{return _this61._performCallout(saveProvider,records.slice(index,index+batchSize),errMsgHeader).then(function(newIds){_this61._logMessage('QuoteDAO.js: Saving record recursively took '+(Date.now()-performCalloutRecursivelyStartTime)+' ms. SessionId='+_this61._settings.userId);ids=ids.concat(newIds);_this61._logMessage('QuoteDAO.js: Save record recursively. SessionId='+_this61._settings.userId);performCalloutRecursivelyStartTime=Date.now();return performCalloutRecursively(index+batchSize);});}};this._logMessage('QuoteDAO.js: Save record recursively. SessionId='+this._settings.userId);var performCalloutRecursivelyStartTime=Date.now();return performCalloutRecursively(0);}},{key:"_saveRequeryRollbackRecords",value:function _saveRequeryRollbackRecords(saveProvider,records,errMsgHeader,fieldsToReQuery){var _this62=this;var newRecords=[];var batchSize=200;var performCalloutRecursively=function performCalloutRecursively(index){if(index>=records.length){_this62._logMessage('QuoteDAO.js: Saving record recursively took '+(Date.now()-performCalloutRecursivelyStartTime)+' ms. SessionId='+_this62._settings.userId);return Promise.resolve(newRecords);}else{var serviceModel={'fields':fieldsToReQuery,'lines':records.slice(index,index+batchSize)};return _this62._performCallout(saveProvider,serviceModel,errMsgHeader).then(function(results){_this62._logMessage('QuoteDAO.js: Saving record recursively took '+(Date.now()-performCalloutRecursivelyStartTime)+' ms. SessionId='+_this62._settings.userId);newRecords=newRecords.concat(results);_this62._logMessage('QuoteDAO.js: Save record recursively. SessionId='+_this62._settings.userId);performCalloutRecursivelyStartTime=Date.now();return performCalloutRecursively(index+batchSize);});return performCalloutRecursively(index+batchSize);}};this._logMessage('QuoteDAO.js: Save record recursively. SessionId='+this._settings.userId);var performCalloutRecursivelyStartTime=Date.now();return performCalloutRecursively(0);}},{key:"_performCallout",value:function _performCallout(saveProvider,model,errMsgHeader){var _this63=this;this._logMessage('QuoteDAO.js: APEX Rest API Call Out ('+saveProvider+'). SessionId='+this._settings.userId);var apexRestCallOutStartTime=Date.now();return this._conn.apex.post(this._serviceRouterUrl,{saver:saveProvider,model:JSON.stringify(model)}).then(function(res){_this63._logMessage('QuoteDAO.js: APEX Rest API Call Out ('+saveProvider+') took '+(Date.now()-apexRestCallOutStartTime)+' ms. SessionId='+_this63._settings.userId);if(res.toLowerCase()==='success'){return[];}else{return JSON.parse(res);}},function(err){var msg=err.message||err;return Promise.reject(errMsgHeader+msg);});}}]);return QuoteDAO;}(BaseDAO);module.exports=QuoteDAO;},{"../../Utils/DAOs/BaseDAO.js":2,"../cleaners/DataChangeTrackerInvoker.js":29,"js-logger":58}],18:[function(require,module,exports){'use strict';var IdToValueCache=require('../../Utils/IdToValueCache.js');var DAOHelperMethods=require('../../Utils/DAOs/DAOHelperMethods.js');var BaseDAO=require('../../Utils/DAOs/BaseDAO.js').BaseDAO;var BaseSubqueryDescriptor=require('../../Utils/DAOs/BaseDAO.js').BaseSubqueryDescriptor;var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var cacheManager=require('../../Utils/CacheManager.js').cacheManager;var SUB_CLI_ASSET_FIELDS=['Id','ChargeType__c','BillingType__c','BillingFrequency__c','DynamicOptionId__c','ProductOption__c','RequiredById__c','RequiredByProduct__c','DiscountSchedule__c','TermDiscountSchedule__c','ComponentDiscountedByPackage__c','OptionLevel__c','OptionType__c','OptionDiscount__c','OptionDiscountAmount__c','Bundled__c','Bundle__c','PartnerDiscount__c','DistributorDiscount__c','Discount__c','UnitCost__c','ListPrice__c','OriginalUnitCost__c','MarkupRate__c','MarkupAmount__c','DiscountScheduleType__c','AdditionalDiscountAmount__c','RootId__c','PackageProductDescription__c','PackageProductCode__c','RenewalUpliftRate__c','SegmentKey__c','SegmentIndex__c','SegmentLabel__c','Dimension__c','RegularPrice__c'];var SUB_CLI_FIELDS=['RenewalQuantity__c','ProrateMultiplier__c','RenewalPrice__c','CustomerPrice__c','ProductId__c','RenewalProductId__c','RenewalProductOptionId__c','RenewalProductOptionProductId__c','RevisedSubscription__c','Account__c','TerminatedDate__c','Quantity__c','ComponentSubscriptionScope__c','SegmentStartDate__c','SegmentEndDate__c','SegmentQuantity__c','SegmentUplift__c','SegmentUpliftAmount__c','HasConsumptionSchedule__c','DimensionType__c','ProductSubscriptionType__c','SubscriptionPricing__c','SubscriptionType__c'];var SUB_ONLY_FIELDS=['StartDate__c','EndDate__c','Contract__c'];var CLI_ONLY_FIELDS=['StartDate','EndDate','ServiceContractId'];var ASSET_ONLY_FIELDS=['Product2Id','Quantity','Price','RevisedAsset__c','UsageEndDate','VirtualAsset__c','CombineKey__c','RequiredByAsset__c','PriceDimension__c'];var ASSET_ONLY_SALES_CLOUD_FIELDS=['CurrentSubscription__c','RequiredBySubscription__c'];var ASSET_ONLY_SERVICE_CLOUD_FIELDS=['CurrentContractLineItem__c','RequiredByLineItem__c'];var SUBSCRIBED_ASSET_FIELDS=['Subscription__c','Asset__c','AssetRootId__c'];var ENTITLEMENT_FIELDS=['ContractLineItemId','AssetId','AssetRootId__c'];var CACHE_NAME='SourceRecordCache';var ASSETS_BY_ID_CACHE='assetsById';var ASSETS_BY_ROOT_ID_CACHE='assetsByRootId';var ASSETS_BY_SEGMENTKEY_CACHE='assetsBySegmentKey';var SubscribedAssetSubqueryDescriptor=function(_BaseSubqueryDescript2){_inherits(SubscribedAssetSubqueryDescriptor,_BaseSubqueryDescript2);function SubscribedAssetSubqueryDescriptor(subscribedAssetFields,subscribedAssetRelationship){_classCallCheck(this,SubscribedAssetSubqueryDescriptor);var _this64=_possibleConstructorReturn(this,(SubscribedAssetSubqueryDescriptor.__proto__||Object.getPrototypeOf(SubscribedAssetSubqueryDescriptor)).call(this));_this64._fields=subscribedAssetFields;_this64._relationship=subscribedAssetRelationship;return _this64;}_createClass(SubscribedAssetSubqueryDescriptor,[{key:"addSubqueriesToQuery",value:function addSubqueriesToQuery(query){if(this._fields&&this._relationship){query=query.include(this._relationship).select(this._fields.join(', ')).end();}}}]);return SubscribedAssetSubqueryDescriptor;}(BaseSubqueryDescriptor);var SourceRecordDAO=function(_BaseDAO10){_inherits(SourceRecordDAO,_BaseDAO10);function SourceRecordDAO(conn,settings,services){_classCallCheck(this,SourceRecordDAO);var _this65=_possibleConstructorReturn(this,(SourceRecordDAO.__proto__||Object.getPrototypeOf(SourceRecordDAO)).call(this,conn,settings.labels));_this65._settings=settings;_this65._isServiceCloudEnabled=_this65._settings.isServiceCloudEnabled;_this65._salesCloudPrefix=_this65._settings.salesCloudPrefix;_this65._serviceCloudPrefix=_this65._settings.serviceCloudPrefix;_this65._prefix=_this65._settings.prefix;_this65._services=services;_this65._cache=cacheManager.getCache(CACHE_NAME);_this65._initialized=false;_this65._logger=jsLogger;return _this65;}_createClass(SourceRecordDAO,[{key:"_identifyUncachedKeys",value:function _identifyUncachedKeys(innerKeys,innerCacheName,innerCacheConstructor){var cachedResults=this._cache.get(innerCacheName);if(!cachedResults){cachedResults=new(innerCacheConstructor||Map)();this._cache.set(innerCacheName,cachedResults);return innerKeys;}else{return innerKeys.filter(function(key){return!cachedResults.has(key);});}}},{key:"loadSubscriptions",value:function loadSubscriptions(subIds){var _this66=this;return this._init().then(function(){return _this66._getSubsByOriginalIdsAsArray(subIds);});}},{key:"loadSourceRecordsRelatedToContracts",value:function loadSourceRecordsRelatedToContracts(contracts,checkSubscribedAssetCount){var _this67=this;checkSubscribedAssetCount=checkSubscribedAssetCount||false;var resultObject={};var cIds=contracts.map(function(contract){return contract.Id;});var getSubsByContractIdsStartTime=void 0;var getAssetsBySubAndContractStartTime=void 0;var initStartTime=Date.now();this._logMessage('SourceRecordDAO.js: Initialization. SessionId='+this._settings.userId);return this._init().then(function(){_this67._logMessage('SourceRecordDAO.js: Initialization took '+(Date.now()-initStartTime)+' ms. SessionId='+_this67._settings.userId);_this67._logMessage('SourceRecordDAO.js: Get subs by contract Ids. SessionId='+_this67._settings.userId);getSubsByContractIdsStartTime=Date.now();return _this67._getSubsByContractIds(cIds);}).then(function(subsByContractId){_this67._logMessage('SourceRecordDAO.js: Getting subs by contract Ids took '+(Date.now()-getSubsByContractIdsStartTime)+' ms. SessionId='+_this67._settings.userId);resultObject.subsByContractId=subsByContractId;_this67._logMessage('SourceRecordDAO.js: Get assets by sub and contract. SessionId='+_this67._settings.userId);getAssetsBySubAndContractStartTime=Date.now();return _this67._getAssetsRelatedToContracts(contracts,subsByContractId);}).then(function(assets){_this67._logMessage('SourceRecordDAO.js: Getting assets by sub and contract took '+(Date.now()-getAssetsBySubAndContractStartTime)+' ms. SessionId='+_this67._settings.userId);var coveredAssetsById=assets[0];var bundledAssetsByRootId=assets[1];var segmentedAssetsBySegmentKey=assets[2];var subPrefix=_this67._isServiceCloudEnabled?_this67._serviceCloudPrefix:_this67._salesCloudPrefix;var subscribedAssetIdField=_this67._isServiceCloudEnabled?'AssetId':_this67._salesCloudPrefix+'Asset__c';var assetsByContractId=new IdToValueCache();cIds.forEach(function(cId){var subList=resultObject.subsByContractId.get(cId)||[];var desiredRootIds=new Set();var desiredAssetIds=new Set();var desiredSegmentKeys=new Set();subList.forEach(function(sub){var rootId=sub[subPrefix+'RootId__c'];if(rootId){desiredRootIds.add(rootId.slice(0,15));}var segmentKey=sub[subPrefix+'SegmentKey__c'];if(segmentKey){desiredSegmentKeys.add(segmentKey);}var subscribedAssets=sub[_this67._subscribedAssetRelationshipName];if(subscribedAssets&&subscribedAssets.totalSize>0){if(checkSubscribedAssetCount&&sub[subPrefix+'SubscriptionPricing__c']==='Percent Of Total'&&!subscribedAssets.done){throw new Error(_this67._settings.labels.msg_amendrenew_pot_total_incorrect);}var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=subscribedAssets.records[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var subscribedAsset=_step5.value;var assetId=subscribedAsset[subscribedAssetIdField];if(_this67._isCoveredAsset(assetId,sub)){desiredAssetIds.add(assetId);}var assetRootId=subscribedAsset[subPrefix+'AssetRootId__c'];if(assetRootId){desiredRootIds.add(assetRootId.slice(0,15));}}}catch(err){_didIteratorError5=true;_iteratorError5=err;}finally{try{if(!_iteratorNormalCompletion5&&_iterator5.return){_iterator5.return();}}finally{if(_didIteratorError5){throw _iteratorError5;}}}}});var relevantAssets=[];desiredRootIds.forEach(function(rootId){var assetsWithDesiredRootId=bundledAssetsByRootId.get(rootId);if(assetsWithDesiredRootId&&assetsWithDesiredRootId.length>0){relevantAssets=relevantAssets.concat(assetsWithDesiredRootId);}});desiredSegmentKeys.forEach(function(segmentKey){var assetsWithDesiredSegmentKey=segmentedAssetsBySegmentKey.get(segmentKey);if(assetsWithDesiredSegmentKey&&assetsWithDesiredSegmentKey.length>0){relevantAssets=relevantAssets.concat(assetsWithDesiredSegmentKey);}});desiredAssetIds.forEach(function(assetId){var asset=coveredAssetsById.get(assetId);relevantAssets.push(asset);});var uniqueIdSet=new Set();var uniqueAssets=relevantAssets.filter(function(asset){if(uniqueIdSet.has(asset.Id)){return false;}uniqueIdSet.add(asset.Id);return true;});assetsByContractId.set(cId,uniqueAssets);});resultObject.assetsByContractId=assetsByContractId;return resultObject;}).catch(function(err){var errHeader=_this67._settings.labels.msg_amendrenew_err_loading_source_recs;return Promise.reject(errHeader+(err.message||err));});}},{key:"loadSourceRecordsRelatedToSubscriptions",value:function loadSourceRecordsRelatedToSubscriptions(subs,contractsById,isRenewal){var _this68=this;var selectedSubsArray=void 0;var referencedSubsMap=void 0;var subsByContractId=void 0;var contracts=Array.from(contractsById.values());var resultObject={};var cIds=void 0;var getReferencedAssetsStartTime=void 0;this._logMessage('SourceRecordDAO.js: Initialization. SessionId='+this._settings.userId);return this._init().then(function(){cIds=Array.from(contractsById.keys());return _this68._getReferencedSubsByRootIdAndContractId(subs,contractsById,isRenewal);}).then(function(returnedSubsMap){var arrays=Array.from(returnedSubsMap.values());var newSubs=[].concat.apply([],arrays);var combinedSubs=[].concat(_toConsumableArray(subs),_toConsumableArray(newSubs));subsByContractId=_this68._mapSubsByContractIds(cIds,combinedSubs);resultObject.subsByContractId=subsByContractId;_this68._logMessage('SourceRecordDAO.js: Get assets by sub and contract. SessionId='+_this68._settings.userId);getReferencedAssetsStartTime=Date.now();return _this68._getAssetsRelatedToContracts(contracts,subsByContractId);}).then(function(assets){_this68._logMessage('SourceRecordDAO.js: Loading referenced assets by their ID and RootAssetId took '+(Date.now()-getReferencedAssetsStartTime)+' ms. SessionId='+_this68._settings.userId);var coveredAssetsById=assets[0];var bundledAssetsByRootId=assets[1];var segmentedAssetsBySegmentKey=assets[2];var subPrefix=_this68._isServiceCloudEnabled?_this68._serviceCloudPrefix:_this68._salesCloudPrefix;var subscribedAssetIdField=_this68._isServiceCloudEnabled?'AssetId':_this68._salesCloudPrefix+'Asset__c';var processedAssets={};var assetsByContractId=new IdToValueCache();cIds.forEach(function(cId){var subList=resultObject.subsByContractId.get(cId)||[];var desiredRootIds=new Set();var desiredAssetIds=new Set();var desiredSegmentKeys=new Set();subList.forEach(function(sub){var rootId=sub[subPrefix+'RootId__c'];if(rootId){desiredRootIds.add(rootId.slice(0,15));}var segmentKey=sub[subPrefix+'SegmentKey__c'];if(segmentKey){desiredSegmentKeys.add(segmentKey);}var subscribedAssets=sub[_this68._subscribedAssetRelationshipName];if(subscribedAssets&&subscribedAssets.totalSize>0){var _iteratorNormalCompletion6=true;var _didIteratorError6=false;var _iteratorError6=undefined;try{for(var _iterator6=subscribedAssets.records[Symbol.iterator](),_step6;!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=true){var subscribedAsset=_step6.value;var assetId=subscribedAsset[subscribedAssetIdField];if(_this68._isCoveredAsset(assetId,sub)){desiredAssetIds.add(assetId);}var assetRootId=subscribedAsset[subPrefix+'AssetRootId__c'];if(assetRootId){desiredRootIds.add(assetRootId.slice(0,15));}}}catch(err){_didIteratorError6=true;_iteratorError6=err;}finally{try{if(!_iteratorNormalCompletion6&&_iterator6.return){_iterator6.return();}}finally{if(_didIteratorError6){throw _iteratorError6;}}}}});var relevantAssets=[];desiredRootIds.forEach(function(rootId){var assetsWithDesiredRootId=bundledAssetsByRootId.get(rootId);if(assetsWithDesiredRootId&&assetsWithDesiredRootId.length>0){relevantAssets=relevantAssets.concat(assetsWithDesiredRootId);}});desiredSegmentKeys.forEach(function(segmentKey){var assetsWithDesiredSegmentKey=segmentedAssetsBySegmentKey.get(segmentKey);if(assetsWithDesiredSegmentKey&&assetsWithDesiredSegmentKey.length>0){relevantAssets=relevantAssets.concat(assetsWithDesiredSegmentKey);}});desiredAssetIds.forEach(function(assetId){var asset=coveredAssetsById.get(assetId);relevantAssets.push(asset);});var uniqueIdSet=new Set();var uniqueAssets=relevantAssets.filter(function(asset){if(uniqueIdSet.has(asset.Id)){return false;}uniqueIdSet.add(asset.Id);return true;});assetsByContractId.set(cId,uniqueAssets);});resultObject.assetsByContractId=assetsByContractId;return resultObject;}).catch(function(err){var errHeader='Could not load source records for QLE amend/renew: ';return Promise.reject(errHeader+(err.message||err));});}},{key:"_init",value:function _init(){var _this69=this;if(this._initialized){return Promise.resolve();}else{var lineType=this._salesCloudPrefix+'QuoteLine__c';var promises=[];promises.push(this._services.fieldMetadataService.getSharedMappableFieldNames(this._subRecType,lineType));promises.push(this._services.fieldMetadataService.getSharedMappableFieldNames('Asset',lineType));return Promise.all(promises).then(function(res){_this69._subMappableFields=res[0];_this69._assetMappableFields=res[1];_this69._initialized=true;});}}},{key:"_getAssetsRelatedToContracts",value:function _getAssetsRelatedToContracts(contracts,subsByContractId){var _this70=this;var prefix=this._isServiceCloudEnabled?this._serviceCloudPrefix:this._salesCloudPrefix;var contractCount=contracts.length;var desiredAssetIdsByContractId=new Map();var desiredSuperParentsByContractId=new Map();var desiredSegmentKeySet=new Set();var _loop5=function _loop5(i){var c=contracts[i];var preserveBundle=c[prefix+'PreserveBundleStructureUponRenewals__c'];var subs=subsByContractId.get(c.Id);var subCount=subs.length;var _loop6=function _loop6(j){var sub=subs[j];var subscribedAssets=sub[_this70._subscribedAssetRelationshipName];if(subscribedAssets&&subscribedAssets.totalSize){subscribedAssets.records.forEach(function(sa){var assetIdField=_this70._isServiceCloudEnabled?'AssetId':_this70._salesCloudPrefix+'Asset__c';var assetId=sa[assetIdField];if(!_this70._isCoveredAsset(assetId,sub)){return;}else if(!desiredAssetIdsByContractId.has(c.Id)){desiredAssetIdsByContractId.set(c.Id,[]);}desiredAssetIdsByContractId.get(c.Id).push(assetId);if(!preserveBundle||!sa[prefix+'AssetRootId__c']){return;}else if(!desiredSuperParentsByContractId.has(c.Id)){desiredSuperParentsByContractId.set(c.Id,new Set());}desiredSuperParentsByContractId.get(c.Id).add(sa[prefix+'AssetRootId__c']);});}if(preserveBundle&&sub[prefix+'RootId__c']){if(!desiredSuperParentsByContractId.has(c.Id)){desiredSuperParentsByContractId.set(c.Id,new Set());}desiredSuperParentsByContractId.get(c.Id).add(sub[prefix+'RootId__c']);}if(subs[j][prefix+'SegmentKey__c']!=null){desiredSegmentKeySet.add(subs[j][prefix+'SegmentKey__c']);}};for(var j=0;j<subCount;j++){_loop6(j);}};for(var i=0;i<contractCount;i++){_loop5(i);}var assetIdsToQuery=[].concat.apply([],Array.from(desiredAssetIdsByContractId.values()));var rootIdsToQueryBy=[];var _iteratorNormalCompletion7=true;var _didIteratorError7=false;var _iteratorError7=undefined;try{for(var _iterator7=desiredSuperParentsByContractId[Symbol.iterator](),_step7;!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=true){var _step7$value=_slicedToArray(_step7.value,2),contractId=_step7$value[0],rootIdsSet=_step7$value[1];rootIdsSet.forEach(function(rootId){return rootIdsToQueryBy.push(rootId);});}}catch(err){_didIteratorError7=true;_iteratorError7=err;}finally{try{if(!_iteratorNormalCompletion7&&_iterator7.return){_iterator7.return();}}finally{if(_didIteratorError7){throw _iteratorError7;}}}var segmentKeysToQuery=Array.from(desiredSegmentKeySet);return Promise.all([this._getAssetsByIds(assetIdsToQuery),this._getAssetsByRootIds(rootIdsToQueryBy),this._getAssetsBySegmentKeys(segmentKeysToQuery)]);}},{key:"_getSubsByContractIds",value:function _getSubsByContractIds(cIds){var _this71=this;var idsWithoutCachedResult=this._identifyUncachedKeys(cIds,'subsByContractId',IdToValueCache);var missingRecordsPromise=idsWithoutCachedResult.length>0?this._queryAndCacheSubscriptionsOnMissingContracts(idsWithoutCachedResult):Promise.resolve();return missingRecordsPromise.then(function(){var results=new IdToValueCache();cIds.forEach(function(cId){results.set(cId,_this71._cache.get('subsByContractId').get(cId)||[]);});return results;});}},{key:"_mapSubsByContractIds",value:function _mapSubsByContractIds(cIds,subs){var _this72=this;var results=new IdToValueCache();cIds.forEach(function(cId){var subsWithContractId=subs.filter(function(sub){return sub[_this72._subLookupToContract].slice(0,15)===cId.slice(0,15);});results.set(cId,subsWithContractId);});return results;}},{key:"_getSubsByOriginalIdsAsArray",value:function _getSubsByOriginalIdsAsArray(subIds){var _this73=this;var idsWithoutCachedResult=this._identifyUncachedKeys(subIds,'subsByOriginalId',IdToValueCache);var missingRecordsPromise=idsWithoutCachedResult.length>0?this._queryAndCacheSubscriptionsByOriginalIds(idsWithoutCachedResult):Promise.resolve();return missingRecordsPromise.then(function(){var results=[];subIds.forEach(function(subId){var cachedSubs=_this73._cache.get('subsByOriginalId').get(subId)||[];results=results.concat(cachedSubs);});return results;});}},{key:"_getAssetsByIds",value:function _getAssetsByIds(assetIds){var _this74=this;var idsWithoutCachedResult=this._identifyUncachedKeys(assetIds,ASSETS_BY_ID_CACHE,IdToValueCache);var missingRecordsPromise=idsWithoutCachedResult.length>0?this._queryAndCacheAssetsByIds(idsWithoutCachedResult):Promise.resolve();return missingRecordsPromise.then(function(){var result=new IdToValueCache();var assetsCachedById=_this74._cache.get(ASSETS_BY_ID_CACHE);assetIds.forEach(function(assetId){result.set(assetId,assetsCachedById.get(assetId));});return result;});}},{key:"_getAssetsByRootIds",value:function _getAssetsByRootIds(rootIds){var _this75=this;var idsWithoutCachedResult=this._identifyUncachedKeys(rootIds,ASSETS_BY_ROOT_ID_CACHE,IdToValueCache);var missingRecordsPromise=idsWithoutCachedResult.length>0?this._queryAndCacheAssetsByRootIds(idsWithoutCachedResult):Promise.resolve();return missingRecordsPromise.then(function(){var result=new IdToValueCache();var assetArraysByRootId=_this75._cache.get(ASSETS_BY_ROOT_ID_CACHE);rootIds.forEach(function(rootId){result.set(rootId,assetArraysByRootId.get(rootId));});return result;});}},{key:"_getAssetsBySegmentKeys",value:function _getAssetsBySegmentKeys(segmentKeys){var _this76=this;var keysWithoutCachedResult=this._identifyUncachedKeys(segmentKeys,ASSETS_BY_SEGMENTKEY_CACHE);var missingRecordsPromise=keysWithoutCachedResult.length>0?this._queryAndCacheAssetsBySegmentKeys(keysWithoutCachedResult):Promise.resolve();return missingRecordsPromise.then(function(){var result=new Map();var assetArraysBySegmentKey=_this76._cache.get(ASSETS_BY_SEGMENTKEY_CACHE);segmentKeys.forEach(function(segmentKey){result.set(segmentKey,assetArraysBySegmentKey.get(segmentKey));});return result;});}},{key:"_getReferencedSubsByRootIdAndContractId",value:function _getReferencedSubsByRootIdAndContractId(selectedSubs,contractsById,isRenewal){var _this77=this;var contractRootPairSet=new Set();var prefix=this._isServiceCloudEnabled?this._serviceCloudPrefix:this._salesCloudPrefix;var rootIdField=prefix+'RootId__c';var bundleStructure=prefix+'PreserveBundleStructureUponRenewals__c';var subscribedAssetToAssetLookup=this._isServiceCloudEnabled?'Asset':this._salesCloudPrefix+'Asset__r';var rootIdsByCacheKey=new Map();selectedSubs.forEach(function(sub){var contractId=sub[_this77._subLookupToContract].slice(0,15);if(sub[rootIdField]&&contractsById.get(contractId)[bundleStructure]){var mainKey=contractId+'_'+sub[rootIdField].slice(0,15);contractRootPairSet.add(mainKey);rootIdsByCacheKey.set(mainKey,sub[rootIdField]);}var subscribedAssets=sub[_this77._subscribedAssetRelationshipName];if(subscribedAssets&&subscribedAssets.totalSize>0){var _iteratorNormalCompletion8=true;var _didIteratorError8=false;var _iteratorError8=undefined;try{for(var _iterator8=subscribedAssets.records[Symbol.iterator](),_step8;!(_iteratorNormalCompletion8=(_step8=_iterator8.next()).done);_iteratorNormalCompletion8=true){var subscribedAsset=_step8.value;var assetRootId=subscribedAsset[prefix+'AssetRootId__c'];if(assetRootId!=null&&assetRootId!=''){var _mainKey=contractId+'_'+assetRootId.slice(0,15);contractRootPairSet.add(_mainKey);rootIdsByCacheKey.set(_mainKey,assetRootId);}}}catch(err){_didIteratorError8=true;_iteratorError8=err;}finally{try{if(!_iteratorNormalCompletion8&&_iterator8.return){_iterator8.return();}}finally{if(_didIteratorError8){throw _iteratorError8;}}}}});var contractRootPairArray=[].concat(_toConsumableArray(contractRootPairSet));var pairingsWithoutCachedResult=this._identifyUncachedKeys(contractRootPairArray,'subsByContractRootPair');var missingRecordsPromise=void 0;if(pairingsWithoutCachedResult.length>0){var rootIdsByContractId=new IdToValueCache();pairingsWithoutCachedResult.forEach(function(key){var contractId=key.split('_')[0];var rootId=rootIdsByCacheKey.get(key);if(rootIdsByContractId.has(contractId)){rootIdsByContractId.get(contractId).push(rootId);}else{rootIdsByContractId.set(contractId,[rootId]);}});missingRecordsPromise=this._queryAndCacheReferencedSubscriptionsByRootIdsAndContractIds(rootIdsByContractId,isRenewal);}else{missingRecordsPromise=Promise.resolve();}return missingRecordsPromise.then(function(){var results=new IdToValueCache();contractRootPairArray.forEach(function(pair){var cachedRecords=_this77._cache.get('subsByContractRootPair').get(pair);var rootId=pair.split('_')[1];var premappedRecords=results.get(rootId)||[];results.set(rootId,premappedRecords.concat(cachedRecords));});return results;});}},{key:"_isCoveredAsset",value:function _isCoveredAsset(assetId,sub){var prefix=this._isServiceCloudEnabled?this._serviceCloudPrefix:this._salesCloudPrefix;var subscriptionPricingMethod=prefix+'SubscriptionPricing__c';return assetId!=null&&sub[subscriptionPricingMethod]!='Fixed Price';}},{key:"_queryAndCacheSubscriptionsByOriginalIds",value:function _queryAndCacheSubscriptionsByOriginalIds(sIds){var _this78=this;var subPrefix=this._isServiceCloudEnabled?this._serviceCloudPrefix:this._salesCloudPrefix;var revisedIdField=subPrefix+'RevisedSubscription__c';var inExpr=" IN ('"+sIds.join("', '")+"')";var originalIdClause="Id"+inExpr;var revisedIdClause=revisedIdField+inExpr;var callback=function callback(subs){var cachedSubsByOriginalId=_this78._cache.get('subsByOriginalId');subs.forEach(function(sub){var idKey=void 0;if(sub[revisedIdField]){idKey=sub[revisedIdField];}else{idKey=sub.Id;}if(cachedSubsByOriginalId.has(idKey)){cachedSubsByOriginalId.get(idKey).push(sub);}else{cachedSubsByOriginalId.set(idKey,[sub]);}});};var whereClause=originalIdClause+" OR "+revisedIdClause;return this._querySubscriptionsAndRunCallback(this._constructAndPerformQuery,whereClause,callback);}},{key:"_queryAndCacheAssetsByIds",value:function _queryAndCacheAssetsByIds(assetIds){var _this79=this;var callback=function callback(assets){var cachedSubsById=_this79._cache.get(ASSETS_BY_ID_CACHE);assets.forEach(function(asset){cachedSubsById.set(asset.Id,asset);});};var whereClause="Id IN ('"+assetIds.join("', '")+"')";return this._queryAssetsAndRunCallback(this._constructAndPerformQuery,whereClause,callback);}},{key:"_queryAndCacheAssetsByRootIds",value:function _queryAndCacheAssetsByRootIds(rootIds){var _this80=this;var rootIdField=this._salesCloudPrefix+'RootId__c';var revisedRootIdField=this._revisedAssetRelationshipName+'.'+rootIdField;var rootIdsInExpr=" IN ('"+rootIds.join("', '")+"')";var clauseArray=[];var callback=function callback(assets){var cachedAssetsByRootId=_this80._cache.get(ASSETS_BY_ROOT_ID_CACHE);assets.forEach(function(asset){var rootId=asset[rootIdField]||asset[_this80._revisedAssetRelationshipName][rootIdField];if(cachedAssetsByRootId.has(rootId)){cachedAssetsByRootId.get(rootId).push(asset);}else{cachedAssetsByRootId.set(rootId,[asset]);}});rootIds.forEach(function(rootId){if(!cachedAssetsByRootId.has(rootId)){cachedAssetsByRootId.set(rootId,[]);}});};clauseArray.push('('+rootIdField+rootIdsInExpr+' AND '+rootIdField+' != null'+')');clauseArray.push('('+revisedRootIdField+rootIdsInExpr+' AND '+revisedRootIdField+' != null'+')');var whereClause=clauseArray.join(" OR ");return this._queryAssetsAndRunCallback(this._constructAndPerformQuery,whereClause,callback);}},{key:"_queryAndCacheAssetsBySegmentKeys",value:function _queryAndCacheAssetsBySegmentKeys(segmentKeys){var _this81=this;var segmentKeyField=this._salesCloudPrefix+'SegmentKey__c';var segmentKeysInExpr=" IN ('"+segmentKeys.join("', '")+"')";var callback=function callback(assets){var cachedAssetsBySegmentKeys=_this81._cache.get(ASSETS_BY_SEGMENTKEY_CACHE);assets.forEach(function(asset){var segmentKey=asset[segmentKeyField];if(cachedAssetsBySegmentKeys.has(segmentKey)){cachedAssetsBySegmentKeys.get(segmentKey).push(asset);}else{cachedAssetsBySegmentKeys.set(segmentKey,[asset]);}});segmentKeys.forEach(function(segmentKey){if(!cachedAssetsBySegmentKeys.has(segmentKey)){cachedAssetsBySegmentKeys.set(segmentKey,[]);}});};var whereClause=segmentKeyField+segmentKeysInExpr;return this._queryAssetsAndRunCallback(this._constructAndPerformQuery,whereClause,callback);}},{key:"_queryAndCacheSubscriptionsOnMissingContracts",value:function _queryAndCacheSubscriptionsOnMissingContracts(cIds){var _this82=this;var callback=function callback(subs){var cachedSubsByContract=_this82._cache.get('subsByContractId');subs.forEach(function(sub){var cId=sub[_this82._subLookupToContract];if(cachedSubsByContract.has(cId)){cachedSubsByContract.get(cId).push(sub);}else{cachedSubsByContract.set(cId,[sub]);}});};var whereClause=this._subLookupToContract+" IN ('"+cIds.join("', '")+"')";return this._querySubscriptionsAndRunCallback(this._constructAndPerformQuery,whereClause,callback);}},{key:"_queryAndCacheReferencedSubscriptionsByRootIdsAndContractIds",value:function _queryAndCacheReferencedSubscriptionsByRootIdsAndContractIds(rootIdsByContractId,isRenewal){var _this83=this;var subPrefix=this._isServiceCloudEnabled?this._serviceCloudPrefix:this._salesCloudPrefix;var rootIdField=subPrefix+"RootId__c";var revisedSubIdField=subPrefix+'RevisedSubscription__c';var revisedRootIdField=revisedSubIdField.slice(0,-1)+'r.'+rootIdField;var contractPreservesBundle=(this._isServiceCloudEnabled?'ServiceContract':this._prefix+'Contract__r')+'.'+this._prefix+'PreserveBundleStructureUponRenewals__c = true';var clauseArray=[];var _iteratorNormalCompletion9=true;var _didIteratorError9=false;var _iteratorError9=undefined;try{for(var _iterator9=rootIdsByContractId[Symbol.iterator](),_step9;!(_iteratorNormalCompletion9=(_step9=_iterator9.next()).done);_iteratorNormalCompletion9=true){var _step9$value=_slicedToArray(_step9.value,2),_contractId=_step9$value[0],rootIds=_step9$value[1];var contractEqExpr=this._subLookupToContract+" = '"+_contractId+"'";var rootIdsInExpr=" IN ('"+rootIds.join("', '")+"')";var rootIdInSet=rootIdField+rootIdsInExpr;var revisedRootIdInSet=revisedRootIdField+rootIdsInExpr;var contractPreserveBundleForRenewal=' ';if(isRenewal||this._settings.canBypassPreserveBundleStructureOnAmend===true){contractPreserveBundleForRenewal=contractPreservesBundle+" AND ";}var clause="("+contractPreserveBundleForRenewal+contractEqExpr+" AND ("+rootIdInSet+" OR "+revisedRootIdInSet+"))";clauseArray.push(clause);}}catch(err){_didIteratorError9=true;_iteratorError9=err;}finally{try{if(!_iteratorNormalCompletion9&&_iterator9.return){_iterator9.return();}}finally{if(_didIteratorError9){throw _iteratorError9;}}}var whereClause=clauseArray.join(" OR ");var callback=function callback(subs){var cachedSubsByContractRootPair=_this83._cache.get('subsByContractRootPair');var revisionsByOriginalId=new IdToValueCache();var rootIdsByOriginalId=new IdToValueCache();subs.forEach(function(sub){var rootId=void 0;var contractId=sub[_this83._subLookupToContract];if(sub[rootIdField]){rootId=sub[rootIdField];var newResults=revisionsByOriginalId.has(sub.Id)?[sub].concat(revisionsByOriginalId.get(sub.Id)):[sub];var cacheKey=contractId.slice(0,15)+'_'+rootId.slice(0,15);var existingResults=cachedSubsByContractRootPair.get(cacheKey)||[];cachedSubsByContractRootPair.set(cacheKey,existingResults.concat(newResults));rootIdsByOriginalId.set(sub.Id,rootId);}else{var revisedSubId=sub[revisedSubIdField];if(rootIdsByOriginalId.has(revisedSubId)){rootId=rootIdsByOriginalId.get(revisedSubId).slice(0,15);var _cacheKey=contractId.slice(0,15)+'_'+rootId;cachedSubsByContractRootPair.get(_cacheKey).push(sub);}else if(revisionsByOriginalId.has(revisedSubId)){revisionsByOriginalId.get(revisedSubId).push(sub);}else{revisionsByOriginalId.set(revisedSubId,[sub]);}}});var _iteratorNormalCompletion10=true;var _didIteratorError10=false;var _iteratorError10=undefined;try{var _loop7=function _loop7(){var _step10$value=_slicedToArray(_step10.value,2),contractId=_step10$value[0],rootIds=_step10$value[1];rootIds.forEach(function(rootId){var cacheKey=contractId.slice(0,15)+'_'+rootId.slice(0,15);if(!cachedSubsByContractRootPair.has(cacheKey)){cachedSubsByContractRootPair.set(cacheKey,[]);}});};for(var _iterator10=rootIdsByContractId[Symbol.iterator](),_step10;!(_iteratorNormalCompletion10=(_step10=_iterator10.next()).done);_iteratorNormalCompletion10=true){_loop7();}}catch(err){_didIteratorError10=true;_iteratorError10=err;}finally{try{if(!_iteratorNormalCompletion10&&_iterator10.return){_iterator10.return();}}finally{if(_didIteratorError10){throw _iteratorError10;}}}};return this._querySubscriptionsAndRunCallback(this._constructAndPerformQuery,whereClause,callback);}},{key:"_getSelectedSubscriptionFields",value:function _getSelectedSubscriptionFields(){var selectedSubFields=SUB_CLI_ASSET_FIELDS.concat(SUB_CLI_FIELDS,this._isServiceCloudEnabled?CLI_ONLY_FIELDS:SUB_ONLY_FIELDS);selectedSubFields=DAOHelperMethods.properlyPrefixFields(this._prefix,selectedSubFields);selectedSubFields.push(this._prefix+'QuoteLine__r.'+this._salesCloudPrefix+'Description__c');selectedSubFields.push(this._prefix+'Product__r.Description');selectedSubFields.push(this._prefix+'ProductOption__r.'+this._salesCloudPrefix+'RenewalProductOption__r.'+this._salesCloudPrefix+'Feature__c');if(this._settings.isMultiCurrencyOrg){selectedSubFields.push('CurrencyIsoCode');}return selectedSubFields.concat(this._subMappableFields);}},{key:"_getSelectedAssetFields",value:function _getSelectedAssetFields(){var selectedAssetFields=DAOHelperMethods.properlyPrefixFields(this._salesCloudPrefix,ASSET_ONLY_FIELDS).concat(DAOHelperMethods.properlyPrefixFields(this._salesCloudPrefix,SUB_CLI_ASSET_FIELDS));var cloudSpecificAssetFields=this._isServiceCloudEnabled?DAOHelperMethods.properlyPrefixFields(this._serviceCloudPrefix,ASSET_ONLY_SERVICE_CLOUD_FIELDS):DAOHelperMethods.properlyPrefixFields(this._salesCloudPrefix,ASSET_ONLY_SALES_CLOUD_FIELDS);selectedAssetFields=selectedAssetFields.concat(cloudSpecificAssetFields);if(this._settings.isMultiCurrencyOrg){selectedAssetFields.push('CurrencyIsoCode');}return selectedAssetFields.concat(this._assetMappableFields);}},{key:"_querySubscriptionsAndRunCallback",value:function _querySubscriptionsAndRunCallback(baseQueryMethod,whereClause,callback){var defaultCallback=function defaultCallback(res){return res;};var selectedSubFields=this._getSelectedSubscriptionFields();var selectedSubscribedAssetFields=this._isServiceCloudEnabled?ENTITLEMENT_FIELDS:SUBSCRIBED_ASSET_FIELDS;selectedSubscribedAssetFields=DAOHelperMethods.properlyPrefixFields(this._prefix,selectedSubscribedAssetFields);if(this._settings.isMultiCurrencyOrg){selectedSubscribedAssetFields.push('CurrencyIsoCode');}var sasd=new SubscribedAssetSubqueryDescriptor(selectedSubscribedAssetFields,this._subscribedAssetRelationshipName);var argArray=[this._subRecType,selectedSubFields,whereClause,sasd,['CreatedDate','ASC']];return baseQueryMethod.apply(this,argArray).then(callback||defaultCallback);}},{key:"_queryAssetsAndRunCallback",value:function _queryAssetsAndRunCallback(baseQueryMethod,whereClause,callback){var defaultCallback=function defaultCallback(res){return res;};var selectedAssetFields=this._getSelectedAssetFields();selectedAssetFields.push(this._revisedAssetRelationshipName+'.'+this._salesCloudPrefix+'RootId__c');var argArray=['Asset',selectedAssetFields,whereClause];return baseQueryMethod.apply(this,argArray).then(callback||defaultCallback);}},{key:"_subRecType",get:function get(){return this._isServiceCloudEnabled?'ContractLineItem':this._salesCloudPrefix+'Subscription__c';}},{key:"_subLookupToContract",get:function get(){return this._isServiceCloudEnabled?'ServiceContractId':this._salesCloudPrefix+'Contract__c';}},{key:"_subscribedAssetRelationshipName",get:function get(){return this._isServiceCloudEnabled?'Entitlements':this._salesCloudPrefix+'SubscribedAssets__r';}},{key:"_revisedAssetRelationshipName",get:function get(){return this._salesCloudPrefix+'RevisedAsset__r';}}]);return SourceRecordDAO;}(BaseDAO);module.exports=SourceRecordDAO;},{"../../Utils/CacheManager.js":1,"../../Utils/DAOs/BaseDAO.js":2,"../../Utils/DAOs/DAOHelperMethods.js":3,"../../Utils/IdToValueCache.js":7,"js-logger":58}],19:[function(require,module,exports){var JSARSettings=function(){function JSARSettings(orgPrefix,rawSettings){_classCallCheck(this,JSARSettings);this.orgPrefix=orgPrefix;this.preventBackdatedAmendments=rawSettings.preventBackdatedAmendments;this.canBypassPreserveBundleStructureOnAmend=rawSettings.canBypassPreserveBundleStructureOnAmend;this.isServiceCloudEnabled=rawSettings.calcSettings.scSettings.isServiceCloudEnabled;this.salesCloudPrefix=rawSettings.calcSettings.scSettings.salesCloudPrefix;this.serviceCloudPrefix=rawSettings.calcSettings.scSettings.serviceCloudPrefix;this.prefix=rawSettings.calcSettings.scSettings.prefix;this.isMultiCurrencyOrg=rawSettings.calcSettings.isMultiCurrencyOrg;this.calcSettings=rawSettings.calcSettings;this.scSettings=rawSettings.calcSettings.scSettings;this.labels=rawSettings.labels;this.userId=rawSettings.userId;this.isTest=rawSettings.isTest;this.isSubscriptionTermUnitDay=rawSettings.calcSettings.subscriptionTermUnitIsDay;this.blockPriceAssetBehavior=rawSettings.calcSettings.blockPriceAssetBehavior;this.contractMagicFieldNamesByAlias=rawSettings.contractMagicFieldNamesByAlias;this.contractedPriceRequeryFields=rawSettings.contractedPriceRequeryFields;}_createClass(JSARSettings,[{key:"includePriorBlockPurchases",get:function get(){return this.blockPriceAssetBehavior==='IncludePriorPurchases';}}]);return JSARSettings;}();module.exports=JSARSettings;},{}],20:[function(require,module,exports){var LineCalculationManager=function(){function LineCalculationManager(services){_classCallCheck(this,LineCalculationManager);this._calcConstructor=typeof window!=='undefined'?window.SB.JSQC:require('../calc/jsqc.js');this._services=services;}_createClass(LineCalculationManager,[{key:"calculateQuotes",value:function calculateQuotes(quotes,settings,primaryConn,customerConn){var _this84=this;var calcPromises=[];quotes.forEach(function(qvo){calcPromises.push(_this84._calculateQuote(qvo,settings,primaryConn,customerConn));});return Promise.all(calcPromises);}},{key:"_calculateQuote",value:function _calculateQuote(qvo,settings,primaryConn,customerConn){var jsqc=new this._calcConstructor(settings.calcSettings,qvo);jsqc.setConnection(primaryConn);jsqc.setCustomerOnlyConnection(customerConn);jsqc.setServices(this._services);return jsqc.onCalc().catch(function(err){var msgTemplate=settings.labels.msg_amendrenew_err_calcing_quote;var msg=msgTemplate.replace('{0}',qvo.record.Id)+(err.message||err);return Promise.reject(msg);});}}]);return LineCalculationManager;}();module.exports=LineCalculationManager;},{"../calc/jsqc.js":"/client/calc/jsqc.js"}],21:[function(require,module,exports){'use strict';var ProductDAO=require('../Utils/DAOs/ProductDAO.js').DAO;var ProductSubqueryDescriptor=require('../Utils/DAOs/ProductDAO.js').SubqueryDescriptor;var SourceRecordDAO=require('./DAO/SourceRecordDAO.js');var ContractDAO=require('./DAO/ContractDAO.js');var AccountDAO=require('./DAO/AccountDAO.js');var LineItemConvertibleGenerator=require('./common/LineItemConvertibleGenerator.js');var LineItemConvertibleProcessor=require('./common/LineItemConvertibleProcessor.js');var ContractedPriceApplicator=require('./common/ContractedPriceApplicator.js');var IdToValueCache=require('../Utils/IdToValueCache.js');var RenewedAsset=require('./renewal/RenewedAsset.js');var RenewedSubscription=require('./renewal/RenewedSubscription.js');var RenewedMDQ=require('./renewal/RenewedMDQ.js');var AmendedAsset=require('./amendment/AmendedAsset.js');var AmendedSubscription=require('./amendment/AmendedSubscription.js');var AmendedMDQ=require('./amendment/AmendedMDQ.js');var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var LineGenerationManager=function(){function LineGenerationManager(conn,settings,services){_classCallCheck(this,LineGenerationManager);this._conn=conn;this._settings=settings;this._services=services;this._logger=jsLogger;}_createClass(LineGenerationManager,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"amendContractToQuote",value:function amendContractToQuote(contract,quote){return this._addContractsToQuote([contract],quote,null,false,{sub:AmendedSubscription,asset:AmendedAsset,mdq:AmendedMDQ});}},{key:"renewContractsToQuote",value:function renewContractsToQuote(contracts,quote,groupsByContract){return this._addContractsToQuote(contracts,quote,groupsByContract,true,{sub:RenewedSubscription,asset:RenewedAsset,mdq:RenewedMDQ});}},{key:"amendSubscriptionsToQuote",value:function amendSubscriptionsToQuote(subIds,quote,groupKey){return this._addSubscriptionsToQuote(subIds,quote,false,groupKey,{sub:AmendedSubscription,asset:AmendedAsset});}},{key:"renewSubscriptionsToQuote",value:function renewSubscriptionsToQuote(subIds,quote,groupKey){return this._addSubscriptionsToQuote(subIds,quote,true,groupKey,{sub:RenewedSubscription,asset:RenewedAsset,mdq:RenewedMDQ});}},{key:"_addSubscriptionsToQuote",value:function _addSubscriptionsToQuote(subIds,quote,isRenewal,groupKey,constructors){var _this85=this;var srDao=new SourceRecordDAO(this._conn,this._settings,this._services);var contractDao=new ContractDAO(this._conn,this._settings,this._services);var prodDaoOpts=ProductDAO.constructOptsFromJsarSettings(this._settings);var prodDao=new ProductDAO(this._conn,this._services,prodDaoOpts);var srcRecObject=void 0;var subsSortedByContractId=new IdToValueCache();var mdqContractIds=new Set();var sourceRecLoadStartTime=void 0;var userId=this._settings.userId;this._logMessage("LineGenerationManager.js: Load Source Records by subscription ID. SessionId="+userId);sourceRecLoadStartTime=Date.now();var contractsById=new IdToValueCache();var subs=void 0;var subPrefix=this._settings.isServiceCloudEnabled?this._settings.serviceCloudPrefix:this._settings.salesCloudPrefix;return srDao.loadSubscriptions(subIds).then(function(subscriptions){var cIds=[];var contractIdField=_this85._settings.isServiceCloudEnabled?'ServiceContractId':subPrefix+'Contract__c';subscriptions.forEach(function(sub){cIds.push(sub[contractIdField]);});subs=subscriptions;return contractDao.loadContractsByIds(cIds);}).then(function(consByIDs){if(!isRenewal){var _iteratorNormalCompletion11=true;var _didIteratorError11=false;var _iteratorError11=undefined;try{for(var _iterator11=consByIDs.entries()[Symbol.iterator](),_step11;!(_iteratorNormalCompletion11=(_step11=_iterator11.next()).done);_iteratorNormalCompletion11=true){var _step11$value=_slicedToArray(_step11.value,2),cId=_step11$value[0],cRec=_step11$value[1];if(_this85._settings.canBypassPreserveBundleStructureOnAmend===false){cRec[subPrefix+'PreserveBundleStructureUponRenewals__c']=true;}cRec[subPrefix+'SubscriptionQuantitiesCombined__c']=false;contractsById.set(cId,cRec);}}catch(err){_didIteratorError11=true;_iteratorError11=err;}finally{try{if(!_iteratorNormalCompletion11&&_iterator11.return){_iterator11.return();}}finally{if(_didIteratorError11){throw _iteratorError11;}}}}else{contractsById=consByIDs;}return srDao.loadSourceRecordsRelatedToSubscriptions(subs,contractsById,isRenewal);}).then(function(srcRec){_this85._logMessage("LineGenerationManager.js: Loading Source Records by Subscription ID took "+(Date.now()-sourceRecLoadStartTime)+" ms. SessionId="+userId);srcRecObject=srcRec;var productIdSet=new Set();var contractIdSet=new Set();var accountIdSet=new Set();var arrays=Array.from(srcRec.subsByContractId.values());var subs=[].concat.apply([],arrays);var prodIdField=subPrefix+'ProductId__c';var renewalProductIdField=subPrefix+'RenewalProductId__c';var renewalProductOptionProductIdField=subPrefix+'RenewalProductOptionProductId__c';var contractIdField=_this85._settings.isServiceCloudEnabled?'ServiceContractId':subPrefix+'Contract__c';var accountIdField=subPrefix+'Account__c';subs.forEach(function(sub){productIdSet.add(sub[prodIdField]);if(sub[renewalProductIdField]){productIdSet.add(sub[renewalProductIdField]);}if(sub[renewalProductOptionProductIdField]){productIdSet.add(sub[renewalProductOptionProductIdField]);}var contractId=sub[contractIdField];contractIdSet.add(contractId);if(!subsSortedByContractId.has(contractId)){subsSortedByContractId.set(contractId,[sub]);}else{subsSortedByContractId.get(contractId).push(sub);}accountIdSet.add(sub[accountIdField]);if(sub[subPrefix+'SegmentKey__c']){if(!isRenewal){throw Error('ERROR: '+sub.attributes.type+' ['+sub.Id+'] is an MDQ segment. MDQ Amendment is currently unsupported in the Advanced Amendment/Renewal Services.');}else{mdqContractIds.add(contractId);}}});_this85._logMessage('Returned Asset '+srcRec.assetsByContractId);var _iteratorNormalCompletion12=true;var _didIteratorError12=false;var _iteratorError12=undefined;try{for(var _iterator12=srcRec.assetsByContractId[Symbol.iterator](),_step12;!(_iteratorNormalCompletion12=(_step12=_iterator12.next()).done);_iteratorNormalCompletion12=true){var _step12$value=_slicedToArray(_step12.value,2),_contractId2=_step12$value[0],assetList=_step12$value[1];assetList.forEach(function(asset){productIdSet.add(asset.Product2Id);});}}catch(err){_didIteratorError12=true;_iteratorError12=err;}finally{try{if(!_iteratorNormalCompletion12&&_iterator12.return){_iterator12.return();}}finally{if(_didIteratorError12){throw _iteratorError12;}}}var prodSubquery=new ProductSubqueryDescriptor(prodDaoOpts);prodSubquery.includeJSARSubqueries();var pricebookIds=[quote.record[_this85._settings.salesCloudPrefix+'PricebookId__c']];var currencyCodes=quote.record.CurrencyIsoCode?[quote.record.CurrencyIsoCode]:[];prodSubquery.addPricebookFilters(pricebookIds);prodSubquery.addCurrencyFilters(currencyCodes);var productQueryPromise=prodDao.loadProductsByIds([].concat(_toConsumableArray(productIdSet)),prodSubquery);return productQueryPromise;}).then(function(prodsById){var productsById=prodsById;var accountsById=new IdToValueCache();var _iteratorNormalCompletion13=true;var _didIteratorError13=false;var _iteratorError13=undefined;try{for(var _iterator13=contractsById[Symbol.iterator](),_step13;!(_iteratorNormalCompletion13=(_step13=_iterator13.next()).done);_iteratorNormalCompletion13=true){var _step13$value=_slicedToArray(_step13.value,2),cId=_step13$value[0],cRec=_step13$value[1];accountsById.set(cRec.AccountId,cRec.Account);}}catch(err){_didIteratorError13=true;_iteratorError13=err;}finally{try{if(!_iteratorNormalCompletion13&&_iterator13.return){_iterator13.return();}}finally{if(_didIteratorError13){throw _iteratorError13;}}}if(mdqContractIds.size>0){var contractPrefix=_this85._settings.isServiceCloudEnabled?_this85._settings.serviceCloudPrefix:_this85._settings.salesCloudPrefix;mdqContractIds.forEach(function(cId){var c=contractsById.get(cId);if((c[contractPrefix+'MDQRenewalBehavior__c']||'').toLowerCase()!=='de-segmented'){throw Error('ERROR: Cannot renew MDQ segments on '+c.attributes.type+' ['+cId+']. MDQ Renewal Behavior other than'+' \'De-segmented\' is currently unsupported in Advanced Amendment/Renewal.');}});}var groupsByContractId=null;if(groupKey!=null){groupsByContractId=new Map();var targetGroup=quote.lineItemGroups.find(function(group){return group.key==groupKey;});var _iteratorNormalCompletion14=true;var _didIteratorError14=false;var _iteratorError14=undefined;try{for(var _iterator14=contractsById[Symbol.iterator](),_step14;!(_iteratorNormalCompletion14=(_step14=_iterator14.next()).done);_iteratorNormalCompletion14=true){var _step14$value=_slicedToArray(_step14.value,2),cId=_step14$value[0],cRec=_step14$value[1];groupsByContractId.set(cRec.Id,targetGroup);}}catch(err){_didIteratorError14=true;_iteratorError14=err;}finally{try{if(!_iteratorNormalCompletion14&&_iterator14.return){_iterator14.return();}}finally{if(_didIteratorError14){throw _iteratorError14;}}}}var args={contractRecordArray:[].concat(_toConsumableArray(contractsById.values())),accountsById:accountsById,productsById:productsById,sourceRecordObject:srcRecObject,quote:quote,groupsByContract:groupsByContractId,isRenewal:isRenewal,constructors:constructors};return _this85._generateAndProcessContractBasedConvertibles(args);});}},{key:"_addContractsToQuote",value:function _addContractsToQuote(contracts,quote,groupsByContract,isRenewal,constructors){var _this86=this;var srDao=new SourceRecordDAO(this._conn,this._settings,this._services);var prodDaoOpts=ProductDAO.constructOptsFromJsarSettings(this._settings);var prodDao=new ProductDAO(this._conn,this._services,prodDaoOpts);var accountsById=new IdToValueCache();contracts.forEach(function(c){accountsById.set(c.AccountId,c.Account);});var srcRecObject=null;var prodsById=null;var loadProductsByIdsStartTime=void 0;this._logMessage('LineGenerationManager.js: Load subscriptions related to contracts. SessionId='+this._settings.userId);var srDaoStartTime=Date.now();return srDao.loadSourceRecordsRelatedToContracts(contracts,isRenewal).then(function(results){_this86._logMessage('LineGenerationManager.js: Loading subscriptions related to contracts took '+(Date.now()-srDaoStartTime)+' ms. SessionId='+_this86._settings.userId);srcRecObject=results;var productIds=[];var subPrefix=_this86._settings.isServiceCloudEnabled?_this86._settings.serviceCloudPrefix:_this86._settings.salesCloudPrefix;var _iteratorNormalCompletion15=true;var _didIteratorError15=false;var _iteratorError15=undefined;try{for(var _iterator15=results.subsByContractId[Symbol.iterator](),_step15;!(_iteratorNormalCompletion15=(_step15=_iterator15.next()).done);_iteratorNormalCompletion15=true){var _step15$value=_slicedToArray(_step15.value,2),_contractId3=_step15$value[0],subList=_step15$value[1];subList.forEach(function(sub){productIds.push(sub[subPrefix+'ProductId__c']);var renProdId=sub[subPrefix+'RenewalProductId__c'];if(renProdId){productIds.push(renProdId);}var renOpProdId=sub[subPrefix+'RenewalProductOptionProductId__c'];if(renOpProdId){productIds.push(renOpProdId);}});}}catch(err){_didIteratorError15=true;_iteratorError15=err;}finally{try{if(!_iteratorNormalCompletion15&&_iterator15.return){_iterator15.return();}}finally{if(_didIteratorError15){throw _iteratorError15;}}}var _iteratorNormalCompletion16=true;var _didIteratorError16=false;var _iteratorError16=undefined;try{for(var _iterator16=results.assetsByContractId[Symbol.iterator](),_step16;!(_iteratorNormalCompletion16=(_step16=_iterator16.next()).done);_iteratorNormalCompletion16=true){var _step16$value=_slicedToArray(_step16.value,2),_contractId4=_step16$value[0],assetList=_step16$value[1];assetList.forEach(function(asset){productIds.push(asset.Product2Id);});}}catch(err){_didIteratorError16=true;_iteratorError16=err;}finally{try{if(!_iteratorNormalCompletion16&&_iterator16.return){_iterator16.return();}}finally{if(_didIteratorError16){throw _iteratorError16;}}}var prodSubquery=new ProductSubqueryDescriptor(prodDaoOpts);prodSubquery.includeJSARSubqueries();var pricebookIds=[quote.record[_this86._settings.salesCloudPrefix+'PricebookId__c']];var currencyCodes=quote.record.CurrencyIsoCode?[quote.record.CurrencyIsoCode]:[];prodSubquery.addPricebookFilters(pricebookIds);prodSubquery.addCurrencyFilters(currencyCodes);_this86._logMessage('LineGenerationManager.js: Load products by ids. SessionId='+_this86._settings.userId);loadProductsByIdsStartTime=Date.now();return prodDao.loadProductsByIds(productIds,prodSubquery);}).then(function(productsById){_this86._logMessage('LineGenerationManager.js: Loading products by ids took '+(Date.now()-loadProductsByIdsStartTime)+' ms. SessionId='+_this86._settings.userId);prodsById=productsById;var args={contractRecordArray:contracts,accountsById:accountsById,productsById:prodsById,sourceRecordObject:srcRecObject,quote:quote,groupsByContract:groupsByContract,isRenewal:isRenewal,constructors:constructors};return _this86._generateAndProcessContractBasedConvertibles(args);});}},{key:"_generateAndProcessContractBasedConvertibles",value:function _generateAndProcessContractBasedConvertibles(argBundle){var _this87=this;var contractRecordArray=argBundle.contractRecordArray;var accountsById=argBundle.accountsById;var productsById=argBundle.productsById;var sourceRecordObject=argBundle.sourceRecordObject;var quote=argBundle.quote;var groupsByContract=argBundle.groupsByContract;var isRenewal=argBundle.isRenewal;var constructors=argBundle.constructors;var licg=new LineItemConvertibleGenerator(this._settings,this._services);var licp=new LineItemConvertibleProcessor(this._settings);var cpa=new ContractedPriceApplicator(this._settings,this._conn);var contractPrefix=this._settings.isServiceCloudEnabled?this._settings.serviceCloudPrefix:this._settings.salesCloudPrefix;var promiseChainStartTime=void 0;var nthContractStartTime=void 0;var processNthTreeListStartTime=void 0;var processContractsIteratively=function processContractsIteratively(n){if(contractRecordArray.length<=n){_this87._logMessage('LineGenerationManager.js: Processing all contracts took '+(Date.now()-promiseChainStartTime)+' ms. SessionId='+_this87._settings.userId);return Promise.resolve(quote);}else{_this87._logMessage('LineGenerationManager.js: Process contract '+(n+1)+' of '+contractRecordArray.length+'. SessionId='+_this87._settings.userId);nthContractStartTime=Date.now();var contract=contractRecordArray[n];var _subs=sourceRecordObject.subsByContractId.get(contract.Id);var assets=sourceRecordObject.assetsByContractId?sourceRecordObject.assetsByContractId.get(contract.Id.slice(0,15)):[];var acc=accountsById.get(contract.AccountId);var group=groupsByContract?groupsByContract.get(contract.Id):null;var relatedObjects={quote:quote.record,group:group?group.record:null,account:acc,contract:contract,productsById:productsById};var processOptions={isRenewal:isRenewal,preserveBundleStructure:contract[contractPrefix+'PreserveBundleStructureUponRenewals__c'],combineSubscriptionQuantities:contract[contractPrefix+'SubscriptionQuantitiesCombined__c']};var convertibles=licg.generateConvertibles(_subs,assets,constructors,relatedObjects,processOptions);processNthTreeListStartTime=Date.now();return licp.processConvertibleTrees(convertibles,quote,group).then(function(){return cpa.assignContractedPrices(quote);}).then(function(){_this87._logMessage('LineGenerationManager.js: Processing convertibles for contract '+(n+1)+' of '+contractRecordArray.length+' took '+(Date.now()-processNthTreeListStartTime)+' ms. SessionId='+_this87._settings.userId);_this87._logMessage('LineGenerationManager.js: Processing contract '+(n+1)+' of '+contractRecordArray.length+' took '+(Date.now()-nthContractStartTime)+' ms. SessionId='+_this87._settings.userId);return processContractsIteratively(n+1);});}};this._logMessage('LineGenerationManager.js: Process contracts iteratively. SessionId='+this._settings.userId);promiseChainStartTime=Date.now();return processContractsIteratively(0);}},{key:"_subscribedAssetRelationshipName",get:function get(){return this._settings.isServiceCloudEnabled?'Entitlements':this._settings.salesCloudPrefix+'SubscribedAssets__r';}},{key:"_revisedAssetRelationshipName",get:function get(){return this._settings.salesCloudPrefix+'RevisedAsset__r';}}]);return LineGenerationManager;}();module.exports=LineGenerationManager;},{"../Utils/DAOs/ProductDAO.js":4,"../Utils/IdToValueCache.js":7,"./DAO/AccountDAO.js":10,"./DAO/ContractDAO.js":11,"./DAO/SourceRecordDAO.js":18,"./amendment/AmendedAsset.js":22,"./amendment/AmendedMDQ.js":24,"./amendment/AmendedSubscription.js":27,"./common/ContractedPriceApplicator.js":31,"./common/LineItemConvertibleGenerator.js":33,"./common/LineItemConvertibleProcessor.js":34,"./renewal/RenewedAsset.js":46,"./renewal/RenewedMDQ.js":48,"./renewal/RenewedSubscription.js":50,"js-logger":58}],22:[function(require,module,exports){'use strict';var AmendedItem=require('./AmendedItem.js');var DateUtils=require('../../Utils/DateUtils.js');var AmendedAsset=function(_AmendedItem){_inherits(AmendedAsset,_AmendedItem);function AmendedAsset(){_classCallCheck(this,AmendedAsset);return _possibleConstructorReturn(this,(AmendedAsset.__proto__||Object.getPrototypeOf(AmendedAsset)).apply(this,arguments));}_createClass(AmendedAsset,[{key:"_getListPriceFromSourceRecord",value:function _getListPriceFromSourceRecord(){return this._sourceRecord[this._sourceRecPrefix+'ListPrice__c'];}},{key:"_getCustomerPriceField",value:function _getCustomerPriceField(){return'Price';}},{key:"_getSummedQuantity",value:function _getSummedQuantity(){var _this89=this;var sum=0;var allRecs=this._originalRecords.concat(this._revisions);allRecs.forEach(function(record){if(_this89._isCountableAsset(record)){sum+=record.Quantity;}});return sum;}},{key:"_isCountableAsset",value:function _isCountableAsset(rec){return rec.Quantity!=null&&(rec.UsageEndDate==null||rec.UsageEndDate>=DateUtils.toApexDate(new Date(Date.now())));}},{key:"_setValuesFromOrigin",value:function _setValuesFromOrigin(lineVO){_get(AmendedAsset.prototype.__proto__||Object.getPrototypeOf(AmendedAsset.prototype),"_setValuesFromOrigin",this).call(this,lineVO);var record=lineVO.record;var prefix=this._salesCloudPrefix;record[prefix+'Renewal__c']=true;var sourceRec=this._sourceRecord;record[prefix+'UpgradedAsset__c']=sourceRec.Id;}},{key:"_setValuesFromProduct",value:function _setValuesFromProduct(lineVO){_get(AmendedAsset.prototype.__proto__||Object.getPrototypeOf(AmendedAsset.prototype),"_setValuesFromProduct",this).call(this,lineVO);var product=this._product;var record=lineVO.record;var prefix=this._salesCloudPrefix;if(product[prefix+'AssetAmendmentBehavior__c']!=null&&product[prefix+'AssetAmendmentBehavior__c'].toLowerCase()==='allow refund'){record[prefix+'AllowAssetRefund__c']=true;}}},{key:"_sourceRecord",get:function get(){var _this90=this;return this._originalRecords.find(function(record){return _this90._isCountableAsset(record);});}},{key:"_sourceRecPrefix",get:function get(){return this._salesCloudPrefix;}}]);return AmendedAsset;}(AmendedItem);module.exports=AmendedAsset;},{"../../Utils/DateUtils.js":6,"./AmendedItem.js":23}],23:[function(require,module,exports){'use strict';var LineItemConvertible=require('../common/LineItemConvertible.js');var AmendedItem=function(_LineItemConvertible){_inherits(AmendedItem,_LineItemConvertible);function AmendedItem(){_classCallCheck(this,AmendedItem);return _possibleConstructorReturn(this,(AmendedItem.__proto__||Object.getPrototypeOf(AmendedItem)).apply(this,arguments));}_createClass(AmendedItem,[{key:"_setValuesFromOrigin",value:function _setValuesFromOrigin(lineVO){_get(AmendedItem.prototype.__proto__||Object.getPrototypeOf(AmendedItem.prototype),"_setValuesFromOrigin",this).call(this,lineVO);var record=lineVO.record;var quoteLinePrefix=this._salesCloudPrefix;var sourcePrefix=this._sourceRecPrefix;var sourceRec=this._sourceRecord;record[quoteLinePrefix+'PriorQuantity__c']=this._getSummedQuantity();record[quoteLinePrefix+'Existing__c']=true;record[quoteLinePrefix+'PartnerDiscount__c']=sourceRec[sourcePrefix+'PartnerDiscount__c'];record[quoteLinePrefix+'DistributorDiscount__c']=sourceRec[sourcePrefix+'DistributorDiscount__c'];var blockPriced=(record[quoteLinePrefix+'PricingMethod__c']||'list').toLowerCase()==='block';var slabDiscounted=(sourceRec[sourcePrefix+'DiscountScheduleType__c']||'').toLowerCase()==='slab';var addDiscAmt=sourceRec[sourcePrefix+'AdditionalDiscountAmount__c'];if((blockPriced||slabDiscounted)&&addDiscAmt!=null){var customerPrice=sourceRec[this._getCustomerPriceField()];var undiscountedPrice=customerPrice+addDiscAmt;if(undiscountedPrice!==0){record[quoteLinePrefix+'Discount__c']=addDiscAmt/undiscountedPrice*100;record[quoteLinePrefix+'AdditionalDiscountAmount__c']=null;}else if(addDiscAmt===0){record[quoteLinePrefix+'Discount__c']=0;record[quoteLinePrefix+'AdditionalDiscountAmount__c']=null;}else{record[quoteLinePrefix+'Discount__c']=null;record[quoteLinePrefix+'AdditionalDiscountAmount__c']=addDiscAmt;}}else{record[quoteLinePrefix+'Discount__c']=sourceRec[sourcePrefix+'Discount__c'];record[quoteLinePrefix+'AdditionalDiscountAmount__c']=sourceRec[sourcePrefix+'AdditionalDiscountAmount__c'];}}},{key:"_listPriceMapsFromProduct",value:function _listPriceMapsFromProduct(){return false;}},{key:"_getCustomerPriceField",value:function _getCustomerPriceField(){throw new Error('AmendedItem._getCustomerPriceField() should be overridden by child classes, and never invoked directly.');}}]);return AmendedItem;}(LineItemConvertible);module.exports=AmendedItem;},{"../common/LineItemConvertible.js":32}],24:[function(require,module,exports){'use strict';var MDQConvertible=require('../common/MDQConvertible.js');var AmendedRecurringSegment=require('./AmendedRecurringSegment.js');var AmendedOneTimeSegment=require('./AmendedOneTimeSegment.js');var AmendedMDQ=function(_MDQConvertible){_inherits(AmendedMDQ,_MDQConvertible);function AmendedMDQ(key,settings,objMap,services){_classCallCheck(this,AmendedMDQ);var _this92=_possibleConstructorReturn(this,(AmendedMDQ.__proto__||Object.getPrototypeOf(AmendedMDQ)).call(this,key,settings,objMap,services));_this92._effectiveSegmentIndex=1;_this92.SEGMENT_INDEX_FIELD=_this92.prefix+'SegmentIndex__c';return _this92;}_createClass(AmendedMDQ,[{key:"addOriginalRecord",value:function addOriginalRecord(rec){var recType=rec.attributes.type;if(recType!=='Asset'){this._addOriginalRecurringRecord(rec,AmendedRecurringSegment);}else{this._addOriginalOneTimeRecord(rec,AmendedOneTimeSegment);}}},{key:"addRevision",value:function addRevision(rec){var recType=rec.attributes.type;if(recType!=='Asset'){this._addRevisionRecurringRecord(rec);}else{this._addRevisionOneTimeRecord(rec,AmendedOneTimeSegment);}}},{key:"_shouldGenerateLines",value:function _shouldGenerateLines(){if(this._recurringSegmentsByIndex.size>0){var _iteratorNormalCompletion17=true;var _didIteratorError17=false;var _iteratorError17=undefined;try{for(var _iterator17=this._recurringSegmentsByIndex[Symbol.iterator](),_step17;!(_iteratorNormalCompletion17=(_step17=_iterator17.next()).done);_iteratorNormalCompletion17=true){var _step17$value=_slicedToArray(_step17.value,2),index=_step17$value[0],segment=_step17$value[1];if(segment.shouldGenerateLines()){return true;}}}catch(err){_didIteratorError17=true;_iteratorError17=err;}finally{try{if(!_iteratorNormalCompletion17&&_iterator17.return){_iterator17.return();}}finally{if(_didIteratorError17){throw _iteratorError17;}}}}if(this._oneTimeSegmentsByKey.size>0){var _iteratorNormalCompletion18=true;var _didIteratorError18=false;var _iteratorError18=undefined;try{for(var _iterator18=this._oneTimeSegmentsByKey[Symbol.iterator](),_step18;!(_iteratorNormalCompletion18=(_step18=_iterator18.next()).done);_iteratorNormalCompletion18=true){var _step18$value=_slicedToArray(_step18.value,2),key=_step18$value[0],segment=_step18$value[1];if(segment.shouldGenerateLines()){return true;}}}catch(err){_didIteratorError18=true;_iteratorError18=err;}finally{try{if(!_iteratorNormalCompletion18&&_iterator18.return){_iterator18.return();}}finally{if(_didIteratorError18){throw _iteratorError18;}}}}return false;}},{key:"process",value:function process(){if(!this._shouldGenerateLines()){return Promise.resolve();}else{var segmentPromiseArray=[];if(this._oneTimeSegmentsByKey.size>0){var _iteratorNormalCompletion19=true;var _didIteratorError19=false;var _iteratorError19=undefined;try{for(var _iterator19=this._oneTimeSegmentsByKey[Symbol.iterator](),_step19;!(_iteratorNormalCompletion19=(_step19=_iterator19.next()).done);_iteratorNormalCompletion19=true){var _step19$value=_slicedToArray(_step19.value,2),key=_step19$value[0],segment=_step19$value[1];if(segment.shouldGenerateLines()){segmentPromiseArray.push(segment.process());}}}catch(err){_didIteratorError19=true;_iteratorError19=err;}finally{try{if(!_iteratorNormalCompletion19&&_iterator19.return){_iterator19.return();}}finally{if(_didIteratorError19){throw _iteratorError19;}}}}if(this._recurringSegmentsByIndex.size>0){var nextIndex=1;while(nextIndex<=this._recurringSegmentsByIndex.size){var segment=this._recurringSegmentsByIndex.get(nextIndex);if(segment===undefined){throw new Error(this._settings.labels.msg_amendrenew_err_missing_segment);}if(!segment.segmentEndsInPast()){segment.effectiveSegmentIndex=this._effectiveSegmentIndex++;segmentPromiseArray.push(segment.process());}nextIndex+=1;}}return Promise.all(segmentPromiseArray);}}},{key:"conversionResults",get:function get(){if(!this._shouldGenerateLines()){return null;}else{var _results=[];if(this._oneTimeSegmentsByKey.size>0){var _iteratorNormalCompletion20=true;var _didIteratorError20=false;var _iteratorError20=undefined;try{for(var _iterator20=this._oneTimeSegmentsByKey[Symbol.iterator](),_step20;!(_iteratorNormalCompletion20=(_step20=_iterator20.next()).done);_iteratorNormalCompletion20=true){var _step20$value=_slicedToArray(_step20.value,2),key=_step20$value[0],segment=_step20$value[1];if(segment.conversionResults){_results.push(segment.conversionResults);}}}catch(err){_didIteratorError20=true;_iteratorError20=err;}finally{try{if(!_iteratorNormalCompletion20&&_iterator20.return){_iterator20.return();}}finally{if(_didIteratorError20){throw _iteratorError20;}}}}if(this._recurringSegmentsByIndex.size>0){var nextIndex=1;while(nextIndex<=this._recurringSegmentsByIndex.size){var segment=this._recurringSegmentsByIndex.get(nextIndex);if(segment.conversionResults!=null){_results.push(segment.conversionResults);}nextIndex+=1;}}return _results;}}}]);return AmendedMDQ;}(MDQConvertible);module.exports=AmendedMDQ;},{"../common/MDQConvertible.js":35,"./AmendedOneTimeSegment.js":25,"./AmendedRecurringSegment.js":26}],25:[function(require,module,exports){'use strict';var AmendedAsset=require('./AmendedAsset.js');var AmendedOneTimeSegment=function(_AmendedAsset){_inherits(AmendedOneTimeSegment,_AmendedAsset);function AmendedOneTimeSegment(key,settings,objMap,services,wrapper){_classCallCheck(this,AmendedOneTimeSegment);var _this93=_possibleConstructorReturn(this,(AmendedOneTimeSegment.__proto__||Object.getPrototypeOf(AmendedOneTimeSegment)).call(this,key,settings,objMap,services));_this93._segmentWrapper=wrapper;return _this93;}_createClass(AmendedOneTimeSegment,[{key:"shouldGenerateLines",value:function shouldGenerateLines(){return _get(AmendedOneTimeSegment.prototype.__proto__||Object.getPrototypeOf(AmendedOneTimeSegment.prototype),"_shouldGenerateLines",this).call(this);}},{key:"process",value:function process(){return this._createVO();}},{key:"_setValuesFromProduct",value:function _setValuesFromProduct(vo){_get(AmendedOneTimeSegment.prototype.__proto__||Object.getPrototypeOf(AmendedOneTimeSegment.prototype),"_setValuesFromProduct",this).call(this,vo);var record=vo.record;var prefix=this._salesCloudPrefix;record[prefix+'SubscriptionPricing__c']=null;record[prefix+'SubscriptionPercent__c']=null;record[prefix+'DefaultSubscriptionTerm__c']=null;}},{key:"_setValuesFromOrigin",value:function _setValuesFromOrigin(lineVO){_get(AmendedOneTimeSegment.prototype.__proto__||Object.getPrototypeOf(AmendedOneTimeSegment.prototype),"_setValuesFromOrigin",this).call(this,lineVO);var rec=lineVO.record;var sourceRec=this._sourceRecord;var sourcePrefix=this._sourceRecPrefix;rec[this._salesCloudPrefix+'SegmentKey__c']=sourceRec[sourcePrefix+'SegmentKey__c'];rec[this._salesCloudPrefix+'SegmentLabel__c']=sourceRec[sourcePrefix+'SegmentLabel__c'];rec[this._salesCloudPrefix+'Dimension__c']=sourceRec[sourcePrefix+'PriceDimension__c'];rec[this._salesCloudPrefix+'SegmentIndex__c']=0;}},{key:"parent",get:function get(){return this._segmentWrapper.parent;}}]);return AmendedOneTimeSegment;}(AmendedAsset);module.exports=AmendedOneTimeSegment;},{"./AmendedAsset.js":22}],26:[function(require,module,exports){'use strict';var AmendedSubscription=require('./AmendedSubscription.js');var AmendedRecurringSegment=function(_AmendedSubscription){_inherits(AmendedRecurringSegment,_AmendedSubscription);function AmendedRecurringSegment(key,settings,objMap,services,wrapper){_classCallCheck(this,AmendedRecurringSegment);var _this94=_possibleConstructorReturn(this,(AmendedRecurringSegment.__proto__||Object.getPrototypeOf(AmendedRecurringSegment)).call(this,key,settings,objMap,services));_this94._segmentWrapper=wrapper;_this94._effectiveSegmentIndex=null;return _this94;}_createClass(AmendedRecurringSegment,[{key:"segmentEndsInPast",value:function segmentEndsInPast(){var segEndDate=this._sourceRecord[this._sourceRecPrefix+'SegmentEndDate__c'];var quoteStartDate=this._quote[this._salesCloudPrefix+'StartDate__c'];return segEndDate<quoteStartDate;}},{key:"_shouldGenerateLines",value:function _shouldGenerateLines(){return _get(AmendedRecurringSegment.prototype.__proto__||Object.getPrototypeOf(AmendedRecurringSegment.prototype),"_shouldGenerateLines",this).call(this)||!this.segmentEndsInPast();}},{key:"shouldGenerateLines",value:function shouldGenerateLines(){return this._shouldGenerateLines();}},{key:"_getSummedQuantity",value:function _getSummedQuantity(){var total=0;var prefix=this._sourceRecPrefix;this._originalRecords.forEach(function(rec){total+=rec[prefix+'SegmentQuantity__c'];});this._revisions.forEach(function(rec){total+=rec[prefix+'Quantity__c'];});return total;}},{key:"process",value:function process(){return this._createVO();}},{key:"_setValuesFromOrigin",value:function _setValuesFromOrigin(lineVO){_get(AmendedRecurringSegment.prototype.__proto__||Object.getPrototypeOf(AmendedRecurringSegment.prototype),"_setValuesFromOrigin",this).call(this,lineVO);var rec=lineVO.record;var sourceRec=this._sourceRecord;var sourcePrefix=this._sourceRecPrefix;rec[this._salesCloudPrefix+'SegmentKey__c']=sourceRec[sourcePrefix+'SegmentKey__c'];rec[this._salesCloudPrefix+'SegmentLabel__c']=sourceRec[sourcePrefix+'SegmentLabel__c'];rec[this._salesCloudPrefix+'Dimension__c']=sourceRec[sourcePrefix+'Dimension__c'];rec[this._salesCloudPrefix+'EndDate__c']=sourceRec[sourcePrefix+'SegmentEndDate__c'];rec[this._salesCloudPrefix+'Uplift__c']=sourceRec[sourcePrefix+'SegmentUplift__c'];var quoteStart=this._quote[this._salesCloudPrefix+'StartDate__c'];var segStart=sourceRec[sourcePrefix+'SegmentStartDate__c'];rec[this._salesCloudPrefix+'StartDate__c']=quoteStart>segStart?quoteStart:segStart;var segUpliftAmt=sourceRec[sourcePrefix+'SegmentUpliftAmount__c']||0;var prorateMultiplier=sourceRec[sourcePrefix+'ProrateMultiplier__c']||0;if(segUpliftAmt>0&&prorateMultiplier>0){rec[this._salesCloudPrefix+'UpliftAmount__c']=segUpliftAmt/prorateMultiplier;}rec[this._salesCloudPrefix+'SegmentIndex__c']=this._effectiveSegmentIndex;if(this._effectiveSegmentIndex===1&&sourceRec[sourcePrefix+'SegmentIndex__c']!==1){var previousSegment=this._segmentWrapper.getRecurringSegmentByIndex(sourceRec[sourcePrefix+'SegmentIndex__c']-1);rec[this._salesCloudPrefix+'PreviousSegmentUplift__c']=previousSegment.sourceRecord[sourcePrefix+'SegmentUpliftAmount__c'];rec[this._salesCloudPrefix+'PreviousSegmentPrice__c']=previousSegment.sourceRecord[sourcePrefix+'RegularPrice__c'];}var rpm=(this._account[this._salesCloudPrefix+'RenewalPricingMethod__c']||'').toLowerCase();if(rpm==='uplift'){var isFirstSegment=this._effectiveSegmentIndex===1&&sourceRec[sourcePrefix+'SegmentIndex__c']===1;var isAmendmentOnSegmentStartDate=quoteStart===segStart;var hasBeenPreviouslyRenewedWithUplift=sourceRec[sourcePrefix+'SegmentUpliftAmount__c']!==0;if(isFirstSegment&&isAmendmentOnSegmentStartDate&&hasBeenPreviouslyRenewedWithUplift){rec[this._salesCloudPrefix+'PreviousSegmentPrice__c']=sourceRec[sourcePrefix+'RegularPrice__c'];}}}},{key:"parent",get:function get(){return this._segmentWrapper.parent;}},{key:"sourceRecord",get:function get(){return this._sourceRecord;}},{key:"effectiveSegmentIndex",set:function set(v){this._effectiveSegmentIndex=v;}}]);return AmendedRecurringSegment;}(AmendedSubscription);module.exports=AmendedRecurringSegment;},{"./AmendedSubscription.js":27}],27:[function(require,module,exports){'use strict';var AmendedItem=require('./AmendedItem.js');var AmendedSubscription=function(_AmendedItem2){_inherits(AmendedSubscription,_AmendedItem2);function AmendedSubscription(){_classCallCheck(this,AmendedSubscription);return _possibleConstructorReturn(this,(AmendedSubscription.__proto__||Object.getPrototypeOf(AmendedSubscription)).apply(this,arguments));}_createClass(AmendedSubscription,[{key:"_getSummedQuantity",value:function _getSummedQuantity(){var _this96=this;var sum=0;var allRecs=this._originalRecords.concat(this._revisions);allRecs.forEach(function(rec){sum+=rec[_this96._sourceRecPrefix+'Quantity__c'];});return sum;}},{key:"_shouldGenerateLines",value:function _shouldGenerateLines(){if(!_get(AmendedSubscription.prototype.__proto__||Object.getPrototypeOf(AmendedSubscription.prototype),"_shouldGenerateLines",this).call(this)){return false;}var sourceRec=this._sourceRecord;var prefix=this._sourceRecPrefix;if(sourceRec[prefix+'TerminatedDate__c']){return false;}var endDate=sourceRec[this._sourceEndDateField];var quoteStartDate=this._quote[this._salesCloudPrefix+'StartDate__c'];if(endDate!=null&&endDate<quoteStartDate){return false;}return true;}},{key:"_getSummedRevisionsMappedByStartDate",value:function _getSummedRevisionsMappedByStartDate(){var _this97=this;if(this._summedRevisionsByStartDate!=null){return this._summedRevisionsByStartDate;}var prefix=this._sourceRecPrefix;var revisionsByStartDate=new Map();this._revisions.forEach(function(revision){var revisionStartDate=revision[_this97._sourceStartDateField];var storedQtyChange=revisionsByStartDate.get(revisionStartDate)||0;var newQtyChange=revision[prefix+'Quantity__c'];revisionsByStartDate.set(revisionStartDate,storedQtyChange+newQtyChange);});this._summedRevisionsByStartDate=revisionsByStartDate;return revisionsByStartDate;}},{key:"_getListPriceFromSourceRecord",value:function _getListPriceFromSourceRecord(){var prefix=this._salesCloudPrefix;var product=this._product;if(product[prefix+'SubscriptionPricing__c'].toLowerCase()==='percent of total'){return 0;}else{var sourceRec=this._sourceRecord;var prorateMultiplier=sourceRec[this._sourceRecPrefix+'ProrateMultiplier__c'];var sourceListPrice=sourceRec[this._sourceRecPrefix+'ListPrice__c'];return prorateMultiplier?sourceListPrice/prorateMultiplier:sourceListPrice;}}},{key:"_getCustomerPriceField",value:function _getCustomerPriceField(){return this._sourceRecPrefix+'CustomerPrice__c';}},{key:"_setValuesFromProduct",value:function _setValuesFromProduct(vo){_get(AmendedSubscription.prototype.__proto__||Object.getPrototypeOf(AmendedSubscription.prototype),"_setValuesFromProduct",this).call(this,vo);}},{key:"_sourceStartDateOverridesQuote",value:function _sourceStartDateOverridesQuote(){var sourceStartDate=this._sourceRecord[this._sourceStartDateField];var quoteStartDate=this._quote[this._salesCloudPrefix+'StartDate__c'];return sourceStartDate>quoteStartDate;}},{key:"_sourceStartDateOverridesQuote",value:function _sourceStartDateOverridesQuote(){var sourceStartDate=this._sourceRecord[this._sourceStartDateField];var quoteStartDate=this._quote[this._salesCloudPrefix+'StartDate__c'];return sourceStartDate>quoteStartDate;}},{key:"_setValuesFromOrigin",value:function _setValuesFromOrigin(lineVO){var _this98=this;_get(AmendedSubscription.prototype.__proto__||Object.getPrototypeOf(AmendedSubscription.prototype),"_setValuesFromOrigin",this).call(this,lineVO);var record=lineVO.record;var quoteLinePrefix=this._salesCloudPrefix;var sourcePrefix=this._sourceRecPrefix;var sourceRec=this._sourceRecord;record[this._amendedItemField]=sourceRec.Id;if(this._sourceStartDateOverridesQuote()){record[quoteLinePrefix+'StartDate__c']=sourceRec[this._sourceStartDateField];}var qtyChangesByDate=this._getSummedRevisionsMappedByStartDate();var latestNonzeroRevisionDate=null;qtyChangesByDate.forEach(function(value,key){if(value!==0&&(!latestNonzeroRevisionDate||latestNonzeroRevisionDate<key)){latestNonzeroRevisionDate=key;}});record[quoteLinePrefix+'EarliestValidAmendmentStartDate__c']=latestNonzeroRevisionDate;var sourceSubscriptionType=sourceRec[sourcePrefix+'SubscriptionType__c'];if(sourceSubscriptionType=='Evergreen'){record[quoteLinePrefix+'SubscriptionTerm__c']=1;record[quoteLinePrefix+'EndDate__c']=null;}else{var sourceEndDate=sourceRec[this._sourceEndDateField];var quoteEndDate=this._quote[this._salesCloudPrefix+'EndDate__c'];if(sourceEndDate!==quoteEndDate){record[quoteLinePrefix+'EndDate__c']=sourceEndDate;}}if(this._preserveBundleStructure()){record[quoteLinePrefix+'ComponentSubscriptionScope__c']=sourceRec[sourcePrefix+'ComponentSubscriptionScope__c'];}var subscriptions=this._originalRecords.concat(this._revisions);var assetField=this._isServiceCloudEnabled?'AssetId':this._salesCloudPrefix+'Asset__c';var assetIds=[];subscriptions.forEach(function(subscription){var subscribedAssets=subscription[_this98._subscribedAssetRelationshipName];if(subscribedAssets&&subscribedAssets.totalSize>0){subscribedAssets.records.forEach(function(subscribedAsset){assetIds.push(subscribedAsset[assetField]);});}});record[this._salesCloudPrefix+'SubscribedAssetIds__c']=assetIds.join(',');record[this._salesCloudPrefix+'HasConsumptionSchedule__c']=sourceRec[sourcePrefix+'HasConsumptionSchedule__c'];record[quoteLinePrefix+'ProductSubscriptionType__c']=sourceRec[sourcePrefix+'ProductSubscriptionType__c'];record[quoteLinePrefix+'SubscriptionType__c']=sourceRec[sourcePrefix+'SubscriptionType__c'];}},{key:"_verifyNonNullValuesForRequiredFields",value:function _verifyNonNullValuesForRequiredFields(){var prefix=this._salesCloudPrefix;var product=this._product;if(!product[prefix+'SubscriptionPricing__c']){throw new Error(this._settings.labels.msg_subscriptions_require_subscription_pricing);}}},{key:"_sourceRecPrefix",get:function get(){return this._sourceRecType.endsWith('Subscription__c')?this._salesCloudPrefix:this._serviceCloudPrefix;}},{key:"_amendedItemField",get:function get(){return this._sourceRecType.endsWith('Subscription__c')?this._salesCloudPrefix+'UpgradedSubscription__c':this._serviceCloudPrefix+'UpgradedContractLine__c';}},{key:"_sourceStartDateField",get:function get(){return this._sourceRecType.endsWith('Subscription__c')?this._salesCloudPrefix+'StartDate__c':'StartDate';}},{key:"_sourceEndDateField",get:function get(){return this._sourceRecType.endsWith('Subscription__c')?this._salesCloudPrefix+'EndDate__c':'EndDate';}}]);return AmendedSubscription;}(AmendedItem);module.exports=AmendedSubscription;},{"./AmendedItem.js":23}],28:[function(require,module,exports){'use strict';var BaseOpportunityWrapper=require('../common/BaseOpportunityWrapper.js');var AmendmentOpportunityWrapper=function(_BaseOpportunityWrapp){_inherits(AmendmentOpportunityWrapper,_BaseOpportunityWrapp);function AmendmentOpportunityWrapper(opptyModel,contractModel){_classCallCheck(this,AmendmentOpportunityWrapper);return _possibleConstructorReturn(this,(AmendmentOpportunityWrapper.__proto__||Object.getPrototypeOf(AmendmentOpportunityWrapper)).call(this,opptyModel,contractModel));}_createClass(AmendmentOpportunityWrapper,[{key:"getQuoteStartDate",value:function getQuoteStartDate(){return Promise.resolve(this._opportunityModel.CloseDate);}},{key:"getQuoteEndDate",value:function getQuoteEndDate(){return this._primaryContract.DisableAmendmentCoTerm__c||this._primaryContract.Evergreen__c?Promise.resolve(null):this._primaryContract.calculateAmendmentEndDate();}},{key:"quoteGroupingAllowed",get:function get(){return false;}},{key:"masterContractId",get:function get(){return this._primaryContract.Id;}}]);return AmendmentOpportunityWrapper;}(BaseOpportunityWrapper);module.exports=AmendmentOpportunityWrapper;},{"../common/BaseOpportunityWrapper.js":30}],29:[function(require,module,exports){(function(process){(function(){var logger=require('js-logger').logger.getLogger("AR Data Tracker");function _sendDataChangesToParent(changeType,changeArgs){if(process&&process.send){process.send({changeType:changeType,changeArgs:changeArgs});}else{logger.error('No parent process exists to whom change data should be sent.');}}var DELETE='delete';var CREATE='create';var UNCREATE='uncreate';var CHANGE='change';module.exports.DELETE=DELETE;module.exports.CREATE=CREATE;module.exports.UNCREATE=UNCREATE;module.exports.CHANGE=CHANGE;module.exports.storeDeletedRecordIds=function(ids,sobjectType){_sendDataChangesToParent(DELETE,[ids,sobjectType]);};module.exports.storeCreatedRecordIds=function(ids,sobjectType,parentIds){_sendDataChangesToParent(CREATE,[ids,sobjectType,parentIds]);};module.exports.storeChangedRecords=function(records){_sendDataChangesToParent(CHANGE,[records]);};module.exports.unstoreCreatedRecordIds=function(ids){_sendDataChangesToParent(UNCREATE,[ids]);};}).call(this);}).call(this,require('_process'));},{"_process":73,"js-logger":58}],30:[function(require,module,exports){'use strict';var BaseOpportunityWrapper=function(){function BaseOpportunityWrapper(opptyModel,primaryContract){_classCallCheck(this,BaseOpportunityWrapper);this._opportunityModel=opptyModel;this._primaryContract=primaryContract;}_createClass(BaseOpportunityWrapper,[{key:"getQuoteStartDate",value:function getQuoteStartDate(){throw new Error('ERROR: BaseOpportunityWrapper.quoteStartDate should be overridden by subclasses, and never invoked directly.');}},{key:"getQuoteEndDate",value:function getQuoteEndDate(){throw new Error('ERROR: BaseOpportunityWrapper.quoteEndDate should be overridden by subclasses, and never invoked directly.');}},{key:"opportunityModel",get:function get(){return this._opportunityModel;}},{key:"primaryContract",get:function get(){return this._primaryContract;}},{key:"renewalTerm",get:function get(){return this._primaryContract.RenewalTerm__c;}},{key:"renewalUpliftRate",get:function get(){return this._primaryContract.RenewalUpliftRate__c;}},{key:"originalQuote",get:function get(){return this._primaryContract.Quote__r;}},{key:"controllingAccount",get:function get(){return this._primaryContract.Account;}},{key:"quoteGroupingAllowed",get:function get(){throw new Error('ERROR: BaseOpportunityWrapper.quoteGroupingAllowed should be overridden by subclasses, and never invoked directly.');}}]);return BaseOpportunityWrapper;}();module.exports=BaseOpportunityWrapper;},{}],31:[function(require,module,exports){'use strict';var MetaDataUtils=require('../../calc/Utils/MetaDataUtils.js');var OperatorsUtils=require('../../calc/Utils/OperatorsUtils.js');var ContractedPriceDAO=require('../DAO/ContractedPriceDAO.js');var QuoteDAO=require('../DAO/QuoteDAO.js');var DateUtils=require('../../Utils/DateUtils.js');var ContractedPriceApplicator=function(){function ContractedPriceApplicator(settings,connection){_classCallCheck(this,ContractedPriceApplicator);this._settings=settings;this._salesCloudPrefix=this._settings.salesCloudPrefix;this._conn=connection;}_createClass(ContractedPriceApplicator,[{key:"_assignContractedPrice",value:function _assignContractedPrice(quoteLine,contractedPrice){quoteLine.record[this._salesCloudPrefix+'ContractedPrice__c']=contractedPrice['Id'];if(contractedPrice[this._salesCloudPrefix+'Discount__c']!=null){if((quoteLine.record[this._salesCloudPrefix+'SubscriptionPricing__c']||'').toLowerCase()=='percent of total'){quoteLine.record[this._salesCloudPrefix+'SpecialPrice__c']=contractedPrice[this._salesCloudPrefix+'Discount__c'];}else{quoteLine.record[this._salesCloudPrefix+'SpecialPrice__c']=quoteLine.record[this._salesCloudPrefix+'ListPrice__c']*(100-contractedPrice[this._salesCloudPrefix+'Discount__c'])/100;}}else if(contractedPrice[this._salesCloudPrefix+'Price__c']!=null){quoteLine.record[this._salesCloudPrefix+'SpecialPrice__c']=contractedPrice[this._salesCloudPrefix+'Price__c'];}quoteLine.record[this._salesCloudPrefix+'SpecialPriceType__c']='Contracted Price';if(contractedPrice[this._salesCloudPrefix+'DiscountSchedule__c']!=null){quoteLine.record[this._salesCloudPrefix+'DiscountSchedule__c']=contractedPrice[this._salesCloudPrefix+'DiscountSchedule__c'];}if(contractedPrice[this._salesCloudPrefix+'NonDiscountable__c']){quoteLine.record[this._salesCloudPrefix+'NonDiscountable__c']=true;}if(contractedPrice[this._salesCloudPrefix+'Description__c']!=null){quoteLine.record[this._salesCloudPrefix+'SpecialPriceDescription__c']=contractedPrice[this._salesCloudPrefix+'Description__c'];}}},{key:"assignContractedPrices",value:function assignContractedPrices(quote){var _this100=this;var customAccountField=this._settings.calcSettings.quoteMagicFieldApiNamesByAlias['ContractedAccountId__c'];var accId=customAccountField&&quote.record[customAccountField]?quote.record[customAccountField]:quote.record[this._salesCloudPrefix+'Account__c'];var productIds=quote.lineItems.map(function(lineItem){return lineItem.record[_this100._salesCloudPrefix+'Product__c'];});var asOfDate=this._determineAsOfDate(quote);var currencyCode=this._settings.isMultiCurrencyOrg?quote.record['CurrencyIsoCode']:null;var cpDao=new ContractedPriceDAO(this._conn,this._settings);var contractedPriceMap=null;return cpDao.loadRelevantContractedPrices(accId,productIds,currencyCode,asOfDate).then(function(daoResults){contractedPriceMap=daoResults;if(contractedPriceMap.has('FILTERED')){var fieldsToRequery=_this100._settings.contractedPriceRequeryFields;var qdao=new QuoteDAO(_this100._conn,_this100._settings);return qdao.saveRequeryRollbackIncompleteLines(quote.lineItems,fieldsToRequery);}else{return quote.lineItems.map(function(lineItem){return lineItem.record;});}}).then(function(filterableLines){quote.lineItems.forEach(function(lineItem,idx){var contractedPrice=contractedPriceMap.get(lineItem.record[_this100._salesCloudPrefix+'Product__c'])||_this100._findApplicableFilteredPrice(filterableLines[idx],contractedPriceMap.get('FILTERED'));if(contractedPrice!=null){_this100._assignContractedPrice(lineItem,contractedPrice);}});return quote;});}},{key:"_determineAsOfDate",value:function _determineAsOfDate(quoteVo){var _this101=this;var asOfDate=quoteVo.record[this._salesCloudPrefix+'StartDate__c'];quoteVo.lineItems.forEach(function(lineItem){var lineStartDate=lineItem.record[_this101._salesCloudPrefix+'StartDate__c'];if(lineStartDate!=null&&(asOfDate==null||asOfDate>lineStartDate)){asOfDate=lineStartDate;}});return asOfDate||DateUtils.toApexDate(new Date());}},{key:"_findApplicableFilteredPrice",value:function _findApplicableFilteredPrice(testLine,filterPrices){if(filterPrices==null||filterPrices.length===0){return null;}var filterPriceCount=filterPrices.length;for(var i=0;i<filterPriceCount;i++){var filterPrice=filterPrices[i];var filterFieldAlias=filterPrice[this._salesCloudPrefix+'FilterField__c'];var filterFieldName=MetaDataUtils.getField(this._salesCloudPrefix+'QuoteLine__c',filterFieldAlias,this._salesCloudPrefix);var operator=OperatorsUtils.getInstance(filterPrice[this._salesCloudPrefix+'Operator__c']);var lineValue=testLine[filterFieldName];var testValue=filterPrice[this._salesCloudPrefix+'FilterValue__c'];if(operator.evaluate(lineValue,testValue)){return filterPrice;}}return null;}}]);return ContractedPriceApplicator;}();module.exports=ContractedPriceApplicator;},{"../../Utils/DateUtils.js":6,"../../calc/Utils/MetaDataUtils.js":52,"../../calc/Utils/OperatorsUtils.js":53,"../DAO/ContractedPriceDAO.js":12,"../DAO/QuoteDAO.js":17}],32:[function(require,module,exports){'use strict';var LineItemConvertible=function(){function LineItemConvertible(key,settings,objMap,services){_classCallCheck(this,LineItemConvertible);this._salesCloudPrefix=settings.salesCloudPrefix||'';this._serviceCloudPrefix=settings.serviceCloudPrefix||'';this._isServiceCloudEnabled=settings.isServiceCloudEnabled;this._key=key;this._settings=settings;this._objMap=objMap;this._account=objMap.account;this._contract=objMap.contract;this._product=objMap.product;this._quote=objMap.quote;this._group=objMap.group;this._services=services;this._parent=null;this._children=[];this._originalRecords=[];this._revisions=[];this._createdLines=[];this._initialized=false;}_createClass(LineItemConvertible,[{key:"_initialize",value:function _initialize(){var _this102=this;if(this._initialized){return Promise.resolve();}else{var lineType=this._salesCloudPrefix+'QuoteLine__c';var prodMappedFields=this._services.fieldMetadataService.getSharedMappableFieldNames('Product2',lineType);var sourceRecType=this._sourceRecord.attributes.type;var sourceMappedFields=this._services.fieldMetadataService.getSharedMappableFieldNames(sourceRecType,lineType);var optionMappedFields=this._services.fieldMetadataService.getSharedMappableFieldNames(this._salesCloudPrefix+'ProductOption__c',lineType);return Promise.all([prodMappedFields,sourceMappedFields,optionMappedFields]).then(function(results){_this102._mappedProductFields=results[0];_this102._mappedSourceFields=results[1];_this102._mappedOptionFields=results[2];_this102._initialized=true;});}}},{key:"addOriginalRecord",value:function addOriginalRecord(rec){this._originalRecords.push(rec);}},{key:"addRevision",value:function addRevision(rec){this._revisions.push(rec);}},{key:"addParent",value:function addParent(parent){this._parent=parent;}},{key:"addChild",value:function addChild(child){this._children.push(child);}},{key:"process",value:function process(){var _this103=this;if(!this._shouldGenerateLines()){return Promise.resolve();}return this._createVO().then(function(){return Promise.all(_this103._processChildren());});}},{key:"_processChildren",value:function _processChildren(){var childPromiseArray=[];this._children.forEach(function(child){childPromiseArray.push(child.process());});return childPromiseArray;}},{key:"_shouldGenerateLines",value:function _shouldGenerateLines(){return this._getSummedQuantity()>0;}},{key:"_isPriceHoldInEffect",value:function _isPriceHoldInEffect(){var priceHoldDateString=this._account[this._salesCloudPrefix+'PriceHoldEnd__c'];if(!priceHoldDateString){return false;}var parts=priceHoldDateString.split('-');var priceHoldDate=Date.UTC(parts[0],parts[1]-1,parts[2]);var now=Date.now();return priceHoldDate>now;}},{key:"_verifyNonNullValuesForRequiredFields",value:function _verifyNonNullValuesForRequiredFields(){}},{key:"_getSummedQuantity",value:function _getSummedQuantity(){throw new Error('LineItemConvertible._getSummedQuantity() should be overridden by child classes, and never invoked directly.');}},{key:"_listPriceMapsFromProduct",value:function _listPriceMapsFromProduct(){throw new Error('LineItemConvertible._listPriceMapsFromProduct() should be overridden by child classes, and never invoked directly.');}},{key:"_getListPriceFromSourceRecord",value:function _getListPriceFromSourceRecord(){throw new Error('LineItemConvertible._getListPriceFromSourceRecord() should be overridden by child classes, and never invoked directly.');}},{key:"_createVO",value:function _createVO(){var _this104=this;if(this.lineVO){return Promise.resolve();}else{return this._initialize().then(function(){var lineVO={dirty:false,record:{attributes:{type:_this104._salesCloudPrefix+'QuoteLine__c'}}};_this104._verifyNonNullValuesForRequiredFields();_this104._setListPrice(lineVO);_this104._setValuesFromQuote(lineVO);_this104._setValuesFromGroup(lineVO);_this104._setValuesFromProduct(lineVO);_this104._setValuesFromOption(lineVO);_this104._setValuesFromOrigin(lineVO);_this104.lineVO=lineVO;});}}},{key:"_getProductOption",value:function _getProductOption(optionId){var prefix=this._salesCloudPrefix;var product=this._product;var options=product[prefix+'OptionalFor__r'];if(options){var optionCount=options.records.length;for(var i=0;i<optionCount;i++){var option=options.records[i];if(option.Id.slice(0,15)===optionId.slice(0,15)){return option;}}}return null;}},{key:"_getListPriceFromProduct",value:function _getListPriceFromProduct(){var prefix=this._salesCloudPrefix;if(this._preserveBundleStructure()&&this._getEffectiveOptionId(this._sourceRecord)!=null){var option=this._getProductOption(this._getEffectiveOptionId(this._sourceRecord));if(option!=null&&option[prefix+'UnitPrice__c']!=null){return option[prefix+'UnitPrice__c'];}}var pricebookId=this._quote[prefix+'PricebookId__c'];var currencyCode=this._quote['CurrencyIsoCode'];var pricebookEntry=this._getPricebookEntry(pricebookId,currencyCode);return pricebookEntry?pricebookEntry.UnitPrice:null;}},{key:"_setListPrice",value:function _setListPrice(vo){var prefix=this._salesCloudPrefix;var listPrice=null;if(this._listPriceMapsFromProduct()){listPrice=this._getListPriceFromProduct();}else{listPrice=this._getListPriceFromSourceRecord();}vo.record[prefix+'ListPrice__c']=listPrice;}},{key:"_setValuesFromQuote",value:function _setValuesFromQuote(vo){var record=vo.record;var quote=this._quote;if(this._settings.isMultiCurrencyOrg){record['CurrencyIsoCode']=quote['CurrencyIsoCode'];}record[this._salesCloudPrefix+'Quote__c']=quote.Id;}},{key:"_setValuesFromGroup",value:function _setValuesFromGroup(vo){var record=vo.record;var prefix=this._salesCloudPrefix;record[prefix+'SubscriptionScope__c']=this._group?'Group':'Quote';}},{key:"_setValuesFromProduct",value:function _setValuesFromProduct(vo){var record=vo.record;var product=this._product;var prefix=this._salesCloudPrefix;record[prefix+'Product__c']=product.Id;if(product[prefix+'BatchQuantity__c']!=null){record[prefix+'BatchQuantity__c']=product[prefix+'BatchQuantity__c'];}record[prefix+'PriceEditable__c']=product[prefix+'PriceEditable__c'];record[prefix+'CostEditable__c']=product[prefix+'CostEditable__c'];record[prefix+'PricingMethodEditable__c']=product[prefix+'PricingMethodEditable__c'];record[prefix+'PricingMethod__c']=product[prefix+'PricingMethod__c']||'List';record[prefix+'NonDiscountable__c']=product[prefix+'NonDiscountable__c'];record[prefix+'NonPartnerDiscountable__c']=product[prefix+'NonPartnerDiscountable__c'];record[prefix+'CompoundDiscountRate__c']=product[prefix+'CompoundDiscountRate__c'];record[prefix+'AllowAssetRefund__c']=false;record[prefix+'Optional__c']=product[prefix+'Optional__c'];record[prefix+'Hidden__c']=product[prefix+'Hidden__c'];record[prefix+'Taxable__c']=product[prefix+'Taxable__c'];record[prefix+'SubscriptionPricing__c']=product[prefix+'SubscriptionPricing__c'];record[prefix+'SubscriptionPercent__c']=product[prefix+'SubscriptionPercent__c'];record[prefix+'DefaultSubscriptionTerm__c']=product[prefix+'SubscriptionTerm__c'];record[prefix+'SubscriptionBase__c']=product[prefix+'SubscriptionBase__c'];record[prefix+'SubscriptionCategory__c']=product[prefix+'SubscriptionCategory__c'];record[prefix+'TaxCode__c']=product[prefix+'TaxCode__c'];record[prefix+'Description__c']=product['Description'];var pricebookId=this._quote[prefix+'PricebookId__c'];var currencyCode=record['CurrencyIsoCode'];var pricebookEntry=this._getPricebookEntry(pricebookId,currencyCode);if(pricebookEntry){record[prefix+'OriginalPrice__c']=pricebookEntry.UnitPrice;record[prefix+'PricebookEntryId__c']=pricebookEntry.Id;}if(pricebookEntry&&product[prefix+'DynamicPricingConstraint__c']){switch(product[prefix+'DynamicPricingConstraint__c'].toLowerCase()){case'list price is minimum':record[prefix+'MinimumPrice__c']=pricebookEntry.UnitPrice;break;case'list price is maximum':record[prefix+'MaximumPrice__c']=pricebookEntry.UnitPrice;break;}}if(product[prefix+'Costs__r']&&product[prefix+'Costs__r'].records.length>0){var costId=null;for(var i=0;i<product[prefix+'Costs__r'].records.length;i++){var cost=product[prefix+'Costs__r'].records[i];if(!this._settings.isMultiCurrencyOrg){costId=cost.Id;break;}else if(cost['CurrencyIsoCode']===record['CurrencyIsoCode']){costId=cost.Id;break;}}record[prefix+'Cost__c']=costId;}if(record[prefix+'PricingMethod__c'].toLowerCase()==='custom'){record[prefix+'CustomerPrice__c']=record[prefix+'ListPrice__c'];}vo.subscriptionTargetId=product[prefix+'SubscriptionTarget__c'];vo.subscriptionExists=product[prefix+'SubscriptionPricing__c']!=null;vo.hasConfigAttrs=product[prefix+'HasConfigurationAttributes__c'];vo.reconfigurationDisabled=product[prefix+'ReconfigurationDisabled__c'];vo.descriptionLocked=product[prefix+'DescriptionLocked__c'];vo.configurationType=product[prefix+'ConfigurationType__c'];vo.configurationEvent=product[prefix+'ConfigurationEvent__c'];vo.productQuantityEditable=product[prefix+'QuantityEditable__c'];vo.productQuantityScale=product[prefix+'QuantityScale__c'];this._mappedProductFields.forEach(function(field){record[field]=product[field];});}},{key:"_setValuesFromOption",value:function _setValuesFromOption(vo){var prefix=this._salesCloudPrefix;var record=vo.record;if(this._preserveBundleStructure()&&this._getEffectiveOptionId(this._sourceRecord)!=null){var option=this._getProductOption(this._getEffectiveOptionId(this._sourceRecord));if(option){this._mappedOptionFields.forEach(function(field){if(option[field]!=null){record[field]=option[field];}});}}}},{key:"_getEffectiveOptionId",value:function _getEffectiveOptionId(sourceRec){return sourceRec[this._sourceRecPrefix+'ProductOption__c'];}},{key:"_preserveBundleStructure",value:function _preserveBundleStructure(){if(this._contract){var contractPrefix=this._settings.isServiceCloudEnabled?this._serviceCloudPrefix:this._salesCloudPrefix;return this._contract[contractPrefix+'PreserveBundleStructureUponRenewals__c']||false;}else{return this._account[this._salesCloudPrefix+'PreserveBundle__c']||false;}}},{key:"_getPricebookEntry",value:function _getPricebookEntry(pricebookId,currencyCode){var product=this._product;if(product.PricebookEntries){var entryCount=product.PricebookEntries.records.length;for(var i=0;i<entryCount;i++){var entry=product.PricebookEntries.records[i];if(entry.Pricebook2Id.slice(0,15)===pricebookId.slice(0,15)){if(!this._settings.isMultiCurrencyOrg||entry.CurrencyIsoCode===currencyCode){return entry;}}}}return null;}},{key:"_setValuesFromOrigin",value:function _setValuesFromOrigin(vo){var record=vo.record;var quoteLinePrefix=this._salesCloudPrefix;record[quoteLinePrefix+'Quantity__c']=this._getSummedQuantity();var sourcePrefix=this._sourceRecPrefix;var sourceRec=this._sourceRecord;record[quoteLinePrefix+'ChargeType__c']=sourceRec[sourcePrefix+'ChargeType__c'];record[quoteLinePrefix+'BillingType__c']=sourceRec[sourcePrefix+'BillingType__c'];record[quoteLinePrefix+'BillingFrequency__c']=sourceRec[sourcePrefix+'BillingFrequency__c'];record[quoteLinePrefix+'DiscountSchedule__c']=sourceRec[sourcePrefix+'DiscountSchedule__c'];record[quoteLinePrefix+'TermDiscountSchedule__c']=sourceRec[sourcePrefix+'TermDiscountSchedule__c'];record[quoteLinePrefix+'UnitCost__c']=sourceRec[sourcePrefix+'UnitCost__c'];record[quoteLinePrefix+'OriginalUnitCost__c']=sourceRec[sourcePrefix+'OriginalUnitCost__c'];record[quoteLinePrefix+'MarkupRate__c']=sourceRec[sourcePrefix+'MarkupRate__c'];record[quoteLinePrefix+'Markup__c']=sourceRec[sourcePrefix+'MarkupAmount__c'];if(sourceRec[sourcePrefix+'QuoteLine__r']&&(sourceRec[sourcePrefix+"ProductId__c"]===sourceRec[sourcePrefix+"RenewalProductId__c"]||this._quote[sourcePrefix+"Type__c"]==='Amendment')){record[quoteLinePrefix+'Description__c']=sourceRec[sourcePrefix+'QuoteLine__r'][quoteLinePrefix+'Description__c'];}else if(sourceRec[sourcePrefix+'Product__r']&&(sourceRec[sourcePrefix+"ProductId__c"]===sourceRec[sourcePrefix+"RenewalProductId__c"]||this._quote[sourcePrefix+"Type__c"]==='Amendment')){record[quoteLinePrefix+'Description__c']=sourceRec[sourcePrefix+'Product__r']['Description'];}if(this._preserveBundleStructure()){var productOption=this._getEffectiveOptionId(sourceRec);record[quoteLinePrefix+'ProductOption__c']=productOption;var doesRenewalProductOptionExist=false;if(productOption!=null){var renewalProductOptionId=sourceRec[sourcePrefix+'RenewalProductOptionId__c'];var renewalProductOptionProductId=sourceRec[sourcePrefix+'RenewalProductOptionProductId__c'];doesRenewalProductOptionExist=renewalProductOptionId&&renewalProductOptionProductId;}var isRenewalQuote=this._quote[sourcePrefix+"Type__c"]==='Renewal';if(isRenewalQuote&&doesRenewalProductOptionExist&&sourceRec[sourcePrefix+'ProductOption__r']&&sourceRec[sourcePrefix+'ProductOption__r'][quoteLinePrefix+'RenewalProductOption__r']){var renewalProductOptionFeatureId=sourceRec[sourcePrefix+'ProductOption__r'][quoteLinePrefix+'RenewalProductOption__r'][quoteLinePrefix+'Feature__c'];if(renewalProductOptionFeatureId){record[quoteLinePrefix+'DynamicOptionId__c']=renewalProductOptionFeatureId;}}else{if(sourceRec[sourcePrefix+'DynamicOptionId__c']!=null){var dynOpId=sourceRec[sourcePrefix+'DynamicOptionId__c'];var dynOpParts=dynOpId.split(':');if(dynOpParts.length===1||dynOpParts[1]===record[quoteLinePrefix+'Product__c']){record[quoteLinePrefix+'DynamicOptionId__c']=dynOpId;}else if(dynOpParts.length>1){var featureId=this.parent.lineVO.record[quoteLinePrefix+'Product__c']===sourceRec[sourcePrefix+'RequiredByProduct__c']?dynOpParts[0]:'null';record[quoteLinePrefix+'DynamicOptionId__c']=featureId+':'+record[quoteLinePrefix+'Product__c'];}}}record[quoteLinePrefix+'OptionLevel__c']=sourceRec[sourcePrefix+'OptionLevel__c']||null;record[quoteLinePrefix+'OptionType__c']=sourceRec[sourcePrefix+'OptionType__c'];record[quoteLinePrefix+'OptionDiscount__c']=sourceRec[sourcePrefix+'OptionDiscount__c'];record[quoteLinePrefix+'OptionDiscountAmount__c']=sourceRec[sourcePrefix+'OptionDiscountAmount__c'];record[quoteLinePrefix+'Bundle__c']=sourceRec[sourcePrefix+'Bundle__c'];record[quoteLinePrefix+'Bundled__c']=sourceRec[sourcePrefix+'Bundled__c'];record[quoteLinePrefix+'ComponentDiscountedByPackage__c']=sourceRec[sourcePrefix+'ComponentDiscountedByPackage__c'];record[quoteLinePrefix+'PackageProductCode__c']=sourceRec[sourcePrefix+'PackageProductCode__c'];record[quoteLinePrefix+'PackageProductDescription__c']=sourceRec[sourcePrefix+'PackageProductDescription__c'];switch(record[quoteLinePrefix+'OptionType__c']){case'Component':if((record[quoteLinePrefix+'SubscriptionPricing__c']||'').toLowerCase()!=='percent of total'&&sourceRec[sourcePrefix+'SegmentIndex__c']==null){var parentQty=this.parent.lineVO.record[quoteLinePrefix+'Quantity__c'];record[quoteLinePrefix+'BundledQuantity__c']=record[quoteLinePrefix+'Quantity__c']/parentQty;break;}case'Accessory':if(sourceRec[sourcePrefix+'SegmentIndex__c']==null){record[quoteLinePrefix+'BundledQuantity__c']=record[quoteLinePrefix+'Quantity__c'];}break;}}this._mappedSourceFields.forEach(function(field){record[field]=sourceRec[field];});}},{key:"_rootIDNull",value:function _rootIDNull(){var sourceRec=this._sourceRecord;var sourcePrefix=this._sourceRecPrefix;return!sourceRec[sourcePrefix+'RootId__c'];}},{key:"key",get:function get(){return this._key;}},{key:"children",get:function get(){return this._children;}},{key:"parent",get:function get(){return this._parent;}},{key:"_subscribedAssetRelationshipName",get:function get(){return this._settings.isServiceCloudEnabled?'Entitlements':this._salesCloudPrefix+'SubscribedAssets__r';}},{key:"conversionResults",get:function get(){return this.lineVO;}},{key:"_sourceRecord",get:function get(){if(this._originalRecords.length>0){return this._originalRecords[0];}else{if(this._revisions.length>0){var revision=this._revisions[0];var revId=revision.Id;var revType=revision.attributes.type;var msgTemplate=this._settings.labels.msg_amendrenew_err_no_source_rec;throw new Error(msgTemplate.replace('{0}',revType).replace('{1}',revId));}else{var _msgTemplate=this._settings.labels.msg_amendrenew_err_no_recs_at_all;throw new Error(_msgTemplate.replace('{0}',this._key));}}return this._originalRecords[0];}},{key:"_sourceRecType",get:function get(){return this._sourceRecord.attributes.type;}},{key:"_sourceRecPrefix",get:function get(){throw new Error('LineItemConvertible._sourceRecPrefix should be overridden by child classes, and never invoked directly.');}}]);return LineItemConvertible;}();module.exports=LineItemConvertible;},{}],33:[function(require,module,exports){'use strict';var LineItemConvertibleGenerator=function(){function LineItemConvertibleGenerator(settings,services){_classCallCheck(this,LineItemConvertibleGenerator);this._settings=settings;this._isServiceCloudEnabled=settings.isServiceCloudEnabled;this._salesCloudPrefix=settings.salesCloudPrefix;this._serviceCloudPrefix=settings.serviceCloudPrefix;this._subPrefix=this._isServiceCloudEnabled?this._serviceCloudPrefix:this._salesCloudPrefix;this._subscriptionType=this._isServiceCloudEnabled?'ContractLineItem':this._salesCloudPrefix+'Subscription__c';this._services=services;this._rootKeyset=new Set();this._rootArray=[];this._convertiblesByKey=new Map();this._convertibleKeysByRecordId=new Map();this._orphanConvertiblesByParentId=new Map();this._orphanIdsByParentId=new Map();}_createClass(LineItemConvertibleGenerator,[{key:"generateConvertibles",value:function generateConvertibles(subscriptions,assets,constructorMap,relatedObjects,processOptions){var _this105=this;this._rootArray=[];this._rootKeyset=new Set();if(processOptions.preserveBundleStructure&&processOptions.combineSubscriptionQuantities){throw Error('ERROR: "Preserve Bundle Structure" and "Combine Subscription Quantities" cannot be active simultaneously.');}var argArray=[subscriptions,this._subPrefix,this._subPrefix+'RevisedSubscription__c',{standard:constructorMap.sub,mdq:constructorMap.mdq},processOptions];var rfArg=this._subPrefix+'RevisedSubscription__c';var constrArg={standard:constructorMap.sub,mdq:constructorMap.mdq};this._processRecords(subscriptions,this._subPrefix,rfArg,constrArg,relatedObjects,processOptions);rfArg=this._salesCloudPrefix+'RevisedAsset__c';constrArg.standard=constructorMap.asset;this._processRecords(assets,this._salesCloudPrefix,rfArg,constrArg,relatedObjects,processOptions);if(this._orphanIdsByParentId.size!==0){var firstAvailablePair=this._orphanIdsByParentId.entries().next().value;var parentId=firstAvailablePair[0];var firstOrphanId=firstAvailablePair[1][0];var firstAvailableOrphanConvertible=this._orphanConvertiblesByParentId.get(parentId)[0];if(firstAvailableOrphanConvertible._rootIDNull()){var errMsg=this._settings.labels.msg_amendrenew_err_rootId_null.replace('{0}',firstAvailableOrphanConvertible._sourceRecType).replace('{1}',firstOrphanId);throw Error(errMsg);}else{var _errMsg=this._settings.labels.msg_amendrenew_err_parent_record_not_found.replace('{0}',firstAvailableOrphanConvertible._sourceRecType).replace('{1}',firstOrphanId).replace('{2}',parentId);throw Error(_errMsg);}}this._rootKeyset.forEach(function(rootKey){_this105._rootArray.push(_this105._convertiblesByKey.get(rootKey));});return this._rootArray;}},{key:"_processRecords",value:function _processRecords(records,prefix,revisionField,constructors,relatedObjects,processOptions){var isCombineSubQtysOnRenewal=processOptions.isRenewal&&processOptions.combineSubscriptionQuantities;var recCount=records.length;for(var i=0;i<recCount;i++){var rec=records[i];if(this._convertibleKeysByRecordId.has(rec.Id)){continue;}var subscriptionShouldBeSkipped=isCombineSubQtysOnRenewal&&rec[prefix+'TerminatedDate__c']&&!rec[prefix+'SegmentLabel__c'];if(subscriptionShouldBeSkipped){continue;}var conKey=this._determineConvertibleKey(rec,prefix,revisionField,processOptions);var convertible=void 0;var convertibleCreatedFromScratch=true;if(this._convertiblesByKey.has(conKey)){convertibleCreatedFromScratch=false;convertible=this._convertiblesByKey.get(conKey);}else if(conKey.startsWith('MDQ_')){var relatedRecordBundle=this._createRelatedRecordBundle(rec,prefix,relatedObjects,processOptions);convertible=new constructors.mdq(conKey,this._settings,relatedRecordBundle,this._services);this._convertiblesByKey.set(conKey,convertible);}else{var _relatedRecordBundle=this._createRelatedRecordBundle(rec,prefix,relatedObjects,processOptions);convertible=new constructors.standard(conKey,this._settings,_relatedRecordBundle,this._services);this._convertiblesByKey.set(conKey,convertible);}if(rec[revisionField]){convertible.addRevision(rec);}else{convertible.addOriginalRecord(rec);}var parentId=rec[prefix+'RequiredById__c']||rec[prefix+'RequiredByAsset__c']||rec[this._requiredBySubscriptionField];if(convertibleCreatedFromScratch&&(!parentId||!processOptions.preserveBundleStructure)){this._rootKeyset.add(conKey);}this._convertibleKeysByRecordId.set(rec.Id,conKey);if(!processOptions.preserveBundleStructure){continue;}this._matchOrphansToParent(convertible,rec.Id);if(parentId&&!convertible.parent){if(!convertibleCreatedFromScratch){this._rootKeyset.delete(conKey);}if(this._convertibleKeysByRecordId.has(parentId)){var parentKey=this._convertibleKeysByRecordId.get(parentId);var parentConvertible=this._convertiblesByKey.get(parentKey);convertible.addParent(parentConvertible);parentConvertible.addChild(convertible);}else{if(this._orphanConvertiblesByParentId.has(parentId)){this._orphanConvertiblesByParentId.get(parentId).push(convertible);}else{this._orphanConvertiblesByParentId.set(parentId,[convertible]);}if(this._orphanIdsByParentId.has(parentId)){this._orphanIdsByParentId.get(parentId).push(rec.Id);}else{this._orphanIdsByParentId.set(parentId,[rec.Id]);}}}}}},{key:"_determineConvertibleKey",value:function _determineConvertibleKey(record,prefix,revisionField,processOptions){if(record[prefix+'SegmentKey__c']){var revisedMDQSubscriptionId=record[revisionField];if(revisedMDQSubscriptionId&&this._convertibleKeysByRecordId.has(revisedMDQSubscriptionId)){return this._convertibleKeysByRecordId.get(revisedMDQSubscriptionId);}return'MDQ_'+record[prefix+'SegmentKey__c'];}else if(processOptions.combineSubscriptionQuantities&&record.attributes.type===this._subscriptionType){var effectiveProductId=record[prefix+'ProductId__c'];if(processOptions.isRenewal){effectiveProductId=record[prefix+'RenewalProductId__c']||effectiveProductId;}var endDateField=this._isServiceCloudEnabled?'EndDate':this._salesCloudPrefix+'EndDate__c';return effectiveProductId+'_'+record[endDateField];}else if(record.attributes.type==='Asset'&&record['Quantity']==null){return'VIRTUAL_'+record.Id;}else if(record.attributes.type==='Asset'&&record[prefix+'VirtualAsset__c']!=null&&record[prefix+'VirtualAsset__c']!=record[prefix+'RequiredByAsset__c']){return'VIRTUAL_'+record[prefix+'VirtualAsset__c'];}else if(record.attributes.type==='Asset'&&record[prefix+'CombineKey__c']!=null){return'COMBINE_'+record[prefix+'CombineKey__c'];}else{return record[revisionField]||record.Id;}}},{key:"_createRelatedRecordBundle",value:function _createRelatedRecordBundle(record,prefix,relatedObjects,processOptions){var relatedRecords={quote:relatedObjects.quote,group:relatedObjects.group,account:relatedObjects.account,contract:relatedObjects.contract};var productsById=relatedObjects.productsById;var effectiveProductId=null;if(record.attributes.type==='Asset'){effectiveProductId=record.Product2Id;}else if(processOptions.isRenewal){var renewalOptionProduct=processOptions.preserveBundleStructure?record[prefix+'RenewalProductOptionProductId__c']:null;var renewalProduct=!processOptions.preserveBundleStructure||record[prefix+'ProductOption__c']==null?record[prefix+'RenewalProductId__c']:null;effectiveProductId=renewalOptionProduct||renewalProduct||record[prefix+'ProductId__c'];}else{effectiveProductId=record[prefix+'ProductId__c'];}relatedRecords.product=productsById.get(effectiveProductId);return relatedRecords;}},{key:"_matchOrphansToParent",value:function _matchOrphansToParent(parent,id){if(this._orphanConvertiblesByParentId.has(id)){var orphans=this._orphanConvertiblesByParentId.get(id);var orphanCount=orphans.length;for(var j=0;j<orphanCount;j++){var orphan=orphans[j];if(orphan.parent){if(orphan.parent.key!==parent.key){var err=this._settings.labels.msg_amendrenew_err_two_parent_convs.replace('{0}',orphan.key).replace('{1}',orphan.parent.key).replace('{2}',parent.key);throw Error(err);}}else{parent.addChild(orphan);orphan.addParent(parent);}}this._orphanConvertiblesByParentId.delete(id);this._orphanIdsByParentId.delete(id);}}},{key:"_requiredBySubscriptionField",get:function get(){return this._isServiceCloudEnabled?this._serviceCloudPrefix+'RequiredByLineItem__c':this._salesCloudPrefix+'RequiredBySubscription__c';}}]);return LineItemConvertibleGenerator;}();module.exports=LineItemConvertibleGenerator;},{}],34:[function(require,module,exports){'use strict';var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var LineItemConvertibleProcessor=function(){function LineItemConvertibleProcessor(settings){_classCallCheck(this,LineItemConvertibleProcessor);this._salesCloudPrefix=settings.salesCloudPrefix;this._effectiveLineNumber=0;this._knownSegmentKeysToLineNumbers=new Map();this._logger=jsLogger;}_createClass(LineItemConvertibleProcessor,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"processConvertibleTrees",value:function processConvertibleTrees(convertibleTrees,quoteVO,groupVO){var _this106=this;this._determineNextLineNumber(quoteVO);var promiseArray=[];convertibleTrees.forEach(function(tree){promiseArray.push(tree.process());});this._logMessage('LineItemConvertibleProcessor.js: Process LineItemConvertibles.');var processLineItemConvertiblesStartTime=Date.now();var addLineItemConveriblesToQuoteStartTime=void 0;var addLineItemConveribleToQuoteStartTime=void 0;return Promise.all(promiseArray).then(function(){_this106._logMessage('LineGenerationManager.js: Processing LineItemConvertibles took '+(Date.now()-processLineItemConvertiblesStartTime)+' ms.');_this106._logMessage('LineItemConvertibleProcessor.js: Add LineItemConvertibles to quote.');addLineItemConveriblesToQuoteStartTime=Date.now();convertibleTrees.forEach(function(tree){_this106._logMessage('LineItemConvertibleProcessor.js: Add LineItemConvertible to quote.');addLineItemConveribleToQuoteStartTime=Date.now();_this106._recursivelyAddTreeToQuote(tree,null,quoteVO,groupVO);_this106._logMessage('LineGenerationManager.js: Adding LineItemConvertible to quote took '+(Date.now()-addLineItemConveriblesToQuoteStartTime)+' ms.');});_this106._logMessage('LineGenerationManager.js: Adding LineItemConvertibles to quote took '+(Date.now()-addLineItemConveriblesToQuoteStartTime)+' ms.');});}},{key:"_recursivelyAddTreeToQuote",value:function _recursivelyAddTreeToQuote(lineConvertible,parentLineVO,quoteVO,groupVO){var _this107=this;var conversionResults=lineConvertible.conversionResults;if(!conversionResults||conversionResults.length===0){return;}else if(!conversionResults.length){this._addLineToQuote(conversionResults,parentLineVO,quoteVO,groupVO);var children=lineConvertible.children;if(children.length>0){children.forEach(function(child){_this107._recursivelyAddTreeToQuote(child,conversionResults,quoteVO,groupVO);});}}else if(conversionResults.length>=1){conversionResults.forEach(function(lineVO){_this107._addLineToQuote(lineVO,parentLineVO,quoteVO,groupVO);});}}},{key:"_addLineToQuote",value:function _addLineToQuote(lineVO,parentLineVO,quoteVO,groupVO){lineVO.key=++quoteVO.nextKey;var lineSegKey=lineVO.record[this._salesCloudPrefix+'SegmentKey__c'];if(!lineSegKey||!this._knownSegmentKeysToLineNumbers.has(lineSegKey)){lineVO.record[this._salesCloudPrefix+'Number__c']=++this._effectiveLineNumber;if(lineSegKey){this._knownSegmentKeysToLineNumbers.set(lineSegKey,this._effectiveLineNumber);}}else{lineVO.record[this._salesCloudPrefix+'Number__c']=this._knownSegmentKeysToLineNumbers.get(lineSegKey);}if(groupVO){lineVO.parentGroupKey=groupVO.key;}else{lineVO.parentGroupKey=null;}if(parentLineVO){lineVO.parentItemKey=parentLineVO.key;}else{lineVO.parentItemKey=null;}quoteVO.lineItems.push(lineVO);}},{key:"_determineNextLineNumber",value:function _determineNextLineNumber(quoteVO){var _this108=this;var effectiveNumber=0;quoteVO.lineItems.forEach(function(line){if(line.record[_this108._salesCloudPrefix+'Number__c']>effectiveNumber){effectiveNumber=line.record[_this108._salesCloudPrefix+'Number__c'];}});this._effectiveLineNumber=effectiveNumber;}}]);return LineItemConvertibleProcessor;}();module.exports=LineItemConvertibleProcessor;},{"js-logger":58}],35:[function(require,module,exports){'use strict';var LineItemConvertible=require('./LineItemConvertible.js');var MDQConvertible=function(_LineItemConvertible2){_inherits(MDQConvertible,_LineItemConvertible2);function MDQConvertible(key,settings,objMap,services){_classCallCheck(this,MDQConvertible);var _this109=_possibleConstructorReturn(this,(MDQConvertible.__proto__||Object.getPrototypeOf(MDQConvertible)).call(this,key,settings,objMap,services));_this109.prefix=_this109._isServiceCloudEnabled?_this109._serviceCloudPrefix:_this109._salesCloudPrefix;_this109._FIRST_SEGMENT_END_DATE_FIELD=_this109.prefix+'FirstSegmentTermEndDate__c';_this109._START_DATE_FIELD=_this109.prefix+'StartDate__c';_this109._END_DATE_FIELD=_this109.prefix+'EndDate__c';_this109._SUBSCRIPTION_TERM_FIELD=_this109.prefix+'SubscriptionTerm__c';_this109._recurringSegmentsByIndex=new Map();_this109._oneTimeSegmentsByKey=new Map();_this109._originalRecIdsToSegIndex=new Map();_this109._unindexedRevisionsByRevisedId=new Map();_this109._DIMTYPE_YEAR='Year';_this109._DIMTYPE_QUARTER='Quarter';_this109._DIMTYPE_MONTH='Month';_this109._DIMTYPE_CUSTOM='Custom';_this109._DIMTYPE_ONETIME='One-time';return _this109;}_createClass(MDQConvertible,[{key:"_addOriginalRecurringRecord",value:function _addOriginalRecurringRecord(rec,segmentConstructor){var prefix=this._isServiceCloudEnabled?this._serviceCloudPrefix:this._salesCloudPrefix;var index=rec[prefix+'SegmentIndex__c'];var seg=this._recurringSegmentsByIndex.has(index)?this._recurringSegmentsByIndex.get(index):new segmentConstructor(this._key,this._settings,this._objMap,this._services,this);this._recurringSegmentsByIndex.set(index,seg);seg.addOriginalRecord(rec);var fifteenCharId=rec['Id'].slice(0,15);this._originalRecIdsToSegIndex.set(fifteenCharId,index);if(this._unindexedRevisionsByRevisedId.has(fifteenCharId)){var unindexedRevisions=this._unindexedRevisionsByRevisedId.get(fifteenCharId);unindexedRevisions.forEach(function(rev){seg.addRevision(rev);});this._unindexedRevisionsByRevisedId.delete(fifteenCharId);}}},{key:"_addRevisionRecurringRecord",value:function _addRevisionRecurringRecord(rec){var prefix=this._isServiceCloudEnabled?this._serviceCloudPrefix:this._salesCloudPrefix;var revisedId=rec[prefix+'RevisedSubscription__c'].slice(0,15);var originalIndex=this._originalRecIdsToSegIndex.get(revisedId);if(originalIndex!=null){var seg=this._recurringSegmentsByIndex.get(originalIndex);seg.addRevision(rec);}else{var unindexedRevisions=this._unindexedRevisionsByRevisedId.get(revisedId)||[];unindexedRevisions.push(rec);this._unindexedRevisionsByRevisedId.set(revisedId,unindexedRevisions);}}},{key:"_addOriginalOneTimeRecord",value:function _addOriginalOneTimeRecord(rec,segmentConstructor){this._addOneTimeSegmentInternal(rec,segmentConstructor,'addOriginalRecord');}},{key:"_addRevisionOneTimeRecord",value:function _addRevisionOneTimeRecord(rec,segmentConstructor){this._addOneTimeSegmentInternal(rec,segmentConstructor,'addRevision');}},{key:"_addOneTimeSegmentInternal",value:function _addOneTimeSegmentInternal(rec,segmentConstructor,recordAdditionMethodName){var key=this._generateOneTimeSegmentKey(rec);var seg=this._oneTimeSegmentsByKey.has(key)?this._oneTimeSegmentsByKey.get(key):new segmentConstructor(this._key,this._settings,this._objMap,this._services,this);this._oneTimeSegmentsByKey.set(key,seg);seg[recordAdditionMethodName].apply(seg,[rec]);}},{key:"_determineRecurringDimensionType",value:function _determineRecurringDimensionType(){if(this._recurringSegmentsByIndex.size<1){throw Error("ERROR: No recurring segments found for MDQ product with key '"+this._key+"'.");}var firstAvailableSeg=this._recurringSegmentsByIndex.entries().next().value[1];return firstAvailableSeg.dimensionType;}},{key:"getRecurringSegmentByIndex",value:function getRecurringSegmentByIndex(index){if(this._recurringSegmentsByIndex.has(index)){return this._recurringSegmentsByIndex.get(index);}return null;}},{key:"_generateOneTimeSegmentKey",value:function _generateOneTimeSegmentKey(rec){var assetPrefix=this._settings.salesCloudPrefix;if(rec[assetPrefix+'VirtualAsset__c']){return rec[assetPrefix+'VirtualAsset__c'];}else if(rec['Quantity']==null){return rec['Id'];}else if(rec[assetPrefix+'CombineKey__c']!=null){return rec[assetPrefix+'CombineKey__c'];}else if(rec[assetPrefix+'RevisedAsset__c']!=null){return rec[assetPrefix+'RevisedAsset__c'];}else{return rec['Id'];}}},{key:"_sourceRecType",get:function get(){return'MDQ Segment';}}]);return MDQConvertible;}(LineItemConvertible);module.exports=MDQConvertible;},{"./LineItemConvertible.js":32}],36:[function(require,module,exports){'use strict';var ContractModel=require('../models/ContractModel.js');var OpportunityModel=require('../models/OpportunityModel.js');var OpportunityDAO=require('../DAO/OpportunityDAO.js');var ContractDAO=require('../DAO/ContractDAO.js');var QuoteDAO=require('../DAO/QuoteDAO.js');var RenewalOpportunity=require('../renewal/RenewalOpportunity.js');var IdToValueCache=require('../../Utils/IdToValueCache.js');var PartnerDAO=require('../DAO/PartnerDAO.js');var OpportunityContactRoleDAO=require('../DAO/OpportunityContactRoleDAO.js');var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var AmendmentOpportunityWrapper=require('../amendment/AmendmentOpportunityWrapper.js');var RenewalOpportunityWrapper=require('../renewal/RenewalOpportunityWrapper.js');var OpportunityGenerator=function(){function OpportunityGenerator(conn,settings,services,contractModelsById){_classCallCheck(this,OpportunityGenerator);this._conn=conn;this._settings=settings;this._serviceCloudActive=this._settings.isServiceCloudEnabled;this._salesCloudPrefix=this._settings.salesCloudPrefix;this._serviceCloudPrefix=this._settings.serviceCloudPrefix;this._services=services;this._labels=settings.labels;this._opportunityDAO=new OpportunityDAO(conn,settings,services);this._contractMap=contractModelsById;this._logger=jsLogger;}_createClass(OpportunityGenerator,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"generateAmendmentOpps",value:function generateAmendmentOpps(opportunityId){var _this110=this;var amendmentOppGenerationPromises=[];if(opportunityId){var _iteratorNormalCompletion21=true;var _didIteratorError21=false;var _iteratorError21=undefined;try{var _loop8=function _loop8(){var contractModel=_step21.value;var oppModel=null;amendmentOppGenerationPromises.push(_this110._opportunityDAO.loadOppsByIds([opportunityId]).then(function(opportunityById){_this110._logMessage('Loaded Opportunities in this flow '+opportunityById.get(opportunityId));oppModel=new OpportunityModel(_this110._settings,opportunityById.get(opportunityId));var amendedContractField='Amended'+ContractModel.getSObjectType(_this110._serviceCloudActive)+'__c';var originalAmendedContract=(oppModel[amendedContractField]||'').slice(0,15);var originalPricebook=(oppModel.Pricebook2Id||'').slice(0,15);oppModel[amendedContractField]=contractModel.Id;oppModel.Pricebook2Id=contractModel.AmendmentPricebookId__c||contractModel.OpportunityPricebookId__c;var contractIdChanged=originalAmendedContract!==contractModel.Id.slice(0,15);var pricebookChanged=originalPricebook!==oppModel.Pricebook2Id.slice(0,15);return!contractIdChanged&&!pricebookChanged?Promise.resolve():_this110._opportunityDAO.updateRecords([_defineProperty({Id:oppModel.Id,Pricebook2Id:oppModel.Pricebook2Id},(_this110._serviceCloudActive?_this110._serviceCloudPrefix:_this110._salesCloudPrefix)+amendedContractField,oppModel[amendedContractField])]);}).then(function(){return new AmendmentOpportunityWrapper(oppModel,contractModel);}));};for(var _iterator21=this._contractMap.values()[Symbol.iterator](),_step21;!(_iteratorNormalCompletion21=(_step21=_iterator21.next()).done);_iteratorNormalCompletion21=true){_loop8();}}catch(err){_didIteratorError21=true;_iteratorError21=err;}finally{try{if(!_iteratorNormalCompletion21&&_iterator21.return){_iterator21.return();}}finally{if(_didIteratorError21){throw _iteratorError21;}}}}else{var _iteratorNormalCompletion22=true;var _didIteratorError22=false;var _iteratorError22=undefined;try{var _loop9=function _loop9(){var contractModel=_step22.value;amendmentOppGenerationPromises.push(_this110._generateOpp('Amendment',contractModel).then(function(oppModel){oppModel.Name=_this110._labels['lbl_amendment_opportunity_name'].replace("{0}",contractModel.ContractNumber);oppModel.CloseDate=oppModel.calculateAmendmentCloseDate(contractModel.AmendmentStartDate__c,contractModel.StartDate);oppModel['Amended'+ContractModel.getSObjectType(_this110._settings.isServiceCloudEnabled)+'__c']=contractModel.Id;_this110._logMessage('AMENDMENT OpportunityGenerator.js: Create opportunity record. Contract='+contractModel.Id+' SessionId='+_this110._settings.userId);var createOppRecordStartTime=Date.now();return _this110._opportunityDAO.createOpportunityRecord(oppModel).then(function(opptyModel){_this110._logMessage('AMENDMENT OpportunityGenerator.js: Creating opportunity record took '+(Date.now()-createOppRecordStartTime)+' ms. Contract='+contractModel.Id+' SessionId='+_this110._settings.userId);return new AmendmentOpportunityWrapper(opptyModel,contractModel);});}));};for(var _iterator22=this._contractMap.values()[Symbol.iterator](),_step22;!(_iteratorNormalCompletion22=(_step22=_iterator22.next()).done);_iteratorNormalCompletion22=true){_loop9();}}catch(err){_didIteratorError22=true;_iteratorError22=err;}finally{try{if(!_iteratorNormalCompletion22&&_iterator22.return){_iterator22.return();}}finally{if(_didIteratorError22){throw _iteratorError22;}}}}var resultsArray=void 0;return Promise.all(amendmentOppGenerationPromises).then(function(amendmentWrapperArray){resultsArray=amendmentWrapperArray;var existingPrimaryQuoteIds=[];amendmentWrapperArray.forEach(function(wrapper){if(wrapper.opportunityModel.PrimaryQuote__c){existingPrimaryQuoteIds.push(wrapper.opportunityModel.PrimaryQuote__c);}});return existingPrimaryQuoteIds.length>0?new QuoteDAO(_this110._conn,_this110._settings).uncheckPrimaryQuotes(existingPrimaryQuoteIds):null;}).then(function(){return resultsArray;},function(err){return Promise.reject(err.message||err);});}},{key:"_determineAutomaticMasterKey",value:function _determineAutomaticMasterKey(contractModel){return contractModel.AccountId+'_'+contractModel.getContractGroup();}},{key:"_determineContractCotermKey",value:function _determineContractCotermKey(contractModel,manualMasterId,activeMastersByMasterKey){var _this111=this;var existingOppId=contractModel.RenewalOpportunity__c;if(existingOppId){return Promise.resolve('RENOPP_'+existingOppId);}else if(manualMasterId){return Promise.resolve('GLOBAL_'+manualMasterId);}else if(contractModel.isActive()&&activeMastersByMasterKey&&activeMastersByMasterKey.has(this._determineAutomaticMasterKey(contractModel))){return Promise.resolve('LOCAL_'+activeMastersByMasterKey.get(this._determineAutomaticMasterKey(contractModel)).Id);}else{if(contractModel.parentAccountAllowsAutomaticMasterlessCoterm()){return contractModel.calculateRenewalStartDate().then(function(renStartDate){var accId=contractModel.AccountId;var pricebookId=contractModel.RenewalPricebookId__c||contractModel.OpportunityPricebookId__c||'';var currencyCode=_this111._settings.isMultiCurrencyOrg?contractModel.CurrencyIsoCode:'';var groupKey=contractModel.getContractGroup();return'NATURAL_'+accId+'_'+pricebookId+'_'+currencyCode+'_'+renStartDate+'_'+groupKey;});}else{return Promise.resolve('NATURAL_'+contractModel.Id);}}}},{key:"_sortContractsByCotermKey",value:function _sortContractsByCotermKey(manualMasterId,activeMastersByMasterKey){var allContracts=[];var cotermPromiseList=[];var _iteratorNormalCompletion23=true;var _didIteratorError23=false;var _iteratorError23=undefined;try{for(var _iterator23=this._contractMap.values()[Symbol.iterator](),_step23;!(_iteratorNormalCompletion23=(_step23=_iterator23.next()).done);_iteratorNormalCompletion23=true){var _contractModel=_step23.value;allContracts.push(_contractModel);cotermPromiseList.push(this._determineContractCotermKey(_contractModel,manualMasterId,activeMastersByMasterKey));}}catch(err){_didIteratorError23=true;_iteratorError23=err;}finally{try{if(!_iteratorNormalCompletion23&&_iterator23.return){_iterator23.return();}}finally{if(_didIteratorError23){throw _iteratorError23;}}}return Promise.all(cotermPromiseList).then(function(cotermKeyList){var contractListsByFinalCotermKey=new Map();allContracts.forEach(function(contract,index){var key=cotermKeyList[index];var listAssociatedWithKey=contractListsByFinalCotermKey.get(key)||[];listAssociatedWithKey.push(contract);contractListsByFinalCotermKey.set(key,listAssociatedWithKey);});return contractListsByFinalCotermKey;});}},{key:"_getMasterContractDescriptor",value:function _getMasterContractDescriptor(cotermKey,coterminousContracts,existingOppsById){var _this112=this;var resultDescriptor={};if(cotermKey.startsWith('GLOBAL_')){resultDescriptor.master=this._contractMap.get(cotermKey.slice(7));resultDescriptor.isTrueMaster=true;return Promise.resolve(resultDescriptor);}else if(cotermKey.startsWith('LOCAL_')){resultDescriptor.master=this._contractMap.get(cotermKey.slice(6));resultDescriptor.isTrueMaster=true;return Promise.resolve(resultDescriptor);}else if(cotermKey.startsWith('NATURAL_')){var _iteratorNormalCompletion24=true;var _didIteratorError24=false;var _iteratorError24=undefined;try{for(var _iterator24=coterminousContracts[Symbol.iterator](),_step24;!(_iteratorNormalCompletion24=(_step24=_iterator24.next()).done);_iteratorNormalCompletion24=true){var cm=_step24.value;if(!resultDescriptor.master||resultDescriptor.master.calculateRenewalTerm()<cm.calculateRenewalTerm()){resultDescriptor.master=cm;}}}catch(err){_didIteratorError24=true;_iteratorError24=err;}finally{try{if(!_iteratorNormalCompletion24&&_iterator24.return){_iterator24.return();}}finally{if(_didIteratorError24){throw _iteratorError24;}}}resultDescriptor.isTrueMaster=false;return Promise.resolve(resultDescriptor);}else if(cotermKey.startsWith('RENOPP_')){var renOppId=cotermKey.slice(7);var renOppModel=new OpportunityModel(this._settings,existingOppsById.get(renOppId));var priorMasterContractId=renOppModel['Renewed'+ContractModel.getSObjectType(this._settings.isServiceCloudEnabled)+'__c'];var _iteratorNormalCompletion25=true;var _didIteratorError25=false;var _iteratorError25=undefined;try{for(var _iterator25=coterminousContracts[Symbol.iterator](),_step25;!(_iteratorNormalCompletion25=(_step25=_iterator25.next()).done);_iteratorNormalCompletion25=true){var _cm=_step25.value;if(_cm.Id.slice(0,15)===priorMasterContractId.slice(0,15)){resultDescriptor.master=_cm;break;}}}catch(err){_didIteratorError25=true;_iteratorError25=err;}finally{try{if(!_iteratorNormalCompletion25&&_iterator25.return){_iterator25.return();}}finally{if(_didIteratorError25){throw _iteratorError25;}}}if(resultDescriptor.master.MasterContract__c&&resultDescriptor.master.isActive()){resultDescriptor.isTrueMaster=true;return Promise.resolve(resultDescriptor);}else{var originalCotermKeyPromises=coterminousContracts.map(function(c){var tmp=c.RenewalOpportunity__c;c.RenewalOpportunity__c=null;return _this112._determineContractCotermKey(c).then(function(originalKey){c.RenewalOpportunity__c=tmp;return originalKey;});});return Promise.all(originalCotermKeyPromises).then(function(originalKeys){resultDescriptor.isTrueMaster=new Set(originalKeys).size>1;return resultDescriptor;});}}}},{key:"_createRenewalOppModelFromScratch",value:function _createRenewalOppModelFromScratch(masterContract){var _this113=this;var oppModel=void 0;return this._generateOpp('Renewal',masterContract).then(function(createdOpp){oppModel=createdOpp;oppModel.Name=_this113._labels['lbl_renewal_opportunity'];oppModel.Renewal__c=true;oppModel['Renewed'+ContractModel.getSObjectType(_this113._settings.isServiceCloudEnabled)+'__c']=masterContract.Id;return masterContract.calculateRenewalStartDate();}).then(function(startDate){oppModel.CloseDate=oppModel.calculateRenewalCloseDate(startDate);return _this113._opportunityDAO.createOpportunityRecord(oppModel);});}},{key:"generateRenewalOpps",value:function generateRenewalOpps(opportunityOnly,manualMasterId){var _this114=this;var existingRenOppIdSet=new Set();var activeMastersByMasterKey=new Map();var existingPrimaryQuoteIds=[];var renOppResults=void 0;var partnersNewOppIdByOldOppId=new Map();var contactRolesNewOppIdByOldOppId=new Map();var _iteratorNormalCompletion26=true;var _didIteratorError26=false;var _iteratorError26=undefined;try{for(var _iterator26=this._contractMap.values()[Symbol.iterator](),_step26;!(_iteratorNormalCompletion26=(_step26=_iterator26.next()).done);_iteratorNormalCompletion26=true){var _contractModel2=_step26.value;if(_contractModel2.RenewalOpportunity__c){existingRenOppIdSet.add(_contractModel2.RenewalOpportunity__c);}else if(_contractModel2.isActive()&&_contractModel2.MasterContract__c){activeMastersByMasterKey.set(this._determineAutomaticMasterKey(_contractModel2),_contractModel2);}}}catch(err){_didIteratorError26=true;_iteratorError26=err;}finally{try{if(!_iteratorNormalCompletion26&&_iterator26.return){_iterator26.return();}}finally{if(_didIteratorError26){throw _iteratorError26;}}}var cotermSortingPromise=this._sortContractsByCotermKey(manualMasterId,activeMastersByMasterKey);var renOppLoadPromise=this._opportunityDAO.loadOppsByIds([].concat(_toConsumableArray(existingRenOppIdSet))).then(function(existingOppsById){var _iteratorNormalCompletion27=true;var _didIteratorError27=false;var _iteratorError27=undefined;try{for(var _iterator27=existingOppsById.values()[Symbol.iterator](),_step27;!(_iteratorNormalCompletion27=(_step27=_iterator27.next()).done);_iteratorNormalCompletion27=true){var existingOpp=_step27.value;var primaryQuoteId=existingOpp[_this114._salesCloudPrefix+'PrimaryQuote__c'];if(primaryQuoteId){existingPrimaryQuoteIds.push(primaryQuoteId);}}}catch(err){_didIteratorError27=true;_iteratorError27=err;}finally{try{if(!_iteratorNormalCompletion27&&_iterator27.return){_iterator27.return();}}finally{if(_didIteratorError27){throw _iteratorError27;}}}return existingOppsById;});return Promise.all([cotermSortingPromise,renOppLoadPromise]).then(function(results){var contractListsByCotermKey=void 0,existingOppsById=void 0;var _results2=_slicedToArray(results,2);contractListsByCotermKey=_results2[0];existingOppsById=_results2[1];var opptyPromiseArray=[];if(_this114._validateContractGroups(contractListsByCotermKey)==true){return Promise.reject(_this114._labels['msg_coterm_currency_error']);}var _iteratorNormalCompletion28=true;var _didIteratorError28=false;var _iteratorError28=undefined;try{var _loop10=function _loop10(){var _step28$value=_slicedToArray(_step28.value,2),cotermKey=_step28$value[0],coterminousContracts=_step28$value[1];var actingMasterContract=void 0;var isTrueMaster=void 0;var opptyModelCreationPromise=_this114._getMasterContractDescriptor(cotermKey,coterminousContracts,existingOppsById).then(function(masterContractDescriptor){actingMasterContract=masterContractDescriptor.master;isTrueMaster=masterContractDescriptor.isTrueMaster;return actingMasterContract.RenewalOpportunity__c?Promise.resolve(new OpportunityModel(_this114._settings,existingOppsById.get(actingMasterContract.RenewalOpportunity__c))):_this114._createRenewalOppModelFromScratch(actingMasterContract).then(function(oppModel){if(actingMasterContract.Opportunity__c){if(actingMasterContract.DefaultRenewalPartners__c){partnersNewOppIdByOldOppId.set(actingMasterContract.Opportunity__c,oppModel.Id);}if(actingMasterContract.DefaultRenewalContactRoles__c){contactRolesNewOppIdByOldOppId.set(actingMasterContract.Opportunity__c,oppModel.Id);}}return oppModel;});}).then(function(oppModel){coterminousContracts.forEach(function(contract){_this114._insertRenOppIntoLookupOnContract(contract,oppModel.Id,opportunityOnly);});return new RenewalOpportunityWrapper(oppModel,actingMasterContract,coterminousContracts,isTrueMaster);});opptyPromiseArray.push(opptyModelCreationPromise);};for(var _iterator28=contractListsByCotermKey[Symbol.iterator](),_step28;!(_iteratorNormalCompletion28=(_step28=_iterator28.next()).done);_iteratorNormalCompletion28=true){_loop10();}}catch(err){_didIteratorError28=true;_iteratorError28=err;}finally{try{if(!_iteratorNormalCompletion28&&_iterator28.return){_iterator28.return();}}finally{if(_didIteratorError28){throw _iteratorError28;}}}return Promise.all(opptyPromiseArray);}).then(function(renOppWrappers){renOppResults=renOppWrappers;if(existingPrimaryQuoteIds.length<1){return;}else{return new QuoteDAO(_this114._conn,_this114._settings).uncheckPrimaryQuotes(existingPrimaryQuoteIds);}}).then(function(){return _this114._mapDefaultContactRolesAndPartners(contactRolesNewOppIdByOldOppId,partnersNewOppIdByOldOppId);}).then(function(){return renOppResults;}).catch(function(err){return Promise.reject(err.message||err);});}},{key:"_generateOpp",value:function _generateOpp(type,contractModel){var _this115=this;var genOppStartTime=Date.now();this._logMessage(type.toUpperCase()+' OpportunityGenerator.js: Generate opportunity. Contract='+contractModel.Id+' SessionId='+this._settings.userId);var oppModel=new OpportunityModel(this._settings,{});var checkOppIsCreateableStartTime=Date.now();var checkOppHasRecordTypeFieldStartTime=void 0;var getOppStageNameStartTime=void 0;var mapCustomFieldsStartTime=void 0;this._logMessage(type.toUpperCase()+' OpportunityGenerator.js: Check if opportunity is createable. Contract='+contractModel.Id+' SessionId='+this._settings.userId);return this._opportunityDAO.isCreateable().then(function(isCreateable){_this115._logMessage(type.toUpperCase()+' OpportunityGenerator.js: Checking if opportunity is createable took '+(Date.now()-checkOppIsCreateableStartTime)+' ms. Contract='+contractModel.Id+' SessionId='+_this115._settings.userId);if(!isCreateable){return Promise.reject(_this115._labels['msg_opportunity_not_creatable']);}oppModel.OwnerId=contractModel[type+'Owner__c']||_this115._settings.userId;oppModel.AccountId=contractModel.AccountId;oppModel.Pricebook2Id=contractModel[type+'PricebookId__c']||contractModel.OpportunityPricebookId__c;if(_this115._settings.isMultiCurrencyOrg){oppModel.CurrencyIsoCode=contractModel.CurrencyIsoCode;}checkOppHasRecordTypeFieldStartTime=Date.now();_this115._logMessage(type.toUpperCase()+' OpportunityGenerator.js: Check if opportunity has RecordType field. Contract='+contractModel.Id+' SessionId='+_this115._settings.userId);return _this115._opportunityDAO.hasRecordTypeField();}).then(function(hasRecordTypeField){_this115._logMessage(type.toUpperCase()+' OpportunityGenerator.js: Checking if opportunity has RecordType field took '+(Date.now()-checkOppHasRecordTypeFieldStartTime)+' ms. Contract='+contractModel.Id+' SessionId='+_this115._settings.userId);if(hasRecordTypeField&&contractModel[type+'OpportunityRecordTypeId__c']){oppModel.RecordTypeId=contractModel[type+'OpportunityRecordTypeId__c'];}getOppStageNameStartTime=Date.now();_this115._logMessage(type.toUpperCase()+' OpportunityGenerator.js: Get opportunity stage name. Contract='+contractModel.Id+' SessionId='+_this115._settings.userId);return contractModel[type+'OpportunityStage__c']?contractModel[type+'OpportunityStage__c']:_this115._opportunityDAO.getOppStage1MasterLabel();}).then(function(oppStageName){_this115._logMessage(type.toUpperCase()+' OpportunityGenerator.js: Getting opportunity stage name took '+(Date.now()-getOppStageNameStartTime)+' ms. Contract='+contractModel.Id+' SessionId='+_this115._settings.userId);oppModel.StageName=oppStageName;mapCustomFieldsStartTime=Date.now();_this115._logMessage(type.toUpperCase()+' OpportunityGenerator.js: Map custom fields from contract to opportunity. Contract='+contractModel.Id+' SessionId='+_this115._settings.userId);return _this115._opportunityDAO.mapCustomFields(contractModel.getContract(),oppModel.getOpportunity());}).then(function(){_this115._logMessage(type.toUpperCase()+': Mapping custom fields from contract to opportunity'+(Date.now()-mapCustomFieldsStartTime)+' ms. Contract='+contractModel.Id+' SessionId='+_this115._settings.userId);_this115._logMessage(type.toUpperCase()+' OpportunityGenerator.js: Generating opportunity took '+(Date.now()-genOppStartTime)+' ms. Contract='+contractModel.Id+' SessionId='+_this115._settings.userId);return oppModel;});}},{key:"_validateContractGroups",value:function _validateContractGroups(contractListsByCotermKey){var _iteratorNormalCompletion29=true;var _didIteratorError29=false;var _iteratorError29=undefined;try{for(var _iterator29=contractListsByCotermKey[Symbol.iterator](),_step29;!(_iteratorNormalCompletion29=(_step29=_iterator29.next()).done);_iteratorNormalCompletion29=true){var _step29$value=_slicedToArray(_step29.value,2),cotermKey=_step29$value[0],_coterminousContracts=_step29$value[1];var check=this._checkContractCurrencies(_coterminousContracts);if(check==true){return true;}}}catch(err){_didIteratorError29=true;_iteratorError29=err;}finally{try{if(!_iteratorNormalCompletion29&&_iterator29.return){_iterator29.return();}}finally{if(_didIteratorError29){throw _iteratorError29;}}}return false;}},{key:"_checkContractCurrencies",value:function _checkContractCurrencies(coterminousContracts){var referenceCurrency=coterminousContracts[0].CurrencyIsoCode;var i=void 0;for(i=0;i<coterminousContracts.length;i++){var contractCurrency=coterminousContracts[i].CurrencyIsoCode;if(referenceCurrency!=contractCurrency){return true;}}return false;}},{key:"_insertRenOppIntoLookupOnContract",value:function _insertRenOppIntoLookupOnContract(contractModel,oppId,opportunityOnly){contractModel.RenewalOpportunity__c=oppId;contractModel.RenewalForecast__c=true;contractModel.RenewalQuoted__c=contractModel.RenewalQuoted__c||!opportunityOnly;}},{key:"_mapDefaultContactRolesAndPartners",value:function _mapDefaultContactRolesAndPartners(contactRolesNewOppIdByOldOppId,partnersNewOppIdByOldOppId){var partnerDAO=new PartnerDAO(this._conn,this._settings);var ocrDAO=new OpportunityContactRoleDAO(this._conn,this._settings);var contactRolesOldIdSet=new Set();var partnersOldIdSet=new Set();var setMapperCallbackCreator=function setMapperCallbackCreator(setToUse){return function(value,key){setToUse.add(key);};};contactRolesNewOppIdByOldOppId.forEach(setMapperCallbackCreator(contactRolesOldIdSet));partnersNewOppIdByOldOppId.forEach(setMapperCallbackCreator(partnersOldIdSet));var contactRolePromise=contactRolesOldIdSet.size===0?Promise.resolve(new Map()):ocrDAO.loadOpportunityContactRolesByOpportunityId(contactRolesOldIdSet);var partnerPromise=partnersOldIdSet.size===0?Promise.resolve(new Map()):partnerDAO.loadPartnersByOpportunityId(partnersOldIdSet);return Promise.all([contactRolePromise,partnerPromise]).then(function(results){var contactRolesByOldOpptyId=results[0];var partnersByOldOpptyId=results[1];var recordClonerFunction=function recordClonerFunction(newOpptyIdByOldOpptyId,recordsByOldOpptyId,filterFn){var results=[];newOpptyIdByOldOpptyId.forEach(function(newOpptyId,oldOpptyId){if(recordsByOldOpptyId.has(oldOpptyId)){recordsByOldOpptyId.get(oldOpptyId).forEach(function(record){if(filterFn&&!filterFn(record)){return;}record.Id=null;record.OpportunityId=newOpptyId;results.push(record);});}});return results;};var clonedContactRoles=recordClonerFunction(contactRolesNewOppIdByOldOppId,contactRolesByOldOpptyId);var clonedPartners=recordClonerFunction(partnersNewOppIdByOldOppId,partnersByOldOpptyId,function(partner){return partner.Opportunity.AccountId!==partner.AccountToId;});var ocrInsertionPromise=clonedContactRoles.length>0?ocrDAO.insertOpportunityContactRoles(clonedContactRoles):Promise.resolve();var partnerInsertionPromise=clonedPartners.length>0?partnerDAO.insertPartners(clonedPartners):Promise.resolve();return Promise.all([ocrInsertionPromise,partnerInsertionPromise]);});}}]);return OpportunityGenerator;}();module.exports=OpportunityGenerator;},{"../../Utils/IdToValueCache.js":7,"../DAO/ContractDAO.js":11,"../DAO/OpportunityContactRoleDAO.js":13,"../DAO/OpportunityDAO.js":14,"../DAO/PartnerDAO.js":16,"../DAO/QuoteDAO.js":17,"../amendment/AmendmentOpportunityWrapper.js":28,"../models/ContractModel.js":40,"../models/OpportunityModel.js":41,"../renewal/RenewalOpportunity.js":44,"../renewal/RenewalOpportunityWrapper.js":45,"js-logger":58}],37:[function(require,module,exports){'use strict';var ContractModel=require('../models/ContractModel.js');var QuoteModel=require('../models/QuoteModel.js');var AccountDAO=require('../DAO/AccountDAO.js');var QuoteDAO=require('../DAO/QuoteDAO.js');var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var QuoteGenerator=function(){function QuoteGenerator(conn,settings,services){_classCallCheck(this,QuoteGenerator);this._conn=conn;this._settings=settings;this._services=services;this._accountDAO=new AccountDAO(conn,settings);this._applyAddDiscLastField=null;this._applyPartnerDiscFirstField=null;this._channelDiscOffListField=null;this._logger=jsLogger;}_createClass(QuoteGenerator,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"generateAmendmentQuote",value:function generateAmendmentQuote(opptyWrapper){var _this116=this;var contractId=opptyWrapper.masterContractId;var quoteModel=void 0;var renewalModel=void 0;var quoteVO=void 0;var calcFirstSegEndDateStartTime=void 0;var saveAndReloadRecordStartTime=void 0;this._logMessage('AMENDMENT QuoteGenerator.js: Generate generic quote. Contract='+contractId+' SessionId='+this._settings.userId);var genericQuoteStartTime=Date.now();return this._generateGenericQuote(opptyWrapper).then(function(genericQuote){_this116._logMessage('AMENDMENT QuoteGenerator.js: Generating generic quote took '+(Date.now()-genericQuoteStartTime)+' ms. Contract='+contractId+' SessionId='+_this116._settings.userId);quoteModel=genericQuote;quoteModel.Type__c='Amendment';quoteModel.PriceBook__c=quoteModel.PricebookId__c;var masterContractField=null;if(opptyWrapper.primaryContract.Evergreen__c){masterContractField='MasterEvergreen'+ContractModel.getSObjectType(_this116._settings.isServiceCloudEnabled)+'__c';}else{masterContractField='Master'+ContractModel.getSObjectType(_this116._settings.isServiceCloudEnabled)+'__c';}quoteModel[masterContractField]=contractId;_this116._logMessage('AMENDMENT QuoteGenerator.js: Calculate amendment first seg end date. Contract='+contractId+' SessionId='+_this116._settings.userId);calcFirstSegEndDateStartTime=Date.now();return opptyWrapper.primaryContract.calculateAmendmentFirstSegEndDate(quoteModel.StartDate__c,quoteModel.EndDate__c);}).then(function(firstSegEndDate){_this116._logMessage('AMENDMENT QuoteGenerator.js: Calculating amendment first seg end date took '+(Date.now()-calcFirstSegEndDateStartTime)+' ms. Contract='+contractId+' SessionId='+_this116._settings.userId);quoteModel.FirstSegmentTermEndDate__c=firstSegEndDate;renewalModel=opptyWrapper.controllingAccount[_this116._settings.salesCloudPrefix+'RenewalModel__c'];var fields=_this116._getRequiredQuoteFields();quoteModel.setSalesRep(opptyWrapper.opportunityModel.OwnerId);saveAndReloadRecordStartTime=Date.now();_this116._logMessage('AMENDMENT QuoteGenerator.js: Save and reload quote record. Contract='+contractId+' SessionId='+_this116._settings.userId);return _this116._saveAndReloadRecord(quoteModel.getQuote(),fields);}).then(function(rec){_this116._logMessage('AMENDMENT QuoteGenerator.js: Saving and reloading quote record took '+(Date.now()-saveAndReloadRecordStartTime)+' ms. Contract='+contractId+' SessionId='+_this116._settings.userId);console.log('AMENDMENT QuoteGenerator.js: Quote -  '+rec.Id+' was successfully created');quoteVO=_this116._createQuoteVO(rec,renewalModel);opptyWrapper.opportunityModel.PrimaryQuote__c=rec.Id;return quoteVO;}).catch(function(err){return Promise.reject(err.message||err);});}},{key:"generateRenewalQuotes",value:function generateRenewalQuotes(renewalOpps){var _this117=this;var quoteGenPromises=[];renewalOpps.forEach(function(renOpp){quoteGenPromises.push(_this117._generateRenewalQuote(renOpp));});return Promise.all(quoteGenPromises);}},{key:"_generateRenewalQuote",value:function _generateRenewalQuote(renewalOpp){var _this118=this;var oppModel=renewalOpp.opportunityModel;var contractModel=renewalOpp.primaryContract;this._logMessage('RENEWAL QuoteGenerator.js: Generate renewal quote. Contract='+contractModel.Id+' SessionId='+this._settings.userId);var genRenewalQuoteStartTime=Date.now();var quoteModel=void 0;var renewalModel=void 0;var quoteVO=void 0;var saveAndReloadRecordStartTime=void 0;this._logMessage('RENEWAL QuoteGenerator.js: Generate generic quote. Contract='+contractModel.Id+' SessionId='+this._settings.userId);var genericQuoteStartTime=Date.now();return this._generateGenericQuote(renewalOpp).then(function(genericQuote){_this118._logMessage('RENEWAL QuoteGenerator.js: Generating generic quote took '+(Date.now()-genericQuoteStartTime)+' ms. Contract='+contractModel.Id+' SessionId='+_this118._settings.userId);quoteModel=genericQuote;quoteModel.Type__c='Renewal';quoteModel.LineItemsGrouped__c=renewalOpp.quoteGroupingAllowed;var fields=_this118._getRequiredQuoteFields();_this118._logMessage('RENEWAL QuoteGenerator.js: Save and reload record. Contract='+contractModel.Id+' SessionId='+_this118._settings.userId);saveAndReloadRecordStartTime=Date.now();return _this118._saveAndReloadRecord(quoteModel.getQuote(),fields);}).then(function(rec){_this118._logMessage('RENEWAL QuoteGenerator.js: Saving and reloading record took '+(Date.now()-saveAndReloadRecordStartTime)+' ms. Contract='+contractModel.Id+' SessionId='+_this118._settings.userId);_this118._logMessage('RENEWAL QuoteGenerator.js: Quote: '+rec.Id+' was successfully created');renewalModel=renewalOpp.controllingAccount[_this118._settings.salesCloudPrefix+'RenewalModel__c'];quoteVO=_this118._createQuoteVO(rec,renewalModel);if(renewalOpp.quoteGroupingAllowed){quoteVO.lineItemGroups=renewalOpp.allContracts.map(function(c){return{record:_defineProperty({Name:'Contract #'+c.ContractNumber},_this118._settings.salesCloudPrefix+'Quote__c',quoteVO.record.Id),key:++quoteVO.nextKey};});}oppModel.PrimaryQuote__c=rec.Id;_this118._logMessage('RENEWAL QuoteGenerator.js: Generating renewal quote took '+(Date.now()-genRenewalQuoteStartTime)+' ms. Contract='+contractModel.Id+' SessionId='+_this118._settings.userId);return quoteVO;}).catch(function(err){return Promise.reject(err.message||err);});}},{key:"_generateGenericQuote",value:function _generateGenericQuote(opptyWrapper){var _this119=this;var quoteModel=new QuoteModel(this._settings);quoteModel.createEmptyQuote();quoteModel.Primary__c=true;quoteModel.RenewalTerm__c=opptyWrapper.renewalTerm;quoteModel.RenewalUpliftRate__c=opptyWrapper.renewalUpliftRate;quoteModel.Opportunity2__c=opptyWrapper.opportunityModel.Id;quoteModel.Account__c=opptyWrapper.opportunityModel.AccountId;quoteModel.PricebookId__c=opptyWrapper.opportunityModel.Pricebook2Id;quoteModel.Pricebook__c=opptyWrapper.opportunityModel.Pricebook2Id;quoteModel.OwnerId=opptyWrapper.opportunityModel.OwnerId||this._settings.userId;quoteModel.LineItemsGrouped__c=opptyWrapper.quoteGroupingAllowed;if(this._settings.isMultiCurrencyOrg){quoteModel.CurrencyIsoCode=opptyWrapper.opportunityModel.CurrencyIsoCode;}return opptyWrapper.getQuoteStartDate().then(function(startDate){quoteModel.StartDate__c=startDate;return opptyWrapper.getQuoteEndDate();}).then(function(endDate){quoteModel.EndDate__c=endDate;return opptyWrapper.originalQuote?_this119._mapNonformulaMagicFields(opptyWrapper.originalQuote,quoteModel):quoteModel;});}},{key:"_mapNonformulaMagicFields",value:function _mapNonformulaMagicFields(originalQuoteRec,newQuoteModel){var _this120=this;var magicFieldMap=this._settings.calcSettings.quoteMagicFieldApiNamesByAlias;var existingMagicFields=[];if(magicFieldMap){QuoteModel.getMagicFields().forEach(function(alias){if(magicFieldMap[alias]){existingMagicFields.push(magicFieldMap[alias]);}});}if(existingMagicFields.length===0){return Promise.resolve(newQuoteModel);}var promiseArray=[];existingMagicFields.forEach(function(fieldName){promiseArray.push(_this120._services.fieldMetadataService.getFieldDescribe(_this120._settings.salesCloudPrefix+'Quote__c',fieldName));});return Promise.all(promiseArray).then(function(describeResults){describeResults.forEach(function(dr){if(!dr.calculated){newQuoteModel.getQuote()[dr.name]=originalQuoteRec[dr.name];}});return newQuoteModel;});}},{key:"_getRequiredQuoteFields",value:function _getRequiredQuoteFields(){var fields=QuoteModel.getFields(this._settings);return fields.concat(this._settings.calcSettings.referencedFieldMap.Quote);}},{key:"_saveAndReloadRecord",value:function _saveAndReloadRecord(rec,fields){return new QuoteDAO(this._conn,this._settings).createAndReloadQuote(rec,fields);}},{key:"_createQuoteVO",value:function _createQuoteVO(rec,renewalModel){var magicFieldMap=this._settings.calcSettings.quoteMagicFieldApiNamesByAlias;var addtnlDiscLastField=null;var partnerDiscFirstField=null;var channelDiscOffListField=null;if(magicFieldMap!=null){addtnlDiscLastField=magicFieldMap.ApplyAdditionalDiscountLast__c;partnerDiscFirstField=magicFieldMap.ApplyPartnerDiscountFirst__c;channelDiscOffListField=magicFieldMap.ChannelDiscountsOffList__c;}var addtnlDiscLast=addtnlDiscLastField!=null?!!rec[addtnlDiscLastField]:false;var partnerDiscFirst=partnerDiscFirstField!=null?!!rec[partnerDiscFirstField]:false;var channelDiscOffList=channelDiscOffListField!=null?!!rec[channelDiscOffListField]:false;return{record:rec,nextKey:1,lineItems:[],lineItemGroups:[],localizationByFieldByDimensionId:{},accountRenewalModel:renewalModel,applyAdditionalDiscountLast:addtnlDiscLast,applyPartnerDiscountFirst:partnerDiscFirst,channelDiscountsOffList:channelDiscOffList};}}]);return QuoteGenerator;}();module.exports=QuoteGenerator;},{"../DAO/AccountDAO.js":10,"../DAO/QuoteDAO.js":17,"../models/ContractModel.js":40,"../models/QuoteModel.js":42,"js-logger":58}],38:[function(require,module,exports){'use strict';var ContractDAO=require('./DAO/ContractDAO.js');var AccountDAO=require('./DAO/AccountDAO.js');var OpportunityDAO=require('./DAO/OpportunityDAO.js');var OpportunityGenerator=require('./common/OpportunityGenerator.js');var QuoteGenerator=require('./common/QuoteGenerator.js');var LineGenerationManager=require('./LineGenerationManager.js');var LineCalculationManager=require('./LineCalculationManager.js');var QuoteDAO=require('./DAO/QuoteDAO.js');var OpportunityLineGenerator=require('./renewal/OpportunityLineGenerator.js');var OpportunityLineDAO=require('./DAO/OpportunityLineDAO.js');var ContractModel=require('./models/ContractModel.js');var IdToValueCache=require('../Utils/IdToValueCache.js');var JSARSettings=require('./JSARSettings.js');var ServicesManager=require('../Utils/Services/ServicesManager.js');var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var Main=function(){function Main(conn,customerConn,calcVersion,orgPrefix,rawSettings){_classCallCheck(this,Main);this._conn=conn;this._customerConn=customerConn;this._calcVersion=calcVersion;this._settings=this._initSettings(orgPrefix,rawSettings);this._services=this._initServices();this._logger=jsLogger;}_createClass(Main,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"_initSettings",value:function _initSettings(orgPrefix,rawSettings){return new JSARSettings(orgPrefix,rawSettings);}},{key:"_initServices",value:function _initServices(){return ServicesManager.constructFromJsarSettings(this._conn,this._settings);}},{key:"loadContractsByIds",value:function loadContractsByIds(contractIds,isRenewal){var _this121=this;var contractDAO=new ContractDAO(this._conn,this._settings,this._services);return contractDAO.loadContractsByIds(contractIds).then(function(contracts){var contractsMap=new IdToValueCache();var _iteratorNormalCompletion30=true;var _didIteratorError30=false;var _iteratorError30=undefined;try{for(var _iterator30=contracts[Symbol.iterator](),_step30;!(_iteratorNormalCompletion30=(_step30=_iterator30.next()).done);_iteratorNormalCompletion30=true){var _step30$value=_slicedToArray(_step30.value,2),_contractId5=_step30$value[0],contract=_step30$value[1];contractsMap.set(_contractId5,new ContractModel(_this121._conn,_this121._settings,_this121._services,contract));var _c=contractsMap.get(_contractId5);if(!isRenewal){if(_this121._settings.canBypassPreserveBundleStructureOnAmend===false){_c.PreserveBundleStructureUponRenewals__c=true;}_c.SubscriptionQuantitiesCombined__c=false;}}}catch(err){_didIteratorError30=true;_iteratorError30=err;}finally{try{if(!_iteratorNormalCompletion30&&_iterator30.return){_iterator30.return();}}finally{if(_didIteratorError30){throw _iteratorError30;}}}return contractsMap;});}},{key:"amendContract",value:function amendContract(cId,oId){var _this122=this;var c=void 0;var o=void 0;var q=void 0;var loadContractsStartTime=Date.now();var genOppStartTime=void 0;var genQuoteStartTime=void 0;var genLinesStartTime=void 0;var postProcessQuoteStartTime=void 0;this._logMessage('AMENDMENT main.js: Load Contracts. Contract='+cId+' SessionId='+this._settings.userId);return this.loadContractsByIds([cId],false).then(function(contractsById){_this122._logMessage('AMENDMENT Loading contracts took '+(Date.now()-loadContractsStartTime)+' ms. Contract='+cId+' SessionId='+_this122._settings.userId);c=contractsById.get(cId);_this122._logMessage('AMENDMENT main.js: Creating amendment opportunities. Contract='+cId+' SessionId='+_this122._settings.userId);genOppStartTime=Date.now();return _this122.generateAmendmentOpps(contractsById,oId);}).then(function(opps){_this122._logMessage('AMENDMENT main.js: Creating amendment opportunities took '+(Date.now()-genOppStartTime)+' ms. Contract='+cId+' SessionId='+_this122._settings.userId);o=opps[0];_this122._logMessage('AMENDMENT main.js: Creating amendment quotes. Contract='+cId+' SessionId='+_this122._settings.userId);genQuoteStartTime=Date.now();return _this122.generateAmendmentQuote(o);}).then(function(quote){_this122._logMessage('AMENDMENT main.js: Creating amendment quotes took '+(Date.now()-genQuoteStartTime)+' ms. Contract='+cId+' SessionId='+_this122._settings.userId);q=quote;_this122._logMessage('AMENDMENT main.js: Create and add amendment lines. Contract='+cId+' SessionId='+_this122._settings.userId);genLinesStartTime=Date.now();return new LineGenerationManager(_this122._conn,_this122._settings,_this122._services).amendContractToQuote(c.getContract(),q);}).then(function(poppedQuote){_this122._logMessage('AMENDMENT main.js: Creating and adding amendment lines took '+(Date.now()-genLinesStartTime)+' ms. Contract='+cId+' SessionId='+_this122._settings.userId);_this122._logMessage('AMENDMENT main.js: Post processing quotes. Contract='+cId+' SessionId='+_this122._settings.userId);postProcessQuoteStartTime=Date.now();return _this122.postProcessQuotes([poppedQuote],[o.opportunityModel],true,false);}).then(function(finalQuotes){_this122._logMessage('AMENDMENT main.js: Post processing quotes took '+(Date.now()-postProcessQuoteStartTime)+' ms. Contract='+cId+' SessionId='+_this122._settings.userId);return finalQuotes;});}},{key:"generateAmendmentOpps",value:function generateAmendmentOpps(contractsById,opportunityId){return new OpportunityGenerator(this._conn,this._settings,this._services,contractsById).generateAmendmentOpps(opportunityId);}},{key:"generateAmendmentQuote",value:function generateAmendmentQuote(opptyWrapper){return new QuoteGenerator(this._conn,this._settings,this._services).generateAmendmentQuote(opptyWrapper);}},{key:"renewContracts",value:function renewContracts(contractIds,masterContractId){return this._handleContractRenewalFlow(contractIds,masterContractId,false);}},{key:"forecastContracts",value:function forecastContracts(contractIds,masterContractId){return this._handleContractRenewalFlow(contractIds,masterContractId,true);}},{key:"_handleContractRenewalFlow",value:function _handleContractRenewalFlow(contractIds,masterContractId,opportunityOnly){var _this123=this;var contractMap=void 0;var opps=void 0;var loadContractsStartTime=Date.now();var genOppStartTime=void 0;var genQuoteStartTime=void 0;var genLinesStartTime=void 0;var postProcessQuoteStartTime=void 0;var updateContractsStartTime=void 0;this._logMessage('RENEWAL main.js: Load Contracts. Contracts='+contractIds+' SessionId='+this._settings.userId);return this.loadContractsByIds(contractIds,true).then(function(contractsByIds){_this123._logMessage('RENEWAL main.js: Loading contracts took '+(Date.now()-loadContractsStartTime)+' ms in total');contractMap=contractsByIds;genOppStartTime=Date.now();return _this123.generateRenewalOpps(contractsByIds,opportunityOnly,masterContractId);}).then(function(renewalOpps){_this123._logMessage('RENEWAL main.js: Creating renewal opportunities took '+(Date.now()-genOppStartTime)+' ms. Contracts='+contractIds+' SessionId='+_this123._settings.userId);opps=renewalOpps;_this123._logMessage('RENEWAL main.js: Creating renewal quotes. Contracts='+contractIds+' SessionId='+_this123._settings.userId);genQuoteStartTime=Date.now();return _this123.generateRenewalQuotes(opps);}).then(function(quotes){_this123._logMessage('RENEWAL main.js: Creating renewal quotes took '+(Date.now()-genQuoteStartTime)+' ms. Contracts='+contractIds+' SessionId='+_this123._settings.userId);var quotePopulationPromises=[];var lgm=new LineGenerationManager(_this123._conn,_this123._settings,_this123._services);var quoteCount=quotes.length;var _loop11=function _loop11(i){var opp=opps[i];var quote=quotes[i];var contractRecords=opp.allContracts.map(function(cModel){return cModel.getContract();});var groupsByContractId=quote.record[_this123._settings.salesCloudPrefix+'LineItemsGrouped__c']?new Map(contractRecords.map(function(cRec,index){return[cRec.Id,quote.lineItemGroups[index]];})):null;quotePopulationPromises.push(lgm.renewContractsToQuote(contractRecords,quote,groupsByContractId));};for(var i=0;i<quoteCount;i++){_loop11(i);}_this123._logMessage('RENEWAL main.js: Create and add renewal lines. Contracts='+contractIds+' SessionId='+_this123._settings.userId);genLinesStartTime=Date.now();return Promise.all(quotePopulationPromises);}).then(function(populatedQuotes){_this123._logMessage('RENEWAL main.js: Creating and adding renewal lines took '+(Date.now()-genLinesStartTime)+' ms. Contracts='+contractIds+' SessionId='+_this123._settings.userId);_this123._logMessage('RENEWAL main.js: Post processing quotes. Contracts='+contractIds+' SessionId='+_this123._settings.userId);postProcessQuoteStartTime=Date.now();return _this123.postProcessQuotes(populatedQuotes,opps.map(function(opp){return opp.opportunityModel;}),!opportunityOnly,true);}).then(function(){_this123._logMessage('RENEWAL main.js: Post processing quotes took '+(Date.now()-postProcessQuoteStartTime)+' ms. Contracts='+contractIds+' SessionId='+_this123._settings.userId);var contractsArray=[];var _iteratorNormalCompletion31=true;var _didIteratorError31=false;var _iteratorError31=undefined;try{for(var _iterator31=contractMap.values()[Symbol.iterator](),_step31;!(_iteratorNormalCompletion31=(_step31=_iterator31.next()).done);_iteratorNormalCompletion31=true){var contract=_step31.value;contractsArray.push(contract.getContract());}}catch(err){_didIteratorError31=true;_iteratorError31=err;}finally{try{if(!_iteratorNormalCompletion31&&_iterator31.return){_iterator31.return();}}finally{if(_didIteratorError31){throw _iteratorError31;}}}_this123._logMessage('RENEWAL main.js: Update contracts. Contracts='+contractIds+' SessionId='+_this123._settings.userId);updateContractsStartTime=Date.now();return new ContractDAO(_this123._conn,_this123._settings,_this123._services).updateRecords(contractsArray);}).then(function(saveResults){_this123._logMessage('RENEWAL main.js: Updating contracts took '+(Date.now()-updateContractsStartTime)+' ms. Contracts='+contractIds+' SessionId='+_this123._settings.userId);return saveResults;}).catch(function(err){console.log('renewContracts failed: ',err);return Promise.reject(err.message||err);});}},{key:"generateRenewalOpps",value:function generateRenewalOpps(contractsByIds,opportunityOnly,manualMasterId){return new OpportunityGenerator(this._conn,this._settings,this._services,contractsByIds).generateRenewalOpps(opportunityOnly,manualMasterId);}},{key:"generateRenewalQuotes",value:function generateRenewalQuotes(renOpps){return new QuoteGenerator(this._conn,this._settings,this._services).generateRenewalQuotes(renOpps);}},{key:"postProcessQuotes",value:function postProcessQuotes(qvos,opps,persistQuotes,createOpptyLines){var _this124=this;var calcManager=new LineCalculationManager(this._services);var finalQuotes=void 0;var processQuoteStartTime=void 0;var createOpptyLineStartTime=void 0;var updateOpptyStartTime=void 0;this._logMessage('main.js: Calculate quote. SessionId='+this._settings.userId);var calculateQuoteStartTime=Date.now();return calcManager.calculateQuotes(qvos,this._settings,this._conn,this._customerConn).then(function(calcedQuotes){_this124._logMessage('main.js: Calculating quote took '+(Date.now()-calculateQuoteStartTime)+' ms. SessionId='+_this124._settings.userId);var qdao=new QuoteDAO(_this124._conn,_this124._settings);_this124._logMessage('main.js: Save/Delete quote. SessionId='+_this124._settings.userId);processQuoteStartTime=Date.now();return persistQuotes?qdao.saveQuotes(calcedQuotes):qdao.deleteQuotes(calcedQuotes);}).then(function(processedQuotes){_this124._logMessage('main.js: Saving/Deleting quote took '+(Date.now()-processQuoteStartTime)+' ms. SessionId='+_this124._settings.userId);finalQuotes=processedQuotes;_this124._logMessage('main.js: Generate and save opportunity lines. SessionId='+_this124._settings.userId);createOpptyLineStartTime=Date.now();return createOpptyLines?_this124._generateAndSaveOpptyLines(processedQuotes):Promise.resolve();}).then(function(){if(createOpptyLines){_this124._logMessage('main.js: Generating and saving opportunity lines took '+(Date.now()-createOpptyLineStartTime)+' ms. SessionId='+_this124._settings.userId);}var opptyRecords=opps.map(function(opp){return _defineProperty({Id:opp.Id},_this124._settings.salesCloudPrefix+'PrimaryQuote__c',persistQuotes?opp.PrimaryQuote__c:null);});_this124._logMessage('main.js: Update opportunity. SessionId='+_this124._settings.userId);updateOpptyStartTime=Date.now();return new OpportunityDAO(_this124._conn,_this124._settings,_this124._services).updateRecords(opptyRecords);}).then(function(){_this124._logMessage('main.js: Updating opportunity took '+(Date.now()-updateOpptyStartTime)+' ms. SessionId='+_this124._settings.userId);return finalQuotes;});}},{key:"_generateAndSaveOpptyLines",value:function _generateAndSaveOpptyLines(quotes){var _this125=this;this._logMessage('main.js: Generate opportunity lines. SessionId='+this._settings.userId);var saveOppLinesByOppIdStartTime=void 0;var genOppStartTime=Date.now();return new OpportunityLineGenerator(this._conn,this._settings,this._services).generateOppLines(quotes).then(function(oppLinesByOppId){_this125._logMessage('main.js: Generating opportunity lines took '+(Date.now()-genOppStartTime)+' ms. SessionId='+_this125._settings.userId);_this125._logMessage('main.js: Save opportunity lines by opportunity id. SessionId='+_this125._settings.userId);saveOppLinesByOppIdStartTime=Date.now();return new OpportunityLineDAO(_this125._conn,_this125._settings).saveOppLinesByOppId(oppLinesByOppId);}).then(function(saveResults){_this125._logMessage('main.js: Saving opportunity lines by opportunity id took '+(Date.now()-genOppStartTime)+' ms. SessionId='+_this125._settings.userId);return saveResults;});}}]);return Main;}();if(typeof window!=='undefined'&&window){window.SB=window.SB||{};window.SB.JSARSettings=JSARSettings;window.SB.JSARServices=ServicesManager;window.SB.JSARLineGenManager=LineGenerationManager;}else{module.exports=Main;}},{"../Utils/IdToValueCache.js":7,"../Utils/Services/ServicesManager.js":9,"./DAO/AccountDAO.js":10,"./DAO/ContractDAO.js":11,"./DAO/OpportunityDAO.js":14,"./DAO/OpportunityLineDAO.js":15,"./DAO/QuoteDAO.js":17,"./JSARSettings.js":19,"./LineCalculationManager.js":20,"./LineGenerationManager.js":21,"./common/OpportunityGenerator.js":36,"./common/QuoteGenerator.js":37,"./models/ContractModel.js":40,"./renewal/OpportunityLineGenerator.js":43,"js-logger":58}],39:[function(require,module,exports){'use strict';var PROTOTYPE_INITIALIZED=false;var FIELDS_INITIALIZED=false;var FIELDS=['Id','ParentId','IgnoreParentContractedPrices__c','RenewalModel__c','RenewalPricingMethod__c','PreserveBundle__c','ContractCoTermination__c','CoTerminationEvent__c','CoTermedContractsCombined__c','PriceHoldEnd__c'];var PREFIXED_FIELDS=[];var AccountModel=function(){function AccountModel(prefix,account){_classCallCheck(this,AccountModel);initPrototype(prefix);if(account){this._account=account;}}_createClass(AccountModel,null,[{key:"getFields",value:function getFields(prefix){if(!FIELDS_INITIALIZED){initializeFields(prefix);}return PREFIXED_FIELDS;}}]);return AccountModel;}();function initPrototype(prefix){if(!FIELDS_INITIALIZED){initializeFields(prefix);}if(!PROTOTYPE_INITIALIZED){for(var i=0;i<FIELDS.length;i++){defineGet(FIELDS[i],PREFIXED_FIELDS[i]);}PROTOTYPE_INITIALIZED=true;}}function initializeFields(prefix){for(var i=0;i<FIELDS.length;i++){initializeField(FIELDS[i],prefix);}FIELDS_INITIALIZED=true;}function initializeField(field,prefix){if(field.endsWith('__c')){PREFIXED_FIELDS.push(prefix+field);}else{PREFIXED_FIELDS.push(field);}}function defineGet(field,prefixedField){Object.defineProperty(AccountModel.prototype,field,{get:function get(){return this._account[prefixedField];}});}module.exports=AccountModel;},{}],40:[function(require,module,exports){'use strict';var PROTOTYPE_INITIALIZED=false;var FIELDS_INITIALIZED=false;var SourceRecordDAO=require('../DAO/SourceRecordDAO.js');var DateUtils=require('../../Utils/DateUtils.js');var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var FIELDS=['Id','ContractNumber','AccountId','AmendmentStartDate__c','StartDate','EndDate','AmendmentOwner__c','AmendmentOpportunityStage__c','AmendmentOpportunityRecordTypeId__c','AmendmentPricebookId__c','OpportunityPricebookId__c','RenewalPricebookId__c','RenewalOpportunityRecordTypeId__c','RenewalOpportunityStage__c','SubscriptionQuantitiesCombined__c','PreserveBundleStructureUponRenewals__c','RenewalTerm__c','RenewalOwner__c','RenewalUpliftRate__c','MasterContract__c','DisableAmendmentCoTerm__c','AmendmentRenewalBehavior__c','DefaultRenewalContactRoles__c','DefaultRenewalPartners__c','Opportunity__c','Quote__c','RenewalOpportunity__c','RenewalForecast__c','RenewalQuoted__c','ActiveContract__c','MDQRenewalBehavior__c','Evergreen__c'];var PREFIXED_FIELDS=[];var ContractModel=function(){function ContractModel(conn,settings,services,contract){_classCallCheck(this,ContractModel);this._settings=settings;this._isServiceCloudEnabled=settings.isServiceCloudEnabled;this._sourceRecordDAO=new SourceRecordDAO(conn,settings,services);this._logger=jsLogger;initPrototype(settings);if(contract){this._contract=contract;}}_createClass(ContractModel,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"getContract",value:function getContract(){return this._contract;}},{key:"getQuote",value:function getQuote(){if(this.Quote__c){var prefix=this._isServiceCloudEnabled?this._settings.serviceCloudPrefix:this._settings.salesCloudPrefix;return this._contract[prefix+'Quote__r'];}else{return null;}}},{key:"isActive",value:function isActive(){var prefix=this._isServiceCloudEnabled?this._settings.serviceCloudPrefix:this._settings.salesCloudPrefix;var activeFieldName=this._settings.contractMagicFieldNamesByAlias['CustomActiveContract__c']||prefix+'ActiveContract__c';return this._contract[activeFieldName]!=0;}},{key:"parentAccountAllowsAutomaticMasterlessCoterm",value:function parentAccountAllowsAutomaticMasterlessCoterm(){var acct=this.Account;var prefix=this._settings.salesCloudPrefix;var cotermType=(acct[prefix+'ContractCoTermination__c']||'').toLowerCase();var cotermEvent=(acct[prefix+'CoTerminationEvent__c']||'').toLowerCase();return cotermType==='always'&&cotermEvent==='renewal';}},{key:"getContractGroup",value:function getContractGroup(){var groupField=this._settings.contractMagicFieldNamesByAlias['ContractGroup__c'];if(groupField&&this._contract[groupField]!=null){return this._contract[groupField];}else{return'';}}},{key:"_findFirstFixedLengthSegment",value:function _findFirstFixedLengthSegment(){var _this126=this;if(this._firstFixedSeg!==undefined){return Promise.resolve(this._firstFixedSeg);}var subPrefix=this._isServiceCloudEnabled?this._settings.serviceCloudPrefix:this._settings.salesCloudPrefix;var loadSubsRelatedToContractsStartTime=Date.now();this._logMessage('ContractModel.js: Load subscriptions related to contracts. Contract='+this.Id+' SessionId='+this._settings.userId);return this._sourceRecordDAO.loadSourceRecordsRelatedToContracts([this.getContract()]).then(function(sourceRecordsResult){_this126._logMessage('ContractModel.js: Loading subscriptions related to contracts took '+(Date.now()-loadSubsRelatedToContractsStartTime)+' ms. Contract='+_this126.Id+' SessionId='+_this126._settings.userId);var subsByContractId=sourceRecordsResult['subsByContractId'];var subscriptions=subsByContractId.get(_this126.Id)||[];var chosenSegment=null;for(var i=0;i<subscriptions.length;i++){var _sub=subscriptions[i];var dimType=_sub[subPrefix+'DimensionType__c'];var isFixedLengthMdq=dimType!=null&&dimType.toLowerCase()!=='one-time'&&dimType.toLowerCase()!=='custom';var isRevision=_sub[subPrefix+'RevisedSubscription__c']!=null;var indexIsOne=_sub[subPrefix+'SegmentIndex__c']===1;if(isFixedLengthMdq&&!isRevision&&indexIsOne){chosenSegment=_sub;break;}}_this126._firstFixedSeg=chosenSegment;return _this126._firstFixedSeg;});}},{key:"_determineOriginalEffectiveFirstSegEndDate",value:function _determineOriginalEffectiveFirstSegEndDate(){var subPrefix=this._settings.isServiceCloudEnabled?this._settings.serviceCloudPrefix:this._settings.salesCloudPrefix;var segEndDateField=subPrefix+'SegmentEndDate__c';return this._findFirstFixedLengthSegment().then(function(firstSeg){if(!firstSeg){return null;}return firstSeg[segEndDateField];});}},{key:"_adjustFirstSegEndDateIfNecessary",value:function _adjustFirstSegEndDateIfNecessary(baseFsedString,amendmentStartDateString){if(baseFsedString>amendmentStartDateString){return Promise.resolve(baseFsedString);}var prefix=this._settings.isServiceCloudEnabled?this._settings.serviceCloudPrefix:this._settings.salesCloudPrefix;return this._findFirstFixedLengthSegment().then(function(firstSeg){if(!firstSeg){return null;}var dimType=firstSeg[prefix+'DimensionType__c'];var fsedDate=new Date(baseFsedString);var amendmentStartDate=new Date(amendmentStartDateString);var baseFsedIsEndOfMonth=DateUtils.isEndOfMonth(fsedDate);var termLengthInMonths=DateUtils.numberOfMonthsInFixedMdqDimension(dimType);var elapsedTermCount=Math.ceil(DateUtils.monthsBetweenRoundPartialUp(fsedDate,amendmentStartDate)/termLengthInMonths);DateUtils.addMonths(fsedDate,elapsedTermCount*termLengthInMonths);if(baseFsedIsEndOfMonth){DateUtils.moveToEndOfMonth(fsedDate);}return DateUtils.toApexDate(fsedDate);});}},{key:"calculateAmendmentFirstSegEndDate",value:function calculateAmendmentFirstSegEndDate(amendmentStartDate,amendmentEndDate){var _this127=this;return this._determineOriginalEffectiveFirstSegEndDate().then(function(baseFsedString){if(!baseFsedString){return null;}return _this127._adjustFirstSegEndDateIfNecessary(baseFsedString,amendmentStartDate);}).then(function(adjustedFsedString){if(!adjustedFsedString){return null;}var adjustedFsedIsEndOfMonth=DateUtils.isEndOfMonth(new Date(adjustedFsedString));var amendingOnOrAfterEndOfMonthFsed=adjustedFsedIsEndOfMonth&&adjustedFsedString>=amendmentStartDate;if(adjustedFsedString&&(adjustedFsedString>amendmentStartDate||amendingOnOrAfterEndOfMonthFsed)&&(!amendmentEndDate||adjustedFsedString<amendmentEndDate)){return adjustedFsedString;}else if(adjustedFsedString&&adjustedFsedString<=amendmentStartDate){throw Error("Error calculating First Segment End Date: Adjusted Date "+adjustedFsedString+" is before start date "+amendmentStartDate+".");}else{return null;}});}},{key:"calculateRenewalEndDate",value:function calculateRenewalEndDate(){var _this128=this;var isSubscriptionTermUnitDay=this._settings.isSubscriptionTermUnitDay;var renewalTerm=this.calculateRenewalTerm();this._logMessage('ContractModel.js: Calculate renewal start date. SessionId='+this._settings.userId);var calcRenewalStartDateStartTime=Date.now();return this.calculateRenewalStartDate().then(function(startDate){_this128._logMessage('ContractModel.js: Calculating amendment end date took '+(Date.now()-calcRenewalStartDateStartTime)+' ms. SessionId='+_this128._settings.userId);var startDateArray=startDate.split('-');startDate=new Date(startDateArray[0],startDateArray[1]-1,startDateArray[2]);if(isSubscriptionTermUnitDay){startDate=DateUtils.addDays(startDate,renewalTerm-1);}else{startDate=DateUtils.addMonths(startDate,renewalTerm);startDate=DateUtils.addDays(startDate,-1);}return DateUtils.toApexDate(startDate);});}},{key:"calculateRenewalStartDate",value:function calculateRenewalStartDate(){var _this129=this;var amendmentRenewalBehavior=this._getAmendmentRenewalBehavior();if(amendmentRenewalBehavior!=null&&this._contract[amendmentRenewalBehavior]){return Promise.resolve(this._contract[amendmentRenewalBehavior]);}else{this._logMessage('ContractModel.js: Calculate amendment end date. SessionId='+this._settings.userId);var calcAmendmentEndDateStartTime=Date.now();return this.calculateAmendmentEndDate().then(function(amendmentEndDate){_this129._logMessage('ContractModel.js: Calculating amendment end date took '+(Date.now()-calcAmendmentEndDateStartTime)+' ms. SessionId='+_this129._settings.userId);var amendmentEndDateArray=amendmentEndDate.split('-');var startDate=new Date(amendmentEndDateArray[0],amendmentEndDateArray[1]-1,amendmentEndDateArray[2]);startDate=DateUtils.addDays(startDate,1);return DateUtils.toApexDate(startDate);});}}},{key:"calculateRenewalTerm",value:function calculateRenewalTerm(){var renewalTerm=this.RenewalTerm__c;if(this.RenewalTerm__c==null){if(this.StartDate==null||this.EndDate==null){renewalTerm=this._settings.isSubscriptionTermUnitDay?365:12;}else{var startDateArray=this.StartDate.split('-');var endDateArray=this.EndDate.split('-');var startDate=new Date(startDateArray[0],startDateArray[1]-1,startDateArray[2]);var endDate=new Date(endDateArray[0],endDateArray[1]-1,endDateArray[2]);endDate=DateUtils.addDays(endDate,1);if(this._settings.isSubscriptionTermUnitDay){renewalTerm=DateUtils.daysBetween(startDate,endDate);}else{renewalTerm=DateUtils.monthsBetween(startDate,endDate);}}}return parseInt(renewalTerm);}},{key:"calculateAmendmentEndDate",value:function calculateAmendmentEndDate(){var _this130=this;var amendmentRenewalBehavior=this._getAmendmentRenewalBehavior();var endDate=this._calculateEndDate();var loadSubsRelatedToContractsStartTime=Date.now();this._logMessage('ContractModel.js: Load subscriptions related to contracts. Contract='+this.Id+' SessionId='+this._settings.userId);return this._sourceRecordDAO.loadSourceRecordsRelatedToContracts([this.getContract()]).then(function(sourceRecordsResult){_this130._logMessage('ContractModel.js: Loading subscriptions related to contracts took '+(Date.now()-loadSubsRelatedToContractsStartTime)+' ms. Contract='+_this130.Id+' SessionId='+_this130._settings.userId);var subsByContractId=sourceRecordsResult['subsByContractId'];var subscriptions=subsByContractId.get(_this130.Id);var prefix=_this130._isServiceCloudEnabled?_this130._settings.serviceCloudPrefix:_this130._settings.salesCloudPrefix;var nonTerminatedSubs=subscriptions.filter(function(sub){var terminatedDateField=prefix+'TerminatedDate__c';var revisedSubLookup=prefix+'RevisedSubscription__c';return sub[terminatedDateField]==null&&sub[revisedSubLookup]==null;});var endDateField=_this130._isServiceCloudEnabled?'EndDate':_this130._settings.salesCloudPrefix+'EndDate__c';if(amendmentRenewalBehavior.toLowerCase()==='latest end date'){nonTerminatedSubs.forEach(function(subscription){if(subscription[endDateField]>endDate){endDate=subscription[endDateField];}});}else if(amendmentRenewalBehavior.toLowerCase()==='earliest end date'){nonTerminatedSubs.forEach(function(subscription){if(subscription[endDateField]<endDate){endDate=subscription[endDateField];}});}else if(amendmentRenewalBehavior!=null){endDate=_this130._contract[amendmentRenewalBehavior];}return endDate;});}},{key:"_getAmendmentRenewalBehavior",value:function _getAmendmentRenewalBehavior(){var value=this.AmendmentRenewalBehavior__c;return value!=null?value:'Latest End Date';}},{key:"_calculateEndDate",value:function _calculateEndDate(){var endDate=this.EndDate;if(endDate){return endDate;}var startDateArray=this.StartDate.split('-');var term=parseInt(this[this._getTermField()]);endDate=new Date(startDateArray[0],startDateArray[1]-1,startDateArray[2]);endDate=DateUtils.addDays(endDate,-1);endDate=DateUtils.addMonths(endDate,term);endDate=DateUtils.toApexDate(endDate);return endDate;}},{key:"_getTermField",value:function _getTermField(){return this._isServiceCloudEnabled?'Term':'ContractTerm';}},{key:"accountForcesGrouplessCotermination",get:function get(){var acct=this.Account;var prefix=this._settings.salesCloudPrefix;return acct[prefix+'CoTermedContractsCombined__c'];}}],[{key:"getSObjectType",value:function getSObjectType(isServiceCloudEnabled){if(isServiceCloudEnabled){return'ServiceContract';}return'Contract';}},{key:"getFields",value:function getFields(settings){if(!FIELDS_INITIALIZED){initializeFields(settings);}return PREFIXED_FIELDS;}}]);return ContractModel;}();function initPrototype(settings){if(!FIELDS_INITIALIZED){initializeFields(settings);}if(!PROTOTYPE_INITIALIZED){for(var i=0;i<FIELDS.length;i++){defineGet(FIELDS[i],PREFIXED_FIELDS[i]);}defineGet('Quote__r',settings.prefix+'Quote__r');defineGet('Account','Account');PROTOTYPE_INITIALIZED=true;}}function initializeFields(settings){if(settings.isMultiCurrencyOrg){FIELDS.push('CurrencyIsoCode');}if(settings.isServiceCloudEnabled){FIELDS.push('Term');}else{FIELDS.push('ContractTerm');}for(var i=0;i<FIELDS.length;i++){initializeField(FIELDS[i],settings.prefix);}FIELDS_INITIALIZED=true;}function initializeField(field,prefix){if(field.endsWith('__c')){PREFIXED_FIELDS.push(prefix+field);}else{PREFIXED_FIELDS.push(field);}}function defineGet(field,prefixedField){Object.defineProperty(ContractModel.prototype,field,{get:function get(){return this._contract[prefixedField];},set:function set(v){this._contract[prefixedField]=v;}});}module.exports=ContractModel;},{"../../Utils/DateUtils.js":6,"../DAO/SourceRecordDAO.js":18,"js-logger":58}],41:[function(require,module,exports){'use strict';var ContractModel=require('./ContractModel.js');var DateUtils=require('../../Utils/DateUtils.js');var PROTOTYPE_INITIALIZED=false;var FIELDS_INITIALIZED=false;var FIELDS=['Id','AccountId','Pricebook2Id','CloseDate','Name','OwnerId','StageName','RecordTypeId','Renewal__c','PrimaryQuote__c'];var PREFIXED_FIELDS=[];var OpportunityModel=function(){function OpportunityModel(settings,opportunity){_classCallCheck(this,OpportunityModel);this._opportunity=opportunity;this._labels=settings.labels;initPrototype(settings);}_createClass(OpportunityModel,[{key:"hasOpp",value:function hasOpp(){if(this._opportunity){return true;}return false;}},{key:"createEmptyOpp",value:function createEmptyOpp(){this._opportunity={};}},{key:"calculateAmendmentCloseDate",value:function calculateAmendmentCloseDate(amendmentStartDate,startDate){var closeDate=this._getCurrentDate();if(amendmentStartDate&&amendmentStartDate<startDate){throw Error(this._labels['msg_contract_amendment_start_date_before_actual_start_date']);}if(amendmentStartDate){closeDate=amendmentStartDate;}else if(startDate>closeDate){closeDate=startDate;}return closeDate;}},{key:"calculateRenewalCloseDate",value:function calculateRenewalCloseDate(closeDate){var closeDateArray=closeDate.split('-');closeDate=new Date(closeDateArray[0],closeDateArray[1]-1,closeDateArray[2]);closeDate=DateUtils.addDays(closeDate,-1);return DateUtils.toApexDate(closeDate);}},{key:"_getCurrentDate",value:function _getCurrentDate(){var today=new Date();return DateUtils.toApexDate(today);}},{key:"getOpportunity",value:function getOpportunity(){return this._opportunity;}}],[{key:"getFields",value:function getFields(settings){if(!FIELDS_INITIALIZED){initializeFields(settings);}return PREFIXED_FIELDS;}}]);return OpportunityModel;}();function initPrototype(settings){if(!FIELDS_INITIALIZED){initializeFields(settings);}if(!PROTOTYPE_INITIALIZED){for(var i=0;i<FIELDS.length;i++){defineGetAndSet(FIELDS[i],PREFIXED_FIELDS[i]);}PROTOTYPE_INITIALIZED=true;}}function initializeFields(settings){if(settings.isMultiCurrencyOrg){FIELDS.push('CurrencyIsoCode');}FIELDS.push('Amended'+ContractModel.getSObjectType(settings.isServiceCloudEnabled)+'__c');FIELDS.push('Renewed'+ContractModel.getSObjectType(settings.isServiceCloudEnabled)+'__c');for(var i=0;i<FIELDS.length;i++){initializeField(FIELDS[i],settings);}FIELDS_INITIALIZED=true;}function initializeField(field,settings){if(field.endsWith('__c')){var prefix=settings.salesCloudPrefix;switch(field){case'RenewedServiceContract__c':case'AmendedServiceContract__c':prefix=settings.serviceCloudPrefix;break;}PREFIXED_FIELDS.push(prefix+field);}else{PREFIXED_FIELDS.push(field);}}function defineGetAndSet(field,prefixedField){Object.defineProperty(OpportunityModel.prototype,field,{get:function get(){return this._opportunity[prefixedField];},set:function set(v){this._opportunity[prefixedField]=v;}});}module.exports=OpportunityModel;},{"../../Utils/DateUtils.js":6,"./ContractModel.js":40}],42:[function(require,module,exports){'use strict';var ContractModel=require('./ContractModel.js');var PROTOTYPE_INITIALIZED=false;var FIELDS_INITIALIZED=false;var FIELDS=['Name','Id','OwnerId','Opportunity2__c','Type__c','Primary__c','Account__c','PricebookId__c','StartDate__c','RenewalTerm__c','RenewalUpliftRate__c','EndDate__c','ExpirationDate__c','LineItemsGrouped__c','DefaultGroupName__c','NetAmount__c','TargetCustomerAmount__c','CustomerDiscount__c','SubscriptionTerm__c','DistributorDiscount__c',"PartnerDiscount__c","MarkupRate__c","FirstSegmentTermEndDate__c","ListAmount__c","CustomerAmount__c","RegularAmount__c","LineItemCount__c",'SalesRep__c','PriceBook__c'];var MAGIC_FIELDS=['ApplyAdditionalDiscountLast__c','ApplyPartnerDiscountFirst__c','ChannelDiscountsOffList__c','DefaultSalesRepId__c','ContractedAccountId__c'];var PREFIXED_FIELDS=[];var QuoteModel=function(){function QuoteModel(settings){_classCallCheck(this,QuoteModel);initPrototype(settings);}_createClass(QuoteModel,[{key:"setSalesRep",value:function setSalesRep(oppOwnerId){if(!this.SalesRep__c){if(this.DefaultSalesRepId__c){this.SalesRep__c=this.DefaultSalesRepId__c;}else{this.SalesRep__c=oppOwnerId;}}}},{key:"createEmptyQuote",value:function createEmptyQuote(){this._quote={};}},{key:"getQuote",value:function getQuote(){return this._quote;}}],[{key:"getFields",value:function getFields(settings){if(!FIELDS_INITIALIZED){initializeFields(settings);}return PREFIXED_FIELDS;}},{key:"getMagicFields",value:function getMagicFields(){return MAGIC_FIELDS;}}]);return QuoteModel;}();function initPrototype(settings){if(!FIELDS_INITIALIZED){initializeFields(settings);}if(!PROTOTYPE_INITIALIZED){for(var i=0;i<FIELDS.length;i++){defineGetAndSet(FIELDS[i],PREFIXED_FIELDS[i]);}PROTOTYPE_INITIALIZED=true;}}function initializeFields(settings){if(settings.isMultiCurrencyOrg){FIELDS.push('CurrencyIsoCode');}FIELDS.push('Master'+ContractModel.getSObjectType(settings.isServiceCloudEnabled)+'__c');FIELDS.push('MasterEvergreen'+ContractModel.getSObjectType(settings.isServiceCloudEnabled)+'__c');for(var i=0;i<FIELDS.length;i++){initializeField(FIELDS[i],settings);}for(var _i4=0;_i4<MAGIC_FIELDS.length;_i4++){initializeField(MAGIC_FIELDS[_i4],settings);}FIELDS_INITIALIZED=true;}function initializeField(field,settings){if(field.endsWith('__c')){var prefix=settings.salesCloudPrefix;switch(field){case'MasterServiceContract__c':prefix=settings.serviceCloudPrefix;break;case'MasterEvergreenServiceContract__c':prefix=settings.serviceCloudPrefix;break;}PREFIXED_FIELDS.push(prefix+field);}else{PREFIXED_FIELDS.push(field);}}function defineGetAndSet(field,prefixedField){Object.defineProperty(QuoteModel.prototype,field,{get:function get(){return this._quote[prefixedField];},set:function set(v){this._quote[prefixedField]=v;}});}module.exports=QuoteModel;},{"./ContractModel.js":40}],43:[function(require,module,exports){var ProductDAO=require('../../Utils/DAOs/ProductDAO.js').DAO;var ProductSubqueryDescriptor=require('../../Utils/DAOs/ProductDAO.js').SubqueryDescriptor;var jsLogger=require('js-logger').logger.getLogger('JSAR Perf');var NEXT_OPP_LINE_MODEL_KEY=0;var OpportunityLineGenerator=function(){function OpportunityLineGenerator(conn,settings,services){_classCallCheck(this,OpportunityLineGenerator);this._conn=conn;this._settings=settings;this._salesCloudPrefix=settings.salesCloudPrefix;this._services=services;this._initialized=false;this._logger=jsLogger;}_createClass(OpportunityLineGenerator,[{key:"_logMessage",value:function _logMessage(msg){this._logger.info(msg);}},{key:"_init",value:function _init(){var _this131=this;if(this._initialized){return Promise.resolve();}else{this._logMessage('OpportunityLineGenerator.js: Get shared mappable field names. SessionId='+this._settings.userId);var getSharedMappableFieldNamesStartTime=Date.now();return this._services.fieldMetadataService.getSharedMappableFieldNames(this._salesCloudPrefix+'QuoteLine__c','OpportunityLineItem').then(function(fields){_this131._logMessage('OpportunityLineGenerator.js: Getting shared mappable fields names took '+(Date.now()-getSharedMappableFieldNamesStartTime)+' ms. SessionId='+_this131._settings.userId);_this131._mappableFields=fields;_this131._initialized=true;});}}},{key:"generateOppLines",value:function generateOppLines(quotes){var _this132=this;this._logMessage('OpportunityLineGenerator.js: Initialization. SessionId='+this._settings.userId);var loadProductsStartTime=void 0;var initStartTime=Date.now();return this._init().then(function(){_this132._logMessage('OpportunityLineGenerator.js: Initialization took '+(Date.now()-initStartTime)+' ms. SessionId='+_this132._settings.userId);_this132._logMessage('OpportunityLineGenerator.js: Load Products. SessionId='+_this132._settings.userId);loadProductsStartTime=Date.now();return _this132._loadProducts(quotes);}).then(function(){_this132._logMessage('OpportunityLineGenerator.js: Loading products took '+(Date.now()-loadProductsStartTime)+' ms. SessionId='+_this132._settings.userId);var quoteCount=quotes.length;var oppLinesByOppId=new Map();var _loop12=function _loop12(i){var oppLinesByQuoteLineKey=new Map();var oppLines=[];var quote=quotes[i];var oppId=quote.record[_this132._salesCloudPrefix+'Opportunity2__c'];var eligibleQuoteLines=_this132._identifyEligibleLines(quote);eligibleQuoteLines.forEach(function(quoteLine){var pricebookEntryId=_this132._getPricebookEntryId(quoteLine,quote.record[_this132._salesCloudPrefix+'PricebookId__c'],quote.record.CurrencyIsoCode);var qty=_this132._calculateOpportunityLineQuantity(quoteLine);if(pricebookEntryId&&qty!==0){var oppLine=_this132._generateOppLine(quoteLine,quote,qty,pricebookEntryId);oppLines.push(oppLine);oppLinesByQuoteLineKey.set(quoteLine.key,oppLine);}});eligibleQuoteLines.forEach(function(quoteLine){var childOppLine=oppLinesByQuoteLineKey.get(quoteLine.key);var parentOppLine=quoteLine.parentItemKey?oppLinesByQuoteLineKey.get(quoteLine.parentItemKey):null;if(childOppLine&&parentOppLine){childOppLine.parentKey=parentOppLine.key;}});oppLinesByOppId.set(oppId,oppLines);};for(var i=0;i<quoteCount;i++){_loop12(i);}return oppLinesByOppId;});}},{key:"_getPricebookEntryId",value:function _getPricebookEntryId(quoteLine,pricebookId,currencyCode){var product=this._getProductForQuoteLine(quoteLine);if(!product.PricebookEntries||product.PricebookEntries.records.length===0){return null;}var pbeCount=product.PricebookEntries.records.length;for(var i=0;i<pbeCount;i++){var pbe=product.PricebookEntries.records[i];var isEntryInDesiredPricebook=pbe.Pricebook2Id.slice(0,15)===pricebookId.slice(0,15);var hasMatchingCurrencyCode=!this._settings.isMultiCurrencyOrg||pbe.CurrencyIsoCode===currencyCode;if(isEntryInDesiredPricebook&&hasMatchingCurrencyCode){return pbe.Id;}}return null;}},{key:"_loadProducts",value:function _loadProducts(quotes){var _this133=this;var productIds=[];var pricebookIds=[];var currencyCodes=[];quotes.forEach(function(quote){pricebookIds.push(quote.record[_this133._salesCloudPrefix+'PricebookId__c']);if(quote.record.CurrencyIsoCode){currencyCodes.push(quote.record.CurrencyIsoCode);}quote.lineItems.forEach(function(line){productIds.push(line.record[_this133._salesCloudPrefix+'Product__c']);});});var prodDaoOpts=ProductDAO.constructOptsFromJsarSettings(this._settings);var productSubqueryDescriptor=new ProductSubqueryDescriptor(prodDaoOpts);productSubqueryDescriptor.includeJSARSubqueries();productSubqueryDescriptor.addPricebookFilters(pricebookIds);productSubqueryDescriptor.addCurrencyFilters(currencyCodes);return new ProductDAO(this._conn,this._services,prodDaoOpts).loadProductsByIds(productIds,productSubqueryDescriptor).then(function(productsById){_this133._productsById=productsById;});}},{key:"_getProductForQuoteLine",value:function _getProductForQuoteLine(lineModel){return this._productsById.get(lineModel.record[this._salesCloudPrefix+'Product__c']);}},{key:"_identifyEligibleLines",value:function _identifyEligibleLines(quoteModel){var _this134=this;return quoteModel.lineItems.filter(function(line){var product=_this134._getProductForQuoteLine(line);var isExcluded=product[_this134._salesCloudPrefix+'ExcludeFromOpportunity__c'];var isOptional=line.record[_this134._salesCloudPrefix+'Optional__c'];if(!isOptional&&!isExcluded){var treatedAsNetNew=!line.record[_this134._salesCloudPrefix+'Renewal__c'];var notSubscription=!line.record[_this134._salesCloudPrefix+'SubscriptionPricing__c'];return treatedAsNetNew||notSubscription;}});}},{key:"_generateOppLine",value:function _generateOppLine(quoteLine,quote,qty,pricebookEntryId){var _record2;var prefix=this._salesCloudPrefix;var oppModel={key:NEXT_OPP_LINE_MODEL_KEY++,quoteLineKey:quoteLine.key,record:(_record2={},_defineProperty(_record2,this._salesCloudPrefix+'QuoteLine__c',quoteLine.record.Id||null),_defineProperty(_record2,"UnitPrice",quote.applyAdditionalDiscountLast?quoteLine.record[prefix+'CustomerPrice__c']:quoteLine.record[prefix+'NetPrice__c']),_defineProperty(_record2,"OpportunityId",quote.record[prefix+'Opportunity2__c']),_defineProperty(_record2,"Quantity",qty),_defineProperty(_record2,"PricebookEntryId",pricebookEntryId),_record2)};this._mappableFields.forEach(function(field){oppModel.record[field]=quoteLine.record[field];});return oppModel;}},{key:"_calculateOpportunityLineQuantity",value:function _calculateOpportunityLineQuantity(lineModel){var isExisting=lineModel.record[this._settings.salesCloudPrefix+'Existing__c'];var priorQty=lineModel.record[this._settings.salesCloudPrefix+'PriorQuantity__c'];var qty=lineModel.record[this._settings.salesCloudPrefix+'Quantity__c'];var isBlock=lineModel.record[this._settings.salesCloudPrefix+'PricingMethod__c']==='Block';var isSlab=lineModel.record[this._settings.salesCloudPrefix+'DiscountScheduleType__c']==='Slab';if(isBlock||isSlab){if(isExisting&&priorQty&&priorQty===qty){return 0;}else if(qty!==0){return 1;}}return qty-(isExisting?priorQty:0);}}]);return OpportunityLineGenerator;}();module.exports=OpportunityLineGenerator;},{"../../Utils/DAOs/ProductDAO.js":4,"js-logger":58}],44:[function(require,module,exports){var RenewalOpportunity=function(){function RenewalOpportunity(contractModel,opportunityModel){_classCallCheck(this,RenewalOpportunity);this._contractModel=contractModel;this._opportunityModel=opportunityModel;}_createClass(RenewalOpportunity,[{key:"masterContractModel",get:function get(){return this._contractModel;}},{key:"contractModels",get:function get(){return[this._contractModel];}},{key:"opportunityModel",get:function get(){return this._opportunityModel;}}]);return RenewalOpportunity;}();module.exports=RenewalOpportunity;},{}],45:[function(require,module,exports){var BaseOpportunityWrapper=require('../common/BaseOpportunityWrapper.js');'use strict';var RenewalOpportunityWrapper=function(_BaseOpportunityWrapp2){_inherits(RenewalOpportunityWrapper,_BaseOpportunityWrapp2);function RenewalOpportunityWrapper(opptyModel,actingMasterContract,allContracts,masterExplicitlyDefined){_classCallCheck(this,RenewalOpportunityWrapper);var _this135=_possibleConstructorReturn(this,(RenewalOpportunityWrapper.__proto__||Object.getPrototypeOf(RenewalOpportunityWrapper)).call(this,opptyModel,actingMasterContract));_this135._allContracts=allContracts;_this135._masterExplicitlyDefined=masterExplicitlyDefined;return _this135;}_createClass(RenewalOpportunityWrapper,[{key:"getQuoteStartDate",value:function getQuoteStartDate(){return this._primaryContract.calculateRenewalStartDate();}},{key:"getQuoteEndDate",value:function getQuoteEndDate(){return this._primaryContract.calculateRenewalEndDate();}},{key:"quoteGroupingAllowed",get:function get(){return!this._masterExplicitlyDefined&&this._allContracts.length>1&&!this._primaryContract.accountForcesGrouplessCotermination;}},{key:"allContracts",get:function get(){return this._allContracts;}}]);return RenewalOpportunityWrapper;}(BaseOpportunityWrapper);module.exports=RenewalOpportunityWrapper;},{"../common/BaseOpportunityWrapper.js":30}],46:[function(require,module,exports){'use strict';var RenewedItem=require('./RenewedItem.js');var DateUtils=require('../../Utils/DateUtils.js');var RenewedAsset=function(_RenewedItem){_inherits(RenewedAsset,_RenewedItem);function RenewedAsset(){_classCallCheck(this,RenewedAsset);return _possibleConstructorReturn(this,(RenewedAsset.__proto__||Object.getPrototypeOf(RenewedAsset)).apply(this,arguments));}_createClass(RenewedAsset,[{key:"_getSummedQuantity",value:function _getSummedQuantity(){var _this137=this;var sum=0;var allRecs=this._originalRecords.concat(this._revisions);allRecs.forEach(function(record){if(_this137._isCountableAsset(record)){sum+=record.Quantity;}});return sum;}},{key:"_isCountableAsset",value:function _isCountableAsset(rec){return rec.Quantity!=null&&(rec.UsageEndDate==null||rec.UsageEndDate>=DateUtils.toApexDate(new Date(Date.now())));}},{key:"_getListPriceFromSourceRecord",value:function _getListPriceFromSourceRecord(){return this._sourceRecord[this._sourceRecPrefix+'ListPrice__c'];}},{key:"_setValuesFromOrigin",value:function _setValuesFromOrigin(lineVO){_get(RenewedAsset.prototype.__proto__||Object.getPrototypeOf(RenewedAsset.prototype),"_setValuesFromOrigin",this).call(this,lineVO);var record=lineVO.record;var sourceRec=this._sourceRecord;record[this._salesCloudPrefix+'RenewedAsset__c']=sourceRec.Id;record[this._salesCloudPrefix+'PriorQuantity__c']=this._getSummedQuantity();record[this._salesCloudPrefix+'Existing__c']=true;record[this._salesCloudPrefix+'Renewal__c']=true;}},{key:"_getRenewalListPrice",value:function _getRenewalListPrice(){var product=this._product;var listPrice=null;var pricebook=this._quote[this._salesCloudPrefix+'PricebookId__c'];var currencyCode=this.lineVO.record.CurrencyIsoCode;var pricebookEntry=this._getPricebookEntry(pricebook,currencyCode);return pricebookEntry?pricebookEntry.UnitPrice:null;}},{key:"_getRenewalSamePrice",value:function _getRenewalSamePrice(asset){return asset.Price;}},{key:"_getRenewalUpliftRate",value:function _getRenewalUpliftRate(asset){return asset[this._salesCloudPrefix+'RenewalUpliftRate__c'];}},{key:"_sourceRecord",get:function get(){var _this138=this;return this._originalRecords.find(function(record){return _this138._isCountableAsset(record);});}},{key:"_sourceRecPrefix",get:function get(){return this._salesCloudPrefix;}}]);return RenewedAsset;}(RenewedItem);module.exports=RenewedAsset;},{"../../Utils/DateUtils.js":6,"./RenewedItem.js":47}],47:[function(require,module,exports){'use strict';var LineItemConvertible=require('../common/LineItemConvertible.js');var RenewedItem=function(_LineItemConvertible3){_inherits(RenewedItem,_LineItemConvertible3);function RenewedItem(){_classCallCheck(this,RenewedItem);return _possibleConstructorReturn(this,(RenewedItem.__proto__||Object.getPrototypeOf(RenewedItem)).apply(this,arguments));}_createClass(RenewedItem,[{key:"_createVO",value:function _createVO(){var _this140=this;return _get(RenewedItem.prototype.__proto__||Object.getPrototypeOf(RenewedItem.prototype),"_createVO",this).call(this).then(function(){_this140._setRenewalPrice();});}},{key:"_setRenewalPrice",value:function _setRenewalPrice(){var _this141=this;var quoteLinePrefix=this._salesCloudPrefix;var pricingMethod=(this.lineVO.record[quoteLinePrefix+'PricingMethod__c']||'list').toLowerCase();var isBlockPriced=pricingMethod==='block';var slabDiscounted=(this._sourceRecord[this._sourceRecPrefix+'DiscountScheduleType__c']||'').toLowerCase()==='slab';var isAsset=!this.lineVO.record[quoteLinePrefix+'SubscriptionPricing__c'];var renewalPricingMethod=(this._account[this._salesCloudPrefix+'RenewalPricingMethod__c']||'').toLowerCase();if(isBlockPriced&&(renewalPricingMethod==='list'||this._settings.includePriorBlockPurchases&&isAsset)){this.lineVO.renewalPrice=null;}else if(isBlockPriced||slabDiscounted){var rpSum=0;var allRecs=this._originalRecords.concat(this._revisions);allRecs.forEach(function(rec){rpSum+=_this141._calculateRenewalPrice(rec);});this.lineVO.renewalPrice=rpSum;}else{this.lineVO.renewalPrice=this._calculateRenewalPrice(this._mostRecentRecord);}var isListPriced=pricingMethod==='list';var rpmIsList=renewalPricingMethod==='list';var renewalPriceEqualsListPrice=this.lineVO.record[quoteLinePrefix+'ListPrice__c']===this.lineVO.renewalPrice;var lineHasVolumeDiscount=this.lineVO.record[quoteLinePrefix+'DiscountSchedule__c']!=null;if(isListPriced&&(rpmIsList||renewalPriceEqualsListPrice&&lineHasVolumeDiscount)){this.lineVO.renewalPrice=null;}}},{key:"_calculateRenewalPrice",value:function _calculateRenewalPrice(sourceRecord){var rpm=(this._account[this._salesCloudPrefix+'RenewalPricingMethod__c']||'').toLowerCase();switch(rpm){case'list':return this._getRenewalListPrice();case'uplift':var samePrice=this._getRenewalSamePrice(sourceRecord);var upliftRate=this._isPriceHoldInEffect()?0:this._getRenewalUpliftRate(sourceRecord)||0;return samePrice==null?null:samePrice*(1.0+upliftRate/100);case'same':default:return this._getRenewalSamePrice(sourceRecord);}}},{key:"_getRenewalUpliftRate",value:function _getRenewalUpliftRate(record){throw new Error('RenewedItem.getRenewalUpliftRate() should be overridden by child classes, and never invoked directly.');}},{key:"_getRenewalSamePrice",value:function _getRenewalSamePrice(record){throw new Error('RenewedItem._getRenewalSamePrice() should be overridden by child classes, and never invoked directly.');}},{key:"_getRenewalListPrice",value:function _getRenewalListPrice(){throw new Error('RenewedItem._getRenewalListPrice() should be overridden by child classes, and never invoked directly.');}},{key:"_listPriceMapsFromProduct",value:function _listPriceMapsFromProduct(){return(this._account[this._salesCloudPrefix+'RenewalPricingMethod__c']||'').toLowerCase()==='list';}},{key:"_mostRecentRecord",get:function get(){if(this._revisions.length>0){return this._revisions[this._revisions.length-1];}else{return this._sourceRecord;}}}]);return RenewedItem;}(LineItemConvertible);module.exports=RenewedItem;},{"../common/LineItemConvertible.js":32}],48:[function(require,module,exports){'use strict';var MDQConvertible=require('../common/MDQConvertible.js');var RenewedRecurringSegment=require('./RenewedRecurringSegment.js');var DateUtils=require('../../Utils/DateUtils.js');var RenewedMDQ=function(_MDQConvertible2){_inherits(RenewedMDQ,_MDQConvertible2);function RenewedMDQ(key,settings,objMap,services){_classCallCheck(this,RenewedMDQ);var _this142=_possibleConstructorReturn(this,(RenewedMDQ.__proto__||Object.getPrototypeOf(RenewedMDQ)).call(this,key,settings,objMap,services));_this142.SEGMENT_INDEX_FIELD=_this142.prefix+'SegmentIndex__c';_this142._isDesegmented=_this142._contract[_this142.prefix+'MDQRenewalBehavior__c']==='De-segmented';return _this142;}_createClass(RenewedMDQ,[{key:"addOriginalRecord",value:function addOriginalRecord(rec){var recType=rec.attributes.type;if(recType!=='Asset'){this._addOriginalRecurringRecord(rec,RenewedRecurringSegment);}}},{key:"addRevision",value:function addRevision(rec){var recType=rec.attributes.type;if(recType!=='Asset'){this._addRevisionRecurringRecord(rec);}}},{key:"_shouldGenerateLines",value:function _shouldGenerateLines(){if(this._recurringSegmentsByIndex.size>0){var lastSeg=this.getLastSegment();return lastSeg.shouldGenerateLines();}return false;}},{key:"process",value:function process(){var _this143=this;if(!this._shouldGenerateLines()){return Promise.resolve();}else if(this._isDesegmented){var lastSeg=this.getLastSegment();return lastSeg.process();}else{var promises=[];var _iteratorNormalCompletion32=true;var _didIteratorError32=false;var _iteratorError32=undefined;try{for(var _iterator32=this._recurringSegmentsByIndex.keys()[Symbol.iterator](),_step32;!(_iteratorNormalCompletion32=(_step32=_iterator32.next()).done);_iteratorNormalCompletion32=true){var key=_step32.value;var promise=this._recurringSegmentsByIndex.get(key).process();promises.push(promise);}}catch(err){_didIteratorError32=true;_iteratorError32=err;}finally{try{if(!_iteratorNormalCompletion32&&_iterator32.return){_iterator32.return();}}finally{if(_didIteratorError32){throw _iteratorError32;}}}return Promise.all(promises).then(function(){for(var i=1;i<=_this143._recurringSegmentsByIndex.size;i++){if(_this143._recurringSegmentsByIndex.has(i)){_this143._recurringSegmentsByIndex.get(i).postProcessSegment();}}});}}},{key:"_getDesiredNumberOfSegments",value:function _getDesiredNumberOfSegments(){var dimType=this._determineRecurringDimensionType();if(dimType===this._DIMTYPE_CUSTOM){return this._recurringSegmentsByIndex.size;}else{var term=this._calculateSubscriptionTermInMonths();switch(dimType){case this._DIMTYPE_YEAR:return Math.ceil(term/12);case this._DIMTYPE_QUARTER:return Math.ceil(term/3);case this._DIMTYPE_MONTH:return term;default:throw Error("ERROR: MDQ Product with segment key "+this._key+" has unrecognized segment type \""+dimType+"\".");}}}},{key:"_calculateSubscriptionTermInMonths",value:function _calculateSubscriptionTermInMonths(){var sourceForDates=this._group||this._quote;var startDate=new Date(sourceForDates[this._salesCloudPrefix+'StartDate__c']);var endDate=new Date(sourceForDates[this._salesCloudPrefix+'EndDate__c']);endDate.setDate(endDate.getDate()+1);return DateUtils.monthsBetweenRoundPartialUp(startDate,endDate);}},{key:"getLastSegment",value:function getLastSegment(){return this._recurringSegmentsByIndex.get(this._recurringSegmentsByIndex.size);}},{key:"conversionResults",get:function get(){if(!this._shouldGenerateLines()){return null;}else if(this._isDesegmented){var lastSeg=this.getLastSegment();return lastSeg.lineVO;}else{var _results3=[];var desiredSegCount=this._getDesiredNumberOfSegments();var nextIndex=1;while(nextIndex<=desiredSegCount){if(nextIndex<=this._recurringSegmentsByIndex.size){_results3.push(this._recurringSegmentsByIndex.get(nextIndex).lineVO);}else{_results3.push(this.getLastSegment().cloneLineVOWithIndex(nextIndex));}nextIndex++;}return _results3;}}}]);return RenewedMDQ;}(MDQConvertible);module.exports=RenewedMDQ;},{"../../Utils/DateUtils.js":6,"../common/MDQConvertible.js":35,"./RenewedRecurringSegment.js":49}],49:[function(require,module,exports){'use strict';var RenewedSubscription=require('./RenewedSubscription.js');var DateUtils=require('../../Utils/DateUtils.js');var RenewedRecurringSegment=function(_RenewedSubscription){_inherits(RenewedRecurringSegment,_RenewedSubscription);function RenewedRecurringSegment(key,settings,objMap,services,wrapper){_classCallCheck(this,RenewedRecurringSegment);var _this144=_possibleConstructorReturn(this,(RenewedRecurringSegment.__proto__||Object.getPrototypeOf(RenewedRecurringSegment)).call(this,key,settings,objMap,services));_this144._segmentWrapper=wrapper;return _this144;}_createClass(RenewedRecurringSegment,[{key:"process",value:function process(){return this._createVO();}},{key:"shouldGenerateLines",value:function shouldGenerateLines(){return this._shouldGenerateLines();}},{key:"getSummedQuantity",value:function getSummedQuantity(){return this._getSummedQuantity();}},{key:"_getSummedQuantity",value:function _getSummedQuantity(){var _this145=this;var sum=0;var lastSeg=this._segmentWrapper.getLastSegment();var myIndex=this._sourceRecord[this._sourceRecPrefix+'SegmentIndex__c'];var lastSegIndex=lastSeg.getFieldFromSourceRecord('SegmentIndex__c');if(myIndex===lastSegIndex){this._originalRecords.forEach(function(originalRec){var renewalQty=originalRec[_this145._sourceRecPrefix+'RenewalQuantity__c'];var segmentQty=originalRec[_this145._sourceRecPrefix+'SegmentQuantity__c'];sum+=renewalQty!=null?renewalQty:segmentQty;});this._revisions.forEach(function(revisionRec){sum+=revisionRec[_this145._sourceRecPrefix+'Quantity__c'];});}else{sum=lastSeg.getSummedQuantity();}return sum;}},{key:"_findMatchingDimension",value:function _findMatchingDimension(){var salesPrefix=this._salesCloudPrefix;var product=this._product;var dimensions=product[salesPrefix+'Dimensions__r'];var selectedDim=null;if(dimensions){var dimCount=dimensions.records.length;var pricebookId=this._quote[salesPrefix+'PricebookId__c'];var currencyCode=this._quote['CurrencyIsoCode'];for(var i=0;i<dimCount;i++){var dim=dimensions.records[i];var currencyMatches=!this._settings.isMultiCurrencyOrg||dim.CurrencyIsoCode===currencyCode;var notOneTime=dim[salesPrefix+'Type__c'].toLowerCase()!=='one-time';if(notOneTime&&currencyMatches){var dimPricebook=dim[salesPrefix+'PriceBook__c'];if(dimPricebook!=null&&dimPricebook.slice(0,15)===pricebookId.slice(0,15)){selectedDim=dim;break;}else if(dimPricebook==null&&selectedDim==null){selectedDim=dim;}}}}return selectedDim;}},{key:"_setValuesFromProduct",value:function _setValuesFromProduct(lineVO){_get(RenewedRecurringSegment.prototype.__proto__||Object.getPrototypeOf(RenewedRecurringSegment.prototype),"_setValuesFromProduct",this).call(this,lineVO);var sourcePrefix=this._sourceRecPrefix;var salesPrefix=this._salesCloudPrefix;if(this._contract[sourcePrefix+'MDQRenewalBehavior__c']==='De-segmented'){return;}var selectedDim=this._findMatchingDimension();if(selectedDim){lineVO.record[salesPrefix+'Dimension__c']=selectedDim.Id;lineVO.dimensionType=selectedDim[salesPrefix+'Type__c'];}}},{key:"_getListPriceFromProduct",value:function _getListPriceFromProduct(){var selectedDim=this._findMatchingDimension();if(selectedDim!=null&&selectedDim[this._salesCloudPrefix+'UnitPrice__c']!=null){return selectedDim[this._salesCloudPrefix+'UnitPrice__c'];}else{return _get(RenewedRecurringSegment.prototype.__proto__||Object.getPrototypeOf(RenewedRecurringSegment.prototype),"_getListPriceFromProduct",this).call(this);}}},{key:"_setValuesFromOrigin",value:function _setValuesFromOrigin(lineVO){_get(RenewedRecurringSegment.prototype.__proto__||Object.getPrototypeOf(RenewedRecurringSegment.prototype),"_setValuesFromOrigin",this).call(this,lineVO);var record=lineVO.record;var salesCloudPrefix=this._salesCloudPrefix;var sourcePrefix=this._sourceRecPrefix;var sourceRec=this._sourceRecord;if(this._contract[sourcePrefix+'MDQRenewalBehavior__c']==='De-segmented'){record[salesCloudPrefix+'StartDate__c']=null;record[salesCloudPrefix+'EndDate__c']=null;if(this._preserveBundleStructure){switch(record[salesCloudPrefix+'OptionType__c']){case'Component':record[salesCloudPrefix+'BundledQuantity__c']=lineVO.record[salesCloudPrefix+'Quantity__c'];break;case'Accessory':record[salesCloudPrefix+'BundledQuantity__c']=record[salesCloudPrefix+'Quantity__c'];break;}}}else{record[salesCloudPrefix+'SegmentKey__c']=sourceRec[sourcePrefix+'SegmentKey__c'];record[salesCloudPrefix+'SegmentIndex__c']=sourceRec[sourcePrefix+'SegmentIndex__c'];record[salesCloudPrefix+'SegmentLabel__c']=sourceRec[sourcePrefix+'SegmentLabel__c'];if(this.dimensionType==='Custom'){var contractTermField=this._settings.isServiceCloudEnabled?'Term':'ContractTerm';var contractTermValue=this._contract[contractTermField];var startDate=new Date(sourceRec[sourcePrefix+'SegmentStartDate__c']);var endDate=new Date(sourceRec[sourcePrefix+'SegmentEndDate__c']);startDate=DateUtils.addMonths(startDate,contractTermValue);record[salesCloudPrefix+'StartDate__c']=DateUtils.toApexDate(startDate);var mustBeEndOfMonth=DateUtils.isEndOfMonth(endDate);endDate=DateUtils.addMonths(endDate,contractTermValue);if(mustBeEndOfMonth&&!DateUtils.isEndOfMonth(endDate)){endDate=DateUtils.moveToEndOfMonth(endDate);}record[salesCloudPrefix+'EndDate__c']=DateUtils.toApexDate(endDate);}else{record[salesCloudPrefix+'StartDate__c']=null;record[salesCloudPrefix+'EndDate__c']=null;}var rpm=(this._account[salesCloudPrefix+'RenewalPricingMethod__c']||'').toLowerCase();if(sourceRec[sourcePrefix+'SegmentIndex__c']===1&&rpm!=='list'){var lastSeg=this._segmentWrapper.getLastSegment();record[salesCloudPrefix+'PreviousSegmentUplift__c']=lastSeg.getFieldFromSourceRecord('SegmentUpliftAmount__c');record[salesCloudPrefix+'PreviousSegmentPrice__c']=lastSeg.getFieldFromSourceRecord('RegularPrice__c');}}}},{key:"_calculateRenewalPrice",value:function _calculateRenewalPrice(sourceRecord){var rpm=(this._account[this._salesCloudPrefix+'RenewalPricingMethod__c']||'').toLowerCase();switch(rpm){case'list':return this._getRenewalListPrice();case'uplift':var samePrice=this._getRenewalSamePrice(sourceRecord);if(this._contract[this._sourceRecPrefix+'MDQRenewalBehavior__c']!=='De-segmented'){return samePrice;}var upliftRate=this._isPriceHoldInEffect()?0:this._getRenewalUpliftRate(sourceRecord)||0;return samePrice==null?null:samePrice*(1.0+upliftRate/100);case'same':default:return this._getRenewalSamePrice(sourceRecord);}}},{key:"postProcessSegment",value:function postProcessSegment(){this._recalculateRenewalPrice();}},{key:"_recalculateRenewalPrice",value:function _recalculateRenewalPrice(){var salesCloudPrefix=this._salesCloudPrefix;var rpm=(this._account[salesCloudPrefix+'RenewalPricingMethod__c']||'').toLowerCase();if(rpm!=='list'){var myIndex=this._sourceRecord[this._sourceRecPrefix+'SegmentIndex__c'];var effectivePreviousSegment=myIndex>1?this._segmentWrapper.getRecurringSegmentByIndex(myIndex-1):this._segmentWrapper.getLastSegment();var basePrice=effectivePreviousSegment.lineVO.renewalPrice;if(rpm==='uplift'){var upliftRate=this._isPriceHoldInEffect()?0:this._getRenewalUpliftRate(this._mostRecentRecord)||0;this.lineVO.renewalPrice=basePrice==null?null:basePrice*(1.0+upliftRate/100);}else{this.lineVO.renewalPrice=basePrice;}}}},{key:"cloneLineVOWithIndex",value:function cloneLineVOWithIndex(newIndex){var cloneVO=JSON.parse(JSON.stringify(this.lineVO));var renewalPricingMethod=(this._account[this._salesCloudPrefix+'RenewalPricingMethod__c']||'').toLowerCase();if(renewalPricingMethod!=='same'){cloneVO.renewalPrice=null;}cloneVO.record[this._salesCloudPrefix+'SegmentIndex__c']=newIndex;var labelWhitespace=newIndex<10?'  ':' ';cloneVO.record[this._salesCloudPrefix+'SegmentLabel__c']=this.dimensionType+labelWhitespace+newIndex;cloneVO.record[this._salesCloudPrefix+'PreviousSegmentUplift__c']=null;cloneVO.record[this._salesCloudPrefix+'PreviousSegmentPrice__c']=null;return cloneVO;}},{key:"getFieldFromSourceRecord",value:function getFieldFromSourceRecord(fieldName){return this._sourceRecord[this._sourceRecPrefix+fieldName];}},{key:"parent",get:function get(){return this._segmentWrapper.parent;}},{key:"dimensionType",get:function get(){var sourceRec=this._sourceRecord;var sourceRecPrefix=this._sourceRecPrefix;return sourceRec[sourceRecPrefix+'DimensionType__c'];}}]);return RenewedRecurringSegment;}(RenewedSubscription);module.exports=RenewedRecurringSegment;},{"../../Utils/DateUtils.js":6,"./RenewedSubscription.js":50}],50:[function(require,module,exports){'use strict';var RenewedItem=require('./RenewedItem.js');var RenewedSubscription=function(_RenewedItem2){_inherits(RenewedSubscription,_RenewedItem2);function RenewedSubscription(){_classCallCheck(this,RenewedSubscription);return _possibleConstructorReturn(this,(RenewedSubscription.__proto__||Object.getPrototypeOf(RenewedSubscription)).apply(this,arguments));}_createClass(RenewedSubscription,[{key:"_getSummedQuantity",value:function _getSummedQuantity(){var _this147=this;var sum=0;var allRecs=this._originalRecords.concat(this._revisions);allRecs.forEach(function(rec){var renewalQty=rec[_this147._sourceRecPrefix+'RenewalQuantity__c'];var qty=rec[_this147._sourceRecPrefix+'Quantity__c'];sum+=renewalQty!=null?renewalQty:qty;});return sum;}},{key:"_shouldGenerateLines",value:function _shouldGenerateLines(){if(!_get(RenewedSubscription.prototype.__proto__||Object.getPrototypeOf(RenewedSubscription.prototype),"_shouldGenerateLines",this).call(this)){return false;}var sourceRec=this._sourceRecord;var prefix=this._sourceRecPrefix;if(sourceRec[prefix+'TerminatedDate__c']){return false;}var renewability=this._product[this._salesCloudPrefix+'SubscriptionType__c']||'';return renewability.toLowerCase()!=='one-time';}},{key:"_setValuesFromProduct",value:function _setValuesFromProduct(vo){_get(RenewedSubscription.prototype.__proto__||Object.getPrototypeOf(RenewedSubscription.prototype),"_setValuesFromProduct",this).call(this,vo);}},{key:"_getListPriceFromSourceRecord",value:function _getListPriceFromSourceRecord(){var sourceRec=this._sourceRecord;var sourcePrefix=this._sourceRecPrefix;var prorateMultiplier=sourceRec[sourcePrefix+'ProrateMultiplier__c'];var subListPrice=sourceRec[sourcePrefix+'ListPrice__c'];return prorateMultiplier?subListPrice/prorateMultiplier:subListPrice;}},{key:"_setValuesFromOrigin",value:function _setValuesFromOrigin(lineVO){var _this148=this;_get(RenewedSubscription.prototype.__proto__||Object.getPrototypeOf(RenewedSubscription.prototype),"_setValuesFromOrigin",this).call(this,lineVO);var record=lineVO.record;var salesCloudPrefix=this._salesCloudPrefix;var sourcePrefix=this._sourceRecPrefix;var sourceRec=this._sourceRecord;record[this._renewedItemField]=sourceRec.Id;var subEndDate=new Date(sourceRec[this._sourceEndDateField]);subEndDate.setUTCDate(subEndDate.getUTCDate()+1);var startDate=subEndDate;var startDateStr=startDate.toISOString().replace(new RegExp('[Tt].*'),"");var quoteStartDateStr=this._quote[salesCloudPrefix+'StartDate__c'];if(quoteStartDateStr!==startDateStr){record[salesCloudPrefix+'StartDate__c']=startDateStr;}if(this._preserveBundleStructure()){record[salesCloudPrefix+'ComponentSubscriptionScope__c']=sourceRec[sourcePrefix+'ComponentSubscriptionScope__c'];}var rpm=(this._account[salesCloudPrefix+'RenewalPricingMethod__c']||'').toLowerCase();if(rpm==='uplift'&&!this._isPriceHoldInEffect()){var upliftRate=this._getRenewalUpliftRate(sourceRec);if(record[salesCloudPrefix+'SubscriptionPricing__c'].toLowerCase()==='percent of total'){record[salesCloudPrefix+'SubscriptionPercent__c']*=(100+(upliftRate||0))/100;}if(upliftRate){record[salesCloudPrefix+'Uplift__c']=upliftRate;}}var subscriptions=this._originalRecords.concat(this._revisions);var assetField=this._isServiceCloudEnabled?'AssetId':this._salesCloudPrefix+'Asset__c';var assetIds=[];subscriptions.forEach(function(subscription){var subscribedAssets=subscription[_this148._subscribedAssetRelationshipName];if(subscribedAssets&&subscribedAssets.totalSize>0){subscribedAssets.records.forEach(function(subscribedAsset){assetIds.push(subscribedAsset[assetField]);});}});record[this._salesCloudPrefix+'SubscribedAssetIds__c']=assetIds.join(',');record[this._salesCloudPrefix+'HasConsumptionSchedule__c']=sourceRec[sourcePrefix+'HasConsumptionSchedule__c'];record[salesCloudPrefix+'ProductSubscriptionType__c']=sourceRec[sourcePrefix+'ProductSubscriptionType__c'];record[salesCloudPrefix+'SubscriptionType__c']=sourceRec[sourcePrefix+'SubscriptionType__c'];}},{key:"_getEffectiveOptionId",value:function _getEffectiveOptionId(sourceRec){var prefix=this._sourceRecPrefix;return sourceRec[prefix+'RenewalProductOptionId__c']||sourceRec[prefix+'ProductOption__c'];}},{key:"_getRenewalUpliftRate",value:function _getRenewalUpliftRate(subRecord){var prefix=this._sourceRecPrefix;var subUplift=subRecord[prefix+'RenewalUpliftRate__c'];return subUplift!=null?subUplift:this._contract[prefix+'RenewalUpliftRate__c'];}},{key:"_getRenewalSamePrice",value:function _getRenewalSamePrice(subRecord){var prefix=this._sourceRecPrefix;var oldPrice=subRecord[prefix+'RenewalPrice__c'];if(oldPrice==null){var prorateMultiplier=subRecord[prefix+'ProrateMultiplier__c'];prorateMultiplier=prorateMultiplier==null?1:prorateMultiplier;var customerPrice=subRecord[prefix+'CustomerPrice__c'];oldPrice=customerPrice==null?null:customerPrice/prorateMultiplier;}return oldPrice;}},{key:"_getRenewalListPrice",value:function _getRenewalListPrice(){return this.lineVO.record[this._salesCloudPrefix+'ListPrice__c'];}},{key:"_verifyNonNullValuesForRequiredFields",value:function _verifyNonNullValuesForRequiredFields(){var prefix=this._salesCloudPrefix;var product=this._product;if(!product[prefix+'SubscriptionPricing__c']){throw new Error(this._settings.labels.msg_subscriptions_require_subscription_pricing);}}},{key:"_sourceRecPrefix",get:function get(){return this._sourceRecType.endsWith('Subscription__c')?this._salesCloudPrefix:this._serviceCloudPrefix;}},{key:"_renewedItemField",get:function get(){return this._sourceRecType.endsWith('Subscription__c')?this._salesCloudPrefix+'RenewedSubscription__c':this._serviceCloudPrefix+'RenewedContractLine__c';}},{key:"_sourceEndDateField",get:function get(){return this._sourceRecType.endsWith('Subscription__c')?this._salesCloudPrefix+'EndDate__c':'EndDate';}}]);return RenewedSubscription;}(RenewedItem);module.exports=RenewedSubscription;},{"./RenewedItem.js":47}],51:[function(require,module,exports){module.exports.TYPE_RENEWAL="Renewal";module.exports.TYPE_AMENDMENT="Amendment";module.exports.TYPE_CHANGEQUOTE="Re-Quote";module.exports.TYPE_SINGLE_DIMENSION="One-time";module.exports.TYPE_YEARLY_DIMENSION="Year";module.exports.TYPE_QUARTERLY_DIMENSION="Quarter";module.exports.TYPE_MONTHLY_DIMENSION="Month";module.exports.TYPE_CUSTOM_DIMENSION="Custom";module.exports.TYPE_SUBSCRIPTION_EVERGREEN='Evergreen';module.exports.PRICING_METHOD_CUSTOM="Custom";module.exports.PRICING_METHOD_COST="Cost";module.exports.PRICING_METHOD_BLOCK="Block";module.exports.PRICING_METHOD_LIST="List";module.exports.PRICING_METHOD_PERCENT_OF_TOTAL="percent of total";module.exports.OP_EQ="equals";module.exports.OP_NEQ="not equals";module.exports.OP_LT="less than";module.exports.OP_LTE="less or equals";module.exports.OP_GT="greater than";module.exports.OP_GTE="greater or equals";module.exports.OP_SW="starts with";module.exports.OP_EW="ends with";module.exports.OP_CONT="contains";},{}],52:[function(require,module,exports){var UNIVERSAL_STANDARD_FIELDS={'id':true,'createddate':true,'lastmodifieddate':true,'name':true,'ownerid':true,'createdbyid':true,'lastmodifiedbyid':true,'currencyisocode':true};var QUOTE_LINE_STANDARD_FIELDS={"quantity":"Quantity__c","list price":"ListPrice__c","net total":"NetTotal__c","customer total":"CustomerTotal__c","regular total":"RegularTotal__c","list total":"ListTotal__c","product family":"ProductFamily__c","product code":"ProductCode__c","product":"Product__c","markup (%)":"MarkupRate__c","markup (amt)":"MarkupAmount__c","discount (%)":"Discount__c","discount (amt)":"AdditionalDiscountAmount__c","partner discount":"PartnerDiscount__c","subscription category":"SubscriptionCategory__c","total discount (amt)":"TotalDiscountAmount__c","optional":"Optional__c","number":"Number__c"};var QUOTE_STANDARD_FIELDS={'type':"Type__c",'status':"Status__c","primary":"Primary__c","list amount":"ListAmount__c","regular amount":"RegularAmount__c","customer amount":"CustomerAmount__c","net amount":"NetAmount__c","total customer disc. amount":"TotalCustomerDiscountAmount__c","addl. disc. amount":"AdditionalDiscountAmount__c","bill to country":"BillingCountry__c","ship to country":"ShippingCountry__c","group line items":"LineItemsGrouped__c"};var QUOTE_LINE_PRICING_GUIDANCE_STANDARD_FIELDS={'target':"Target__c",'norm':"Norm__c",'floor':"Floor__c",'explanation':"Explanation__c"};var ASSET_STANDARD_FIELDS={'AccountId':'AccountId','ContactId':'ContactId','Description':'Description','InstallDate':'InstallDate','IsCompetitorProduct':'IsCompetitorProduct','LastReferencedDate':'LastReferencedDate','LastViewedDate':'LastViewedDate','Name':'Name','OwnerId':'OwnerId','ParentId':'ParentId','Price':'Price','PurchaseDate':'PurchaseDate','Quantity':'Quantity','RootAssetId':'RootAssetId','SerialNumber':'SerialNumber','Status':'Status','UsageEndDate':'UsageEndDate'};var SUBSCRIPTION_STANDARD_FIELDS={'quantity':'Quantity__c'};module.exports.getRecordType=function(object){if(object==null){return null;}else if(object.hasOwnProperty("attributes")&&object["attributes"]!=null){return object["attributes"]["type"];}return null;};module.exports.getObjectType=function(obj){var record=obj["record"];if(record==null){return null;}else if(record.hasOwnProperty("attributes")&&record["attributes"]!=null){return record["attributes"]["type"];}return null;};module.exports.getField=function(type,name,prefix){if(name==null){return null;}if(UNIVERSAL_STANDARD_FIELDS[name.toLowerCase()]!=null){return name;}var lcPrefix=prefix.toLowerCase();var convType=type.toLowerCase();switch(convType){case lcPrefix+"quoteline__c":case'quote line':return getFieldFromMap(QUOTE_LINE_STANDARD_FIELDS,name,prefix);case lcPrefix+'quote__c':case'quote':return getFieldFromMap(QUOTE_STANDARD_FIELDS,name,prefix);case lcPrefix+"quotelinepricingguidance__c":case'quote line pricing guidance':return getFieldFromMap(QUOTE_LINE_PRICING_GUIDANCE_STANDARD_FIELDS,name,prefix);case'asset':return ASSET_STANDARD_FIELDS[name]||name;case lcPrefix+'subscription__c':case'subscription':return getFieldFromMap(SUBSCRIPTION_STANDARD_FIELDS,name,prefix);default:return name;}};module.exports.getAliasTargetType=function(targetType,prefix){switch(targetType){case prefix+'Quote__c':return'Quote';case prefix+'QuoteLineGroup__c':return'Group';case prefix+'QuoteLine__c':return'Quote Line';default:return targetType;}};module.exports.getRelationshipName=function(fieldName){if(!fieldName||fieldName==='Id')return fieldName;return fieldName.substring(fieldName.length-3)==='__c'?fieldName.substring(0,fieldName.length-1)+'r':fieldName.substring(fieldName.length-2)==='Id'?fieldName.substring(0,fieldName.length-2):fieldName;};function getFieldFromMap(fieldMap,field,prefix){var trueField=fieldMap[field.toLowerCase()];if(trueField!=null){return prefix+trueField;}else{if(field.lastIndexOf('__c')===field.length-3&&field.indexOf(' ')===-1){return field;}else{return null;}}}},{}],53:[function(require,module,exports){var constants=require("./JSQCConstants.js");module.exports.getInstance=getInstance;module.exports.getInverseInstance=getInverseInstance;function getInstance(key){switch(key){case constants.OP_EQ:return new OpEquals();case constants.OP_NEQ:return new OpNotEquals();case constants.OP_LT:return new OpLessThan();case constants.OP_LTE:return new OpLessThanEquals();case constants.OP_GT:return new OpGreaterThan();case constants.OP_GTE:return new OpGreaterThanEquals();case constants.OP_SW:return new OpStartsWith();case constants.OP_EW:return new OpEndsWith();case constants.OP_CONT:return new OpContains();default:return null;}}function getInverseInstance(key){switch(key){case constants.OP_EQ:return new OpEquals();case constants.OP_NEQ:return new OpNotEquals();case constants.OP_LT:return new OpGreaterThan();case constants.OP_LTE:return new OpGreaterThanEquals();case constants.OP_GT:return new OpLessThan();case constants.OP_GTE:return new OpLessThanEquals();case constants.OP_SW:return new OpStartsWith();case constants.OP_EW:return new OpEndsWith();case constants.OP_CONT:return new OpContains();default:return null;}}function OpEquals(){return{testValueCache:{},fieldValueCache:{},opType:constants.OP_EQ,evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null){return fieldValue==testValue;}if(fieldValue instanceof Date){return fieldValue.getTime()===new Date(testValue).getTime();}else if(typeof fieldValue==="boolean"){return fieldValue===(String(testValue).toLowerCase()==="true");}else if(typeof fieldValue==="string"&&typeof testValue==="string"){var lowerCaseTest=testValue.toLowerCase();var lowerCaseField=fieldValue.toLowerCase();if(this.testValueCache[lowerCaseTest]==null){this.testValueCache[lowerCaseTest]=valueFor(lowerCaseTest);}if(this.fieldValueCache[lowerCaseField]==null){this.fieldValueCache[lowerCaseField]=valueFor(lowerCaseField);}return this.testValueCache[lowerCaseTest].equals(this.fieldValueCache[lowerCaseField]);}else if(typeof fieldValue==="number"||fieldValue instanceof Number){return fieldValue.valueOf()==testValue;}return false;}};}function OpNotEquals(){return{opType:constants.OP_NEQ,equals:new OpEquals(),evaluate:function evaluate(fieldValue,testValue){return!this.equals.evaluate(fieldValue,testValue);}};}function OpGreaterThan(){return{opType:constants.OP_GT,evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null){return false;}if(typeof fieldValue==="number"||fieldValue instanceof Number){return fieldValue.valueOf()>testValue;}else if(fieldValue instanceof Date){return fieldValue>new Date(testValue);}else if(typeof fieldValue=='string'){var fieldTime=Date.parse(fieldValue);var testTime=Date.parse(testValue);if(fieldTime===fieldTime&&testTime===testTime){return fieldTime>testTime;}return fieldValue.toLowerCase()>testValue.toLowerCase();}return false;}};}function OpGreaterThanEquals(){return{opType:constants.OP_GTE,evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null){return false;}if(typeof fieldValue==="number"||fieldValue instanceof Number){return fieldValue.valueOf()>=testValue;}else if(fieldValue instanceof Date){return fieldValue>=new Date(testValue);}else if(typeof fieldValue=='string'){var fieldTime=Date.parse(fieldValue);var testTime=Date.parse(testValue);if(fieldTime===fieldTime&&testTime===testTime){return fieldTime>=testTime;}return fieldValue>=testValue;}return false;}};}function OpLessThan(){return{opType:constants.OP_LT,gte:new OpGreaterThanEquals(),evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null||typeof fieldValue!=="number"&&typeof fieldValue!=='string'&&!(fieldValue instanceof Date||fieldValue instanceof Number)){return false;}return!this.gte.evaluate(fieldValue,testValue);}};}function OpLessThanEquals(){return{opType:constants.OP_LTE,gt:new OpGreaterThan(),evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null||typeof fieldValue!=="number"&&typeof fieldValue!=='string'&&!(fieldValue instanceof Date||fieldValue instanceof Number)){return false;}return!this.gt.evaluate(fieldValue,testValue);}};}function OpStartsWith(){return{opType:constants.OP_SW,evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null){return false;}return String(fieldValue).toLowerCase().indexOf(String(testValue).toLowerCase())===0;}};}function OpEndsWith(){return{opType:constants.OP_EW,evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null){return false;}var fStr=String(fieldValue).toLowerCase();var tStr=String(testValue).toLowerCase();return fStr.indexOf(tStr,fStr.length-tStr.length)!==-1;}};}function OpContains(){return{opType:constants.OP_CONT,evaluate:function evaluate(fieldValue,testValue){if(fieldValue==null||testValue==null){return false;}var fStr=String(fieldValue).toLowerCase();var tStr=String(testValue).toLowerCase();return fStr.indexOf(tStr)!==-1;}};}function valueFor(value){if(value.indexOf(',')>-1&&value.indexOf('"')!=0&&value.lastIndexOf('"')!=value.length-1){return{valueType:'Multi',valueSet:value.split(',').map(function(v){return v.trim();}),equals:function equals(otherValue){if(otherValue.valueType==='Multi'){var otherVals=otherValue.valueSet;return otherVals.some(function(v){return this.valueSet.indexOf(v)!=-1;},this);}else{return this.valueSet.indexOf(otherValue.value)!=-1;}}};}else{return{valueType:'Single',value:value,equals:function equals(otherValue){return this.value===otherValue.value;}};}}},{"./JSQCConstants.js":51}],54:[function(require,module,exports){'use strict';exports.path=require('path').dirname(require.main.filename);exports.resolve=function(pathToModule){return exports.path+pathToModule;};exports.require=function(pathToModule){var r='function'===typeof __webpack_require__?__non_webpack_require__:require;return r(exports.resolve(pathToModule));};exports.toString=function(){return exports.path;};exports.setPath=function(explicitlySetPath){exports.path=explicitlySetPath;};},{"path":72}],55:[function(require,module,exports){},{}],56:[function(require,module,exports){arguments[4][55][0].apply(exports,arguments);},{"dup":55}],57:[function(require,module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined;}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError('n must be a positive number');this._maxListeners=n;return this;};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==='error'){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er;}else{var err=new Error('Uncaught, unspecified "error" event. ('+er+')');err.context=er;throw err;}}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:args=Array.prototype.slice.call(arguments,1);handler.apply(this,args);}}else if(isObject(handler)){args=Array.prototype.slice.call(arguments,1);listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++){listeners[i].apply(this,args);}}return true;};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError('listener must be a function');if(!this._events)this._events={};if(this._events.newListener)this.emit('newListener',type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){if(!isUndefined(this._maxListeners)){m=this._maxListeners;}else{m=EventEmitter.defaultMaxListeners;}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error('(node) warning: possible EventEmitter memory '+'leak detected. %d listeners added. '+'Use emitter.setMaxListeners() to increase limit.',this._events[type].length);if(typeof console.trace==='function'){console.trace();}}}return this;};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError('listener must be a function');var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments);}}g.listener=listener;this.on(type,g);return this;};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError('listener must be a function');if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit('removeListener',type,listener);}else if(isObject(list)){for(i=length;i-->0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break;}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type];}else{list.splice(position,1);}if(this._events.removeListener)this.emit('removeListener',type,listener);}return this;};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this;}if(arguments.length===0){for(key in this._events){if(key==='removeListener')continue;this.removeAllListeners(key);}this.removeAllListeners('removeListener');this._events={};return this;}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners);}else if(listeners){while(listeners.length){this.removeListener(type,listeners[listeners.length-1]);}}delete this._events[type];return this;};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret;};EventEmitter.prototype.listenerCount=function(type){if(this._events){var evlistener=this._events[type];if(isFunction(evlistener))return 1;else if(evlistener)return evlistener.length;}return 0;};EventEmitter.listenerCount=function(emitter,type){return emitter.listenerCount(type);};function isFunction(arg){return typeof arg==='function';}function isNumber(arg){return typeof arg==='number';}function isObject(arg){return(typeof arg==="undefined"?"undefined":_typeof(arg))==='object'&&arg!==null;}function isUndefined(arg){return arg===void 0;}},{}],58:[function(require,module,exports){module.exports.logger=require('./logger.js').instance;module.exports.newLoggerInstance=require('./logger.js').newInstance;},{"./logger.js":59}],59:[function(require,module,exports){(function(process,global,__filename){(function(){'use strict';var fs=require('fs');var log4js=require('log4js');var path=require('path');var loggers={};var logCtxNS={};if(typeof window==='undefined'){var cls=require('continuation-local-storage');logCtxNS=cls.getNamespace('app-log-ctx');}function decorateLogMethod(logMethod){return function(){var args=Array.prototype.slice.call(arguments);var ctx=undefined;if(typeof logCtxNS!=='undefined'){ctx=logCtxNS.get('logCtx');}if(typeof ctx==='undefined'){ctx='{}';}args.unshift(ctx);return logMethod.apply(undefined,args);};}function _Logger(log4jsLogger){for(var key in log4jsLogger){var attribute=log4jsLogger[key];if(typeof attribute==='function'){var originalMethod=attribute.bind(log4jsLogger);if(['trace','debug','info','warn','error','fatal'].indexOf(key)!==-1){this[key]=decorateLogMethod(originalMethod);}else{this[key]=originalMethod;}}else{this[key]=attribute;}}}var configurationFileOrObject=process.env.JS_LOGGER_CONFIG;var defaultConfig={"appenders":[{"type":"console","layout":{"type":"basic"}}],"levels":{"[all]":"INFO"}};function Logger(){this._initialized=false;}Logger.prototype.init=function(configurationFileOrObject){if(!this._initialized){if(configurationFileOrObject){try{if(typeof window!=='undefined'){log4js.configure(JSON.parse(configurationFileOrObject));}else{if(fs.existsSync(configurationFileOrObject)){log4js.configure(configurationFileOrObject);}else{log4js.configure(JSON.parse(configurationFileOrObject));}}}catch(err){console.error("Loading default config as Configuration File or Object is not valid.",err);log4js.configure(defaultConfig);}}else{log4js.configure(defaultConfig);}this._initialized=true;}return this;};Logger.prototype.getLogger=function(category,prefix){if(!this._initialized){this.init(configurationFileOrObject);}var name;if(category&&prefix){name=prefix+'#'+category;}else if(category){name=category;}else{name=this._getCallerFile();}if(typeof window!=='undefined'){loggers[name]=log4js.getLogger(name);}else{if(!loggers.hasOwnProperty(name)){loggers[name]=new _Logger(log4js.getLogger(name));}}return loggers[name];};Logger.prototype._getCallerFile=function(){var originalFunc=Error.prepareStackTrace;var classPath=null;try{if(typeof window!=='undefined'){return path.basename(__filename);}else{var appRoot=require('app-root-path');var error=new Error();var callerFile;var currentFile;Error.prepareStackTrace=function(err,stack){return stack;};currentFile=error.stack.shift().getFileName();while(error.stack.length){callerFile=error.stack.shift().getFileName();if(currentFile!==callerFile){var pathFromRoot=callerFile.replace(appRoot+"/","");classPath=pathFromRoot.substring(0,pathFromRoot.lastIndexOf('.')).replace(/\//g,".");break;}}}}catch(err){console.error("Error while getting caller file name: ",err);}finally{Error.prepareStackTrace=originalFunc;return classPath!=null?classPath:'default';}};var LOGGER=Symbol.for('logger');var globalRef=typeof global!=='undefined'?global:typeof self!=='undefined'?self:typeof window!='undefined'?window:{};var globalSymbols=Object.getOwnPropertySymbols(globalRef);var hasLogger=globalSymbols.indexOf(LOGGER)>-1;if(!hasLogger){var _logger=new Logger();globalRef[LOGGER]=_logger;}function newInstance(){return new Logger();}module.exports={instance:globalRef[LOGGER],newInstance:newInstance};}).call(this);}).call(this,require('_process'),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{},"/node_modules/js-logger/logger.js");},{"_process":73,"app-root-path":54,"continuation-local-storage":undefined,"fs":56,"log4js":65,"path":72}],60:[function(require,module,exports){"use strict";var layouts=require('../layouts'),consoleLog=console.log.bind(console);function consoleAppender(layout,timezoneOffset){layout=layout||layouts.colouredLayout;return function(loggingEvent){consoleLog(layout(loggingEvent,timezoneOffset));};}function configure(config){var layout;if(config.layout){layout=layouts.layout(config.layout.type,config.layout);}return consoleAppender(layout,config.timezoneOffset);}exports.appender=consoleAppender;exports.configure=configure;},{"../layouts":63}],61:[function(require,module,exports){"use strict";var levels=require("./levels");var DEFAULT_FORMAT=':remote-addr - -'+' ":method :url HTTP/:http-version"'+' :status :content-length ":referrer"'+' ":user-agent"';function getLogger(logger4js,options){if('object'==(typeof options==="undefined"?"undefined":_typeof(options))){options=options||{};}else if(options){options={format:options};}else{options={};}var thislogger=logger4js,level=levels.toLevel(options.level,levels.INFO),fmt=options.format||DEFAULT_FORMAT,nolog=options.nolog?createNoLogCondition(options.nolog):null;return function(req,res,next){if(req._logging)return next();if(nolog&&nolog.test(req.originalUrl))return next();if(thislogger.isLevelEnabled(level)||options.level==='auto'){var start=new Date(),statusCode,writeHead=res.writeHead,url=req.originalUrl;req._logging=true;res.writeHead=function(code,headers){res.writeHead=writeHead;res.writeHead(code,headers);res.__statusCode=statusCode=code;res.__headers=headers||{};if(options.level==='auto'){level=levels.INFO;if(code>=300)level=levels.WARN;if(code>=400)level=levels.ERROR;}else{level=levels.toLevel(options.level,levels.INFO);}};res.on('finish',function(){res.responseTime=new Date()-start;if(res.statusCode&&options.level==='auto'){level=levels.INFO;if(res.statusCode>=300)level=levels.WARN;if(res.statusCode>=400)level=levels.ERROR;}if(thislogger.isLevelEnabled(level)){var combined_tokens=assemble_tokens(req,res,options.tokens||[]);if(typeof fmt==='function'){var line=fmt(req,res,function(str){return format(str,combined_tokens);});if(line)thislogger.log(level,line);}else{thislogger.log(level,format(fmt,combined_tokens));}}});}next();};}function assemble_tokens(req,res,custom_tokens){var array_unique_tokens=function array_unique_tokens(array){var a=array.concat();for(var i=0;i<a.length;++i){for(var j=i+1;j<a.length;++j){if(a[i].token==a[j].token){a.splice(j--,1);}}}return a;};var default_tokens=[];default_tokens.push({token:':url',replacement:getUrl(req)});default_tokens.push({token:':protocol',replacement:req.protocol});default_tokens.push({token:':hostname',replacement:req.hostname});default_tokens.push({token:':method',replacement:req.method});default_tokens.push({token:':status',replacement:res.__statusCode||res.statusCode});default_tokens.push({token:':response-time',replacement:res.responseTime});default_tokens.push({token:':date',replacement:new Date().toUTCString()});default_tokens.push({token:':referrer',replacement:req.headers.referer||req.headers.referrer||''});default_tokens.push({token:':http-version',replacement:req.httpVersionMajor+'.'+req.httpVersionMinor});default_tokens.push({token:':remote-addr',replacement:req.headers['x-forwarded-for']||req.ip||req._remoteAddress||req.socket&&(req.socket.remoteAddress||req.socket.socket&&req.socket.socket.remoteAddress)});default_tokens.push({token:':user-agent',replacement:req.headers['user-agent']});default_tokens.push({token:':content-length',replacement:res._headers&&res._headers['content-length']||res.__headers&&res.__headers['Content-Length']||'-'});default_tokens.push({token:/:req\[([^\]]+)\]/g,replacement:function replacement(_,field){return req.headers[field.toLowerCase()];}});default_tokens.push({token:/:res\[([^\]]+)\]/g,replacement:function replacement(_,field){return res._headers?res._headers[field.toLowerCase()]||res.__headers[field]:res.__headers&&res.__headers[field];}});return array_unique_tokens(custom_tokens.concat(default_tokens));}function getUrl(req){return req.originalUrl||req.url;}function format(str,tokens){for(var i=0;i<tokens.length;i++){str=str.replace(tokens[i].token,tokens[i].replacement);}return str;}function createNoLogCondition(nolog){var regexp=null;if(nolog){if(nolog instanceof RegExp){regexp=nolog;}if(typeof nolog==='string'){regexp=new RegExp(nolog);}if(Array.isArray(nolog)){var regexpsAsStrings=nolog.map(function convertToStrings(o){return o.source?o.source:o;});regexp=new RegExp(regexpsAsStrings.join('|'));}}return regexp;}exports.connectLogger=getLogger;},{"./levels":64}],62:[function(require,module,exports){"use strict";exports.ISO8601_FORMAT="yyyy-MM-dd hh:mm:ss.SSS";exports.ISO8601_WITH_TZ_OFFSET_FORMAT="yyyy-MM-ddThh:mm:ssO";exports.DATETIME_FORMAT="dd MM yyyy hh:mm:ss.SSS";exports.ABSOLUTETIME_FORMAT="hh:mm:ss.SSS";function padWithZeros(vNumber,width){var numAsString=vNumber+"";while(numAsString.length<width){numAsString="0"+numAsString;}return numAsString;}function addZero(vNumber){return padWithZeros(vNumber,2);}function offset(timezoneOffset){var os=Math.abs(timezoneOffset);var h=String(Math.floor(os/60));var m=String(os%60);if(h.length==1){h="0"+h;}if(m.length==1){m="0"+m;}return timezoneOffset<0?"+"+h+m:"-"+h+m;}exports.asString=function(date,timezoneOffset){var format=exports.ISO8601_FORMAT;if(typeof date==="string"){format=arguments[0];date=arguments[1];timezoneOffset=arguments[2];}if(timezoneOffset===undefined){timezoneOffset=date.getTimezoneOffset();}date.setUTCMinutes(date.getUTCMinutes()-timezoneOffset);var vDay=addZero(date.getUTCDate());var vMonth=addZero(date.getUTCMonth()+1);var vYearLong=addZero(date.getUTCFullYear());var vYearShort=addZero(date.getUTCFullYear().toString().substring(2,4));var vYear=format.indexOf("yyyy")>-1?vYearLong:vYearShort;var vHour=addZero(date.getUTCHours());var vMinute=addZero(date.getUTCMinutes());var vSecond=addZero(date.getUTCSeconds());var vMillisecond=padWithZeros(date.getUTCMilliseconds(),3);var vTimeZone=offset(timezoneOffset);date.setUTCMinutes(date.getUTCMinutes()+timezoneOffset);var formatted=format.replace(/dd/g,vDay).replace(/MM/g,vMonth).replace(/y{1,4}/g,vYear).replace(/hh/g,vHour).replace(/mm/g,vMinute).replace(/ss/g,vSecond).replace(/SSS/g,vMillisecond).replace(/O/g,vTimeZone);return formatted;};},{}],63:[function(require,module,exports){(function(process){(function(){"use strict";var dateFormat=require('./date_format'),os=require('os'),eol=os.EOL||'\n',util=require('util'),semver=require('semver'),replacementRegExp=/%[sdj]/g,layoutMakers={"messagePassThrough":function messagePassThrough(){return messagePassThroughLayout;},"basic":function basic(){return basicLayout;},"colored":function colored(){return colouredLayout;},"coloured":function coloured(){return colouredLayout;},"pattern":function pattern(config){return patternLayout(config&&config.pattern,config&&config.tokens);},"dummy":function dummy(){return dummyLayout;}},colours={ALL:"grey",TRACE:"blue",DEBUG:"cyan",INFO:"green",WARN:"yellow",ERROR:"red",FATAL:"magenta",OFF:"grey"};function wrapErrorsWithInspect(items){return items.map(function(item){if(item instanceof Error&&item.stack){return{inspect:function inspect(){if(semver.satisfies(process.version,'>=6')){return util.format(item);}else{return util.format(item)+'\n'+item.stack;}}};}else{return item;}});}function formatLogData(logData){var data=Array.isArray(logData)?logData:Array.prototype.slice.call(arguments);return util.format.apply(util,wrapErrorsWithInspect(data));}var styles={'bold':[1,22],'italic':[3,23],'underline':[4,24],'inverse':[7,27],'white':[37,39],'grey':[90,39],'black':[90,39],'blue':[34,39],'cyan':[36,39],'green':[32,39],'magenta':[35,39],'red':[31,39],'yellow':[33,39]};function colorizeStart(style){return style?'\x1B['+styles[style][0]+'m':'';}function colorizeEnd(style){return style?'\x1B['+styles[style][1]+'m':'';}function colorize(str,style){return colorizeStart(style)+str+colorizeEnd(style);}function timestampLevelAndCategory(loggingEvent,colour,timezoneOffest){var output=colorize(formatLogData('[%s] [%s] %s - ',dateFormat.asString(loggingEvent.startTime,timezoneOffest),loggingEvent.level,loggingEvent.categoryName),colour);return output;}function basicLayout(loggingEvent,timezoneOffset){return timestampLevelAndCategory(loggingEvent,undefined,timezoneOffset)+formatLogData(loggingEvent.data);}function colouredLayout(loggingEvent,timezoneOffset){return timestampLevelAndCategory(loggingEvent,colours[loggingEvent.level.toString()],timezoneOffset)+formatLogData(loggingEvent.data);}function messagePassThroughLayout(loggingEvent){return formatLogData(loggingEvent.data);}function dummyLayout(loggingEvent){return loggingEvent.data[0];}function patternLayout(pattern,tokens,timezoneOffset){var TTCC_CONVERSION_PATTERN="%r %p %c - %m%n";var regex=/%(-?[0-9]+)?(\.?[0-9]+)?([\[\]cdhmnprzxy%])(\{([^\}]+)\})?|([^%]+)/;pattern=pattern||TTCC_CONVERSION_PATTERN;function categoryName(loggingEvent,specifier){var loggerName=loggingEvent.categoryName;if(specifier){var precision=parseInt(specifier,10);var loggerNameBits=loggerName.split(".");if(precision<loggerNameBits.length){loggerName=loggerNameBits.slice(loggerNameBits.length-precision).join(".");}}return loggerName;}function formatAsDate(loggingEvent,specifier){var format=dateFormat.ISO8601_FORMAT;if(specifier){format=specifier;if(format=="ISO8601"){format=dateFormat.ISO8601_FORMAT;}else if(format=="ISO8601_WITH_TZ_OFFSET"){format=dateFormat.ISO8601_WITH_TZ_OFFSET_FORMAT;}else if(format=="ABSOLUTE"){format=dateFormat.ABSOLUTETIME_FORMAT;}else if(format=="DATE"){format=dateFormat.DATETIME_FORMAT;}}return dateFormat.asString(format,loggingEvent.startTime,timezoneOffset);}function hostname(){return os.hostname().toString();}function formatMessage(loggingEvent){return formatLogData(loggingEvent.data);}function endOfLine(){return eol;}function logLevel(loggingEvent){return loggingEvent.level.toString();}function startTime(loggingEvent){return dateFormat.asString('hh:mm:ss',loggingEvent.startTime,timezoneOffset);}function startColour(loggingEvent){return colorizeStart(colours[loggingEvent.level.toString()]);}function endColour(loggingEvent){return colorizeEnd(colours[loggingEvent.level.toString()]);}function percent(){return'%';}function pid(loggingEvent){if(loggingEvent&&loggingEvent.pid){return loggingEvent.pid;}else{return process.pid;}}function clusterInfo(loggingEvent,specifier){if(loggingEvent.cluster&&specifier){return specifier.replace('%m',loggingEvent.cluster.master).replace('%w',loggingEvent.cluster.worker).replace('%i',loggingEvent.cluster.workerId);}else if(loggingEvent.cluster){return loggingEvent.cluster.worker+'@'+loggingEvent.cluster.master;}else{return pid();}}function userDefined(loggingEvent,specifier){if(typeof tokens[specifier]!=='undefined'){if(typeof tokens[specifier]==='function'){return tokens[specifier](loggingEvent);}else{return tokens[specifier];}}return null;}var replacers={'c':categoryName,'d':formatAsDate,'h':hostname,'m':formatMessage,'n':endOfLine,'p':logLevel,'r':startTime,'[':startColour,']':endColour,'y':clusterInfo,'z':pid,'%':percent,'x':userDefined};function replaceToken(conversionCharacter,loggingEvent,specifier){return replacers[conversionCharacter](loggingEvent,specifier);}function truncate(truncation,toTruncate){var len;if(truncation){len=parseInt(truncation.substr(1),10);return toTruncate.substring(0,len);}return toTruncate;}function pad(padding,toPad){var len;if(padding){if(padding.charAt(0)=="-"){len=parseInt(padding.substr(1),10);while(toPad.length<len){toPad+=" ";}}else{len=parseInt(padding,10);while(toPad.length<len){toPad=" "+toPad;}}}return toPad;}function truncateAndPad(toTruncAndPad,truncation,padding){var replacement=toTruncAndPad;replacement=truncate(truncation,replacement);replacement=pad(padding,replacement);return replacement;}return function(loggingEvent){var formattedString="";var result;var searchString=pattern;while(result=regex.exec(searchString)){var matchedString=result[0];var padding=result[1];var truncation=result[2];var conversionCharacter=result[3];var specifier=result[5];var text=result[6];if(text){formattedString+=""+text;}else{var replacement=replaceToken(conversionCharacter,loggingEvent,specifier);formattedString+=truncateAndPad(replacement,truncation,padding);}searchString=searchString.substr(result.index+result[0].length);}return formattedString;};}module.exports={basicLayout:basicLayout,messagePassThroughLayout:messagePassThroughLayout,patternLayout:patternLayout,colouredLayout:colouredLayout,coloredLayout:colouredLayout,dummyLayout:dummyLayout,addLayout:function addLayout(name,serializerGenerator){layoutMakers[name]=serializerGenerator;},layout:function layout(name,config){return layoutMakers[name]&&layoutMakers[name](config);}};}).call(this);}).call(this,require('_process'));},{"./date_format":62,"_process":73,"os":55,"semver":67,"util":76}],64:[function(require,module,exports){"use strict";function Level(level,levelStr){this.level=level;this.levelStr=levelStr;}function toLevel(sArg,defaultLevel){if(!sArg){return defaultLevel;}if(sArg instanceof Level){module.exports[sArg.toString()]=sArg;return sArg;}if(typeof sArg==="string"){return module.exports[sArg.toUpperCase()]||defaultLevel;}return toLevel(sArg.toString());}Level.prototype.toString=function(){return this.levelStr;};Level.prototype.isLessThanOrEqualTo=function(otherLevel){if(typeof otherLevel==="string"){otherLevel=toLevel(otherLevel);}return this.level<=otherLevel.level;};Level.prototype.isGreaterThanOrEqualTo=function(otherLevel){if(typeof otherLevel==="string"){otherLevel=toLevel(otherLevel);}return this.level>=otherLevel.level;};Level.prototype.isEqualTo=function(otherLevel){if(typeof otherLevel==="string"){otherLevel=toLevel(otherLevel);}return this.level===otherLevel.level;};module.exports={ALL:new Level(Number.MIN_VALUE,"ALL"),TRACE:new Level(5000,"TRACE"),DEBUG:new Level(10000,"DEBUG"),INFO:new Level(20000,"INFO"),WARN:new Level(30000,"WARN"),ERROR:new Level(40000,"ERROR"),FATAL:new Level(50000,"FATAL"),MARK:new Level(9007199254740992,"MARK"),OFF:new Level(Number.MAX_VALUE,"OFF"),toLevel:toLevel,Level:Level};},{}],65:[function(require,module,exports){(function(process){(function(){"use strict";var events=require('events'),fs=require('fs'),path=require('path'),util=require('util'),layouts=require('./layouts'),levels=require('./levels'),loggerModule=require('./logger'),LoggingEvent=loggerModule.LoggingEvent,Logger=loggerModule.Logger,ALL_CATEGORIES='[all]',appenders={},loggers={},appenderMakers={},appenderShutdowns={},defaultConfig={appenders:[{type:"console"}],replaceConsole:false};require('./appenders/console');function hasLogger(logger){return loggers.hasOwnProperty(logger);}levels.forName=function(levelStr,levelVal){var level;if(typeof levelStr==="string"&&typeof levelVal==="number"){var levelUpper=levelStr.toUpperCase();level=new levels.Level(levelVal,levelUpper);loggerModule.addLevelMethods(level);}return level;};levels.getLevel=function(levelStr){var level;if(typeof levelStr==="string"){var levelUpper=levelStr.toUpperCase();level=levels.toLevel(levelStr);}return level;};function getBufferedLogger(categoryName){var base_logger=getLogger(categoryName);var logger={};logger.temp=[];logger.target=base_logger;logger.flush=function(){for(var i=0;i<logger.temp.length;i++){var log=logger.temp[i];logger.target[log.level](log.message);delete logger.temp[i];}};logger.trace=function(message){logger.temp.push({level:'trace',message:message});};logger.debug=function(message){logger.temp.push({level:'debug',message:message});};logger.info=function(message){logger.temp.push({level:'info',message:message});};logger.warn=function(message){logger.temp.push({level:'warn',message:message});};logger.error=function(message){logger.temp.push({level:'error',message:message});};logger.fatal=function(message){logger.temp.push({level:'fatal',message:message});};return logger;}function normalizeCategory(category){return category+'.';}function doesLevelEntryContainsLogger(levelCategory,loggerCategory){var normalizedLevelCategory=normalizeCategory(levelCategory);var normalizedLoggerCategory=normalizeCategory(loggerCategory);return normalizedLoggerCategory.substring(0,normalizedLevelCategory.length)==normalizedLevelCategory;}function doesAppenderContainsLogger(appenderCategory,loggerCategory){var normalizedAppenderCategory=normalizeCategory(appenderCategory);var normalizedLoggerCategory=normalizeCategory(loggerCategory);return normalizedLoggerCategory.substring(0,normalizedAppenderCategory.length)==normalizedAppenderCategory;}function getLogger(loggerCategoryName){if(typeof loggerCategoryName!=="string"){loggerCategoryName=Logger.DEFAULT_CATEGORY;}if(!hasLogger(loggerCategoryName)){var level;if(levels.config){var keys=Object.keys(levels.config).sort();for(var idx=0;idx<keys.length;idx++){var levelCategory=keys[idx];if(doesLevelEntryContainsLogger(levelCategory,loggerCategoryName)){level=levels.config[levelCategory];}}}loggers[loggerCategoryName]=new Logger(loggerCategoryName,level);var appenderList;for(var appenderCategory in appenders){if(doesAppenderContainsLogger(appenderCategory,loggerCategoryName)){appenderList=appenders[appenderCategory];appenderList.forEach(function(appender){loggers[loggerCategoryName].addListener("log",appender);});}}if(appenders[ALL_CATEGORIES]){appenderList=appenders[ALL_CATEGORIES];appenderList.forEach(function(appender){loggers[loggerCategoryName].addListener("log",appender);});}}return loggers[loggerCategoryName];}function addAppender(){var args=Array.prototype.slice.call(arguments);var appender=args.shift();if(args.length===0||args[0]===undefined){args=[ALL_CATEGORIES];}if(Array.isArray(args[0])){args=args[0];}args.forEach(function(appenderCategory){addAppenderToCategory(appender,appenderCategory);if(appenderCategory===ALL_CATEGORIES){addAppenderToAllLoggers(appender);}else{for(var loggerCategory in loggers){if(doesAppenderContainsLogger(appenderCategory,loggerCategory)){loggers[loggerCategory].addListener("log",appender);}}}});}function addAppenderToAllLoggers(appender){for(var logger in loggers){if(hasLogger(logger)){loggers[logger].addListener("log",appender);}}}function addAppenderToCategory(appender,category){if(!appenders[category]){appenders[category]=[];}appenders[category].push(appender);}function clearAppenders(){appenders={};for(var logger in loggers){if(hasLogger(logger)){loggers[logger].removeAllListeners("log");}}}function configureAppenders(appenderList,options){clearAppenders();if(appenderList){appenderList.forEach(function(appenderConfig){loadAppender(appenderConfig.type);var appender;appenderConfig.makers=appenderMakers;try{appender=appenderMakers[appenderConfig.type](appenderConfig,options);addAppender(appender,appenderConfig.category);}catch(e){throw new Error("log4js configuration problem for "+util.inspect(appenderConfig),e);}});}}function configureLevels(_levels){levels.config=_levels;if(_levels){var keys=Object.keys(levels.config).sort();for(var idx in keys){var category=keys[idx];if(category===ALL_CATEGORIES){setGlobalLogLevel(_levels[category]);}for(var loggerCategory in loggers){if(doesLevelEntryContainsLogger(category,loggerCategory)){loggers[loggerCategory].setLevel(_levels[category]);}}}}}function setGlobalLogLevel(level){Logger.prototype.level=levels.toLevel(level,levels.TRACE);}function getDefaultLogger(){return getLogger(Logger.DEFAULT_CATEGORY);}var configState={};function loadConfigurationFile(filename){if(filename){return JSON.parse(fs.readFileSync(filename,"utf8"));}return undefined;}function configureOnceOff(config,options){if(config){try{configureLevels(config.levels);configureAppenders(config.appenders,options);if(config.replaceConsole){replaceConsole();}else{restoreConsole();}}catch(e){throw new Error("Problem reading log4js config "+util.inspect(config)+". Error was \""+e.message+"\" ("+e.stack+")");}}}function reloadConfiguration(options){var mtime=getMTime(configState.filename);if(!mtime)return;if(configState.lastMTime&&mtime.getTime()>configState.lastMTime.getTime()){configureOnceOff(loadConfigurationFile(configState.filename),options);}configState.lastMTime=mtime;}function getMTime(filename){var mtime;try{mtime=fs.statSync(configState.filename).mtime;}catch(e){getLogger('log4js').warn('Failed to load configuration file '+filename);}return mtime;}function initReloadConfiguration(filename,options){if(configState.timerId){clearInterval(configState.timerId);delete configState.timerId;}configState.filename=filename;configState.lastMTime=getMTime(filename);configState.timerId=setInterval(reloadConfiguration,options.reloadSecs*1000,options);}function configure(configurationFileOrObject,options){var config=configurationFileOrObject;config=config||process.env.LOG4JS_CONFIG;options=options||{};if(config===undefined||config===null||typeof config==='string'){if(options.reloadSecs){initReloadConfiguration(config,options);}config=loadConfigurationFile(config)||defaultConfig;}else{if(options.reloadSecs){getLogger('log4js').warn('Ignoring configuration reload parameter for "object" configuration.');}}configureOnceOff(config,options);}var originalConsoleFunctions={log:console.log,debug:console.debug,info:console.info,warn:console.warn,error:console.error};function replaceConsole(logger){function replaceWith(fn){return function(){fn.apply(logger,arguments);};}logger=logger||getLogger("console");['log','debug','info','warn','error'].forEach(function(item){console[item]=replaceWith(item==='log'?logger.info:logger[item]);});}function restoreConsole(){['log','debug','info','warn','error'].forEach(function(item){console[item]=originalConsoleFunctions[item];});}function requireAppender(appender){var appenderModule;try{appenderModule=require('./appenders/'+appender);}catch(e){appenderModule=require(appender);}return appenderModule;}function loadAppender(appender,appenderModule){appenderModule=appenderModule||requireAppender(appender);if(!appenderModule){throw new Error("Invalid log4js appender: "+util.inspect(appender));}module.exports.appenders[appender]=appenderModule.appender.bind(appenderModule);if(appenderModule.shutdown){appenderShutdowns[appender]=appenderModule.shutdown.bind(appenderModule);}appenderMakers[appender]=appenderModule.configure.bind(appenderModule);}function shutdown(cb){loggerModule.disableAllLogWrites();var completed=0;var error;var shutdownFcts=[];var complete=function complete(err){error=error||err;completed++;if(completed>=shutdownFcts.length){cb(error);}};for(var category in appenderShutdowns){if(appenderShutdowns.hasOwnProperty(category)){shutdownFcts.push(appenderShutdowns[category]);}}if(!shutdownFcts.length){return cb();}shutdownFcts.forEach(function(shutdownFct){shutdownFct(complete);});}module.exports={getBufferedLogger:getBufferedLogger,getLogger:getLogger,getDefaultLogger:getDefaultLogger,hasLogger:hasLogger,addAppender:addAppender,loadAppender:loadAppender,clearAppenders:clearAppenders,configure:configure,shutdown:shutdown,replaceConsole:replaceConsole,restoreConsole:restoreConsole,levels:levels,setGlobalLogLevel:setGlobalLogLevel,layouts:layouts,appenders:{},appenderMakers:appenderMakers,connectLogger:require('./connect-logger').connectLogger};configure();}).call(this);}).call(this,require('_process'));},{"./appenders/console":60,"./connect-logger":61,"./layouts":63,"./levels":64,"./logger":66,"_process":73,"events":57,"fs":56,"path":72,"util":76}],66:[function(require,module,exports){"use strict";var levels=require('./levels'),util=require('util'),events=require('events'),DEFAULT_CATEGORY='[default]';var logWritesEnabled=true;function LoggingEvent(categoryName,level,data,logger){this.startTime=new Date();this.categoryName=categoryName;this.data=data;this.level=level;this.logger=logger;}function Logger(name,level){this.category=name||DEFAULT_CATEGORY;if(level){this.setLevel(level);}}util.inherits(Logger,events.EventEmitter);Logger.DEFAULT_CATEGORY=DEFAULT_CATEGORY;Logger.prototype.level=levels.TRACE;Logger.prototype.setLevel=function(level){this.level=levels.toLevel(level,this.level||levels.TRACE);};Logger.prototype.removeLevel=function(){delete this.level;};Logger.prototype.log=function(){var logLevel=levels.toLevel(arguments[0],levels.INFO);if(!this.isLevelEnabled(logLevel)){return;}var numArgs=arguments.length-1;var args=new Array(numArgs);for(var i=0;i<numArgs;i++){args[i]=arguments[i+1];}this._log(logLevel,args);};Logger.prototype.isLevelEnabled=function(otherLevel){return this.level.isLessThanOrEqualTo(otherLevel);};['Trace','Debug','Info','Warn','Error','Fatal','Mark'].forEach(function(levelString){addLevelMethods(levelString);});function addLevelMethods(level){level=levels.toLevel(level);var levelStrLower=level.toString().toLowerCase();var levelMethod=levelStrLower.replace(/_([a-z])/g,function(g){return g[1].toUpperCase();});var isLevelMethod=levelMethod[0].toUpperCase()+levelMethod.slice(1);Logger.prototype['is'+isLevelMethod+'Enabled']=function(){return this.isLevelEnabled(level.toString());};Logger.prototype[levelMethod]=function(){if(logWritesEnabled&&this.isLevelEnabled(level)){var numArgs=arguments.length;var args=new Array(numArgs);for(var i=0;i<numArgs;i++){args[i]=arguments[i];}this._log(level,args);}};}Logger.prototype._log=function(level,data){var loggingEvent=new LoggingEvent(this.category,level,data,this);this.emit('log',loggingEvent);};function disableAllLogWrites(){logWritesEnabled=false;}function enableAllLogWrites(){logWritesEnabled=true;}exports.LoggingEvent=LoggingEvent;exports.Logger=Logger;exports.disableAllLogWrites=disableAllLogWrites;exports.enableAllLogWrites=enableAllLogWrites;exports.addLevelMethods=addLevelMethods;},{"./levels":64,"events":57,"util":76}],67:[function(require,module,exports){;(function(exports){if((typeof module==="undefined"?"undefined":_typeof(module))==='object'&&module.exports===exports)exports=module.exports=SemVer;exports.SEMVER_SPEC_VERSION='2.0.0';var MAX_LENGTH=256;var MAX_SAFE_INTEGER=Number.MAX_SAFE_INTEGER||9007199254740991;var re=exports.re=[];var src=exports.src=[];var R=0;var NUMERICIDENTIFIER=R++;src[NUMERICIDENTIFIER]='0|[1-9]\\d*';var NUMERICIDENTIFIERLOOSE=R++;src[NUMERICIDENTIFIERLOOSE]='[0-9]+';var NONNUMERICIDENTIFIER=R++;src[NONNUMERICIDENTIFIER]='\\d*[a-zA-Z-][a-zA-Z0-9-]*';var MAINVERSION=R++;src[MAINVERSION]='('+src[NUMERICIDENTIFIER]+')\\.'+'('+src[NUMERICIDENTIFIER]+')\\.'+'('+src[NUMERICIDENTIFIER]+')';var MAINVERSIONLOOSE=R++;src[MAINVERSIONLOOSE]='('+src[NUMERICIDENTIFIERLOOSE]+')\\.'+'('+src[NUMERICIDENTIFIERLOOSE]+')\\.'+'('+src[NUMERICIDENTIFIERLOOSE]+')';var PRERELEASEIDENTIFIER=R++;src[PRERELEASEIDENTIFIER]='(?:'+src[NUMERICIDENTIFIER]+'|'+src[NONNUMERICIDENTIFIER]+')';var PRERELEASEIDENTIFIERLOOSE=R++;src[PRERELEASEIDENTIFIERLOOSE]='(?:'+src[NUMERICIDENTIFIERLOOSE]+'|'+src[NONNUMERICIDENTIFIER]+')';var PRERELEASE=R++;src[PRERELEASE]='(?:-('+src[PRERELEASEIDENTIFIER]+'(?:\\.'+src[PRERELEASEIDENTIFIER]+')*))';var PRERELEASELOOSE=R++;src[PRERELEASELOOSE]='(?:-?('+src[PRERELEASEIDENTIFIERLOOSE]+'(?:\\.'+src[PRERELEASEIDENTIFIERLOOSE]+')*))';var BUILDIDENTIFIER=R++;src[BUILDIDENTIFIER]='[0-9A-Za-z-]+';var BUILD=R++;src[BUILD]='(?:\\+('+src[BUILDIDENTIFIER]+'(?:\\.'+src[BUILDIDENTIFIER]+')*))';var FULL=R++;var FULLPLAIN='v?'+src[MAINVERSION]+src[PRERELEASE]+'?'+src[BUILD]+'?';src[FULL]='^'+FULLPLAIN+'$';var LOOSEPLAIN='[v=\\s]*'+src[MAINVERSIONLOOSE]+src[PRERELEASELOOSE]+'?'+src[BUILD]+'?';var LOOSE=R++;src[LOOSE]='^'+LOOSEPLAIN+'$';var GTLT=R++;src[GTLT]='((?:<|>)?=?)';var XRANGEIDENTIFIERLOOSE=R++;src[XRANGEIDENTIFIERLOOSE]=src[NUMERICIDENTIFIERLOOSE]+'|x|X|\\*';var XRANGEIDENTIFIER=R++;src[XRANGEIDENTIFIER]=src[NUMERICIDENTIFIER]+'|x|X|\\*';var XRANGEPLAIN=R++;src[XRANGEPLAIN]='[v=\\s]*('+src[XRANGEIDENTIFIER]+')'+'(?:\\.('+src[XRANGEIDENTIFIER]+')'+'(?:\\.('+src[XRANGEIDENTIFIER]+')'+'(?:'+src[PRERELEASE]+')?'+src[BUILD]+'?'+')?)?';var XRANGEPLAINLOOSE=R++;src[XRANGEPLAINLOOSE]='[v=\\s]*('+src[XRANGEIDENTIFIERLOOSE]+')'+'(?:\\.('+src[XRANGEIDENTIFIERLOOSE]+')'+'(?:\\.('+src[XRANGEIDENTIFIERLOOSE]+')'+'(?:'+src[PRERELEASELOOSE]+')?'+src[BUILD]+'?'+')?)?';var XRANGE=R++;src[XRANGE]='^'+src[GTLT]+'\\s*'+src[XRANGEPLAIN]+'$';var XRANGELOOSE=R++;src[XRANGELOOSE]='^'+src[GTLT]+'\\s*'+src[XRANGEPLAINLOOSE]+'$';var LONETILDE=R++;src[LONETILDE]='(?:~>?)';var TILDETRIM=R++;src[TILDETRIM]='(\\s*)'+src[LONETILDE]+'\\s+';re[TILDETRIM]=new RegExp(src[TILDETRIM],'g');var tildeTrimReplace='$1~';var TILDE=R++;src[TILDE]='^'+src[LONETILDE]+src[XRANGEPLAIN]+'$';var TILDELOOSE=R++;src[TILDELOOSE]='^'+src[LONETILDE]+src[XRANGEPLAINLOOSE]+'$';var LONECARET=R++;src[LONECARET]='(?:\\^)';var CARETTRIM=R++;src[CARETTRIM]='(\\s*)'+src[LONECARET]+'\\s+';re[CARETTRIM]=new RegExp(src[CARETTRIM],'g');var caretTrimReplace='$1^';var CARET=R++;src[CARET]='^'+src[LONECARET]+src[XRANGEPLAIN]+'$';var CARETLOOSE=R++;src[CARETLOOSE]='^'+src[LONECARET]+src[XRANGEPLAINLOOSE]+'$';var COMPARATORLOOSE=R++;src[COMPARATORLOOSE]='^'+src[GTLT]+'\\s*('+LOOSEPLAIN+')$|^$';var COMPARATOR=R++;src[COMPARATOR]='^'+src[GTLT]+'\\s*('+FULLPLAIN+')$|^$';var COMPARATORTRIM=R++;src[COMPARATORTRIM]='(\\s*)'+src[GTLT]+'\\s*('+LOOSEPLAIN+'|'+src[XRANGEPLAIN]+')';re[COMPARATORTRIM]=new RegExp(src[COMPARATORTRIM],'g');var comparatorTrimReplace='$1$2$3';var HYPHENRANGE=R++;src[HYPHENRANGE]='^\\s*('+src[XRANGEPLAIN]+')'+'\\s+-\\s+'+'('+src[XRANGEPLAIN]+')'+'\\s*$';var HYPHENRANGELOOSE=R++;src[HYPHENRANGELOOSE]='^\\s*('+src[XRANGEPLAINLOOSE]+')'+'\\s+-\\s+'+'('+src[XRANGEPLAINLOOSE]+')'+'\\s*$';var STAR=R++;src[STAR]='(<|>)?=?\\s*\\*';for(var i=0;i<R;i++){;if(!re[i])re[i]=new RegExp(src[i]);}exports.parse=parse;function parse(version,loose){if(version instanceof SemVer)return version;if(typeof version!=='string')return null;if(version.length>MAX_LENGTH)return null;var r=loose?re[LOOSE]:re[FULL];if(!r.test(version))return null;try{return new SemVer(version,loose);}catch(er){return null;}}exports.valid=valid;function valid(version,loose){var v=parse(version,loose);return v?v.version:null;}exports.clean=clean;function clean(version,loose){var s=parse(version.trim().replace(/^[=v]+/,''),loose);return s?s.version:null;}exports.SemVer=SemVer;function SemVer(version,loose){if(version instanceof SemVer){if(version.loose===loose)return version;else version=version.version;}else if(typeof version!=='string'){throw new TypeError('Invalid Version: '+version);}if(version.length>MAX_LENGTH)throw new TypeError('version is longer than '+MAX_LENGTH+' characters');if(!(this instanceof SemVer))return new SemVer(version,loose);;this.loose=loose;var m=version.trim().match(loose?re[LOOSE]:re[FULL]);if(!m)throw new TypeError('Invalid Version: '+version);this.raw=version;this.major=+m[1];this.minor=+m[2];this.patch=+m[3];if(this.major>MAX_SAFE_INTEGER||this.major<0)throw new TypeError('Invalid major version');if(this.minor>MAX_SAFE_INTEGER||this.minor<0)throw new TypeError('Invalid minor version');if(this.patch>MAX_SAFE_INTEGER||this.patch<0)throw new TypeError('Invalid patch version');if(!m[4])this.prerelease=[];else this.prerelease=m[4].split('.').map(function(id){if(/^[0-9]+$/.test(id)){var num=+id;if(num>=0&&num<MAX_SAFE_INTEGER)return num;}return id;});this.build=m[5]?m[5].split('.'):[];this.format();}SemVer.prototype.format=function(){this.version=this.major+'.'+this.minor+'.'+this.patch;if(this.prerelease.length)this.version+='-'+this.prerelease.join('.');return this.version;};SemVer.prototype.inspect=function(){return'<SemVer "'+this+'">';};SemVer.prototype.toString=function(){return this.version;};SemVer.prototype.compare=function(other){;if(!(other instanceof SemVer))other=new SemVer(other,this.loose);return this.compareMain(other)||this.comparePre(other);};SemVer.prototype.compareMain=function(other){if(!(other instanceof SemVer))other=new SemVer(other,this.loose);return compareIdentifiers(this.major,other.major)||compareIdentifiers(this.minor,other.minor)||compareIdentifiers(this.patch,other.patch);};SemVer.prototype.comparePre=function(other){if(!(other instanceof SemVer))other=new SemVer(other,this.loose);if(this.prerelease.length&&!other.prerelease.length)return-1;else if(!this.prerelease.length&&other.prerelease.length)return 1;else if(!this.prerelease.length&&!other.prerelease.length)return 0;var i=0;do{var a=this.prerelease[i];var b=other.prerelease[i];;if(a===undefined&&b===undefined)return 0;else if(b===undefined)return 1;else if(a===undefined)return-1;else if(a===b)continue;else return compareIdentifiers(a,b);}while(++i);};SemVer.prototype.inc=function(release,identifier){switch(release){case'premajor':this.prerelease.length=0;this.patch=0;this.minor=0;this.major++;this.inc('pre',identifier);break;case'preminor':this.prerelease.length=0;this.patch=0;this.minor++;this.inc('pre',identifier);break;case'prepatch':this.prerelease.length=0;this.inc('patch',identifier);this.inc('pre',identifier);break;case'prerelease':if(this.prerelease.length===0)this.inc('patch',identifier);this.inc('pre',identifier);break;case'major':if(this.minor!==0||this.patch!==0||this.prerelease.length===0)this.major++;this.minor=0;this.patch=0;this.prerelease=[];break;case'minor':if(this.patch!==0||this.prerelease.length===0)this.minor++;this.patch=0;this.prerelease=[];break;case'patch':if(this.prerelease.length===0)this.patch++;this.prerelease=[];break;case'pre':if(this.prerelease.length===0)this.prerelease=[0];else{var i=this.prerelease.length;while(--i>=0){if(typeof this.prerelease[i]==='number'){this.prerelease[i]++;i=-2;}}if(i===-1)this.prerelease.push(0);}if(identifier){if(this.prerelease[0]===identifier){if(isNaN(this.prerelease[1]))this.prerelease=[identifier,0];}else this.prerelease=[identifier,0];}break;default:throw new Error('invalid increment argument: '+release);}this.format();return this;};exports.inc=inc;function inc(version,release,loose,identifier){if(typeof loose==='string'){identifier=loose;loose=undefined;}try{return new SemVer(version,loose).inc(release,identifier).version;}catch(er){return null;}}exports.diff=diff;function diff(version1,version2){if(eq(version1,version2)){return null;}else{var v1=parse(version1);var v2=parse(version2);if(v1.prerelease.length||v2.prerelease.length){for(var key in v1){if(key==='major'||key==='minor'||key==='patch'){if(v1[key]!==v2[key]){return'pre'+key;}}}return'prerelease';}for(var key in v1){if(key==='major'||key==='minor'||key==='patch'){if(v1[key]!==v2[key]){return key;}}}}}exports.compareIdentifiers=compareIdentifiers;var numeric=/^[0-9]+$/;function compareIdentifiers(a,b){var anum=numeric.test(a);var bnum=numeric.test(b);if(anum&&bnum){a=+a;b=+b;}return anum&&!bnum?-1:bnum&&!anum?1:a<b?-1:a>b?1:0;}exports.rcompareIdentifiers=rcompareIdentifiers;function rcompareIdentifiers(a,b){return compareIdentifiers(b,a);}exports.major=major;function major(a,loose){return new SemVer(a,loose).major;}exports.minor=minor;function minor(a,loose){return new SemVer(a,loose).minor;}exports.patch=patch;function patch(a,loose){return new SemVer(a,loose).patch;}exports.compare=compare;function compare(a,b,loose){return new SemVer(a,loose).compare(b);}exports.compareLoose=compareLoose;function compareLoose(a,b){return compare(a,b,true);}exports.rcompare=rcompare;function rcompare(a,b,loose){return compare(b,a,loose);}exports.sort=sort;function sort(list,loose){return list.sort(function(a,b){return exports.compare(a,b,loose);});}exports.rsort=rsort;function rsort(list,loose){return list.sort(function(a,b){return exports.rcompare(a,b,loose);});}exports.gt=gt;function gt(a,b,loose){return compare(a,b,loose)>0;}exports.lt=lt;function lt(a,b,loose){return compare(a,b,loose)<0;}exports.eq=eq;function eq(a,b,loose){return compare(a,b,loose)===0;}exports.neq=neq;function neq(a,b,loose){return compare(a,b,loose)!==0;}exports.gte=gte;function gte(a,b,loose){return compare(a,b,loose)>=0;}exports.lte=lte;function lte(a,b,loose){return compare(a,b,loose)<=0;}exports.cmp=cmp;function cmp(a,op,b,loose){var ret;switch(op){case'===':if((typeof a==="undefined"?"undefined":_typeof(a))==='object')a=a.version;if((typeof b==="undefined"?"undefined":_typeof(b))==='object')b=b.version;ret=a===b;break;case'!==':if((typeof a==="undefined"?"undefined":_typeof(a))==='object')a=a.version;if((typeof b==="undefined"?"undefined":_typeof(b))==='object')b=b.version;ret=a!==b;break;case'':case'=':case'==':ret=eq(a,b,loose);break;case'!=':ret=neq(a,b,loose);break;case'>':ret=gt(a,b,loose);break;case'>=':ret=gte(a,b,loose);break;case'<':ret=lt(a,b,loose);break;case'<=':ret=lte(a,b,loose);break;default:throw new TypeError('Invalid operator: '+op);}return ret;}exports.Comparator=Comparator;function Comparator(comp,loose){if(comp instanceof Comparator){if(comp.loose===loose)return comp;else comp=comp.value;}if(!(this instanceof Comparator))return new Comparator(comp,loose);;this.loose=loose;this.parse(comp);if(this.semver===ANY)this.value='';else this.value=this.operator+this.semver.version;;}var ANY={};Comparator.prototype.parse=function(comp){var r=this.loose?re[COMPARATORLOOSE]:re[COMPARATOR];var m=comp.match(r);if(!m)throw new TypeError('Invalid comparator: '+comp);this.operator=m[1];if(this.operator==='=')this.operator='';if(!m[2])this.semver=ANY;else this.semver=new SemVer(m[2],this.loose);};Comparator.prototype.inspect=function(){return'<SemVer Comparator "'+this+'">';};Comparator.prototype.toString=function(){return this.value;};Comparator.prototype.test=function(version){;if(this.semver===ANY)return true;if(typeof version==='string')version=new SemVer(version,this.loose);return cmp(version,this.operator,this.semver,this.loose);};exports.Range=Range;function Range(range,loose){if(range instanceof Range&&range.loose===loose)return range;if(!(this instanceof Range))return new Range(range,loose);this.loose=loose;this.raw=range;this.set=range.split(/\s*\|\|\s*/).map(function(range){return this.parseRange(range.trim());},this).filter(function(c){return c.length;});if(!this.set.length){throw new TypeError('Invalid SemVer Range: '+range);}this.format();}Range.prototype.inspect=function(){return'<SemVer Range "'+this.range+'">';};Range.prototype.format=function(){this.range=this.set.map(function(comps){return comps.join(' ').trim();}).join('||').trim();return this.range;};Range.prototype.toString=function(){return this.range;};Range.prototype.parseRange=function(range){var loose=this.loose;range=range.trim();;var hr=loose?re[HYPHENRANGELOOSE]:re[HYPHENRANGE];range=range.replace(hr,hyphenReplace);;range=range.replace(re[COMPARATORTRIM],comparatorTrimReplace);;range=range.replace(re[TILDETRIM],tildeTrimReplace);range=range.replace(re[CARETTRIM],caretTrimReplace);range=range.split(/\s+/).join(' ');var compRe=loose?re[COMPARATORLOOSE]:re[COMPARATOR];var set=range.split(' ').map(function(comp){return parseComparator(comp,loose);}).join(' ').split(/\s+/);if(this.loose){set=set.filter(function(comp){return!!comp.match(compRe);});}set=set.map(function(comp){return new Comparator(comp,loose);});return set;};exports.toComparators=toComparators;function toComparators(range,loose){return new Range(range,loose).set.map(function(comp){return comp.map(function(c){return c.value;}).join(' ').trim().split(' ');});}function parseComparator(comp,loose){;comp=replaceCarets(comp,loose);;comp=replaceTildes(comp,loose);;comp=replaceXRanges(comp,loose);;comp=replaceStars(comp,loose);;return comp;}function isX(id){return!id||id.toLowerCase()==='x'||id==='*';}function replaceTildes(comp,loose){return comp.trim().split(/\s+/).map(function(comp){return replaceTilde(comp,loose);}).join(' ');}function replaceTilde(comp,loose){var r=loose?re[TILDELOOSE]:re[TILDE];return comp.replace(r,function(_,M,m,p,pr){;var ret;if(isX(M))ret='';else if(isX(m))ret='>='+M+'.0.0 <'+(+M+1)+'.0.0';else if(isX(p))ret='>='+M+'.'+m+'.0 <'+M+'.'+(+m+1)+'.0';else if(pr){;if(pr.charAt(0)!=='-')pr='-'+pr;ret='>='+M+'.'+m+'.'+p+pr+' <'+M+'.'+(+m+1)+'.0';}else ret='>='+M+'.'+m+'.'+p+' <'+M+'.'+(+m+1)+'.0';;return ret;});}function replaceCarets(comp,loose){return comp.trim().split(/\s+/).map(function(comp){return replaceCaret(comp,loose);}).join(' ');}function replaceCaret(comp,loose){;var r=loose?re[CARETLOOSE]:re[CARET];return comp.replace(r,function(_,M,m,p,pr){;var ret;if(isX(M))ret='';else if(isX(m))ret='>='+M+'.0.0 <'+(+M+1)+'.0.0';else if(isX(p)){if(M==='0')ret='>='+M+'.'+m+'.0 <'+M+'.'+(+m+1)+'.0';else ret='>='+M+'.'+m+'.0 <'+(+M+1)+'.0.0';}else if(pr){;if(pr.charAt(0)!=='-')pr='-'+pr;if(M==='0'){if(m==='0')ret='>='+M+'.'+m+'.'+p+pr+' <'+M+'.'+m+'.'+(+p+1);else ret='>='+M+'.'+m+'.'+p+pr+' <'+M+'.'+(+m+1)+'.0';}else ret='>='+M+'.'+m+'.'+p+pr+' <'+(+M+1)+'.0.0';}else{;if(M==='0'){if(m==='0')ret='>='+M+'.'+m+'.'+p+' <'+M+'.'+m+'.'+(+p+1);else ret='>='+M+'.'+m+'.'+p+' <'+M+'.'+(+m+1)+'.0';}else ret='>='+M+'.'+m+'.'+p+' <'+(+M+1)+'.0.0';};return ret;});}function replaceXRanges(comp,loose){;return comp.split(/\s+/).map(function(comp){return replaceXRange(comp,loose);}).join(' ');}function replaceXRange(comp,loose){comp=comp.trim();var r=loose?re[XRANGELOOSE]:re[XRANGE];return comp.replace(r,function(ret,gtlt,M,m,p,pr){;var xM=isX(M);var xm=xM||isX(m);var xp=xm||isX(p);var anyX=xp;if(gtlt==='='&&anyX)gtlt='';if(xM){if(gtlt==='>'||gtlt==='<'){ret='<0.0.0';}else{ret='*';}}else if(gtlt&&anyX){if(xm)m=0;if(xp)p=0;if(gtlt==='>'){gtlt='>=';if(xm){M=+M+1;m=0;p=0;}else if(xp){m=+m+1;p=0;}}else if(gtlt==='<='){gtlt='<';if(xm)M=+M+1;else m=+m+1;}ret=gtlt+M+'.'+m+'.'+p;}else if(xm){ret='>='+M+'.0.0 <'+(+M+1)+'.0.0';}else if(xp){ret='>='+M+'.'+m+'.0 <'+M+'.'+(+m+1)+'.0';};return ret;});}function replaceStars(comp,loose){;return comp.trim().replace(re[STAR],'');}function hyphenReplace($0,from,fM,fm,fp,fpr,fb,to,tM,tm,tp,tpr,tb){if(isX(fM))from='';else if(isX(fm))from='>='+fM+'.0.0';else if(isX(fp))from='>='+fM+'.'+fm+'.0';else from='>='+from;if(isX(tM))to='';else if(isX(tm))to='<'+(+tM+1)+'.0.0';else if(isX(tp))to='<'+tM+'.'+(+tm+1)+'.0';else if(tpr)to='<='+tM+'.'+tm+'.'+tp+'-'+tpr;else to='<='+to;return(from+' '+to).trim();}Range.prototype.test=function(version){if(!version)return false;if(typeof version==='string')version=new SemVer(version,this.loose);for(var i=0;i<this.set.length;i++){if(testSet(this.set[i],version))return true;}return false;};function testSet(set,version){for(var i=0;i<set.length;i++){if(!set[i].test(version))return false;}if(version.prerelease.length){for(var i=0;i<set.length;i++){;if(set[i].semver===ANY)continue;if(set[i].semver.prerelease.length>0){var allowed=set[i].semver;if(allowed.major===version.major&&allowed.minor===version.minor&&allowed.patch===version.patch)return true;}}return false;}return true;}exports.satisfies=satisfies;function satisfies(version,range,loose){try{range=new Range(range,loose);}catch(er){return false;}return range.test(version);}exports.maxSatisfying=maxSatisfying;function maxSatisfying(versions,range,loose){return versions.filter(function(version){return satisfies(version,range,loose);}).sort(function(a,b){return rcompare(a,b,loose);})[0]||null;}exports.validRange=validRange;function validRange(range,loose){try{return new Range(range,loose).range||'*';}catch(er){return null;}}exports.ltr=ltr;function ltr(version,range,loose){return outside(version,range,'<',loose);}exports.gtr=gtr;function gtr(version,range,loose){return outside(version,range,'>',loose);}exports.outside=outside;function outside(version,range,hilo,loose){version=new SemVer(version,loose);range=new Range(range,loose);var gtfn,ltefn,ltfn,comp,ecomp;switch(hilo){case'>':gtfn=gt;ltefn=lte;ltfn=lt;comp='>';ecomp='>=';break;case'<':gtfn=lt;ltefn=gte;ltfn=gt;comp='<';ecomp='<=';break;default:throw new TypeError('Must provide a hilo val of "<" or ">"');}if(satisfies(version,range,loose)){return false;}for(var i=0;i<range.set.length;++i){var comparators=range.set[i];var high=null;var low=null;comparators.forEach(function(comparator){if(comparator.semver===ANY){comparator=new Comparator('>=0.0.0');}high=high||comparator;low=low||comparator;if(gtfn(comparator.semver,high.semver,loose)){high=comparator;}else if(ltfn(comparator.semver,low.semver,loose)){low=comparator;}});if(high.operator===comp||high.operator===ecomp){return false;}if((!low.operator||low.operator===comp)&&ltefn(version,low.semver)){return false;}else if(low.operator===ecomp&&ltfn(version,low.semver)){return false;}}return true;}if(typeof define==='function'&&define.amd)define(exports);})((typeof exports==="undefined"?"undefined":_typeof(exports))==='object'?exports:typeof define==='function'&&define.amd?{}:semver={});},{}],68:[function(require,module,exports){exports.AST=require('./lib/ast');exports.parse=require('./lib/parse').parse;exports.stringify=require('./lib/stringify');},{"./lib/ast":69,"./lib/parse":70,"./lib/stringify":71}],69:[function(require,module,exports){var _parse=require('./parse').parse;var _stringify=require('./stringify');function AST(ast){this.ast=ast;}AST.prototype={parse:function parse(sql){this.ast=_parse(sql);},stringify:function stringify(){return _stringify(this.ast);},getTables:function getTables(){},getSelectedColumns:function getSelectedColumns(){}};module.exports=AST;},{"./parse":70,"./stringify":71}],70:[function(require,module,exports){"use strict";function peg$subclass(child,parent){function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();}function peg$SyntaxError(message,expected,found,location){this.message=message;this.expected=expected;this.found=found;this.location=location;this.name="SyntaxError";if(typeof Error.captureStackTrace==="function"){Error.captureStackTrace(this,peg$SyntaxError);}}peg$subclass(peg$SyntaxError,Error);peg$SyntaxError.buildMessage=function(expected,found){var DESCRIBE_EXPECTATION_FNS={literal:function literal(expectation){return"\""+literalEscape(expectation.text)+"\"";},"class":function _class(expectation){var escapedParts="",i;for(i=0;i<expectation.parts.length;i++){escapedParts+=expectation.parts[i]instanceof Array?classEscape(expectation.parts[i][0])+"-"+classEscape(expectation.parts[i][1]):classEscape(expectation.parts[i]);}return"["+(expectation.inverted?"^":"")+escapedParts+"]";},any:function any(expectation){return"any character";},end:function end(expectation){return"end of input";},other:function other(expectation){return expectation.description;}};function hex(ch){return ch.charCodeAt(0).toString(16).toUpperCase();}function literalEscape(s){return s.replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\0/g,'\\0').replace(/\t/g,'\\t').replace(/\n/g,'\\n').replace(/\r/g,'\\r').replace(/[\x00-\x0F]/g,function(ch){return'\\x0'+hex(ch);}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(ch){return'\\x'+hex(ch);});}function classEscape(s){return s.replace(/\\/g,'\\\\').replace(/\]/g,'\\]').replace(/\^/g,'\\^').replace(/-/g,'\\-').replace(/\0/g,'\\0').replace(/\t/g,'\\t').replace(/\n/g,'\\n').replace(/\r/g,'\\r').replace(/[\x00-\x0F]/g,function(ch){return'\\x0'+hex(ch);}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(ch){return'\\x'+hex(ch);});}function describeExpectation(expectation){return DESCRIBE_EXPECTATION_FNS[expectation.type](expectation);}function describeExpected(expected){var descriptions=new Array(expected.length),i,j;for(i=0;i<expected.length;i++){descriptions[i]=describeExpectation(expected[i]);}descriptions.sort();if(descriptions.length>0){for(i=1,j=1;i<descriptions.length;i++){if(descriptions[i-1]!==descriptions[i]){descriptions[j]=descriptions[i];j++;}}descriptions.length=j;}switch(descriptions.length){case 1:return descriptions[0];case 2:return descriptions[0]+" or "+descriptions[1];default:return descriptions.slice(0,-1).join(", ")+", or "+descriptions[descriptions.length-1];}}function describeFound(found){return found?"\""+literalEscape(found)+"\"":"end of input";}return"Expected "+describeExpected(expected)+" but "+describeFound(found)+" found.";};function peg$parse(input,options){options=options!==void 0?options:{};var peg$FAILED={},peg$startRuleFunctions={start:peg$parsestart},peg$startRuleFunction=peg$parsestart,peg$c0=function peg$c0(ast){ast.params=params;return ast;},peg$c1=function peg$c1(ast){return ast;},peg$c2=function peg$c2(head,tail){var cur=head;for(var i=0;i<tail.length;i++){cur._next=tail[i][3];cur=cur._next;}return head;},peg$c3="(",peg$c4=peg$literalExpectation("(",false),peg$c5=")",peg$c6=peg$literalExpectation(")",false),peg$c7=";",peg$c8=peg$literalExpectation(";",false),peg$c9=function peg$c9(tb,clist,topt,popt){return{type:'create_table',name:tb,columns:clist,tableOptions:topt,partitionOptions:popt};},peg$c10=function peg$c10(h,t){return createList(h,t);},peg$c11=function peg$c11(n,t,e){var ext=[];e.forEach(function(v){ext.push(v[1]);});return{name:n,type:t,ext:ext};},peg$c12=function peg$c12(ct){if(ct.type==='function'){var args=[];ct.args.value.forEach(function(v){args.push(v.value);});return{type:ct.name,args:args};}else{return{type:ct};}},peg$c13=function peg$c13(h,t){var res=h;t.forEach(function(v){var tmp=v[1];var keys=Object.keys(tmp);keys.forEach(function(k){res[k]=tmp[k].column;});});return res;},peg$c14="=",peg$c15=peg$literalExpectation("=",false),peg$c16=function peg$c16(k,v){var obj={};var key=k.type==='column_ref'?k.column:k.value;var value=v.type==='column_ref'?v.column:v.value;obj[key]=value;return obj;},peg$c17=function peg$c17(h,t){var res=[h];t.forEach(function(v){res.push(v);});return res;},peg$c18="key",peg$c19=peg$literalExpectation("KEY",true),peg$c20="index",peg$c21=peg$literalExpectation("INDEX",true),peg$c22=function peg$c22(f,n,l){var list=[];l.forEach(function(v){list.push(v.expr.column);});return{type:f,name:n,columns:list};},peg$c23=function peg$c23(f,w){return{type:'delete',from:f,where:w};},peg$c24=function peg$c24(s){return s[2];},peg$c25=function peg$c25(d,c,f,w,g,o,l){return{type:'select',distinct:d,columns:c,from:f,where:w,groupby:g,orderby:o,limit:l};},peg$c26=peg$otherExpectation("column_clause"),peg$c27=function peg$c27(){return'*';},peg$c28=function peg$c28(head,tail){return createList(head,tail);},peg$c29=function peg$c29(e,alias){return{expr:e,as:alias};},peg$c30=function peg$c30(i){return i;},peg$c31=function peg$c31(l){return l;},peg$c32=function peg$c32(head,tail){tail.unshift(head);return tail;},peg$c33=function peg$c33(t){return t;},peg$c34=function peg$c34(op,t,expr){t.join=op;t.on=expr;return t;},peg$c35=function peg$c35(t,alias){if(t.type=='var'){t.as=alias;return t;}else{return{db:t.db,table:t.table,as:alias};}},peg$c36=function peg$c36(){return'LEFT JOIN';},peg$c37=function peg$c37(){return'INNER JOIN';},peg$c38="`",peg$c39=peg$literalExpectation("`",false),peg$c40=function peg$c40(dt,tail){var obj={db:'',table:dt};if(tail){obj.db=dt;obj.table=tail[3];}return obj;},peg$c41=function peg$c41(v){v.db='';v.table=v.name;return v;},peg$c42=function peg$c42(e){return e;},peg$c43=function peg$c43(e,d){var obj={expr:e,type:'ASC'};if(d=='DESC'){obj.type='DESC';}return obj;},peg$c44=function peg$c44(i1,tail){var res=[i1];if(!tail){res.unshift({type:'number',value:0});}else{res.push(tail[2]);}return res;},peg$c45=function peg$c45(t,l,w){return{type:'update',db:t.db,table:t.table,set:l,where:w};},peg$c46=function peg$c46(c,v){return{column:c,value:v};},peg$c47=function peg$c47(ri,t,c,v){return{type:ri,db:t.db,table:t.table,columns:c,values:v};},peg$c48=function peg$c48(){return'insert';},peg$c49=function peg$c49(){return'replace';},peg$c50=function peg$c50(l){return l;},peg$c51=function peg$c51(head,tail){var el={type:'expr_list'};var l=createExprList(head,tail,el);el.value=l;return el;},peg$c52="",peg$c53=function peg$c53(){return{type:'expr_list',value:[]};},peg$c54=function peg$c54(head,tail){return createBinaryExprChain(head,tail);},peg$c55="!",peg$c56=peg$literalExpectation("!",false),peg$c57=function peg$c57(expr){return createUnaryExpr('NOT',expr);},peg$c58=function peg$c58(left,rh){if(!rh){return left;}else{var res=null;if(rh.type=='arithmetic'){res=createBinaryExprChain(left,rh.tail);}else{res=createBinaryExpr(rh.op,left,rh.right);}return res;}},peg$c59=function peg$c59(l){return{type:'arithmetic',tail:l};},peg$c60=">=",peg$c61=peg$literalExpectation(">=",false),peg$c62=">",peg$c63=peg$literalExpectation(">",false),peg$c64="<=",peg$c65=peg$literalExpectation("<=",false),peg$c66="<>",peg$c67=peg$literalExpectation("<>",false),peg$c68="<",peg$c69=peg$literalExpectation("<",false),peg$c70="!=",peg$c71=peg$literalExpectation("!=",false),peg$c72=function peg$c72(op,right){return{op:op,right:right};},peg$c73=function peg$c73(op,begin,end){return{op:op,right:{type:'expr_list',value:[begin,end]}};},peg$c74=function peg$c74(nk){return nk[0]+' '+nk[2];},peg$c75=function peg$c75(op,l){return{op:op,right:l};},peg$c76=function peg$c76(op,e){return{op:op,right:e};},peg$c77="+",peg$c78=peg$literalExpectation("+",false),peg$c79="-",peg$c80=peg$literalExpectation("-",false),peg$c81=function peg$c81(head,tail){return createBinaryExprChain(head,tail);},peg$c82="*",peg$c83=peg$literalExpectation("*",false),peg$c84="/",peg$c85=peg$literalExpectation("/",false),peg$c86="%",peg$c87=peg$literalExpectation("%",false),peg$c88=function peg$c88(e){e.paren=true;return e;},peg$c89=function peg$c89(tbl,col){return{type:'column_ref',table:tbl,column:col};},peg$c90=function peg$c90(col){return{type:'column_ref',table:'',column:col};},peg$c91=function peg$c91(name){return reservedMap[name.toUpperCase()]===true;},peg$c92=function peg$c92(name){return name;},peg$c93=/^[^`]/,peg$c94=peg$classExpectation(["`"],true,false),peg$c95=function peg$c95(chars){return chars.join('');},peg$c96=function peg$c96(start,parts){return start+parts.join('');},peg$c97=/^[A-Za-z_]/,peg$c98=peg$classExpectation([["A","Z"],["a","z"],"_"],false,false),peg$c99=/^[A-Za-z0-9_]/,peg$c100=peg$classExpectation([["A","Z"],["a","z"],["0","9"],"_"],false,false),peg$c101=/^[A-Za-z0-9_:]/,peg$c102=peg$classExpectation([["A","Z"],["a","z"],["0","9"],"_",":"],false,false),peg$c103=peg$otherExpectation("PARAM[:param, ?]"),peg$c104=":",peg$c105=peg$literalExpectation(":",false),peg$c106="?",peg$c107=peg$literalExpectation("?",false),peg$c108=function peg$c108(l){var p={type:'param',value:l.length>1?l[1]:l[0]};params.push(p);return p;},peg$c109=function peg$c109(name,e){return{type:'aggr_func',name:name,args:{expr:e}};},peg$c110=/^[0-9a-zA-Z_]/,peg$c111=peg$classExpectation([["0","9"],["a","z"],["A","Z"],"_"],false,false),peg$c112=function peg$c112(w){return w.join('');},peg$c113=function peg$c113(name,arg){return{type:'aggr_func',name:name,args:arg};},peg$c114=function peg$c114(e){return{expr:e};},peg$c115=function peg$c115(d,c){return{distinct:d,expr:c};},peg$c116=function peg$c116(){return{type:'star',value:'*'};},peg$c117=function peg$c117(name,l){return{type:'function',name:name,args:l};},peg$c118=function peg$c118(){return{type:'null',value:null};},peg$c119=function peg$c119(){return{type:'bool',value:true};},peg$c120=function peg$c120(){return{type:'bool',value:false};},peg$c121="\"",peg$c122=peg$literalExpectation("\"",false),peg$c123="'",peg$c124=peg$literalExpectation("'",false),peg$c125=function peg$c125(ca){return{type:'string',value:ca[1].join('')};},peg$c126=/^[^'\\\0-\x1F\x7F]/,peg$c127=peg$classExpectation(["'","\\",["\0","\x1F"],"\x7F"],true,false),peg$c128=/^[^"\\\0-\x1F\x7F]/,peg$c129=peg$classExpectation(["\"","\\",["\0","\x1F"],"\x7F"],true,false),peg$c130="\\'",peg$c131=peg$literalExpectation("\\'",false),peg$c132=function peg$c132(){return"'";},peg$c133="\\\"",peg$c134=peg$literalExpectation("\\\"",false),peg$c135=function peg$c135(){return'"';},peg$c136="\\\\",peg$c137=peg$literalExpectation("\\\\",false),peg$c138=function peg$c138(){return"\\";},peg$c139="\\/",peg$c140=peg$literalExpectation("\\/",false),peg$c141=function peg$c141(){return"/";},peg$c142="\\b",peg$c143=peg$literalExpectation("\\b",false),peg$c144=function peg$c144(){return"\b";},peg$c145="\\f",peg$c146=peg$literalExpectation("\\f",false),peg$c147=function peg$c147(){return"\f";},peg$c148="\\n",peg$c149=peg$literalExpectation("\\n",false),peg$c150=function peg$c150(){return"\n";},peg$c151="\\r",peg$c152=peg$literalExpectation("\\r",false),peg$c153=function peg$c153(){return"\r";},peg$c154="\\t",peg$c155=peg$literalExpectation("\\t",false),peg$c156=function peg$c156(){return"\t";},peg$c157="\\u",peg$c158=peg$literalExpectation("\\u",false),peg$c159=function peg$c159(h1,h2,h3,h4){return String.fromCharCode(parseInt("0x"+h1+h2+h3+h4));},peg$c160=/^[\n\r]/,peg$c161=peg$classExpectation(["\n","\r"],false,false),peg$c162=function peg$c162(n){return{type:'number',value:n};},peg$c163=peg$otherExpectation("LITERAL INT"),peg$c164=function peg$c164(n){return{type:'number',value:n};},peg$c165=function peg$c165(int_,frac,exp){var x=parseFloat(int_+frac+exp);return x%1!=0?x.toString():x.toString()+".0";},peg$c166=function peg$c166(int_,frac){var x=parseFloat(int_+frac);return x%1!=0?x.toString():x.toString()+".0";},peg$c167=function peg$c167(int_,exp){return parseFloat(int_+exp).toString();},peg$c168=function peg$c168(int_){return parseFloat(int_).toString();},peg$c169=function peg$c169(digit19,digits){return digit19+digits;},peg$c170=function peg$c170(op,digit19,digits){return"-"+digit19+digits;},peg$c171=function peg$c171(op,digit){return"-"+digit;},peg$c172=".",peg$c173=peg$literalExpectation(".",false),peg$c174=function peg$c174(digits){return"."+digits;},peg$c175=function peg$c175(e,digits){return e+digits;},peg$c176=function peg$c176(digits){return digits.join("");},peg$c177=peg$otherExpectation("NUMBER"),peg$c178=/^[0-9]/,peg$c179=peg$classExpectation([["0","9"]],false,false),peg$c180=/^[1-9]/,peg$c181=peg$classExpectation([["1","9"]],false,false),peg$c182=peg$otherExpectation("HEX"),peg$c183=/^[0-9a-fA-F]/,peg$c184=peg$classExpectation([["0","9"],["a","f"],["A","F"]],false,false),peg$c185=/^[eE]/,peg$c186=peg$classExpectation(["e","E"],false,false),peg$c187=/^[+\-]/,peg$c188=peg$classExpectation(["+","-"],false,false),peg$c189=function peg$c189(e,sign){return e+sign;},peg$c190="null",peg$c191=peg$literalExpectation("NULL",true),peg$c192="true",peg$c193=peg$literalExpectation("TRUE",true),peg$c194="false",peg$c195=peg$literalExpectation("FALSE",true),peg$c196="show",peg$c197=peg$literalExpectation("SHOW",true),peg$c198="drop",peg$c199=peg$literalExpectation("DROP",true),peg$c200="select",peg$c201=peg$literalExpectation("SELECT",true),peg$c202="update",peg$c203=peg$literalExpectation("UPDATE",true),peg$c204="create",peg$c205=peg$literalExpectation("CREATE",true),peg$c206="delete",peg$c207=peg$literalExpectation("DELETE",true),peg$c208="insert",peg$c209=peg$literalExpectation("INSERT",true),peg$c210="replace",peg$c211=peg$literalExpectation("REPLACE",true),peg$c212="explain",peg$c213=peg$literalExpectation("EXPLAIN",true),peg$c214="into",peg$c215=peg$literalExpectation("INTO",true),peg$c216="from",peg$c217=peg$literalExpectation("FROM",true),peg$c218="set",peg$c219=peg$literalExpectation("SET",true),peg$c220="as",peg$c221=peg$literalExpectation("AS",true),peg$c222="table",peg$c223=peg$literalExpectation("TABLE",true),peg$c224="on",peg$c225=peg$literalExpectation("ON",true),peg$c226="left",peg$c227=peg$literalExpectation("LEFT",true),peg$c228="inner",peg$c229=peg$literalExpectation("INNER",true),peg$c230="join",peg$c231=peg$literalExpectation("JOIN",true),peg$c232="union",peg$c233=peg$literalExpectation("UNION",true),peg$c234="values",peg$c235=peg$literalExpectation("VALUES",true),peg$c236="if",peg$c237=peg$literalExpectation("IF",true),peg$c238="exists",peg$c239=peg$literalExpectation("EXISTS",true),peg$c240="where",peg$c241=peg$literalExpectation("WHERE",true),peg$c242="group",peg$c243=peg$literalExpectation("GROUP",true),peg$c244="by",peg$c245=peg$literalExpectation("BY",true),peg$c246="order",peg$c247=peg$literalExpectation("ORDER",true),peg$c248="having",peg$c249=peg$literalExpectation("HAVING",true),peg$c250="limit",peg$c251=peg$literalExpectation("LIMIT",true),peg$c252="asc",peg$c253=peg$literalExpectation("ASC",true),peg$c254=function peg$c254(){return'ASC';},peg$c255="desc",peg$c256=peg$literalExpectation("DESC",true),peg$c257=function peg$c257(){return'DESC';},peg$c258="all",peg$c259=peg$literalExpectation("ALL",true),peg$c260=function peg$c260(){return'ALL';},peg$c261="distinct",peg$c262=peg$literalExpectation("DISTINCT",true),peg$c263=function peg$c263(){return'DISTINCT';},peg$c264="between",peg$c265=peg$literalExpectation("BETWEEN",true),peg$c266=function peg$c266(){return'BETWEEN';},peg$c267="in",peg$c268=peg$literalExpectation("IN",true),peg$c269=function peg$c269(){return'IN';},peg$c270="is",peg$c271=peg$literalExpectation("IS",true),peg$c272=function peg$c272(){return'IS';},peg$c273="like",peg$c274=peg$literalExpectation("LIKE",true),peg$c275=function peg$c275(){return'LIKE';},peg$c276="contains",peg$c277=peg$literalExpectation("CONTAINS",true),peg$c278=function peg$c278(){return'CONTAINS';},peg$c279="not",peg$c280=peg$literalExpectation("NOT",true),peg$c281=function peg$c281(){return'NOT';},peg$c282="and",peg$c283=peg$literalExpectation("AND",true),peg$c284=function peg$c284(){return'AND';},peg$c285="or",peg$c286=peg$literalExpectation("OR",true),peg$c287=function peg$c287(){return'OR';},peg$c288="count",peg$c289=peg$literalExpectation("COUNT",true),peg$c290=function peg$c290(){return'COUNT';},peg$c291="max",peg$c292=peg$literalExpectation("MAX",true),peg$c293=function peg$c293(){return'MAX';},peg$c294="min",peg$c295=peg$literalExpectation("MIN",true),peg$c296=function peg$c296(){return'MIN';},peg$c297="sum",peg$c298=peg$literalExpectation("SUM",true),peg$c299=function peg$c299(){return'SUM';},peg$c300="avg",peg$c301=peg$literalExpectation("AVG",true),peg$c302=function peg$c302(){return'AVG';},peg$c303=",",peg$c304=peg$literalExpectation(",",false),peg$c305="[",peg$c306=peg$literalExpectation("[",false),peg$c307="]",peg$c308=peg$literalExpectation("]",false),peg$c309=peg$anyExpectation(),peg$c310=peg$otherExpectation("WHITE_SPACE"),peg$c311=/^[ \t\n\r]/,peg$c312=peg$classExpectation([" ","\t","\n","\r"],false,false),peg$c313=peg$otherExpectation("EOF"),peg$c314=function peg$c314(s){return{stmt:s,vars:varList};},peg$c315=function peg$c315(){varList=[];return true;},peg$c316=function peg$c316(va,e){return{type:'assign',left:va,right:e};},peg$c317=function peg$c317(e){return{type:'return',expr:e};},peg$c318=function peg$c318(lt,op,rt,expr){return{type:'join',ltable:lt,rtable:rt,op:op,on:expr};},peg$c319=function peg$c319(name,l){return{type:'function',name:name,args:{type:'expr_list',value:l}};},peg$c320=function peg$c320(l){return{type:'array',value:l};},peg$c321=function peg$c321(name,m){varList.push(name);return{type:'var',name:name,members:m};},peg$c322=function peg$c322(l){var s=[];for(var i=0;i<l.length;i++){s.push(l[i][1]);}return s;},peg$c323="$",peg$c324=peg$literalExpectation("$",false),peg$c325="return",peg$c326=peg$literalExpectation("return",true),peg$c327=":=",peg$c328=peg$literalExpectation(":=",false),peg$currPos=0,peg$savedPos=0,peg$posDetailsCache=[{line:1,column:1}],peg$maxFailPos=0,peg$maxFailExpected=[],peg$silentFails=0,peg$result;if("startRule"in options){if(!(options.startRule in peg$startRuleFunctions)){throw new Error("Can't start parsing from rule \""+options.startRule+"\".");}peg$startRuleFunction=peg$startRuleFunctions[options.startRule];}function text(){return input.substring(peg$savedPos,peg$currPos);}function location(){return peg$computeLocation(peg$savedPos,peg$currPos);}function expected(description,location){location=location!==void 0?location:peg$computeLocation(peg$savedPos,peg$currPos);throw peg$buildStructuredError([peg$otherExpectation(description)],input.substring(peg$savedPos,peg$currPos),location);}function error(message,location){location=location!==void 0?location:peg$computeLocation(peg$savedPos,peg$currPos);throw peg$buildSimpleError(message,location);}function peg$literalExpectation(text,ignoreCase){return{type:"literal",text:text,ignoreCase:ignoreCase};}function peg$classExpectation(parts,inverted,ignoreCase){return{type:"class",parts:parts,inverted:inverted,ignoreCase:ignoreCase};}function peg$anyExpectation(){return{type:"any"};}function peg$endExpectation(){return{type:"end"};}function peg$otherExpectation(description){return{type:"other",description:description};}function peg$computePosDetails(pos){var details=peg$posDetailsCache[pos],p;if(details){return details;}else{p=pos-1;while(!peg$posDetailsCache[p]){p--;}details=peg$posDetailsCache[p];details={line:details.line,column:details.column};while(p<pos){if(input.charCodeAt(p)===10){details.line++;details.column=1;}else{details.column++;}p++;}peg$posDetailsCache[pos]=details;return details;}}function peg$computeLocation(startPos,endPos){var startPosDetails=peg$computePosDetails(startPos),endPosDetails=peg$computePosDetails(endPos);return{start:{offset:startPos,line:startPosDetails.line,column:startPosDetails.column},end:{offset:endPos,line:endPosDetails.line,column:endPosDetails.column}};}function peg$fail(expected){if(peg$currPos<peg$maxFailPos){return;}if(peg$currPos>peg$maxFailPos){peg$maxFailPos=peg$currPos;peg$maxFailExpected=[];}peg$maxFailExpected.push(expected);}function peg$buildSimpleError(message,location){return new peg$SyntaxError(message,null,null,location);}function peg$buildStructuredError(expected,found,location){return new peg$SyntaxError(peg$SyntaxError.buildMessage(expected,found),expected,found,location);}function peg$parsestart(){var s0,s1,s2;s0=peg$currPos;s1=peg$parse__();if(s1!==peg$FAILED){s2=peg$parseunion_stmt();if(s2===peg$FAILED){s2=peg$parseupdate_stmt();if(s2===peg$FAILED){s2=peg$parsedelete_stmt();if(s2===peg$FAILED){s2=peg$parsereplace_insert_stmt();if(s2===peg$FAILED){s2=peg$parsecreate_table_stmt();}}}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c0(s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseproc_stmts();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c1(s1);}s0=s1;}return s0;}function peg$parseunion_stmt(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseselect_stmt();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseKW_UNION();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseselect_stmt();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseKW_UNION();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseselect_stmt();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c2(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsecreate_table_stmt(){var s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11,s12,s13,s14,s15,s16,s17,s18,s19;s0=peg$currPos;s1=peg$parseKW_CREATE();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseKW_TABLE();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$currPos;s6=peg$parseKW_IF();if(s6!==peg$FAILED){s7=peg$parse__();if(s7!==peg$FAILED){s8=peg$parseKW_NOT();if(s8!==peg$FAILED){s9=peg$parse__();if(s9!==peg$FAILED){s10=peg$parseKW_EXISTS();if(s10!==peg$FAILED){s11=peg$parse__();if(s11!==peg$FAILED){s6=[s6,s7,s8,s9,s10,s11];s5=s6;}else{peg$currPos=s5;s5=peg$FAILED;}}else{peg$currPos=s5;s5=peg$FAILED;}}else{peg$currPos=s5;s5=peg$FAILED;}}else{peg$currPos=s5;s5=peg$FAILED;}}else{peg$currPos=s5;s5=peg$FAILED;}}else{peg$currPos=s5;s5=peg$FAILED;}if(s5===peg$FAILED){s5=null;}if(s5!==peg$FAILED){s6=peg$parsetable_name();if(s6!==peg$FAILED){s7=peg$parse__();if(s7!==peg$FAILED){if(input.charCodeAt(peg$currPos)===40){s8=peg$c3;peg$currPos++;}else{s8=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c4);}}if(s8!==peg$FAILED){s9=peg$parse__();if(s9!==peg$FAILED){s10=peg$parsecolumns_defs();if(s10!==peg$FAILED){s11=peg$parse__();if(s11!==peg$FAILED){if(input.charCodeAt(peg$currPos)===41){s12=peg$c5;peg$currPos++;}else{s12=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c6);}}if(s12!==peg$FAILED){s13=peg$parse__();if(s13!==peg$FAILED){s14=peg$parsetable_options();if(s14===peg$FAILED){s14=null;}if(s14!==peg$FAILED){s15=peg$parse__();if(s15!==peg$FAILED){s16=peg$parsepartition_options();if(s16===peg$FAILED){s16=null;}if(s16!==peg$FAILED){s17=peg$parse__();if(s17!==peg$FAILED){if(input.charCodeAt(peg$currPos)===59){s18=peg$c7;peg$currPos++;}else{s18=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c8);}}if(s18===peg$FAILED){s18=null;}if(s18!==peg$FAILED){s19=peg$parse__();if(s19===peg$FAILED){s19=null;}if(s19!==peg$FAILED){peg$savedPos=s0;s1=peg$c9(s6,s10,s14,s16);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsecolumns_defs(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parsecolumn_def();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parsecolumn_def();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parsecolumn_def();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c10(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsecolumn_def(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$parseindex_def();if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parsecolumn();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parsecolumn_type();if(s3!==peg$FAILED){s4=[];s5=peg$currPos;s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseliteral();if(s7===peg$FAILED){s7=peg$parseident_name();}if(s7!==peg$FAILED){s6=[s6,s7];s5=s6;}else{peg$currPos=s5;s5=peg$FAILED;}}else{peg$currPos=s5;s5=peg$FAILED;}while(s5!==peg$FAILED){s4.push(s5);s5=peg$currPos;s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseliteral();if(s7===peg$FAILED){s7=peg$parseident_name();}if(s7!==peg$FAILED){s6=[s6,s7];s5=s6;}else{peg$currPos=s5;s5=peg$FAILED;}}else{peg$currPos=s5;s5=peg$FAILED;}}if(s4!==peg$FAILED){peg$savedPos=s0;s1=peg$c11(s1,s3,s4);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}return s0;}function peg$parsecolumn_type(){var s0,s1;s0=peg$currPos;s1=peg$parsefunc_call();if(s1===peg$FAILED){s1=peg$parseident();}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c12(s1);}s0=s1;return s0;}function peg$parsetable_options(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;s1=peg$parsetable_option();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parsetable_option();if(s5!==peg$FAILED){s4=[s4,s5];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parsetable_option();if(s5!==peg$FAILED){s4=[s4,s5];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c13(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsetable_option(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;s1=peg$parseprimary();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){if(input.charCodeAt(peg$currPos)===61){s3=peg$c14;peg$currPos++;}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c15);}}if(s3===peg$FAILED){s3=null;}if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseprimary();if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c16(s1,s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsepartition_options(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;s1=peg$parseprimary();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseprimary();if(s5!==peg$FAILED){s4=[s4,s5];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseprimary();if(s5!==peg$FAILED){s4=[s4,s5];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c17(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseindex_def(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$currPos;s2=peg$currPos;s3=[];s4=peg$parseident_name();while(s4!==peg$FAILED){s3.push(s4);s4=peg$parseident_name();}if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){if(input.substr(peg$currPos,3).toLowerCase()===peg$c18){s5=input.substr(peg$currPos,3);peg$currPos+=3;}else{s5=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c19);}}if(s5===peg$FAILED){if(input.substr(peg$currPos,5).toLowerCase()===peg$c20){s5=input.substr(peg$currPos,5);peg$currPos+=5;}else{s5=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c21);}}}if(s5!==peg$FAILED){s3=[s3,s4,s5];s2=s3;}else{peg$currPos=s2;s2=peg$FAILED;}}else{peg$currPos=s2;s2=peg$FAILED;}}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=input.substring(s1,peg$currPos);}else{s1=s2;}if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parsecolumn();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){if(input.charCodeAt(peg$currPos)===40){s5=peg$c3;peg$currPos++;}else{s5=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c4);}}if(s5!==peg$FAILED){s6=peg$parsecolumn_clause();if(s6!==peg$FAILED){if(input.charCodeAt(peg$currPos)===41){s7=peg$c5;peg$currPos++;}else{s7=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c6);}}if(s7!==peg$FAILED){peg$savedPos=s0;s1=peg$c22(s1,s3,s6);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsedelete_stmt(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;s1=peg$parseKW_DELETE();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parsefrom_clause();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parsewhere_clause();if(s5===peg$FAILED){s5=null;}if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c23(s3,s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseselect_stmt(){var s0,s1,s2,s3,s4,s5,s6;s0=peg$parseselect_stmt_nake();if(s0===peg$FAILED){s0=peg$currPos;s1=peg$currPos;if(input.charCodeAt(peg$currPos)===40){s2=peg$c3;peg$currPos++;}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c4);}}if(s2!==peg$FAILED){s3=peg$parse__();if(s3!==peg$FAILED){s4=peg$parseselect_stmt();if(s4!==peg$FAILED){s5=peg$parse__();if(s5!==peg$FAILED){if(input.charCodeAt(peg$currPos)===41){s6=peg$c5;peg$currPos++;}else{s6=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c6);}}if(s6!==peg$FAILED){s2=[s2,s3,s4,s5,s6];s1=s2;}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c24(s1);}s0=s1;}return s0;}function peg$parseselect_stmt_nake(){var s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11,s12,s13,s14,s15;s0=peg$currPos;s1=peg$parseKW_SELECT();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseKW_DISTINCT();if(s3===peg$FAILED){s3=null;}if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parsecolumn_clause();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parsefrom_clause();if(s7===peg$FAILED){s7=null;}if(s7!==peg$FAILED){s8=peg$parse__();if(s8!==peg$FAILED){s9=peg$parsewhere_clause();if(s9===peg$FAILED){s9=null;}if(s9!==peg$FAILED){s10=peg$parse__();if(s10!==peg$FAILED){s11=peg$parsegroup_by_clause();if(s11===peg$FAILED){s11=null;}if(s11!==peg$FAILED){s12=peg$parse__();if(s12!==peg$FAILED){s13=peg$parseorder_by_clause();if(s13===peg$FAILED){s13=null;}if(s13!==peg$FAILED){s14=peg$parse__();if(s14!==peg$FAILED){s15=peg$parselimit_clause();if(s15===peg$FAILED){s15=null;}if(s15!==peg$FAILED){peg$savedPos=s0;s1=peg$c25(s3,s5,s7,s9,s11,s13,s15);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsecolumn_clause(){var s0,s1,s2,s3,s4,s5,s6,s7;peg$silentFails++;s0=peg$currPos;s1=peg$parseKW_ALL();if(s1===peg$FAILED){s1=peg$currPos;s2=peg$parseSTAR();if(s2!==peg$FAILED){s3=peg$currPos;peg$silentFails++;s4=peg$parseident_start();peg$silentFails--;if(s4===peg$FAILED){s3=void 0;}else{peg$currPos=s3;s3=peg$FAILED;}if(s3!==peg$FAILED){s2=[s2,s3];s1=s2;}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c27();}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parsecolumn_list_item();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parsecolumn_list_item();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parsecolumn_list_item();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c28(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}peg$silentFails--;if(s0===peg$FAILED){s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c26);}}return s0;}function peg$parsecolumn_list_item(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseadditive_expr();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parsealias_clause();if(s3===peg$FAILED){s3=null;}if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c29(s1,s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsealias_clause(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseKW_AS();if(s1===peg$FAILED){s1=null;}if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseident();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c30(s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsefrom_clause(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseKW_FROM();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parsetable_ref_list();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c31(s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsetable_ref_list(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parsetable_base();if(s1!==peg$FAILED){s2=[];s3=peg$parsetable_ref();while(s3!==peg$FAILED){s2.push(s3);s3=peg$parsetable_ref();}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c32(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsetable_ref(){var s0,s1,s2,s3,s4;s0=peg$currPos;s1=peg$parse__();if(s1!==peg$FAILED){s2=peg$parseCOMMA();if(s2!==peg$FAILED){s3=peg$parse__();if(s3!==peg$FAILED){s4=peg$parsetable_base();if(s4!==peg$FAILED){peg$savedPos=s0;s1=peg$c33(s4);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parse__();if(s1!==peg$FAILED){s2=peg$parsetable_join();if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c33(s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}return s0;}function peg$parsetable_join(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;s1=peg$parsejoin_op();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parsetable_base();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseon_clause();if(s5===peg$FAILED){s5=null;}if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c34(s1,s3,s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsetable_base(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;s1=peg$parsetable_name();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseKW_AS();if(s3===peg$FAILED){s3=null;}if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseident();if(s5===peg$FAILED){s5=null;}if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c35(s1,s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsejoin_op(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseKW_LEFT();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseKW_JOIN();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c36();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$currPos;s2=peg$parseKW_INNER();if(s2!==peg$FAILED){s3=peg$parse__();if(s3!==peg$FAILED){s2=[s2,s3];s1=s2;}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}if(s1===peg$FAILED){s1=null;}if(s1!==peg$FAILED){s2=peg$parseKW_JOIN();if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c37();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}return s0;}function peg$parsetable_name(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===96){s1=peg$c38;peg$currPos++;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c39);}}if(s1===peg$FAILED){s1=null;}if(s1!==peg$FAILED){s2=peg$parseident();if(s2!==peg$FAILED){s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseDOT();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseident_name();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}if(s3===peg$FAILED){s3=null;}if(s3!==peg$FAILED){if(input.charCodeAt(peg$currPos)===96){s4=peg$c38;peg$currPos++;}else{s4=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c39);}}if(s4===peg$FAILED){s4=null;}if(s4!==peg$FAILED){peg$savedPos=s0;s1=peg$c40(s2,s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parsevar_decl();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c41(s1);}s0=s1;}return s0;}function peg$parseon_clause(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseKW_ON();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseor_expr();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c42(s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsewhere_clause(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseKW_WHERE();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseor_expr();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c42(s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsegroup_by_clause(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;s1=peg$parseKW_GROUP();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseKW_BY();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parsecolumn_ref_list();if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c31(s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsecolumn_ref_list(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parsecolumn_ref();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parsecolumn_ref();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parsecolumn_ref();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c28(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsehaving_clause(){var s0,s1,s2;s0=peg$currPos;s1=peg$parseKW_HAVING();if(s1!==peg$FAILED){s2=peg$parseor_expr();if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c42(s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseorder_by_clause(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;s1=peg$parseKW_ORDER();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseKW_BY();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseorder_by_list();if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c31(s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseorder_by_list(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseorder_by_element();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseorder_by_element();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseorder_by_element();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c28(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseorder_by_element(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseor_expr();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseKW_DESC();if(s3===peg$FAILED){s3=peg$parseKW_ASC();}if(s3===peg$FAILED){s3=null;}if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c43(s1,s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsenumber_or_param(){var s0;s0=peg$parseliteral_numeric();if(s0===peg$FAILED){s0=peg$parseparam();}return s0;}function peg$parseint_or_param(){var s0;s0=peg$parseliteral_int();if(s0===peg$FAILED){s0=peg$parseparam();}return s0;}function peg$parselimit_clause(){var s0,s1,s2,s3,s4,s5,s6,s7,s8;s0=peg$currPos;s1=peg$parseKW_LIMIT();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseint_or_param();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$currPos;s6=peg$parseCOMMA();if(s6!==peg$FAILED){s7=peg$parse__();if(s7!==peg$FAILED){s8=peg$parseint_or_param();if(s8!==peg$FAILED){s6=[s6,s7,s8];s5=s6;}else{peg$currPos=s5;s5=peg$FAILED;}}else{peg$currPos=s5;s5=peg$FAILED;}}else{peg$currPos=s5;s5=peg$FAILED;}if(s5===peg$FAILED){s5=null;}if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c44(s3,s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseupdate_stmt(){var s0,s1,s2,s3,s4,s5,s6,s7,s8,s9;s0=peg$currPos;s1=peg$parseKW_UPDATE();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parsetable_name();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseKW_SET();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseset_list();if(s7!==peg$FAILED){s8=peg$parse__();if(s8!==peg$FAILED){s9=peg$parsewhere_clause();if(s9!==peg$FAILED){peg$savedPos=s0;s1=peg$c45(s3,s7,s9);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseset_list(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseset_item();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseset_item();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseset_item();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c28(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseset_item(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;s1=peg$parsecolumn_name();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){if(input.charCodeAt(peg$currPos)===61){s3=peg$c14;peg$currPos++;}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c15);}}if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseadditive_expr();if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c46(s1,s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsereplace_insert_stmt(){var s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11,s12,s13;s0=peg$currPos;s1=peg$parsereplace_insert();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseKW_INTO();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parsetable_name();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseLPAREN();if(s7!==peg$FAILED){s8=peg$parse__();if(s8!==peg$FAILED){s9=peg$parsecolumn_list();if(s9!==peg$FAILED){s10=peg$parse__();if(s10!==peg$FAILED){s11=peg$parseRPAREN();if(s11!==peg$FAILED){s12=peg$parse__();if(s12!==peg$FAILED){s13=peg$parsevalue_clause();if(s13!==peg$FAILED){peg$savedPos=s0;s1=peg$c47(s1,s5,s9,s13);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsereplace_insert(){var s0,s1;s0=peg$currPos;s1=peg$parseKW_INSERT();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c48();}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseKW_REPLACE();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c49();}s0=s1;}return s0;}function peg$parsevalue_clause(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseKW_VALUES();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parsevalue_list();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c31(s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsevalue_list(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parsevalue_item();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parsevalue_item();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parsevalue_item();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c28(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsevalue_item(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;s1=peg$parseLPAREN();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseexpr_list();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseRPAREN();if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c50(s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseexpr_list(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseor_expr();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseor_expr();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseor_expr();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c51(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseexpr_list_or_empty(){var s0,s1;s0=peg$parseexpr_list();if(s0===peg$FAILED){s0=peg$currPos;s1=peg$c52;if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c53();}s0=s1;}return s0;}function peg$parseor_expr(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseand_expr();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseKW_OR();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseand_expr();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseKW_OR();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseand_expr();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c54(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseand_expr(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parsenot_expr();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseKW_AND();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parsenot_expr();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseKW_AND();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parsenot_expr();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c54(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsenot_expr(){var s0,s1,s2,s3,s4;s0=peg$currPos;s1=peg$parseKW_NOT();if(s1===peg$FAILED){s1=peg$currPos;if(input.charCodeAt(peg$currPos)===33){s2=peg$c55;peg$currPos++;}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c56);}}if(s2!==peg$FAILED){s3=peg$currPos;peg$silentFails++;if(input.charCodeAt(peg$currPos)===61){s4=peg$c14;peg$currPos++;}else{s4=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c15);}}peg$silentFails--;if(s4===peg$FAILED){s3=void 0;}else{peg$currPos=s3;s3=peg$FAILED;}if(s3!==peg$FAILED){s2=[s2,s3];s1=s2;}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}}if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parsenot_expr();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c57(s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$parsecomparison_expr();}return s0;}function peg$parsecomparison_expr(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseadditive_expr();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parsecomparison_op_right();if(s3===peg$FAILED){s3=null;}if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c58(s1,s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsecomparison_op_right(){var s0;s0=peg$parsearithmetic_op_right();if(s0===peg$FAILED){s0=peg$parsein_op_right();if(s0===peg$FAILED){s0=peg$parsebetween_op_right();if(s0===peg$FAILED){s0=peg$parseis_op_right();if(s0===peg$FAILED){s0=peg$parselike_op_right();if(s0===peg$FAILED){s0=peg$parsecontains_op_right();}}}}}return s0;}function peg$parsearithmetic_op_right(){var s0,s1,s2,s3,s4,s5,s6;s0=peg$currPos;s1=[];s2=peg$currPos;s3=peg$parse__();if(s3!==peg$FAILED){s4=peg$parsearithmetic_comparison_operator();if(s4!==peg$FAILED){s5=peg$parse__();if(s5!==peg$FAILED){s6=peg$parseadditive_expr();if(s6!==peg$FAILED){s3=[s3,s4,s5,s6];s2=s3;}else{peg$currPos=s2;s2=peg$FAILED;}}else{peg$currPos=s2;s2=peg$FAILED;}}else{peg$currPos=s2;s2=peg$FAILED;}}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){while(s2!==peg$FAILED){s1.push(s2);s2=peg$currPos;s3=peg$parse__();if(s3!==peg$FAILED){s4=peg$parsearithmetic_comparison_operator();if(s4!==peg$FAILED){s5=peg$parse__();if(s5!==peg$FAILED){s6=peg$parseadditive_expr();if(s6!==peg$FAILED){s3=[s3,s4,s5,s6];s2=s3;}else{peg$currPos=s2;s2=peg$FAILED;}}else{peg$currPos=s2;s2=peg$FAILED;}}else{peg$currPos=s2;s2=peg$FAILED;}}else{peg$currPos=s2;s2=peg$FAILED;}}}else{s1=peg$FAILED;}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c59(s1);}s0=s1;return s0;}function peg$parsearithmetic_comparison_operator(){var s0;if(input.substr(peg$currPos,2)===peg$c60){s0=peg$c60;peg$currPos+=2;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c61);}}if(s0===peg$FAILED){if(input.charCodeAt(peg$currPos)===62){s0=peg$c62;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c63);}}if(s0===peg$FAILED){if(input.substr(peg$currPos,2)===peg$c64){s0=peg$c64;peg$currPos+=2;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c65);}}if(s0===peg$FAILED){if(input.substr(peg$currPos,2)===peg$c66){s0=peg$c66;peg$currPos+=2;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c67);}}if(s0===peg$FAILED){if(input.charCodeAt(peg$currPos)===60){s0=peg$c68;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c69);}}if(s0===peg$FAILED){if(input.charCodeAt(peg$currPos)===61){s0=peg$c14;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c15);}}if(s0===peg$FAILED){if(input.substr(peg$currPos,2)===peg$c70){s0=peg$c70;peg$currPos+=2;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c71);}}}}}}}}return s0;}function peg$parseis_op_right(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseKW_IS();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseadditive_expr();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c72(s1,s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsebetween_op_right(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseKW_BETWEEN();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseadditive_expr();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseKW_AND();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseadditive_expr();if(s7!==peg$FAILED){peg$savedPos=s0;s1=peg$c73(s1,s3,s7);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parselike_op(){var s0,s1,s2,s3,s4;s0=peg$currPos;s1=peg$currPos;s2=peg$parseKW_NOT();if(s2!==peg$FAILED){s3=peg$parse__();if(s3!==peg$FAILED){s4=peg$parseKW_LIKE();if(s4!==peg$FAILED){s2=[s2,s3,s4];s1=s2;}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c74(s1);}s0=s1;if(s0===peg$FAILED){s0=peg$parseKW_LIKE();}return s0;}function peg$parsein_op(){var s0,s1,s2,s3,s4;s0=peg$currPos;s1=peg$currPos;s2=peg$parseKW_NOT();if(s2!==peg$FAILED){s3=peg$parse__();if(s3!==peg$FAILED){s4=peg$parseKW_IN();if(s4!==peg$FAILED){s2=[s2,s3,s4];s1=s2;}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c74(s1);}s0=s1;if(s0===peg$FAILED){s0=peg$parseKW_IN();}return s0;}function peg$parsecontains_op(){var s0,s1,s2,s3,s4;s0=peg$currPos;s1=peg$currPos;s2=peg$parseKW_NOT();if(s2!==peg$FAILED){s3=peg$parse__();if(s3!==peg$FAILED){s4=peg$parseKW_CONTAINS();if(s4!==peg$FAILED){s2=[s2,s3,s4];s1=s2;}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c74(s1);}s0=s1;if(s0===peg$FAILED){s0=peg$parseKW_CONTAINS();}return s0;}function peg$parselike_op_right(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parselike_op();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parsecomparison_expr();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c72(s1,s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsein_op_right(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parsein_op();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseLPAREN();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseexpr_list();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseRPAREN();if(s7!==peg$FAILED){peg$savedPos=s0;s1=peg$c75(s1,s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parsein_op();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parsevar_decl();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c76(s1,s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}return s0;}function peg$parsecontains_op_right(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parsecontains_op();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseLPAREN();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseexpr_list();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseRPAREN();if(s7!==peg$FAILED){peg$savedPos=s0;s1=peg$c75(s1,s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parsecontains_op();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parsevar_decl();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c76(s1,s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}return s0;}function peg$parseadditive_expr(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parsemultiplicative_expr();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseadditive_operator();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parsemultiplicative_expr();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseadditive_operator();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parsemultiplicative_expr();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c54(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseadditive_operator(){var s0;if(input.charCodeAt(peg$currPos)===43){s0=peg$c77;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c78);}}if(s0===peg$FAILED){if(input.charCodeAt(peg$currPos)===45){s0=peg$c79;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c80);}}}return s0;}function peg$parsemultiplicative_expr(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseprimary();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parsemultiplicative_operator();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseprimary();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parsemultiplicative_operator();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseprimary();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c81(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsemultiplicative_operator(){var s0;if(input.charCodeAt(peg$currPos)===42){s0=peg$c82;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c83);}}if(s0===peg$FAILED){if(input.charCodeAt(peg$currPos)===47){s0=peg$c84;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c85);}}if(s0===peg$FAILED){if(input.charCodeAt(peg$currPos)===37){s0=peg$c86;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c87);}}}}return s0;}function peg$parseprimary(){var s0,s1,s2,s3,s4,s5;s0=peg$parseliteral();if(s0===peg$FAILED){s0=peg$parseaggr_func();if(s0===peg$FAILED){s0=peg$parsefunc_call();if(s0===peg$FAILED){s0=peg$parsecolumn_ref();if(s0===peg$FAILED){s0=peg$parseparam();if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseLPAREN();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseor_expr();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseRPAREN();if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c88(s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$parsevar_decl();}}}}}}return s0;}function peg$parsecolumn_ref(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;s1=peg$parseident();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseDOT();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parsecolumn();if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c89(s1,s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parsecolumn();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c90(s1);}s0=s1;}return s0;}function peg$parsecolumn_list(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parsecolumn();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parsecolumn();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parsecolumn();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c28(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseident(){var s0,s1,s2;s0=peg$currPos;s1=peg$parseident_name();if(s1!==peg$FAILED){peg$savedPos=peg$currPos;s2=peg$c91(s1);if(s2){s2=peg$FAILED;}else{s2=void 0;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c92(s1);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsecolumn(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parsecolumn_name();if(s1!==peg$FAILED){peg$savedPos=peg$currPos;s2=peg$c91(s1);if(s2){s2=peg$FAILED;}else{s2=void 0;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c92(s1);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$currPos;if(input.charCodeAt(peg$currPos)===96){s1=peg$c38;peg$currPos++;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c39);}}if(s1!==peg$FAILED){s2=[];if(peg$c93.test(input.charAt(peg$currPos))){s3=input.charAt(peg$currPos);peg$currPos++;}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c94);}}if(s3!==peg$FAILED){while(s3!==peg$FAILED){s2.push(s3);if(peg$c93.test(input.charAt(peg$currPos))){s3=input.charAt(peg$currPos);peg$currPos++;}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c94);}}}}else{s2=peg$FAILED;}if(s2!==peg$FAILED){if(input.charCodeAt(peg$currPos)===96){s3=peg$c38;peg$currPos++;}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c39);}}if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c95(s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}return s0;}function peg$parsecolumn_name(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseident_start();if(s1!==peg$FAILED){s2=[];s3=peg$parsecolumn_part();while(s3!==peg$FAILED){s2.push(s3);s3=peg$parsecolumn_part();}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c96(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseident_name(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseident_start();if(s1!==peg$FAILED){s2=[];s3=peg$parseident_part();while(s3!==peg$FAILED){s2.push(s3);s3=peg$parseident_part();}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c96(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseident_start(){var s0;if(peg$c97.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c98);}}return s0;}function peg$parseident_part(){var s0;if(peg$c99.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c100);}}return s0;}function peg$parsecolumn_part(){var s0;if(peg$c101.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c102);}}return s0;}function peg$parseparam(){var s0,s1,s2;peg$silentFails++;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===58){s1=peg$c104;peg$currPos++;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c105);}}if(s1!==peg$FAILED){s2=peg$parseident_name();if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$currPos;if(input.charCodeAt(peg$currPos)===63){s1=peg$c106;peg$currPos++;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c107);}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c108(s1);}s0=s1;}peg$silentFails--;if(s0===peg$FAILED){s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c103);}}return s0;}function peg$parseaggr_func(){var s0;s0=peg$parseaggr_fun_count();if(s0===peg$FAILED){s0=peg$parseaggr_fun_smma();}return s0;}function peg$parseaggr_fun_smma(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseKW_SUM_MAX_MIN_AVG();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseLPAREN();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseadditive_expr();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseRPAREN();if(s7!==peg$FAILED){peg$savedPos=s0;s1=peg$c109(s1,s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_SUM_MAX_MIN_AVG(){var s0,s1,s2;s0=peg$currPos;s1=[];if(peg$c110.test(input.charAt(peg$currPos))){s2=input.charAt(peg$currPos);peg$currPos++;}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c111);}}if(s2!==peg$FAILED){while(s2!==peg$FAILED){s1.push(s2);if(peg$c110.test(input.charAt(peg$currPos))){s2=input.charAt(peg$currPos);peg$currPos++;}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c111);}}}}else{s1=peg$FAILED;}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c112(s1);}s0=s1;return s0;}function peg$parseaggr_fun_count(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseKW_COUNT();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseLPAREN();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parsecount_arg();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseRPAREN();if(s7!==peg$FAILED){peg$savedPos=s0;s1=peg$c113(s1,s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsecount_arg(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parsestar_expr();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c114(s1);}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseKW_DISTINCT();if(s1===peg$FAILED){s1=null;}if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parsecolumn_ref();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c115(s1,s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}return s0;}function peg$parsestar_expr(){var s0,s1;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===42){s1=peg$c82;peg$currPos++;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c83);}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c116();}s0=s1;return s0;}function peg$parsefunc_call(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseident();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseLPAREN();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseexpr_list_or_empty();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseRPAREN();if(s7!==peg$FAILED){peg$savedPos=s0;s1=peg$c117(s1,s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseliteral(){var s0;s0=peg$parseliteral_string();if(s0===peg$FAILED){s0=peg$parseliteral_numeric();if(s0===peg$FAILED){s0=peg$parseliteral_bool();if(s0===peg$FAILED){s0=peg$parseliteral_null();}}}return s0;}function peg$parseliteral_list(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseliteral();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseliteral();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseliteral();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c28(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseliteral_null(){var s0,s1;s0=peg$currPos;s1=peg$parseKW_NULL();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c118();}s0=s1;return s0;}function peg$parseliteral_bool(){var s0,s1;s0=peg$currPos;s1=peg$parseKW_TRUE();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c119();}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseKW_FALSE();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c120();}s0=s1;}return s0;}function peg$parseliteral_string(){var s0,s1,s2,s3,s4;s0=peg$currPos;s1=peg$currPos;if(input.charCodeAt(peg$currPos)===34){s2=peg$c121;peg$currPos++;}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c122);}}if(s2!==peg$FAILED){s3=[];s4=peg$parsedouble_char();while(s4!==peg$FAILED){s3.push(s4);s4=peg$parsedouble_char();}if(s3!==peg$FAILED){if(input.charCodeAt(peg$currPos)===34){s4=peg$c121;peg$currPos++;}else{s4=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c122);}}if(s4!==peg$FAILED){s2=[s2,s3,s4];s1=s2;}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}if(s1===peg$FAILED){s1=peg$currPos;if(input.charCodeAt(peg$currPos)===39){s2=peg$c123;peg$currPos++;}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c124);}}if(s2!==peg$FAILED){s3=[];s4=peg$parsesingle_char();while(s4!==peg$FAILED){s3.push(s4);s4=peg$parsesingle_char();}if(s3!==peg$FAILED){if(input.charCodeAt(peg$currPos)===39){s4=peg$c123;peg$currPos++;}else{s4=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c124);}}if(s4!==peg$FAILED){s2=[s2,s3,s4];s1=s2;}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}}else{peg$currPos=s1;s1=peg$FAILED;}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c125(s1);}s0=s1;return s0;}function peg$parsesingle_char(){var s0;if(peg$c126.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c127);}}if(s0===peg$FAILED){s0=peg$parseescape_char();}return s0;}function peg$parsedouble_char(){var s0;if(peg$c128.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c129);}}if(s0===peg$FAILED){s0=peg$parseescape_char();}return s0;}function peg$parseescape_char(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c130){s1=peg$c130;peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c131);}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c132();}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c133){s1=peg$c133;peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c134);}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c135();}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c136){s1=peg$c136;peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c137);}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c138();}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c139){s1=peg$c139;peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c140);}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c141();}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c142){s1=peg$c142;peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c143);}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c144();}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c145){s1=peg$c145;peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c146);}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c147();}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c148){s1=peg$c148;peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c149);}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c150();}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c151){s1=peg$c151;peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c152);}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c153();}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c154){s1=peg$c154;peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c155);}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c156();}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c157){s1=peg$c157;peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c158);}}if(s1!==peg$FAILED){s2=peg$parsehexDigit();if(s2!==peg$FAILED){s3=peg$parsehexDigit();if(s3!==peg$FAILED){s4=peg$parsehexDigit();if(s4!==peg$FAILED){s5=peg$parsehexDigit();if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c159(s2,s3,s4,s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}}}}}}}}}return s0;}function peg$parseline_terminator(){var s0;if(peg$c160.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c161);}}return s0;}function peg$parseliteral_numeric(){var s0,s1;s0=peg$currPos;s1=peg$parsenumber();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c162(s1);}s0=s1;return s0;}function peg$parseliteral_int(){var s0,s1;peg$silentFails++;s0=peg$currPos;s1=peg$parseint();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c164(s1);}s0=s1;peg$silentFails--;if(s0===peg$FAILED){s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c163);}}return s0;}function peg$parsenumber(){var s0,s1,s2,s3,s4;s0=peg$currPos;s1=peg$parseint();if(s1!==peg$FAILED){s2=peg$parsefrac();if(s2!==peg$FAILED){s3=peg$parseexp();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){peg$savedPos=s0;s1=peg$c165(s1,s2,s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseint();if(s1!==peg$FAILED){s2=peg$parsefrac();if(s2!==peg$FAILED){s3=peg$parse__();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c166(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseint();if(s1!==peg$FAILED){s2=peg$parseexp();if(s2!==peg$FAILED){s3=peg$parse__();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c167(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseint();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c168(s1);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}}}return s0;}function peg$parseint(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parsedigit19();if(s1!==peg$FAILED){s2=peg$parsedigits();if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c169(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$parsedigit();if(s0===peg$FAILED){s0=peg$currPos;if(input.charCodeAt(peg$currPos)===45){s1=peg$c79;peg$currPos++;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c80);}}if(s1===peg$FAILED){if(input.charCodeAt(peg$currPos)===43){s1=peg$c77;peg$currPos++;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c78);}}}if(s1!==peg$FAILED){s2=peg$parsedigit19();if(s2!==peg$FAILED){s3=peg$parsedigits();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c170(s1,s2,s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}if(s0===peg$FAILED){s0=peg$currPos;if(input.charCodeAt(peg$currPos)===45){s1=peg$c79;peg$currPos++;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c80);}}if(s1===peg$FAILED){if(input.charCodeAt(peg$currPos)===43){s1=peg$c77;peg$currPos++;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c78);}}}if(s1!==peg$FAILED){s2=peg$parsedigit();if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c171(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}}}return s0;}function peg$parsefrac(){var s0,s1,s2;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===46){s1=peg$c172;peg$currPos++;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c173);}}if(s1!==peg$FAILED){s2=peg$parsedigits();if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c174(s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseexp(){var s0,s1,s2;s0=peg$currPos;s1=peg$parsee();if(s1!==peg$FAILED){s2=peg$parsedigits();if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c175(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsedigits(){var s0,s1,s2;s0=peg$currPos;s1=[];s2=peg$parsedigit();if(s2!==peg$FAILED){while(s2!==peg$FAILED){s1.push(s2);s2=peg$parsedigit();}}else{s1=peg$FAILED;}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c176(s1);}s0=s1;return s0;}function peg$parsedigit(){var s0,s1;peg$silentFails++;if(peg$c178.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c179);}}peg$silentFails--;if(s0===peg$FAILED){s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c177);}}return s0;}function peg$parsedigit19(){var s0,s1;peg$silentFails++;if(peg$c180.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c181);}}peg$silentFails--;if(s0===peg$FAILED){s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c177);}}return s0;}function peg$parsehexDigit(){var s0,s1;peg$silentFails++;if(peg$c183.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c184);}}peg$silentFails--;if(s0===peg$FAILED){s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c182);}}return s0;}function peg$parsee(){var s0,s1,s2;s0=peg$currPos;if(peg$c185.test(input.charAt(peg$currPos))){s1=input.charAt(peg$currPos);peg$currPos++;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c186);}}if(s1!==peg$FAILED){if(peg$c187.test(input.charAt(peg$currPos))){s2=input.charAt(peg$currPos);peg$currPos++;}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c188);}}if(s2===peg$FAILED){s2=null;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c189(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_NULL(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,4).toLowerCase()===peg$c190){s1=input.substr(peg$currPos,4);peg$currPos+=4;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c191);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_TRUE(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,4).toLowerCase()===peg$c192){s1=input.substr(peg$currPos,4);peg$currPos+=4;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c193);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_FALSE(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,5).toLowerCase()===peg$c194){s1=input.substr(peg$currPos,5);peg$currPos+=5;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c195);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_SHOW(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,4).toLowerCase()===peg$c196){s1=input.substr(peg$currPos,4);peg$currPos+=4;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c197);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_DROP(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,4).toLowerCase()===peg$c198){s1=input.substr(peg$currPos,4);peg$currPos+=4;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c199);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_SELECT(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,6).toLowerCase()===peg$c200){s1=input.substr(peg$currPos,6);peg$currPos+=6;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c201);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_UPDATE(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,6).toLowerCase()===peg$c202){s1=input.substr(peg$currPos,6);peg$currPos+=6;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c203);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_CREATE(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,6).toLowerCase()===peg$c204){s1=input.substr(peg$currPos,6);peg$currPos+=6;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c205);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_DELETE(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,6).toLowerCase()===peg$c206){s1=input.substr(peg$currPos,6);peg$currPos+=6;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c207);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_INSERT(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,6).toLowerCase()===peg$c208){s1=input.substr(peg$currPos,6);peg$currPos+=6;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c209);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_REPLACE(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,7).toLowerCase()===peg$c210){s1=input.substr(peg$currPos,7);peg$currPos+=7;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c211);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_EXPLAIN(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,7).toLowerCase()===peg$c212){s1=input.substr(peg$currPos,7);peg$currPos+=7;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c213);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_INTO(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,4).toLowerCase()===peg$c214){s1=input.substr(peg$currPos,4);peg$currPos+=4;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c215);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_FROM(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,4).toLowerCase()===peg$c216){s1=input.substr(peg$currPos,4);peg$currPos+=4;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c217);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_SET(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,3).toLowerCase()===peg$c218){s1=input.substr(peg$currPos,3);peg$currPos+=3;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c219);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_AS(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,2).toLowerCase()===peg$c220){s1=input.substr(peg$currPos,2);peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c221);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_TABLE(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,5).toLowerCase()===peg$c222){s1=input.substr(peg$currPos,5);peg$currPos+=5;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c223);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_ON(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,2).toLowerCase()===peg$c224){s1=input.substr(peg$currPos,2);peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c225);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_LEFT(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,4).toLowerCase()===peg$c226){s1=input.substr(peg$currPos,4);peg$currPos+=4;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c227);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_INNER(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,5).toLowerCase()===peg$c228){s1=input.substr(peg$currPos,5);peg$currPos+=5;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c229);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_JOIN(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,4).toLowerCase()===peg$c230){s1=input.substr(peg$currPos,4);peg$currPos+=4;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c231);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_UNION(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,5).toLowerCase()===peg$c232){s1=input.substr(peg$currPos,5);peg$currPos+=5;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c233);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_VALUES(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,6).toLowerCase()===peg$c234){s1=input.substr(peg$currPos,6);peg$currPos+=6;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c235);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_IF(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,2).toLowerCase()===peg$c236){s1=input.substr(peg$currPos,2);peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c237);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_EXISTS(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,6).toLowerCase()===peg$c238){s1=input.substr(peg$currPos,6);peg$currPos+=6;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c239);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_WHERE(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,5).toLowerCase()===peg$c240){s1=input.substr(peg$currPos,5);peg$currPos+=5;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c241);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_GROUP(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,5).toLowerCase()===peg$c242){s1=input.substr(peg$currPos,5);peg$currPos+=5;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c243);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_BY(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,2).toLowerCase()===peg$c244){s1=input.substr(peg$currPos,2);peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c245);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_ORDER(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,5).toLowerCase()===peg$c246){s1=input.substr(peg$currPos,5);peg$currPos+=5;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c247);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_HAVING(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,6).toLowerCase()===peg$c248){s1=input.substr(peg$currPos,6);peg$currPos+=6;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c249);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_LIMIT(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,5).toLowerCase()===peg$c250){s1=input.substr(peg$currPos,5);peg$currPos+=5;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c251);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_ASC(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,3).toLowerCase()===peg$c252){s1=input.substr(peg$currPos,3);peg$currPos+=3;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c253);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c254();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_DESC(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,4).toLowerCase()===peg$c255){s1=input.substr(peg$currPos,4);peg$currPos+=4;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c256);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c257();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_ALL(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,3).toLowerCase()===peg$c258){s1=input.substr(peg$currPos,3);peg$currPos+=3;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c259);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c260();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_DISTINCT(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,8).toLowerCase()===peg$c261){s1=input.substr(peg$currPos,8);peg$currPos+=8;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c262);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c263();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_BETWEEN(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,7).toLowerCase()===peg$c264){s1=input.substr(peg$currPos,7);peg$currPos+=7;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c265);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c266();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_IN(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,2).toLowerCase()===peg$c267){s1=input.substr(peg$currPos,2);peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c268);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c269();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_IS(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,2).toLowerCase()===peg$c270){s1=input.substr(peg$currPos,2);peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c271);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c272();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_LIKE(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,4).toLowerCase()===peg$c273){s1=input.substr(peg$currPos,4);peg$currPos+=4;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c274);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c275();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_CONTAINS(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,8).toLowerCase()===peg$c276){s1=input.substr(peg$currPos,8);peg$currPos+=8;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c277);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c278();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_NOT(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,3).toLowerCase()===peg$c279){s1=input.substr(peg$currPos,3);peg$currPos+=3;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c280);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c281();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_AND(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,3).toLowerCase()===peg$c282){s1=input.substr(peg$currPos,3);peg$currPos+=3;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c283);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c284();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_OR(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,2).toLowerCase()===peg$c285){s1=input.substr(peg$currPos,2);peg$currPos+=2;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c286);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c287();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_COUNT(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,5).toLowerCase()===peg$c288){s1=input.substr(peg$currPos,5);peg$currPos+=5;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c289);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c290();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_MAX(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,3).toLowerCase()===peg$c291){s1=input.substr(peg$currPos,3);peg$currPos+=3;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c292);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c293();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_MIN(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,3).toLowerCase()===peg$c294){s1=input.substr(peg$currPos,3);peg$currPos+=3;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c295);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c296();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_SUM(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,3).toLowerCase()===peg$c297){s1=input.substr(peg$currPos,3);peg$currPos+=3;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c298);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c299();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseKW_AVG(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,3).toLowerCase()===peg$c300){s1=input.substr(peg$currPos,3);peg$currPos+=3;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c301);}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseident_start();peg$silentFails--;if(s3===peg$FAILED){s2=void 0;}else{peg$currPos=s2;s2=peg$FAILED;}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c302();s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseDOT(){var s0;if(input.charCodeAt(peg$currPos)===46){s0=peg$c172;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c173);}}return s0;}function peg$parseCOMMA(){var s0;if(input.charCodeAt(peg$currPos)===44){s0=peg$c303;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c304);}}return s0;}function peg$parseSTAR(){var s0;if(input.charCodeAt(peg$currPos)===42){s0=peg$c82;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c83);}}return s0;}function peg$parseLPAREN(){var s0;if(input.charCodeAt(peg$currPos)===40){s0=peg$c3;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c4);}}return s0;}function peg$parseRPAREN(){var s0;if(input.charCodeAt(peg$currPos)===41){s0=peg$c5;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c6);}}return s0;}function peg$parseLBRAKE(){var s0;if(input.charCodeAt(peg$currPos)===91){s0=peg$c305;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c306);}}return s0;}function peg$parseRBRAKE(){var s0;if(input.charCodeAt(peg$currPos)===93){s0=peg$c307;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c308);}}return s0;}function peg$parse__(){var s0,s1;s0=[];s1=peg$parsewhitespace();while(s1!==peg$FAILED){s0.push(s1);s1=peg$parsewhitespace();}return s0;}function peg$parsechar(){var s0;if(input.length>peg$currPos){s0=input.charAt(peg$currPos);peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c309);}}return s0;}function peg$parsewhitespace(){var s0,s1;peg$silentFails++;if(peg$c311.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c312);}}peg$silentFails--;if(s0===peg$FAILED){s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c310);}}return s0;}function peg$parseEOL(){var s0,s1;peg$silentFails++;s0=peg$parseEOF();if(s0===peg$FAILED){s0=[];if(peg$c160.test(input.charAt(peg$currPos))){s1=input.charAt(peg$currPos);peg$currPos++;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c161);}}if(s1!==peg$FAILED){while(s1!==peg$FAILED){s0.push(s1);if(peg$c160.test(input.charAt(peg$currPos))){s1=input.charAt(peg$currPos);peg$currPos++;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c161);}}}}else{s0=peg$FAILED;}}peg$silentFails--;if(s0===peg$FAILED){s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c313);}}return s0;}function peg$parseEOF(){var s0,s1;s0=peg$currPos;peg$silentFails++;if(input.length>peg$currPos){s1=input.charAt(peg$currPos);peg$currPos++;}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c309);}}peg$silentFails--;if(s1===peg$FAILED){s0=void 0;}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseproc_stmts(){var s0,s1;s0=[];s1=peg$parseproc_stmt();while(s1!==peg$FAILED){s0.push(s1);s1=peg$parseproc_stmt();}return s0;}function peg$parseproc_stmt(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$currPos;peg$silentFails++;s2=peg$parseproc_init();peg$silentFails--;if(s2!==peg$FAILED){peg$currPos=s1;s1=void 0;}else{s1=peg$FAILED;}if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseassign_stmt();if(s3===peg$FAILED){s3=peg$parsereturn_stmt();}if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c314(s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseproc_init(){var s0,s1;s0=peg$currPos;s1=peg$c52;if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c315();}s0=s1;return s0;}function peg$parseassign_stmt(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;s1=peg$parsevar_decl();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseKW_ASSIGN();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseproc_expr();if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c316(s1,s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsereturn_stmt(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseKW_RETURN();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseproc_expr();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c317(s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseproc_expr(){var s0;s0=peg$parseselect_stmt();if(s0===peg$FAILED){s0=peg$parseproc_join();if(s0===peg$FAILED){s0=peg$parseproc_additive_expr();if(s0===peg$FAILED){s0=peg$parseproc_array();}}}return s0;}function peg$parseproc_additive_expr(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseproc_multiplicative_expr();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseadditive_operator();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseproc_multiplicative_expr();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseadditive_operator();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseproc_multiplicative_expr();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c54(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseproc_multiplicative_expr(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseproc_primary();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parsemultiplicative_operator();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseproc_primary();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parsemultiplicative_operator();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseproc_primary();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c54(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseproc_join(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parsevar_decl();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parsejoin_op();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parsevar_decl();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseon_clause();if(s7!==peg$FAILED){peg$savedPos=s0;s1=peg$c318(s1,s3,s5,s7);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseproc_primary(){var s0,s1,s2,s3,s4,s5;s0=peg$parseliteral();if(s0===peg$FAILED){s0=peg$parsevar_decl();if(s0===peg$FAILED){s0=peg$parseproc_func_call();if(s0===peg$FAILED){s0=peg$parseparam();if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseLPAREN();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseproc_additive_expr();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseRPAREN();if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c88(s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}}}}return s0;}function peg$parseproc_func_call(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseident();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseLPAREN();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseproc_primary_list();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseRPAREN();if(s7!==peg$FAILED){peg$savedPos=s0;s1=peg$c319(s1,s5);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseproc_primary_list(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseproc_primary();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseproc_primary();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseCOMMA();if(s5!==peg$FAILED){s6=peg$parse__();if(s6!==peg$FAILED){s7=peg$parseproc_primary();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4;}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}else{peg$currPos=s3;s3=peg$FAILED;}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c28(s1,s2);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parseproc_array(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;s1=peg$parseLBRAKE();if(s1!==peg$FAILED){s2=peg$parse__();if(s2!==peg$FAILED){s3=peg$parseproc_primary_list();if(s3!==peg$FAILED){s4=peg$parse__();if(s4!==peg$FAILED){s5=peg$parseRBRAKE();if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c320(s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsevar_decl(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseKW_VAR_PRE();if(s1!==peg$FAILED){s2=peg$parseident_name();if(s2!==peg$FAILED){s3=peg$parsemem_chain();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c321(s2,s3);s0=s1;}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}}else{peg$currPos=s0;s0=peg$FAILED;}return s0;}function peg$parsemem_chain(){var s0,s1,s2,s3,s4;s0=peg$currPos;s1=[];s2=peg$currPos;if(input.charCodeAt(peg$currPos)===46){s3=peg$c172;peg$currPos++;}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c173);}}if(s3!==peg$FAILED){s4=peg$parseident_name();if(s4!==peg$FAILED){s3=[s3,s4];s2=s3;}else{peg$currPos=s2;s2=peg$FAILED;}}else{peg$currPos=s2;s2=peg$FAILED;}while(s2!==peg$FAILED){s1.push(s2);s2=peg$currPos;if(input.charCodeAt(peg$currPos)===46){s3=peg$c172;peg$currPos++;}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c173);}}if(s3!==peg$FAILED){s4=peg$parseident_name();if(s4!==peg$FAILED){s3=[s3,s4];s2=s3;}else{peg$currPos=s2;s2=peg$FAILED;}}else{peg$currPos=s2;s2=peg$FAILED;}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c322(s1);}s0=s1;return s0;}function peg$parseKW_VAR_PRE(){var s0;if(input.charCodeAt(peg$currPos)===36){s0=peg$c323;peg$currPos++;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c324);}}return s0;}function peg$parseKW_RETURN(){var s0;if(input.substr(peg$currPos,6).toLowerCase()===peg$c325){s0=input.substr(peg$currPos,6);peg$currPos+=6;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c326);}}return s0;}function peg$parseKW_ASSIGN(){var s0;if(input.substr(peg$currPos,2)===peg$c327){s0=peg$c327;peg$currPos+=2;}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c328);}}return s0;}function debug(str){console.log(str);}function createUnaryExpr(op,e){return{type:'unary_expr',operator:op,expr:e};}function createBinaryExpr(op,left,right){return{type:'binary_expr',operator:op,left:left,right:right};}function createList(head,tail){var result=[head];for(var i=0;i<tail.length;i++){result.push(tail[i][3]);}return result;}function createExprList(head,tail,room){var epList=createList(head,tail);var exprList=[];var ep;for(var i=0;i<epList.length;i++){ep=epList[i];if(ep.type=='param'){ep.room=room;ep.pos=i;}else{exprList.push(ep);}}return exprList;}function createBinaryExprChain(head,tail){var result=head;for(var i=0;i<tail.length;i++){result=createBinaryExpr(tail[i][1],result,tail[i][3]);}return result;}var reservedMap={'SHOW':true,'DROP':true,'SELECT':true,'UPDATE':true,'CREATE':true,'DELETE':true,'INSERT':true,'REPLACE':true,'EXPLAIN':true,'ALL':true,'DISTINCT':true,'AS':true,'TABLE':true,'INTO':true,'FROM':true,'SET':true,'LEFT':true,'ON':true,'INNER':true,'JOIN':true,'UNION':true,'VALUES':true,'EXISTS':true,'WHERE':true,'GROUP':true,'BY':true,'HAVING':true,'ORDER':true,'ASC':true,'DESC':true,'LIMIT':true,'BETWEEN':true,'IN':true,'IS':true,'LIKE':true,'CONTAINS':true,'NOT':true,'AND':true,'OR':true,'TRUE':true,'FALSE':true,'NULL':true};var cmpPrefixMap={'+':true,'-':true,'*':true,'/':true,'>':true,'<':true,'!':true,'=':true,'B':true,'b':true,'I':true,'i':true,'L':true,'l':true,'N':true,'n':true,'C':true,'c':true};var params=[];var varList=[];peg$result=peg$startRuleFunction();if(peg$result!==peg$FAILED&&peg$currPos===input.length){return peg$result;}else{if(peg$result!==peg$FAILED&&peg$currPos<input.length){peg$fail(peg$endExpectation());}throw peg$buildStructuredError(peg$maxFailExpected,peg$maxFailPos<input.length?input.charAt(peg$maxFailPos):null,peg$maxFailPos<input.length?peg$computeLocation(peg$maxFailPos,peg$maxFailPos+1):peg$computeLocation(peg$maxFailPos,peg$maxFailPos));}}module.exports={SyntaxError:peg$SyntaxError,parse:peg$parse};},{}],71:[function(require,module,exports){var escapeMap={'\0':'\\0','\'':'\\\'','\"':'\\\"','\b':'\\b','\n':'\\n','\r':'\\r','\t':'\\t','\x1a':'\\Z','\\':'\\\\'};function escape(str){var res=[];var c,e;for(var i=0;i<str.length;i++){c=str[i];e=escapeMap[c];if(e){c=e;}res.push(c);}return res.join('');}function literalToSQL(l){var t=l.type;var v=l.value;if(t==='string'){v='\''+escape(v)+'\'';}else if(t==='bool'){v=v?'TRUE':'FALSE';}else if(t==='null'){v='NULL';}else if(t==='star'){v='*';}if(l.paren){return'('+v+')';}else{return v;}}function unaryToSQL(e){var str=e.operator+' '+exprToSQL(e.expr);if(e.paren){return'('+str+')';}else{return str;}}function getExprListSQL(l){var es=[];for(var i=0;i<l.length;i++){es.push(exprToSQL(l[i]));}return es;}function binaryToSQL(e){var op=e.operator;var left=e.left;var right=e.right;var lstr=exprToSQL(left);var rstr=exprToSQL(right);if(Array.isArray(rstr)){if(op==='='){op='IN';}if(op==='BETWEEN'){rstr=rstr[0]+' AND '+rstr[1];}else{rstr='('+rstr.join(', ')+')';}}var str=lstr+' '+op+' '+rstr;if(e.paren){return'('+str+')';}else{return str;}}function aggrToSQL(e){var args=e.args;var str=exprToSQL(args.expr);var name=e.name;if(name==='COUNT'){var distinct=args.distinct;if(distinct){str='DISTINCT '+str;}}return name+'('+str+')';}function funcToSQL(e){var es=exprToSQL(e.args);var str=e.name+'('+es.join(', ')+')';if(e.paren){return'('+str+')';}else{return str;}}function columnRefToSQL(e){var str=e.column;if(e.table){str=e.table+'.'+str;}if(e.paren){return'('+str+')';}else{return str;}}function exprToSQL(e){var t=e.type;var res;switch(t){case'unary_expr':res=unaryToSQL(e);break;case'binary_expr':res=binaryToSQL(e);break;case'aggr_func':res=aggrToSQL(e);break;case'function':res=funcToSQL(e);break;case'column_ref':res=columnRefToSQL(e);break;case'expr_list':res=getExprListSQL(e.value);break;case'var':throw new Error('unsupported type `var`');case'param':res=paramToSql(e);break;default:res=literalToSQL(e);}return res;}function paramToSql(e){return e.value==='?'?'?':':'+e.value;}function js2nSQLExpr(val){var type=typeof val==="undefined"?"undefined":_typeof(val);var obj={};switch(type){case'string':case'number':obj.type=type;obj.value=val;break;case'boolean':obj.type='bool';obj.value=val;break;case'object':if(val===null){obj.type='null';obj.value=val;}else if(Array.isArray(val)){obj.type='expr_list';var arr=[];for(var i=0;i<val.length;i++){arr.push(js2nSQLExpr(val[i]));}obj.value=arr;}else{obj.type='object';obj.value=val;}break;default:obj.type='unknown';}return obj;}function unionToSQL(s,options){var str=selectToSQL(s,options);var res=[];res.push(str);while(s._next){str=selectToSQL(s._next,options);res.push('UNION');res.push(str);s=s._next;}return res.join(' ');}function selectToSQL(s,options){var distinct=s.distinct;var columns=s.columns;var from=s.from;var where=s.where;var groupby=s.groupby;var orderby=s.orderby;var limit=s.limit;var clauses=[];var i,str,cs;options=options||{};clauses.push('SELECT');if(distinct){clauses.push(distinct);}if(columns==='*'){clauses.push('*');}else{cs=[];for(i=0;i<columns.length;i++){var ea=columns[i];str=exprToSQL(ea.expr);if(ea.as){str+=' AS '+ea.as;}cs.push(str);}clauses.push(cs.join(', '));}if(Array.isArray(from)){var tbase=from[0];clauses.push('FROM');cs=[];str=tbase.table;if(options.keep_db!==false&&tbase.db){str=tbase.db+'.'+str;}if(tbase.as){str+=' AS '+tbase.as;}cs.push(str);for(i=1;i<from.length;i++){var tref=from[i];if(tref.join){str=' '+tref.join+' ';}else{str=', ';}if(options.keep_db!==false&&tref.db){str+=tref.db+'.';}str+=tref.table;if(tref.as){str+=' AS '+tref.as;}if(tref.on){str+=' ON '+exprToSQL(tref.on);}cs.push(str);}clauses.push(cs.join(''));}if(where){clauses.push('WHERE '+exprToSQL(where));}if(Array.isArray(groupby)){var l=getExprListSQL(groupby);clauses.push('GROUP BY '+l.join(', '));}if(Array.isArray(orderby)){cs=[];for(var i=0;i<orderby.length;i++){var o=orderby[i];str=exprToSQL(o.expr);str+=' '+o.type;cs.push(str);}clauses.push('ORDER BY '+cs.join(', '));}if(Array.isArray(limit)){if(options.offset!==false){str='LIMIT '+limit[0].value+', '+limit[1].value;}else{str='LIMIT '+(limit[0].value+limit[1].value);}clauses.push(str);}return clauses.join(' ');}function updateToSQL(stmt,options){var res=['UPDATE'];options=options||{};if(options.keep_db===false){res.push(stmt.table);}else{res.push(stmt.db+'.'+stmt.table);}res.push('SET');var cs=[];var sets=stmt.set;var i,str;for(i=0;i<sets.length;i++){str=sets[i].column+' = '+exprToSQL(sets[i].value);cs.push(str);}res.push(cs.join(', '));if(stmt.where){str='WHERE ';str+=exprToSQL(stmt.where);res.push(str);}return res.join(' ');}function replace_insertToSQL(stmt,options){options=options||{};var res=[];res.push(stmt.type.toUpperCase());res.push('INTO');if(options.keep_db===false){res.push(stmt.table);}else{res.push(stmt.db+'.'+stmt.table);}res.push('('+stmt.columns.join(', ')+')');res.push('VALUES');var i;var cs=[];var vs=stmt.values;for(i=0;i<vs.length;i++){var es=vs[i].value;var rs=[];for(var j=0;j<es.length;j++){rs.push(exprToSQL(es[j]));}cs.push('('+rs.join(', ')+')');}res.push(cs.join(', '));return res.join(' ');}module.exports=function(ast,opt){var options={keep_db:true,offset:false};for(var k in opt){options[k]=opt[k];}var res;switch(ast.type){case'select':res=unionToSQL(ast,options);break;case'update':res=updateToSQL(ast,options);break;case'insert':case'replace':res=replace_insertToSQL(ast,options);break;case'delete':throw new Error('ERROR TYPE :'+ast.type+', NOT SUPPORTED');default:throw new Error('ERROR TYPE :'+ast.type+', NOT SUPPORTED');}return res;};module.exports.exprToSQL=exprToSQL;},{}],72:[function(require,module,exports){(function(process){(function(){function normalizeArray(parts,allowAboveRoot){var up=0;for(var i=parts.length-1;i>=0;i--){var last=parts[i];if(last==='.'){parts.splice(i,1);}else if(last==='..'){parts.splice(i,1);up++;}else if(up){parts.splice(i,1);up--;}}if(allowAboveRoot){for(;up--;up){parts.unshift('..');}}return parts;}exports.resolve=function(){var resolvedPath='',resolvedAbsolute=false;for(var i=arguments.length-1;i>=-1&&!resolvedAbsolute;i--){var path=i>=0?arguments[i]:process.cwd();if(typeof path!=='string'){throw new TypeError('Arguments to path.resolve must be strings');}else if(!path){continue;}resolvedPath=path+'/'+resolvedPath;resolvedAbsolute=path.charAt(0)==='/';}resolvedPath=normalizeArray(filter(resolvedPath.split('/'),function(p){return!!p;}),!resolvedAbsolute).join('/');return(resolvedAbsolute?'/':'')+resolvedPath||'.';};exports.normalize=function(path){var isAbsolute=exports.isAbsolute(path),trailingSlash=substr(path,-1)==='/';path=normalizeArray(filter(path.split('/'),function(p){return!!p;}),!isAbsolute).join('/');if(!path&&!isAbsolute){path='.';}if(path&&trailingSlash){path+='/';}return(isAbsolute?'/':'')+path;};exports.isAbsolute=function(path){return path.charAt(0)==='/';};exports.join=function(){var paths=Array.prototype.slice.call(arguments,0);return exports.normalize(filter(paths,function(p,index){if(typeof p!=='string'){throw new TypeError('Arguments to path.join must be strings');}return p;}).join('/'));};exports.relative=function(from,to){from=exports.resolve(from).substr(1);to=exports.resolve(to).substr(1);function trim(arr){var start=0;for(;start<arr.length;start++){if(arr[start]!=='')break;}var end=arr.length-1;for(;end>=0;end--){if(arr[end]!=='')break;}if(start>end)return[];return arr.slice(start,end-start+1);}var fromParts=trim(from.split('/'));var toParts=trim(to.split('/'));var length=Math.min(fromParts.length,toParts.length);var samePartsLength=length;for(var i=0;i<length;i++){if(fromParts[i]!==toParts[i]){samePartsLength=i;break;}}var outputParts=[];for(var i=samePartsLength;i<fromParts.length;i++){outputParts.push('..');}outputParts=outputParts.concat(toParts.slice(samePartsLength));return outputParts.join('/');};exports.sep='/';exports.delimiter=':';exports.dirname=function(path){if(typeof path!=='string')path=path+'';if(path.length===0)return'.';var code=path.charCodeAt(0);var hasRoot=code===47;var end=-1;var matchedSlash=true;for(var i=path.length-1;i>=1;--i){code=path.charCodeAt(i);if(code===47){if(!matchedSlash){end=i;break;}}else{matchedSlash=false;}}if(end===-1)return hasRoot?'/':'.';if(hasRoot&&end===1){return'/';}return path.slice(0,end);};function basename(path){if(typeof path!=='string')path=path+'';var start=0;var end=-1;var matchedSlash=true;var i;for(i=path.length-1;i>=0;--i){if(path.charCodeAt(i)===47){if(!matchedSlash){start=i+1;break;}}else if(end===-1){matchedSlash=false;end=i+1;}}if(end===-1)return'';return path.slice(start,end);}exports.basename=function(path,ext){var f=basename(path);if(ext&&f.substr(-1*ext.length)===ext){f=f.substr(0,f.length-ext.length);}return f;};exports.extname=function(path){if(typeof path!=='string')path=path+'';var startDot=-1;var startPart=0;var end=-1;var matchedSlash=true;var preDotState=0;for(var i=path.length-1;i>=0;--i){var code=path.charCodeAt(i);if(code===47){if(!matchedSlash){startPart=i+1;break;}continue;}if(end===-1){matchedSlash=false;end=i+1;}if(code===46){if(startDot===-1)startDot=i;else if(preDotState!==1)preDotState=1;}else if(startDot!==-1){preDotState=-1;}}if(startDot===-1||end===-1||preDotState===0||preDotState===1&&startDot===end-1&&startDot===startPart+1){return'';}return path.slice(startDot,end);};function filter(xs,f){if(xs.filter)return xs.filter(f);var res=[];for(var i=0;i<xs.length;i++){if(f(xs[i],i,xs))res.push(xs[i]);}return res;}var substr='ab'.substr(-1)==='b'?function(str,start,len){return str.substr(start,len);}:function(str,start,len){if(start<0)start=str.length+start;return str.substr(start,len);};}).call(this);}).call(this,require('_process'));},{"_process":73}],73:[function(require,module,exports){var process=module.exports={};var cachedSetTimeout;var cachedClearTimeout;function defaultSetTimout(){throw new Error('setTimeout has not been defined');}function defaultClearTimeout(){throw new Error('clearTimeout has not been defined');}(function(){try{if(typeof setTimeout==='function'){cachedSetTimeout=setTimeout;}else{cachedSetTimeout=defaultSetTimout;}}catch(e){cachedSetTimeout=defaultSetTimout;}try{if(typeof clearTimeout==='function'){cachedClearTimeout=clearTimeout;}else{cachedClearTimeout=defaultClearTimeout;}}catch(e){cachedClearTimeout=defaultClearTimeout;}})();function runTimeout(fun){if(cachedSetTimeout===setTimeout){return setTimeout(fun,0);}if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0);}try{return cachedSetTimeout(fun,0);}catch(e){try{return cachedSetTimeout.call(null,fun,0);}catch(e){return cachedSetTimeout.call(this,fun,0);}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){return clearTimeout(marker);}if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker);}try{return cachedClearTimeout(marker);}catch(e){try{return cachedClearTimeout.call(null,marker);}catch(e){return cachedClearTimeout.call(this,marker);}}}var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return;}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue);}else{queueIndex=-1;}if(queue.length){drainQueue();}}function drainQueue(){if(draining){return;}var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run();}}queueIndex=-1;len=queue.length;}currentQueue=null;draining=false;runClearTimeout(timeout);}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i];}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue);}};function Item(fun,array){this.fun=fun;this.array=array;}Item.prototype.run=function(){this.fun.apply(null,this.array);};process.title='browser';process.browser=true;process.env={};process.argv=[];process.version='';process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.prependListener=noop;process.prependOnceListener=noop;process.listeners=function(name){return[];};process.binding=function(name){throw new Error('process.binding is not supported');};process.cwd=function(){return'/';};process.chdir=function(dir){throw new Error('process.chdir is not supported');};process.umask=function(){return 0;};},{}],74:[function(require,module,exports){if(typeof Object.create==='function'){module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}});};}else{module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function TempCtor(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor();ctor.prototype.constructor=ctor;};}},{}],75:[function(require,module,exports){module.exports=function isBuffer(arg){return arg&&(typeof arg==="undefined"?"undefined":_typeof(arg))==='object'&&typeof arg.copy==='function'&&typeof arg.fill==='function'&&typeof arg.readUInt8==='function';};},{}],76:[function(require,module,exports){(function(process,global){(function(){var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]));}return objects.join(' ');}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==='%%')return'%';if(i>=len)return x;switch(x){case'%s':return String(args[i++]);case'%d':return Number(args[i++]);case'%j':try{return JSON.stringify(args[i++]);}catch(_){return'[Circular]';}default:return x;}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=' '+x;}else{str+=' '+inspect(x);}}return str;};exports.deprecate=function(fn,msg){if(isUndefined(global.process)){return function(){return exports.deprecate(fn,msg).apply(this,arguments);};}if(process.noDeprecation===true){return fn;}var warned=false;function deprecated(){if(!warned){if(process.throwDeprecation){throw new Error(msg);}else if(process.traceDeprecation){console.trace(msg);}else{console.error(msg);}warned=true;}return fn.apply(this,arguments);}return deprecated;};var debugs={};var debugEnviron;exports.debuglog=function(set){if(isUndefined(debugEnviron))debugEnviron=process.env.NODE_DEBUG||'';set=set.toUpperCase();if(!debugs[set]){if(new RegExp('\\b'+set+'\\b','i').test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error('%s %d: %s',set,pid,msg);};}else{debugs[set]=function(){};}}return debugs[set];};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts;}else if(opts){exports._extend(ctx,opts);}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth);}exports.inspect=inspect;inspect.colors={'bold':[1,22],'italic':[3,23],'underline':[4,24],'inverse':[7,27],'white':[37,39],'grey':[90,39],'black':[30,39],'blue':[34,39],'cyan':[36,39],'green':[32,39],'magenta':[35,39],'red':[31,39],'yellow':[33,39]};inspect.styles={'special':'cyan','number':'yellow','boolean':'yellow','undefined':'grey','null':'bold','string':'green','date':'magenta','regexp':'red'};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"\x1B["+inspect.colors[style][0]+'m'+str+"\x1B["+inspect.colors[style][1]+'m';}else{return str;}}function stylizeNoColor(str,styleType){return str;}function arrayToHash(array){var hash={};array.forEach(function(val,idx){hash[val]=true;});return hash;}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes);}return ret;}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive;}var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value);}if(isError(value)&&(keys.indexOf('message')>=0||keys.indexOf('description')>=0)){return formatError(value);}if(keys.length===0){if(isFunction(value)){var name=value.name?': '+value.name:'';return ctx.stylize('[Function'+name+']','special');}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),'regexp');}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),'date');}if(isError(value)){return formatError(value);}}var base='',array=false,braces=['{','}'];if(isArray(value)){array=true;braces=['[',']'];}if(isFunction(value)){var n=value.name?': '+value.name:'';base=' [Function'+n+']';}if(isRegExp(value)){base=' '+RegExp.prototype.toString.call(value);}if(isDate(value)){base=' '+Date.prototype.toUTCString.call(value);}if(isError(value)){base=' '+formatError(value);}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1];}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),'regexp');}else{return ctx.stylize('[Object]','special');}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys);}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array);});}ctx.seen.pop();return reduceToSingleString(output,base,braces);}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize('undefined','undefined');if(isString(value)){var simple='\''+JSON.stringify(value).replace(/^"|"$/g,'').replace(/'/g,"\\'").replace(/\\"/g,'"')+'\'';return ctx.stylize(simple,'string');}if(isNumber(value))return ctx.stylize(''+value,'number');if(isBoolean(value))return ctx.stylize(''+value,'boolean');if(isNull(value))return ctx.stylize('null','null');}function formatError(value){return'['+Error.prototype.toString.call(value)+']';}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true));}else{output.push('');}}keys.forEach(function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true));}});return output;}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize('[Getter/Setter]','special');}else{str=ctx.stylize('[Getter]','special');}}else{if(desc.set){str=ctx.stylize('[Setter]','special');}}if(!hasOwnProperty(visibleKeys,key)){name='['+key+']';}if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null);}else{str=formatValue(ctx,desc.value,recurseTimes-1);}if(str.indexOf('\n')>-1){if(array){str=str.split('\n').map(function(line){return'  '+line;}).join('\n').substr(2);}else{str='\n'+str.split('\n').map(function(line){return'   '+line;}).join('\n');}}}else{str=ctx.stylize('[Circular]','special');}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str;}name=JSON.stringify(''+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,'name');}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,'string');}}return name+': '+str;}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=output.reduce(function(prev,cur){numLinesEst++;if(cur.indexOf('\n')>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,'').length+1;},0);if(length>60){return braces[0]+(base===''?'':base+'\n ')+' '+output.join(',\n  ')+' '+braces[1];}return braces[0]+base+' '+output.join(', ')+' '+braces[1];}function isArray(ar){return Array.isArray(ar);}exports.isArray=isArray;function isBoolean(arg){return typeof arg==='boolean';}exports.isBoolean=isBoolean;function isNull(arg){return arg===null;}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null;}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==='number';}exports.isNumber=isNumber;function isString(arg){return typeof arg==='string';}exports.isString=isString;function isSymbol(arg){return(typeof arg==="undefined"?"undefined":_typeof(arg))==='symbol';}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0;}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==='[object RegExp]';}exports.isRegExp=isRegExp;function isObject(arg){return(typeof arg==="undefined"?"undefined":_typeof(arg))==='object'&&arg!==null;}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==='[object Date]';}exports.isDate=isDate;function isError(e){return isObject(e)&&(objectToString(e)==='[object Error]'||e instanceof Error);}exports.isError=isError;function isFunction(arg){return typeof arg==='function';}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==='boolean'||typeof arg==='number'||typeof arg==='string'||(typeof arg==="undefined"?"undefined":_typeof(arg))==='symbol'||typeof arg==='undefined';}exports.isPrimitive=isPrimitive;exports.isBuffer=require('./support/isBuffer');function objectToString(o){return Object.prototype.toString.call(o);}function pad(n){return n<10?'0'+n.toString(10):n.toString(10);}var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];function timestamp(){var d=new Date();var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(':');return[d.getDate(),months[d.getMonth()],time].join(' ');}exports.log=function(){console.log('%s - %s',timestamp(),exports.format.apply(exports,arguments));};exports.inherits=require('inherits');exports._extend=function(origin,add){if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]];}return origin;};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop);}}).call(this);}).call(this,require('_process'),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"./support/isBuffer":75,"_process":73,"inherits":74}]},{},[38]);